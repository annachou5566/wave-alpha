<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        window.onerror = function (msg, url, lineNo, columnNo, error) {
            alert("LỖI TÌM THẤY:\n" + msg + "\nTại dòng: " + lineNo);
            return false;
        };
        
        window.addEventListener('unhandledrejection', function (event) {
            alert("LỖI KẾT NỐI (Promise):\n" + event.reason);
        });
    </script>
    
    <meta charset="UTF-8">


    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>WAVE ALPHA | TOURNAMENT VOLUME TRACKER</title>
    <meta name="description" content="Predict Market Volume, Win USDT. The most advanced crypto simulation terminal.">
    <meta property="og:title" content="WAVE ALPHA TERMINAL">
    <meta property="og:description" content="Tham gia dự đoán Volume Bitcoin & nhận thưởng ngay hôm nay!">
    <meta property="og:image" content="https://placehold.co/1200x630/0b0e11/00F0FF.png?text=WAVE+ALPHA+TERMINAL&font=montserrat">
    <meta property="og:url" content="https://wave-alpha.app">
    <meta name="twitter:card" content="summary_large_image">

    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KTKQYTJ2ZC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KTKQYTJ2ZC');
    </script>

    <style>
        /* --- CORE THEME (Original V44) --- */
        :root {
            --bg-body: #0b0e11; --bg-card: #161a1e; --bg-header: #181a20;
            --bg-input: #2b3139; --border: #353a42; --text-main: #eaecef; --text-sub: #848e9c;
            --brand: #00F0FF; --brand-glow: rgba(0, 240, 255, 0.3);
            --accent-yellow: #F0B90B; --accent-green: #0ECB81; --accent-red: #F6465D;
            --purple: #9945FF;
            --font-main: 'Be Vietnam Pro', sans-serif; --font-num: 'Rajdhani', sans-serif;
        }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-main); font-size: 13px; display: flex; flex-direction: column; min-height: 100vh; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--bg-body); } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .font-num { font-family: var(--font-num); font-weight: 700; letter-spacing: 0.5px; }
        .text-brand { color: var(--brand) !important; text-shadow: 0 0 10px var(--brand-glow); }
        .text-gold { color: var(--accent-yellow) !important; } .text-green { color: var(--accent-green) !important; } .text-red { color: var(--accent-red) !important; }

        .navbar { background: var(--bg-header); border-bottom: 1px solid var(--border); padding: 12px 0; position: sticky; top: 0; z-index: 1000; }
        .brand-logo { font-family: var(--font-num); font-weight: 800; font-size: 1.6rem; color: var(--text-main); text-decoration: none; cursor:pointer; display: flex; align-items: center; gap: 4px; }
        .brand-logo span { color: var(--brand); }

        .btn-icon { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--text-sub); background: var(--bg-input); transition: all 0.2s ease-in-out; cursor: pointer; position: relative; }
        .btn-icon:hover { color: #fff; border-color: #fff; background: #333; box-shadow: 0 0 15px 2px rgba(255,255,255,0.6); transform: scale(1.1); z-index: 10; }

        .stat-box { background: linear-gradient(145deg, var(--bg-card), #080808); border: 1px solid var(--border); border-radius: 8px; padding: 20px; display: flex; align-items: center; justify-content: space-between; height: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .stat-val { font-size: 2rem; font-weight: 700; font-family: var(--font-num); line-height: 1; }

        /* V45 REDESIGN: COMPACT TRADING ARSENAL (Đã sửa lại nhỏ gọn) */
        .arsenal-section { margin-bottom: 25px; }
        .arsenal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
        }
        .arsenal-card {
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            height: 50px;
        }
        .arsenal-card:hover {
            transform: translateY(-2px);
            border-color: var(--brand);
            background: rgba(0, 240, 255, 0.05);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.15);
        }
        /* --- ĐÃ SỬA: LOGO CÓ MÀU RỰC RỠ --- */
        .ex-logo {
            width: 24px; height: 24px;
            object-fit: contain;
            transition: 0.3s;
            flex-shrink: 0;
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.2));
        }
        /* Khi di chuột vào thì sáng lên và phóng to một chút */
        .arsenal-card:hover .ex-logo {
            transform: scale(1.15);
            filter: brightness(1.2) drop-shadow(0 0 5px var(--brand));
        }


        .ex-info { display: flex; flex-direction: column; justify-content: center; line-height: 1.1; overflow: hidden; }
        .ex-name {
            font-family: var(--font-num);
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--text-main);
            white-space: nowrap;
        }
        .ex-bonus {
            font-size: 0.55rem;
            color: var(--accent-yellow);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* GAME STYLES */
        .balance-badge { background: rgba(14, 203, 129, 0.15); border: 1px solid var(--accent-green); color: var(--accent-green); font-family: var(--font-num); font-weight: 700; padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; margin-right: 10px; }
        .rule-list { list-style: none; padding: 0; }
        .rule-list li { margin-bottom: 10px; padding-left: 20px; position: relative; color: #ddd; font-size: 0.9rem; }
        .rule-list li::before { content: '►'; position: absolute; left: 0; color: var(--brand); font-size: 0.7rem; top: 4px; }
        .admin-settle-box { background: rgba(246, 70, 93, 0.1); border: 1px dashed var(--accent-red); padding: 15px; border-radius: 8px; margin-top: 20px; width: 100%; }

        /* HERO & SORT BAR */
        .hero-banner { background: linear-gradient(180deg, rgba(0, 240, 255, 0.05) 0%, rgba(11, 14, 17, 0) 100%); border-bottom: 1px solid var(--border); padding: 40px 0 20px 0; margin-bottom: 30px; text-align: center; }
        .hero-title { font-family: var(--font-main); font-weight: 900; font-size: 2.2rem; letter-spacing: 1px; color: #fff; text-shadow: 0 0 20px rgba(0,240,255,0.3); margin-bottom: 10px; text-transform: uppercase; }
        .hero-sub { color: var(--text-sub); font-size: 1rem; max-width: 600px; margin: 0 auto; }
        .sort-select { background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; outline: none; transition: 0.3s; }
        .sort-select:hover, .sort-select:focus { border-color: var(--brand); box-shadow: 0 0 10px rgba(0,240,255,0.3); }

        /* CARD STYLES */
        .tour-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; position: relative;
            display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center center;
            z-index: 1;
            height: 100%;
        }


        .tour-card:hover { transform: translateY(-3px); border-color: #666; box-shadow: 0 8px 25px rgba(0,0,0,0.5); }

        /* --- CODE MỚI (V2): ZOOM CARD - CHUYÊN NGHIỆP HƠN --- */
        
        /* 1. Màn hình nền đen */
        #card-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px);
            z-index: 9998; display: none; opacity: 0; transition: opacity 0.3s ease;
        }
        #card-backdrop.show { display: block; opacity: 1; }

        /* 2. Thẻ bài khi phóng to (Fixed ra giữa màn hình) */
        .tour-card.active-card {
            position: fixed !important; 
            top: 50% !important; left: 50% !important;
            transform: translate(-50%, -50%) scale(1.15) !important;
            width: 100% !important; max-width: 380px !important;
            height: auto !important; max-height: 90vh !important;
            z-index: 9999 !important;
            margin: 0 !important;
            
            /* UPDATE 1: ĐỔ BÓNG CHUYÊN NGHIỆP (DEEP SHADOW) */
            /* Bóng đen sâu tạo độ nổi + Viền sáng cực nhẹ (0.2) tạo nét tinh tế */
            box-shadow: 
                0 25px 50px -12px rgba(0, 0, 0, 1), 
                0 0 0 1px rgba(0, 240, 255, 0.2) !important;
                
            border-color: rgba(0, 240, 255, 0.3) !important; /* Viền thẻ bớt gắt */
            background: #161a1e !important;
            overflow-y: auto !important; cursor: default !important;
        }

        /* UPDATE 2: XỬ LÝ THẺ ĐÃ KẾT THÚC (ENDED) KHI CLICK */
        /* Khi thẻ Ended được Active -> Trở về sáng rõ bình thường */
        .tour-card.ended-card.active-card {
            opacity: 1 !important;     /* Hết mờ */
            filter: none !important;   /* Hết trắng đen (có màu lại) */
            border-color: #444 !important; /* Viền xám nhẹ cho phân biệt với thẻ đang chạy */
        }

        /* Mobile: Không phóng to quá mức */
        @media (max-width: 768px) {
            .tour-card.active-card { width: 95% !important; transform: translate(-50%, -50%) scale(1) !important; }
        }

        /* 3. Ô trống thế thân (giữ khung không bị lệch) */
        .tour-card-placeholder {
            visibility: hidden; border: 1px dashed #333; border-radius: 10px; height: 100%; width: 100%;
        }

        /* 4. FIX LỖI KHOẢNG TRỐNG NÚT PREDICT */
        .tour-card {
            display: flex; flex-direction: column; height: 100%;
        }
        .card-list { flex: 1; }
        .card-actions {
            margin-top: auto;
            display: grid; grid-template-columns: 1fr;
            border-top: 1px solid var(--border); padding: 0;
        }
        .btn-card-action.predict { margin-bottom: 0 !important; border-bottom-left-radius: 9px; border-bottom-right-radius: 9px; }

        /* Các class cũ giữ nguyên */
        body.has-active-card .tour-card:not(.active-card) { opacity: 0; pointer-events: none; }
        
        /* Style mặc định cho thẻ Ended khi CHƯA click (nằm trong lưới) */
        .tour-card.ended-card { opacity: 0.6; filter: grayscale(0.8); border-color: #333; }


        
        .tour-card.ended-card { opacity: 0.6; filter: grayscale(0.8); border-color: #333; }
        .tour-card.highlight-x4 { border: 1px solid rgba(240, 185, 11, 0.8); box-shadow: 0 0 15px rgba(240, 185, 11, 0.15); }
        .tour-card.highlight-x2 { border: 1px solid rgba(14, 203, 129, 0.8); box-shadow: 0 0 15px rgba(14, 203, 129, 0.15); }

        .card-head { padding: 10px 15px; background: linear-gradient(to bottom, #20252b, #161a1e); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: relative; }
        .token-info-wrapper { display: flex; align-items: center; gap: 10px; }
        .token-logo { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #333; background: #000; transition: transform 0.2s, border-color 0.2s; cursor: pointer; }
        .token-logo:hover { transform: scale(1.15); border-color: var(--brand); box-shadow: 0 0 10px var(--brand); }
        .token-title { font-family: var(--font-num); font-weight: 800; font-size: 1.4rem; color: var(--text-main); line-height: 1; }
        .token-status { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

        .tag-x4, .tag-x2 { font-family: var(--font-num); font-size: 0.65rem; font-weight: 700; text-transform: uppercase; padding: 3px 8px; border-radius: 4px; letter-spacing: 0.5px; margin-left: 5px; transition: all 0.3s; }
        .tag-x4 { background: rgba(255, 215, 0, 0.1); color: var(--accent-yellow); border: 1px solid var(--accent-yellow); }
        .tag-x2 { background: rgba(14, 203, 129, 0.1); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .tag-expired { opacity: 0.3; filter: grayscale(1); border-color: #444 !important; color: #666 !important; background: transparent !important; }

        .x4-timer-box { font-family: var(--font-num); font-size: 0.75rem; color: var(--text-sub); font-weight: 600; display: flex; align-items: center; gap: 4px; margin-top: 2px; justify-content: flex-end;}
        .x4-timer-val { color: var(--accent-yellow); font-weight: 700; }

        .card-stats-grid { display: grid; grid-template-columns: 0.8fr 1.4fr 1fr; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .stat-cell { padding: 12px 5px; text-align: center; position: relative; display: flex; flex-direction: column; justify-content: center; }
        .stat-cell:not(:last-child)::after { content: ''; position: absolute; right: 0; top: 20%; height: 60%; width: 1px; background: #333; }
              
        /* 1. Style nhỏ cho trong thẻ bài (Card) */
        .card-stats-grid .stat-lbl { font-size: 0.6rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 3px; }
        .card-stats-grid .stat-val { font-family: var(--font-num); font-weight: 700; font-size: 1rem; color: var(--text-main); line-height: 1; }

        /* 2. Style to cho Hộp thống kê (Market Overview) */
        .stat-box .stat-lbl { font-size: 0.9rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .stat-box .stat-val { font-family: var(--font-num); font-weight: 700; font-size: 2.8rem; color: var(--text-main); line-height: 1; text-shadow: 0 0 20px rgba(0,0,0,0.5); }

        .card-list { padding: 10px 15px; flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .acc-item { display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; position: relative; padding: 2px 0; }
        .acc-info { display: flex; align-items: center; width: 25%; gap: 6px; color: var(--text-main); font-weight: 500; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; z-index: 2; }
        .acc-bar-bg { position: absolute; left: 0; bottom: 0; height: 2px; width: 100%; background: #222; border-radius: 2px; }
        .acc-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
        .acc-stats { text-align: right; font-family: var(--font-num); font-weight: 700; z-index: 2; display: flex; gap: 8px; align-items: center; justify-content: flex-end; flex: 1; }
        .acc-vol { color: #fff; font-size: 0.9rem; }
        .acc-gap { font-size: 0.75rem; padding: 1px 4px; border-radius: 3px; background: rgba(0,0,0,0.3); }
        .gap-pos { color: var(--accent-green); }
        .gap-neg { color: var(--accent-red); }

     /* Đổi từ 1fr 1fr thành 1fr để nút Update full chiều ngang */
.card-actions { display: grid; grid-template-columns: 1fr; border-top: 1px solid var(--border); }
        .btn-card-action { background: var(--bg-input); border: none; color: var(--text-sub); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; padding: 10px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-card-action:hover { background: #fff; color: #000; box-shadow: 0 0 15px rgba(255,255,255,0.7); z-index: 10; transform: translateY(-2px); }
        .btn-card-action.action-update { color: var(--accent-green); }
        .btn-card-action.action-update:hover { background: var(--accent-green); color: #000; box-shadow: 0 0 15px var(--accent-green); }
        /* Sửa đoạn này trong CSS */
.btn-card-action.predict { 
    color: #fff; 
    background: rgba(153, 69, 255, 0.15); 
    /* Bỏ border-left cũ đi nếu có */
    border-top: 1px solid var(--border); 
}

.btn-card-action.predict:hover { 
    background: var(--purple) !important; 
    color: #fff !important; 
    box-shadow: 0 0 20px rgba(153, 69, 255, 0.6); 
    text-shadow: 0 0 5px #fff; 
}

        .card-foot { padding: 8px 15px; background: var(--bg-input); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .tour-timer { display: flex; align-items: center; gap: 5px; }
        .tour-timer-label { font-size: 0.6rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
        .tour-timer-val { font-family: var(--font-num); font-weight: 700; font-size: 0.9rem; color: var(--text-main); }
        .btn-edit-foot { background: transparent; border: none; color: #444; font-size: 0.85rem; padding: 2px 10px; transition: 0.2s; cursor: pointer; }
        .btn-edit-foot:hover { color: var(--brand); transform: scale(1.1); }

        /* TERMINAL */
        .terminal-layout { display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; height: calc(100vh - 80px); padding: 0 20px 20px 20px; max-width:1600px; margin:0 auto; }
        .terminal-main { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .terminal-side { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .terminal-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }

        .hero-header { display: grid; grid-template-columns: 0.8fr 1.5fr 0.8fr; align-items: center; padding: 25px 30px; background: linear-gradient(90deg, #111 0%, #161616 100%); border: 1px solid var(--border); border-radius: 12px; gap: 20px; }
        .hh-left { display: flex; align-items: center; gap: 15px; }
        #pt-logo { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #444; object-fit: cover; transition:0.2s; cursor: pointer; }
        #pt-logo:hover { border-color: var(--brand); box-shadow: 0 0 15px var(--brand); transform: scale(1.05); }
        #pt-symbol { font-size: 2.2rem; line-height: 1; }
        .hh-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .big-vol { font-size: 5.5rem; font-weight: 800; font-family: var(--font-num); line-height: 1; color: #fff; text-shadow: 0 0 40px rgba(255,255,255,0.1); margin: 5px 0 15px 0; }

        .btn-predict-hero { background: linear-gradient(135deg, var(--purple), #7b2cbf); border: none; color: #fff; font-weight: 800; padding: 12px 50px; border-radius: 50px; font-size: 1.1rem; box-shadow: 0 0 20px rgba(153, 69, 255, 0.4); transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-predict-hero:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(153, 69, 255, 0.6); }
        .btn-ended { background: #333 !important; color: #888 !important; border: 1px solid #444 !important; box-shadow: none !important; cursor: not-allowed; opacity: 0.8; }
        .btn-ended:hover { transform: none !important; }

        .hh-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 15px; }
        .header-stat-lbl { font-size: 0.7rem; color: var(--text-sub); font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; }
        .p-tabs { display: flex; border-bottom: 1px solid var(--border); background: #111; }
        .p-tab { padding: 12px 20px; color: var(--text-sub); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.2s; font-size: 0.85rem; }
        .p-tab:hover { color: #fff; }
        .p-tab.active { color: var(--brand); border-bottom-color: var(--brand); background: rgba(0,240,255,0.05); }
        .feed-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { max-width: 85%; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; line-height: 1.4; color: #ddd; display: flex; flex-direction: column; }
        .chat-me { align-self: flex-end; background: rgba(157, 78, 221, 0.2); border: 1px solid var(--purple); }
        .chat-other { align-self: flex-start; background: #222; border: 1px solid #333; }
        .chat-row { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 5px; }
        .chat-row.me { flex-direction: row-reverse; }

        .leaderboard-table th { padding: 10px; text-align: left; color: var(--text-sub); font-size: 0.7rem; }
        .leaderboard-table td { padding: 8px 10px; border-bottom: 1px solid #222; vertical-align: middle; }
        .rank-badge { width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.7rem; font-weight: bold; background: #333; color: #aaa; margin-right: 5px; }
        .rank-1 { background: #FFD700; color: #000; box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
        .rank-2 { background: #C0C0C0; color: #000; }
        .rank-3 { background: #CD7F32; color: #000; }

        /* FOOTER */
        .app-footer { background: var(--bg-header); border-top: 1px solid var(--border); padding: 30px 0; margin-top: auto; }
        .footer-socials { display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; }
        .social-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-input); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--text-sub); transition: 0.2s; text-decoration: none; }
        .social-btn:hover { color: #fff; border-color: var(--brand); transform: translateY(-3px); box-shadow: 0 0 10px var(--brand); }
        .footer-copy { color: var(--text-sub); font-size: 0.8rem; text-align: center; }

        /* MODALS & UTILS */
        .modal-content { background: #1e2329; border: 1px solid var(--border); box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .form-control, .form-select { background: var(--bg-input); border: 1px solid var(--border); color: #fff; }
        .form-control:focus { border-color: var(--brand); background: #2b3139; color:#fff; box-shadow:none; }
        .form-control:disabled { background: #111; color: #555; }
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, input:-webkit-autofill:active { -webkit-box-shadow: 0 0 0 30px var(--bg-input) inset !important; -webkit-text-fill-color: white !important; }
        .btn-action { background: var(--brand); color: #000; font-weight: 800; border: none; padding: 10px; width: 100%; border-radius: 4px; text-transform: uppercase; transition: 0.2s; }
        .btn-action:hover { background: #fff; box-shadow: 0 0 15px var(--brand); }
        .acc-input-row { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px; border: 1px solid transparent; }
        .acc-input-row:hover { border-color: #333; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b0e11; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }
        .back-btn { color: #fff; border: 1px solid #444; padding: 8px 20px; border-radius: 30px; font-weight: 600; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; background:rgba(255,255,255,0.05); }
        .back-btn:hover { background: #fff; color: #000; border-color: #fff; box-shadow: 0 0 10px #fff; }
        @media (max-width: 1200px) {
            .terminal-layout { grid-template-columns: 1fr; height: auto; display: block; }
            .hero-header { grid-template-columns: 1fr; text-align: center; gap: 20px; padding: 20px; }
            .hh-left, .hh-right { justify-content: center; align-items: center; width: 100%; }
            .btn-predict-hero { width: 100%; }
        }
        .anim-breathe { animation: breathe 3s infinite ease-in-out; }
        @keyframes breathe { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        #legalModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .legal-box { width: 90%; max-width: 500px; background: #161a1e; border: 1px solid var(--brand); border-radius: 10px; padding: 30px; text-align: center; box-shadow: 0 0 50px rgba(0,240,255,0.2); }
        .legal-title { color: var(--brand); font-family: var(--font-num); font-weight: 800; font-size: 1.8rem; margin-bottom: 20px; letter-spacing: 1px; }
        .legal-text { color: #ddd; font-size: 0.9rem; line-height: 1.6; text-align: left; margin-bottom: 25px; max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; border: 1px solid #333; }
        .btn-legal { background: var(--brand); color: #000; font-weight: 800; padding: 12px 30px; border: none; border-radius: 30px; text-transform: uppercase; transition: 0.3s; width: 100%; }
        .btn-legal:hover { transform: scale(1.05); background: #fff; box-shadow: 0 0 20px var(--brand); }

        .cursor-pointer { cursor: pointer; }

        /* AVATAR STYLES */
        .user-avatar-sm { width:24px; height:24px; border-radius:50%; object-fit:cover; border:1px solid var(--brand); margin-right:5px; }
        .profile-btn-area { display: flex; align-items: center; cursor: pointer; padding: 5px 10px; border-radius: 20px; transition:0.2s; border: 1px solid transparent;}
        .profile-btn-area:hover { background: rgba(255,255,255,0.1); border-color:#444; }
        .avatar-upload-box { position: relative; width: 100px; height: 100px; margin: 0 auto 20px; border-radius: 50%; overflow: hidden; border: 2px dashed #444; cursor: pointer; background: #111; transition: 0.2s; }
        .avatar-upload-box:hover { border-color: var(--brand); }
        .avatar-upload-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .upload-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #666; font-size: 0.8rem; pointer-events: none; }
        #file-input { display: none; }

        /* New Avatar Classes */
        .list-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; margin-right: 8px; border: 1px solid #444; vertical-align: middle; }
        .chat-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #444; margin-bottom: 5px; flex-shrink: 0; }
        .act-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--brand); margin-right: 10px; flex-shrink: 0; }
        .list-avatar-placeholder { width: 28px; height: 28px; border-radius: 50%; background: #333; color: #aaa; display: inline-flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; margin-right: 8px; vertical-align: middle; }
        .chat-avatar-placeholder { width: 32px; height: 32px; border-radius: 50%; background: #333; color: #aaa; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; flex-shrink: 0; }

        /* --- V45 SHARE CARD STYLES (REDESIGNED) --- */
        #share-card-container {
            width: 100%; max-width: 400px; margin: 0 auto;
            background: #0b0e11;
            background-image:
                linear-gradient(rgba(0, 240, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            border: 1px solid var(--border); border-radius: 16px;
            padding: 25px; text-align: center; position: relative; overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }
        /* Top Border Accent */
        #share-card-container::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--brand), var(--purple));
        }

        .sc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .sc-logo-text { font-family: var(--font-num); font-weight: 800; font-size: 1.4rem; color: #fff; letter-spacing: 1px; }
        .sc-logo-text span { color: var(--brand); }
        .sc-date { font-family: var(--font-num); font-size: 0.85rem; color: var(--text-sub); font-weight: 600; text-transform: uppercase; }

        .sc-main { position: relative; z-index: 2; margin-bottom: 25px; }
        .sc-token-row { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .sc-token-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--brand); box-shadow: 0 0 15px rgba(0,240,255,0.3); }
        .sc-token-name { font-size: 2.2rem; font-weight: 800; font-family: var(--font-num); color: #fff; line-height: 1; text-shadow: 0 0 20px rgba(255,255,255,0.2); }

        .sc-stat-box {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px;
            display: grid; grid-template-columns: 1fr 1px 1fr; align-items: center;
        }
        .sc-divider { height: 40px; background: rgba(255,255,255,0.1); }

        .sc-stat-label { font-size: 0.65rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 5px; font-weight: 700; }
        .sc-stat-val { font-size: 1.5rem; font-weight: 700; font-family: var(--font-num); color: #fff; }
        .sc-stat-val.gold { color: var(--accent-yellow); text-shadow: 0 0 10px rgba(240, 185, 11, 0.4); }
        .sc-stat-val.brand { color: var(--brand); }

        .sc-footer {
            display: flex; align-items: center; justify-content: space-between;
            background: linear-gradient(90deg, rgba(0,240,255,0.1), transparent);
            padding: 12px 15px; border-radius: 8px; border: 1px solid rgba(0,240,255,0.2);
        }
        .sc-qr-box { background: #fff; padding: 4px; border-radius: 4px; height: 58px; width: 58px; display: flex; align-items: center; justify-content: center; }
        .sc-ref-text { text-align: left; font-size: 0.75rem; color: #ddd; line-height: 1.3; font-weight: 500; }
        .sc-web-link {
            font-family: var(--font-num); font-weight: 800; color: var(--brand);
            font-size: 0.9rem; margin-top: 3px; letter-spacing: 0.5px;
        }

        /* V45 FIX: Style cho User Profile trên thẻ Share */
        .sc-user-box {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            margin-bottom: 15px; padding-bottom: 15px;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
        }
        .sc-user-avatar {
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--text-sub);
        }
        .sc-user-info { text-align: left; }
        .sc-user-label { font-size: 0.6rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        .sc-user-name {
            font-family: var(--font-num); font-weight: 800; font-size: 1.2rem; color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.1);
        }

        /* V45 UX POLISH: TOAST NOTIFICATIONS (Thay thế Alert xấu xí) */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast-item {
            background: rgba(16, 20, 24, 0.95); border: 1px solid var(--border); border-left: 4px solid var(--brand);
            color: #fff; padding: 15px 20px; border-radius: 4px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            min-width: 300px; backdrop-filter: blur(10px);
        }
        .toast-success { border-left-color: var(--accent-green); }
        .toast-error { border-left-color: var(--accent-red); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        /* --- [STYLE MỚI] GIAO DIỆN TAG NHỎ GỌN (SLIM PILL) --- */
        .rule-pill {
            font-family: var(--font-num);
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 2px;
            cursor: help;
            transition: all 0.2s;
            border: 1px solid transparent;
            line-height: 1.1;
            width: fit-content;
        }
        .rule-pill:hover { filter: brightness(1.2); transform: translateY(-1px); }

        /* ONLY BUY: Màu xanh nhẹ */
        .rp-buy {
            border-color: rgba(14, 203, 129, 0.4);
            color: #0ECB81;
            background: rgba(14, 203, 129, 0.05);
        }

        /* ALL VOL x4: Màu tím huyền bí */
        .rp-x4 {
            border-color: rgba(153, 69, 255, 0.5);
            color: #d0aaff;
            background: rgba(153, 69, 255, 0.05);
        }

        /* Ô vuông nhỏ bao quanh chữ x4 */
        .x4-box {
            background: #9945FF;
            color: #fff;
            padding: 1px 3px;
            border-radius: 2px;
            font-size: 0.55rem;
            font-weight: 800;
        }

        /* Sắp xếp cột bên phải */
        .card-head-right {
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 3px;
        }
        /* --- STYLE CHO THẺ KẾT QUẢ (WIN/LOSE) --- */
        .res-badge {
            font-family: var(--font-num);
            font-size: 0.65rem;
            font-weight: 800;
            padding: 1px 6px;
            border-radius: 3px;
            margin-left: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            min-width: 45px;
            justify-content: center;
        }
        /* Thẻ Thắng: Vàng rực + Bóng sáng */
        .res-win {
            background: #F0B90B;
            color: #000;
            box-shadow: 0 0 8px rgba(240, 185, 11, 0.4);
        }
        /* Thẻ Thua: Xám tối + Viền mờ */
        .res-lose {
            background: #2b3139;
            color: #666;
            border: 1px solid #444;
        }
        /* Thêm vào cuối phần <style> */
        .text-silver { color: #C0C0C0 !important; text-shadow: 0 0 10px rgba(192, 192, 192, 0.4); }
        .text-bronze { color: #CD7F32 !important; text-shadow: 0 0 10px rgba(205, 127, 50, 0.4); }



        /* --- ADMIN DRAG & DROP (FIXED ORDER) --- */

        /* Hiệu ứng khi đang kéo */
        .tour-card.dragging {
            opacity: 0.5;
            border: 2px dashed var(--brand);
            transform: scale(0.95);
            z-index: 1000;
        }

        /* Icon tay cầm (Grip) - Mặc định ẩn */
        .admin-drag-handle {
            display: none;
            color: var(--text-sub);
            margin-right: 8px;
            font-size: 1.1rem;
            cursor: grab;
            transition: 0.2s;
        }

        /* Admin thì LUÔN LUÔN nhìn thấy tay cầm và kéo được */
        body.is-admin .admin-drag-handle { display: inline-block; }
        body.is-admin .admin-drag-handle:hover { color: var(--brand); }
        body.is-admin .tour-card { cursor: grab; }
        body.is-admin .tour-card:active { cursor: grabbing; }
        
        /* --- BẮT ĐẦU: MARKET HEALTH CSS (MỚI) --- */
.health-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 2px;
    padding: 8px 10px;
    background: rgba(0,0,0,0.3);
    border-bottom: 1px solid var(--border);
    margin-bottom: 0;
}
.h-item { text-align: center; display: flex; flex-direction: column; justify-content: center; border-right: 1px solid rgba(255,255,255,0.05); }
.h-item:last-child { border-right: none; }
.h-lbl { font-size: 0.55rem; color: var(--text-sub); text-transform: uppercase; font-weight: 700; margin-bottom: 3px; }
.h-val { font-family: var(--font-num); font-size: 0.9rem; font-weight: 700; line-height: 1; }

/* Hiệu ứng huy hiệu ROCKET */
.rocket-badge {
    position: absolute; top: -12px; right: 50px;
    background: var(--brand); color: #000;
    font-size: 0.65rem; font-weight: 800; font-family: var(--font-num);
    padding: 2px 8px; border-radius: 10px;
    box-shadow: 0 0 10px var(--brand);
    z-index: 5;
    animation: rocketPulse 2s infinite;
    border: 2px solid #fff;
}
@keyframes rocketPulse {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 240, 255, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(0, 240, 255, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 240, 255, 0); }
}
.tour-card.card-perfect {
    border: 1px solid var(--brand) !important;
    box-shadow: 0 0 25px rgba(0, 240, 255, 0.2) !important;
}
/* --- KẾT THÚC: MARKET HEALTH CSS --- */
        
        /* =============================================
   START: MARKET HEALTH V50 (GIAO DIỆN & BADGE) 
   ============================================= */

/* 1. KHUNG GIAO DIỆN (MỚI) */
.health-panel {
    background: #111418;
    border: 1px solid #2a2e35;
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 30px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
}

.health-header {
    padding: 15px 20px;
    background: linear-gradient(90deg, rgba(22,26,30,1) 0%, rgba(32,36,40,1) 100%);
    border-bottom: 1px solid #2a2e35;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

/* 2. BẢNG DỮ LIỆU (MỚI) */
.health-table th {
    background: #1a1e23;
    color: #848e9c;
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 12px 15px;
    border-bottom: 2px solid #2a2e35;
    white-space: nowrap;
}

.health-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #1e2329;
    font-size: 0.9rem;
    vertical-align: middle;
}

/* Highlight cột Avg 10s */
.col-highlight {
    background: rgba(0, 240, 255, 0.02); 
    border-left: 1px solid #2a2e35;
    border-right: 1px solid #2a2e35;
}

/* 3. CÁC HUY HIỆU TRẠNG THÁI (BADGES - GIỮ LẠI ĐỂ TÔ MÀU) */
.health-badge { 
    font-size: 0.65rem; font-weight: 800; padding: 4px 10px; border-radius: 4px; 
    text-transform: uppercase; letter-spacing: 1px; display: inline-block; min-width: 80px; text-align: center;
}
.hb-hot { background: rgba(246, 70, 93, 0.15); color: #F6465D; border: 1px solid #F6465D; box-shadow: 0 0 10px rgba(246, 70, 93, 0.2); }
.hb-moon { background: rgba(14, 203, 129, 0.15); color: #0ECB81; border: 1px solid #0ECB81; box-shadow: 0 0 10px rgba(14, 203, 129, 0.2); }
.hb-dead { background: #222; color: #666; border: 1px solid #444; }
.hb-normal { background: rgba(0, 240, 255, 0.1); color: var(--brand); border: 1px solid var(--brand); }

/* 4. KHUNG HƯỚNG DẪN & DISCLAIMER (MỚI) */
.guide-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    padding: 20px;
    background: #0b0e11;
}

.guide-item {
    font-size: 0.8rem;
    color: #b7bdc6;
    line-height: 1.6;
}

.guide-title {
    color: var(--brand);
    font-family: var(--font-num);
    font-weight: 700;
    font-size: 0.9rem;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.disclaimer-box {
    margin-top: 15px;
    padding: 12px;
    background: rgba(246, 70, 93, 0.05);
    border: 1px dashed rgba(246, 70, 93, 0.3);
    border-radius: 6px;
    color: #888;
    font-size: 0.7rem;
    text-align: center;
    font-style: italic;
}

.tooltip-inner { max-width: 300px; text-align: left; }

@media (max-width: 992px) {
    .guide-grid { grid-template-columns: 1fr; }
}
/* =============================================
   END: MARKET HEALTH V50
   ============================================= */
        
        /* --- BẮT ĐẦU: GIAO DIỆN LỊCH MỚI (FIXED STYLE) --- */
    .timeline-wrapper {
        margin-bottom: 30px;
        position: relative;
    }
    
    /* Thanh cuộn ngang ẩn nhưng vẫn vuốt được */
    .timeline-scroll {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding: 20px 2px 15px 2px; /* Padding để không bị cắt bóng đổ */
        scrollbar-width: none; /* Firefox */
        -webkit-overflow-scrolling: touch;
    }
    .timeline-scroll::-webkit-scrollbar { display: none; } /* Chrome/Safari */

    /* Ô ngày: Thiết kế khối hộp nổi */
    .date-box {
        flex: 0 0 auto; /* Không cho co giãn */
        width: 75px;
        height: 85px;
        background: #161a1e; /* Màu nền trùng màu thẻ bài */
        border: 1px solid #353a42;
        border-radius: 8px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }

    /* Hiệu ứng khi di chuột */
    .date-box:hover {
        transform: translateY(-5px);
        border-color: var(--text-sub);
        background: #2b3139;
    }

    /* Trạng thái ĐANG CHỌN (Active) */
    .date-box.active {
        background: rgba(0, 240, 255, 0.1); /* Xanh neon nhạt */
        border: 1px solid var(--brand);
        box-shadow: 0 0 15px rgba(0, 240, 255, 0.3); /* Phát sáng */
    }

    /* Chữ Thứ (MON, TUE...) */
    .date-box .d-name {
        font-size: 0.7rem;
        color: #848e9c;
        font-weight: 700;
        text-transform: uppercase;
        margin-bottom: 4px;
    }
    .date-box.active .d-name { color: var(--brand); }

    /* Số Ngày (12, 13...) */
    .date-box .d-num {
        font-family: var(--font-num); /* Font số chuyên dụng */
        font-size: 1.6rem;
        color: #fff;
        font-weight: 700;
        line-height: 1;
    }

    /* CHẤM SỐ LƯỢNG GIẢI (ĐÃ FIX HIỆN LÊN) */
    .date-dot {
        position: absolute;
        top: -6px; right: -6px; /* Đẩy ra góc ngoài một chút cho đẹp */
        min-width: 20px; height: 20px; /* Đủ rộng để chứa số */
        background: var(--accent-yellow);
        color: #000; /* Chữ màu đen cho nổi trên nền vàng */
        border-radius: 50%;
        font-family: var(--font-num);
        font-size: 0.7rem; font-weight: 800;
        display: flex; align-items: center; justify-content: center; /* Căn giữa số */
        box-shadow: 0 0 8px rgba(240, 185, 11, 0.8);
        border: 2px solid var(--bg-body); /* Tạo viền cắt với nền */
        z-index: 5;
        animation: bounceBadge 2s infinite; /* Hiệu ứng nhún nhảy cho dễ thấy */
    }
    
    @keyframes bounceBadge { 
        0%, 100% { transform: translateY(0); } 
        50% { transform: translateY(-3px); } 
    }
    /* HIỂN THỊ SỐ TIỀN TRONG LỊCH */
    .d-val {
        font-family: var(--font-num);
        font-size: 0.75rem;
        font-weight: 700;
        color: #0ECB81; /* Màu xanh lá tiền tài */
        background: rgba(14, 203, 129, 0.15);
        padding: 1px 6px;
        border-radius: 4px;
        line-height: 1;
        white-space: nowrap;
        min-width: 45px; text-align: center;
        margin-top: 4px; /* Cách số ngày ra một chút */
    }
    .date-dot.has-event { display: block; }
    /* --- KẾT THÚC: GIAO DIỆN LỊCH MỚI --- */
        
   /* --- V4: NEON COMMAND CENTER THEME --- */

/* 1. Layout tổng */
.neo-wrapper {
    width: 100%;
    /* SỬA QUAN TRỌNG: Dùng dvh để tự co lại khi có thanh công cụ */
    height: 100dvh; 
    /* Fallback cho trình duyệt cũ */
    min-height: -webkit-fill-available;
    
    background: radial-gradient(circle at 50% 50%, #1a1e23 0%, #0b0e11 100%);
    
    /* TĂNG PADDING ĐÁY: Để nội dung không bị sát mép dưới */
    padding: 80px 20px 50px 20px; /* Top - Right - Bottom (50px) - Left */
    
    position: fixed; top: 0; left: 0; z-index: 2000;
    display: grid;
    grid-template-columns: 320px 1fr 350px;
    grid-template-rows: 1fr; /* Đảm bảo chỉ có 1 hàng, nội dung tự co giãn bên trong */
    gap: 20px;
    font-family: var(--font-main);
    overflow: hidden;
}

/* 2. Hiệu ứng nền lưới */
.grid-overlay {
    position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background-image: 
        linear-gradient(rgba(0, 240, 255, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 240, 255, 0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none; z-index: -1;
}

/* 3. Thẻ kính (Glass Card) */
.glass-card {
    background: rgba(22, 26, 30, 0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    display: flex; flex-direction: column;
    overflow: hidden;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    transition: transform 0.3s ease;
}

/* Header của từng thẻ */
.glass-head {
    padding: 15px 20px;
    background: rgba(255, 255, 255, 0.02);
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    font-size: 0.75rem; font-weight: 800; color: var(--text-sub);
    text-transform: uppercase; letter-spacing: 1.5px;
    display: flex; justify-content: space-between; align-items: center;
}

/* --- CỘT TRÁI: DATA --- */
.stat-highlight {
    padding: 25px 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.05);
    position: relative;
}
.stat-label { font-size: 0.7rem; color: var(--text-sub); letter-spacing: 1px; margin-bottom: 5px; font-weight: 700; }
.stat-val-mega {
    font-family: var(--font-num); font-size: 2.8rem; font-weight: 800; color: #fff;
    text-shadow: 0 0 20px rgba(0, 240, 255, 0.4); line-height: 1;
}
.stat-val-sub { font-family: var(--font-num); font-size: 1.8rem; font-weight: 700; color: var(--accent-green); }

/* Nút bấm Neon (Cyber Button) */
.btn-cyber {
    margin: 20px;
    background: transparent;
    border: 1px solid var(--brand);
    color: var(--brand);
    padding: 15px;
    font-weight: 800; font-size: 1rem; letter-spacing: 2px;
    text-transform: uppercase;
    position: relative; overflow: hidden;
    cursor: pointer; transition: 0.3s;
    box-shadow: 0 0 10px rgba(0, 240, 255, 0.1);
}
.btn-cyber::before {
    content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(0, 240, 255, 0.2), transparent);
    transition: 0.5s;
}
.btn-cyber:hover {
    background: var(--brand); color: #000; box-shadow: 0 0 30px var(--brand);
}
.btn-cyber:hover::before { left: 100%; }
.btn-cyber:disabled { border-color: #555; color: #555; cursor: not-allowed; box-shadow: none; background: transparent; }

/* Các nút công cụ nhỏ */
.tools-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 0 20px; }
.btn-tool-glass {
    background: rgba(255,255,255,0.05); border: none; color: #aaa; padding: 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; transition: 0.2s;
}
.btn-tool-glass:hover { background: #fff; color: #000; }

/* --- CỘT GIỮA: CHART --- */
.chart-wrapper { flex: 1; width: 100%; position: relative; min-height: 0; padding: 10px; }
.token-badge {
    display: flex; align-items: center; gap: 10px;
    background: rgba(0,0,0,0.3); padding: 8px 15px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1);
}

/* --- CỘT PHẢI: SOCIAL --- */
.tab-capsule {
    display: flex; background: rgba(0,0,0,0.3); margin: 15px; padding: 4px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1);
}
.tab-pill {
    flex: 1; text-align: center; padding: 8px; font-size: 0.75rem; font-weight: 700; color: #888; cursor: pointer; border-radius: 20px; transition: 0.3s;
}
.tab-pill.active { background: var(--brand); color: #000; box-shadow: 0 0 15px rgba(0, 240, 255, 0.3); }

/* Chat & List Style */
.neo-list { flex: 1; overflow-y: auto; padding: 0 15px 15px 15px; }
.neo-list::-webkit-scrollbar { width: 4px; }
.neo-list::-webkit-scrollbar-thumb { background: #444; border-radius: 2px; }

.chat-bubble-v2 {
    background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.05);
    padding: 8px 12px; border-radius: 12px; font-size: 0.85rem; color: #ddd; margin-bottom: 8px;
}
.chat-bubble-v2.me { background: rgba(153, 69, 255, 0.15); border-color: var(--purple); color: #fff; text-align: right; }

/* --- FIX MODAL & RESPONSIVE --- */
.modal { z-index: 3000 !important; }
.modal-backdrop { z-index: 2900 !important; }
@media (max-width: 1200px) {
    .neo-wrapper { display: block; overflow-y: auto; padding-bottom: 80px; height: auto; position: absolute; }
    .glass-card { margin-bottom: 20px; min-height: 400px; }
    .btn-cyber { position: fixed; bottom: 0; left: 0; width: 100%; margin: 0; z-index: 2050; background: #000; border-top: 1px solid var(--brand); }
}

/* --- FIX LỖI Z-INDEX (QUAN TRỌNG) --- */
/* Đẩy Modal lên cao hơn giao diện Cockpit (đang là 2000) */
.modal { z-index: 3000 !important; }
.modal-backdrop { z-index: 2900 !important; }

/* FIX LỖI HIỂN THỊ CHAT */
/* Đảm bảo khung chat hiển thị đúng kiểu Flex khi được kích hoạt */
.chat-visible {
    display: flex !important;
}
.hide-force {
    display: none !important;
}

/* --- FIX CHO TABLET & MÀN HÌNH THẤP (Landscapes) --- */
@media (max-height: 800px) {
    .neo-wrapper {
        padding-top: 60px; /* Giảm khoảng cách bên trên */
        padding-bottom: 70px; /* Tăng khoảng cách an toàn bên dưới */
    }

    /* Thu nhỏ font chữ tiêu đề để tiết kiệm diện tích dọc */
    .stat-val-mega { font-size: 2.2rem; }
    .stat-val-sub { font-size: 1.5rem; }
    
    /* Thu nhỏ padding trong các thẻ */
    .stat-highlight { padding: 15px 10px; }
    .btn-cyber { padding: 12px; margin: 10px 20px; }
    
    /* Đảm bảo khung Chat và Leaderboard luôn nằm trong khung nhìn */
    .glass-card {
        height: 100%; 
        max-height: 100%;
    }
}

/* --- FIX RIÊNG CHO MOBILE & TABLET DỌC (Chuyển sang chế độ cuộn) --- */
@media (max-width: 1024px) {
    .neo-wrapper {
        display: flex;
        flex-direction: column;
        height: auto; 
        min-height: 100dvh;
        position: absolute; /* Bỏ fixed để cho phép cuộn trang */
        overflow-y: auto;
        padding-bottom: 100px; /* Khoảng trống lớn dưới cùng để né nút Home */
    }
    
    .glass-card {
        min-height: 450px; /* Đặt chiều cao tối thiểu cho mỗi thẻ */
        flex-shrink: 0;
    }
    
    /* Ghim nút Predict xuống đáy màn hình điện thoại (nếu muốn) */
    /* Hoặc để nó trôi theo nội dung (an toàn hơn) */
    .btn-cyber {
        position: relative; 
        margin-top: auto;
    }
}

/* Hiệu ứng nút Predict trên Card */
.btn-card-action.predict:hover {
    transform: translateY(-2px);
    box-shadow: 0 0 25px var(--brand);
    filter: brightness(1.1);
}

/* Hiệu ứng nút Update */
.btn-card-action.action-update:hover {
    background: #333 !important;
    color: #fff !important;
    border-color: #fff !important;
}

/* --- V50: MINI CHART TRONG THẺ BÀI --- */
.mini-chart-box {
    position: relative;
    height: 110px; /* Chiều cao vừa đủ đẹp */
    width: 100%;
    background: rgba(0,0,0,0.2);
    border-radius: 6px;
    padding: 5px;
    margin-bottom: 5px;
}
.chart-legend {
    display: flex;
    justify-content: space-between;
    padding: 0 5px;
    margin-bottom: 5px;
}
.legend-item {
    font-size: 0.6rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 4px;
    color: var(--text-sub);
}
.dot { width: 6px; height: 6px; border-radius: 50%; }

/* --- V55 FINAL: NEW CARD LAYOUT CSS --- */

/* 1. Khung Chart & Info */
.mini-chart-wrapper {
    background: rgba(0,0,0,0.2);
    border-radius: 8px;
    padding: 10px 5px 0 5px; /* Padding bottom = 0 để nối liền với lưới info */
    border: 1px solid rgba(255,255,255,0.05);
    margin-bottom: 0; /* Dính liền với phần dưới */
    border-bottom: none;
    border-bottom-left-radius: 0;
    border-bottom-right-radius: 0;
}

/* --- V57 FINAL STYLE --- */

/* 1. Lưới Acc Info (Auto Fit & Căn giữa) */
.acc-stats-grid {
    display: grid;
    /* Tự động chia cột, tối thiểu 30% chiều rộng */
    grid-template-columns: repeat(auto-fit, minmax(30%, 1fr));
    gap: 1px;
    background: rgba(255,255,255,0.05); /* Đường kẻ */
    border: 1px solid rgba(255,255,255,0.05);
    border-top: none; /* Dính liền với chart */
    border-bottom-left-radius: 8px;
    border-bottom-right-radius: 8px;
    overflow: hidden;
    margin-bottom: 15px;
}

.as-item {
    background: rgba(20, 24, 28, 0.9); /* Màu nền đậm hơn chút */
    padding: 10px 5px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
}

.as-head { font-size: 0.6rem; color: var(--text-sub); display: flex; align-items: center; gap: 4px; margin-bottom: 4px; }
.as-vol { font-family: var(--font-num); font-size: 1rem; font-weight: 700; color: #fff; line-height: 1; }
.as-gap { font-family: var(--font-num); font-size: 0.75rem; font-weight: 700; margin-top: 3px; }

/* 2. Market Bar (Căn chỉnh thẳng hàng) */
.market-bar {
    display: flex;
    justify-content: space-between;
    align-items: flex-end; /* Căn đáy */
    padding: 10px 15px;
    background: #111;
    border-top: 1px solid var(--border);
}
.mb-item { display: flex; flex-direction: column; gap: 4px; }
.mb-label { font-size: 0.55rem; color: #666; text-transform: uppercase; font-weight: 700; display: flex; align-items: center; gap: 4px; height: 14px; }
.mb-val { font-family: var(--font-num); font-size: 1.1rem; font-weight: 700; line-height: 1; height: 20px; display: flex; align-items: center; }

/* 3. Nút Predict (Xanh Alpha) */
.btn-card-action.predict {
    width: 100%;
    border: none;
    padding: 12px;
    font-size: 0.95rem;
    font-weight: 700;
    font-family: var(--font-main) !important;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    background: linear-gradient(90deg, rgba(0, 240, 255, 0.1), rgba(0, 240, 255, 0.2)); 
    border-top: 1px solid rgba(0, 240, 255, 0.3);
    color: var(--brand);
    transition: 0.3s;
}
.btn-card-action.predict:hover {
    background: var(--brand) !important;
    color: #000 !important;
    box-shadow: 0 0 20px rgba(0, 240, 255, 0.6);
}

/* 4. Timer bên phải Header */
.card-head-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    justify-content: center;
    gap: 2px;
}
.tag-timer {
    font-family: var(--font-num);
    font-size: 0.75rem;
    font-weight: 700;
    color: #ccc;
    margin-top: 2px;
    letter-spacing: 0.5px;
}

/* --- V58 FIX: DUAL TIMERS STYLE --- */

/* 1. Đồng hồ kết thúc giải (Bên Trái - Dưới Status) */
.tour-end-timer {
    font-size: 0.7rem; 
    color: #ccc; 
    display: flex; 
    align-items: center; 
    gap: 4px; 
    margin-top: 2px;
    font-weight: 600;
}

/* 2. Đồng hồ hạn X4/X2 (Bên Phải - Dưới Tag) */
.promo-timer {
    font-family: var(--font-num);
    font-size: 0.7rem;
    font-weight: 700;
    margin-top: 1px;
    letter-spacing: 0.5px;
    /* Mặc định màu vàng cam cho giống khuyến mãi */
    color: var(--accent-yellow); 
    text-shadow: 0 0 5px rgba(0,0,0,0.5);
}

/* --- FEEDBACK & COMMUNITY STYLES (REFINED) --- */

/* 1. Nút Telegram "Tinh Tế" (Glass Style) */
.fab-telegram {
    position: fixed; 
    bottom: 25px; 
    right: 25px;
    width: 48px; height: 48px; /* Nhỏ gọn hơn (Cũ là 60px) */
    
    /* Hiệu ứng kính mờ sang trọng */
    background: rgba(0, 136, 204, 0.2);
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    border: 1px solid rgba(0, 136, 204, 0.5);
    
    border-radius: 50%; 
    display: flex; align-items: center; justify-content: center;
    color: #0088cc; /* Màu logo Tele gốc */
    font-size: 1.4rem;
    z-index: 9990; 
    cursor: pointer; 
    transition: all 0.3s ease;
    box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* Hover vào mới sáng lên và nổi bật */
.fab-telegram:hover { 
    transform: translateY(-3px);
    background: #0088cc; 
    color: #fff;
    box-shadow: 0 0 20px rgba(0, 136, 204, 0.6);
    border-color: #fff;
}

/* Badge thông báo nhỏ xíu (Dấu chấm đỏ) */
.fab-dot {
    position: absolute; top: 10px; right: 10px;
    width: 8px; height: 8px;
    background: #F6465D;
    border-radius: 50%;
    box-shadow: 0 0 5px #F6465D;
}

/* 2. Style cho Modal Form */
.feedback-type-btn {
    flex: 1; padding: 10px; border: 1px solid var(--border);
    background: var(--bg-input); color: var(--text-sub);
    border-radius: 8px; font-size: 0.85rem; font-weight: 700;
    transition: 0.2s;
}
.feedback-type-btn.active {
    border-color: var(--brand); background: rgba(0, 240, 255, 0.1); color: #fff;
}

    </style>
</head>
<body>

<div id="toast-container"></div>
<div id="card-backdrop" onclick="closeActiveCard()"></div>

<audio id="sfx-click" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>
<audio id="sfx-hover" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

<div id="loading-overlay">
    <div class="spinner mb-3"></div>
    <div class="text-brand font-num fw-bold letter-spacing-1">SYSTEM LOADING...</div>
</div>

<div id="legalModal">
    <div class="legal-box">
        <div class="legal-title"><i class="fas fa-shield-alt me-2"></i> DISCLAIMER</div>
        <div class="legal-text"><strong>Welcome to Wave Alpha Terminal.</strong><br><br>1. <strong>Not Financial Advice:</strong> All content, data, and predictions provided herein are for informational and entertainment purposes only.<br>2. <strong>No Real Money:</strong> This is a simulation tracking tool. We do not accept deposits or facilitate real-money gambling.<br>3. <strong>Risk Warning:</strong> Cryptocurrency trading involves significant risk. You are solely responsible for your investment decisions.<br><br>By clicking "I AGREE", you acknowledge that you have read and understood these terms.</div>
        <button class="btn-legal" onclick="acceptLegal(); playSfx('click')">I AGREE & ENTER</button>
    </div>
</div>

<nav class="navbar">
    <div class="container">
        <div class="d-flex align-items-center gap-4">
            <a onclick="playSfx('click'); switchView('dashboard')" class="brand-logo d-flex align-items-center gap-2" style="text-decoration:none">
                <img id="nav-brand-img" src="" style="height:50px; display:none; border-radius:4px;">
                <div id="nav-brand-text">WAVE<span>ALPHA</span></div>
            </a>
            <div class="d-none d-md-block ps-4 border-start border-secondary border-opacity-25">
                <span class="text-sub" style="font-size:0.65rem; font-weight:700; letter-spacing:1px" data-i18n="sys_time">SYSTEM TIME</span>
                <div id="sysClock" class="font-num fw-bold text-brand" style="line-height:1; font-size: 1.2rem;">--:--:--</div>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-light border-secondary text-sub fw-bold dropdown-toggle d-flex align-items-center gap-1" type="button" data-bs-toggle="dropdown" style="min-width: 70px;">
                    <i class="fas fa-globe"></i> <span id="cur-lang-text">EN</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark shadow" style="border: 1px solid var(--border);">
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')"><i class="fas fa-flag-usa me-2"></i>ENGLISH</a></li>
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('vi')"><i class="fas fa-star text-danger me-2"></i>TIẾNG VIỆT</a></li>
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('zh')"><i class="fas fa-circle text-danger me-2"></i>中文</a></li>
                </ul>
            </div>

            <button class="btn btn-sm btn-outline-light border-secondary text-brand fw-bold d-flex align-items-center gap-2 me-2" onclick="new bootstrap.Modal(document.getElementById('guideModal')).show()">
                <i class="fas fa-book-open"></i> <span class="d-none d-md-inline">GUIDE</span>
            </button>

            <button class="btn-icon text-gold" onclick="handleSmartRefresh()" title="Smart Sync" style="display:none">
    <i class="fas fa-sync-alt"></i>
</button>
            <button class="btn-icon" onclick="loadFromCloud()" title="Reload Data"><i class="fas fa-database"></i></button>
            <button class="btn-icon" onclick="openSettingsModal()" title="Wallets"><i class="fas fa-wallet"></i></button>

            <button class="btn-icon text-brand me-2" onclick="openFeedbackModal()" title="Feedback / Support">
                <i class="fas fa-comment-dots"></i>
            </button>
</button>
<button class="btn-icon" onclick="new bootstrap.Modal(document.getElementById('helpModal')).show()" title="Help"><i class="fas fa-question"></i></button>

            <button class="btn btn-sm btn-outline-light d-flex align-items-center gap-2 ms-2" onclick="openLoginModal()" id="loginBtn"><i class="fas fa-key"></i> <span class="d-none d-md-inline">Login</span></button>

            <div id="userProfile" class="d-none align-items-center ms-2">
                 <div class="balance-badge" title="Virtual USDT (BSC)">
                    <i class="fas fa-coins"></i> <span id="user-balance">0</span> USDT
                </div>
                <div class="profile-btn-area" onclick="openProfileModal()">
                    <img id="nav-avatar" src="" class="user-avatar-sm" style="display:none">
                    <span class="text-brand fw-bold small" id="userNameDisplay">User</span>
                </div>
                <button class="btn-icon ms-2" style="width:28px;height:28px" onclick="handleLogout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </div>
</nav>


<div id="view-dashboard">
    <div class="hero-banner">
        <div class="container">
            <h1 class="hero-title" data-i18n="hero_title">TOURNAMENT VOLUME TRACKER</h1>
            <p class="hero-sub" data-i18n="hero_sub">Manage your accounts & Join the prediction.</p>
        </div>
    </div>

    <div class="container">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
             <h4 class="fw-bold mb-0 text-brand text-uppercase letter-spacing-1 font-num" style="text-shadow: 0 0 10px rgba(0, 240, 255, 0.4);">
                <i class="fas fa-link me-2"></i>
                <span data-i18n="sect_arsenal">TRADING PLATFORMS</span>
            </h4>
            <span class="text-sub small"><i class="fas fa-check-circle text-green me-1"></i> <span data-i18n="verified_link">Verified Links</span></span>
        </div>
        
        <div class="arsenal-section">
            <div class="arsenal-grid" id="arsenal-grid">
                </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
             <h4 class="fw-bold mb-0 text-brand text-uppercase letter-spacing-1 font-num" style="text-shadow: 0 0 10px rgba(0, 240, 255, 0.4);">
                <i class="fas fa-chart-pie me-2"></i>
                <span data-i18n="sect_market">MARKET OVERVIEW</span>
            </h4>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="stat-box">
                    <div>
                        <div class="stat-lbl" data-i18n="stat_active">ACTIVE POOLS</div>
                        <div class="stat-val text-brand" id="stat-active">0</div>
                    </div>
                    <i class="fas fa-bolt text-sub opacity-25 fa-2x"></i>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stat-box">
                    <div>
                        <div class="stat-lbl" data-i18n="stat_pool">TOTAL ACTIVE REWARDS</div>
                        <div class="stat-val text-green" id="stat-pool">0 $</div>
                    </div>
                    <i class="fas fa-sack-dollar text-sub opacity-25 fa-2x"></i>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stat-box" style="position: relative; overflow: hidden; border-color: var(--accent-yellow);">
                    <div style="z-index: 2; position: relative;">
                        <div class="stat-lbl text-gold" data-i18n="stat_top_reward">HIGHEST REWARD</div>
                        <div class="d-flex align-items-baseline gap-3"> <div class="stat-val text-white anim-breathe" id="stat-top-symbol">---</div>
    <div class="fw-bold text-gold font-num" id="stat-top-val" style="font-size: 1.8rem; text-shadow: 0 0 10px rgba(240, 185, 11, 0.5);">$0</div>
</div>
                    </div>
                    <img id="stat-top-img" src="" style="position: absolute; right: -10px; bottom: -10px; width: 80px; height: 80px; opacity: 0.15; border-radius: 50%; filter: grayscale(100%); transform: rotate(-15deg); display:none">
                    <i class="fas fa-trophy text-gold opacity-25 fa-2x" style="position: absolute; right: 20px; top: 20px;"></i>
                </div>
            </div>
        </div>

<div class="health-panel">
    <div class="health-header">
        <h4 class="fw-bold mb-0 text-brand text-uppercase letter-spacing-1 font-num">
            <i class="fas fa-heartbeat me-2"></i> MARKET HEALTH
        </h4>
        <span class="text-sub small">
            <i class="fas fa-circle text-green me-1" style="font-size: 6px; vertical-align: middle;"></i> 
            Real-time
        </span>
    </div>

    <div class="table-responsive">
        <table class="table table-dark table-hover mb-0 align-middle health-table">
            <thead>
                <tr>
                    <th class="ps-4">TOKEN</th>
                    <th class="text-end text-sub">PRICE</th>
                    <th class="text-end text-sub">Limit VOL (Today)</th>
                    <th class="text-end text-sub">TXs (Day)</th>
                    
                    <th class="text-end text-sub">
                        SPEED (tx/s) <i class="fas fa-info-circle ms-1 text-sub opacity-50" title="Tốc độ khớp lệnh (Số lệnh/Giây)"></i>
                    </th>

                    <th class="text-end text-sub">
                        AVG 1s MATCH 
                        <i class="fas fa-info-circle ms-1 text-sub opacity-50" title="Giá trị trung bình ($) thị trường hấp thụ được trong mỗi 1 Giây."></i>
                    </th>

                    <th class="text-end">
                        AVG ORDER (24h)
                        <i class="fas fa-info-circle ms-1 text-sub opacity-50" title="Giá trị bình quân 1 lệnh tính cả ngày."></i>
                    </th>
                    
                    <th class="text-end">NET FLOW (1m)</th>
                    <th class="text-end pe-4">SPREAD (%)</th>
                                    </tr>
            </thead>
            <tbody id="healthTableBody">
            </tbody>
        </table>
    </div>

    <div class="guide-grid">
        <div>
            <div class="guide-title"><i class="fas fa-info-circle"></i> <span data-i18n="g_title">CHÚ THÍCH THÔNG SỐ</span></div>
            <div class="guide-item mb-2"><strong class="text-sub">Limit VOL (Today):</strong> <span data-i18n="g_vol">Tổng giá trị giao dịch lệnh Limit (USDT) từ 00:00 UTC.</span></div>
            <div class="guide-item mb-2"><strong class="text-sub">TXs (Day):</strong> <span data-i18n="g_txs">Tổng số lệnh đã khớp trong ngày.</span></div>
            <div class="guide-item mb-2"><strong class="text-sub">SPEED (tx/s):</strong> <span data-i18n="g_speed">Tốc độ khớp lệnh (Số lệnh trên giây).</span></div>
            <div class="guide-item mb-2"><strong class="text-sub">AVG 1s MATCH:</strong> <span data-i18n="g_match">Trung bình mỗi giây thị trường khớp được bao nhiêu Đô ($).</span></div>
        </div>
        <div>
            <div class="guide-title d-none d-md-block" style="visibility: hidden;">.</div>
            <div class="guide-item mb-2"><strong class="text-sub">AVG ORDER (24h):</strong> <span data-i18n="g_ord">Giá trị trung bình của 1 lệnh (Cả ngày).</span></div>
            <div class="guide-item mb-2"><strong class="text-sub">NET FLOW (1m):</strong> <span data-i18n="g_flow">Dòng tiền ròng trong 1 phút qua.</span></div>
            <div class="guide-item mb-2"><strong class="text-sub">SPREAD (%):</strong> <span data-i18n="g_spread">Biên độ chênh lệch giá Mua/Bán.</span></div>
            
            <div class="disclaimer-box mt-3" data-i18n="g_disc">
                Dữ liệu tự động. Miễn trừ trách nhiệm: Chỉ mang tính tham khảo. Vui lòng tự nghiên cứu (DYOR) kỹ trước khi ra quyết định.
            </div>
        </div>
    </div>

<div class="row mb-4"> <div class="col-12">
                <div class="d-flex justify-content-between align-items-end mb-2">
                    <h6 class="text-brand fw-bold font-num letter-spacing-1 mb-0" style="font-size: 1rem; text-shadow: 0 0 10px rgba(0, 240, 255, 0.3);">
                        <i class="far fa-calendar-alt me-2"></i>DEADLINE RADAR
                    </h6>
                    <button class="btn btn-sm btn-dark border-secondary text-sub" onclick="filterByDate(null)" style="font-size: 0.75rem;">
                        <i class="fas fa-sync-alt me-1"></i> View All
                    </button>
                </div>
                
                <div class="timeline-wrapper">
                    <div class="timeline-scroll" id="calendar-wrapper">
                        </div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <h6 class="fw-bold mb-0 text-sub text-uppercase letter-spacing-1 font-num" style="font-size: 1rem;">
                    <i class="fas fa-list me-2"></i>
                    <span data-i18n="sect_board">TRACKING BOARD</span>
                </h6>

                <button class="btn btn-sm btn-outline-success fw-bold admin-only" onclick="openCreateModal()" style="border-radius: 20px; padding: 5px 20px;">
                    <i class="fas fa-plus me-1"></i> <span data-i18n="stat_create">CREATE</span>
                </button>

                <button class="btn btn-sm btn-brand fw-bold admin-only btn-save-pos" style="display:none; background:var(--brand); color:#000; border:none; padding: 5px 20px; border-radius: 20px; box-shadow: 0 0 10px rgba(0,240,255,0.3); white-space: nowrap;" onclick="saveCustomOrder()">
                    <i class="fas fa-save me-1"></i> SAVE POSITION
                </button>
            </div>

            <div>
                <button class="btn btn-sm btn-outline-warning border-0 text-sub me-2 admin-only" onclick="openConfigModal()"><i class="fas fa-cog me-1"></i> Site Config</button>
            </div>
        </div>

        <div class="row g-4" id="appGrid"></div>
    </div>
</div>

<div id="view-predict" style="display:none;">
    <div class="neo-wrapper">
        <div class="grid-overlay"></div>

        <div style="position: absolute; top: 20px; left: 20px; z-index: 10; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #fff; font-weight: 700; opacity: 0.7; transition: 0.2s;" onclick="playSfx('click'); switchView('dashboard')" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7">
            <div style="width:36px; height:36px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-arrow-left"></i></div>
            <span style="letter-spacing:1px; font-size:0.8rem;">BACK TO TERMINAL</span>
        </div>

        <div class="glass-card">
            <div class="glass-head"><i class="fas fa-database me-2"></i> CORE DATA</div>
            
            <div style="flex:1; display:flex; flex-direction:column;">
                <div class="stat-highlight">
                    <div class="stat-label">TARGET MIN VOLUME</div>
                    <div class="stat-val-mega anim-breathe" id="pt-min-vol">0</div>
                    <div id="pt-vol-change" class="d-flex justify-content-center mt-2"></div>
                </div>

                <div class="stat-highlight">
                    <div class="stat-label">PRIZE POOL</div>
                    <div class="stat-val-sub" id="pt-pool">$0</div>
                </div>

                <div class="stat-highlight" style="border:none">
                    <div class="stat-label">REMAINING TIME</div>
                    <div class="font-num text-gold fw-bold fs-3" id="pt-time">--:--</div>
                </div>

                <div class="tools-grid mt-auto mb-3">
                    <button class="btn-tool-glass" onclick="new bootstrap.Modal(document.getElementById('ruleModal')).show()"><i class="fas fa-scroll me-1"></i> RULES</button>
                    <button class="btn-tool-glass" onclick="generateShareCard()"><i class="fas fa-share-nodes me-1"></i> SHARE</button>
                </div>
            </div>

            <button id="btn-predict-action" class="btn-cyber" onclick="openInputModal()">
                INITIATE PREDICTION
            </button>
        </div>

        <div class="glass-card">
            <div class="glass-head" style="justify-content:space-between">
                <span><i class="fas fa-chart-area me-2"></i> MARKET VISUALIZER</span>
                
                <div class="token-badge">
                    <img id="pt-logo" src="" style="width:20px; height:20px; border-radius:50%;">
                    <span id="pt-symbol" class="fw-bold text-white small">BTC</span>
                </div>
            </div>
            
            <div class="chart-wrapper">
                <canvas id="marketChart"></canvas>
            </div>
        </div>

        <div class="glass-card">
            <div class="glass-head"><i class="fas fa-users me-2"></i> NETWORK</div>
            
            <div class="tab-capsule">
                <div class="tab-pill active" id="tab-btn-leaderboard" onclick="switchCpTab('leaderboard')">TOP RANK</div>
                <div class="tab-pill" id="tab-btn-chat" onclick="switchCpTab('chat')">CHAT</div>
            </div>

            <div id="cp-content-leaderboard" class="neo-list">
                <table class="w-100" style="font-size:0.85rem; border-collapse: separate; border-spacing: 0 8px;">
                    <tbody id="pt-leaderboard"></tbody>
                </table>
            </div>

            <div id="cp-content-chat" class="d-none flex-column h-100" style="padding-bottom:15px">
                <div id="chat-feed" class="neo-list mb-3"></div>
                <div style="padding:0 15px">
                    <div class="input-group input-group-sm">
                        <input id="chat-msg" class="form-control bg-transparent text-white border-secondary" style="border-radius:20px 0 0 20px" placeholder="Broadcast message..." onkeydown="if(event.key==='Enter') sendChat()">
                        <button class="btn btn-light" style="border-radius:0 20px 20px 0" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<footer class="app-footer">
    <div class="container">
        <div class="footer-socials" id="footer-socials-container"></div>
        <div class="footer-copy text-center text-sub small">
            &copy; 2025 WAVE ALPHA. All rights reserved.<br>
            <span class="opacity-50">Data provided by DexScreener & Binance. Not financial advice.</span><br>
            <a href="#" class="text-sub text-decoration-none mt-2 d-inline-block border-bottom border-secondary" onclick="new bootstrap.Modal(document.getElementById('privacyModal')).show()">Privacy Policy</a> &bull; <a href="#" class="text-sub text-decoration-none border-bottom border-secondary" onclick="new bootstrap.Modal(document.getElementById('legalModal')).show()">Terms of Service</a>
        </div>
    </div>
</footer>

<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-white">MANAGE WALLETS</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-sub small mb-3">Define accounts to track volume separately (e.g. Main, Sub, Friend).</p>

                <div id="settingsList" class="d-flex flex-column gap-2 mb-3"></div>

                <label class="small fw-bold text-brand mb-1">ADD NEW WALLET</label>
                <div class="input-group">
                    <input type="color" class="form-control form-control-color" id="newAccColor" value="#00F0FF" title="Choose Color">
                    <input type="text" class="form-control" id="newAccName" placeholder="Name (e.g. Account 3)">
                    <button class="btn btn-light fw-bold" onclick="addNewAccount()">ADD</button>
                </div>

                <div class="text-center mt-4">
                    <button class="btn btn-sm btn-outline-secondary border-0" onclick="syncLocalToCloud()">
                        <i class="fas fa-cloud-upload-alt me-1"></i> Sync Old Data to Cloud
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0" style="background: linear-gradient(145deg, #1a1e23, #111); border: 1px solid var(--border);">
            <div class="modal-body p-4 text-center">
                <div class="mb-4">
                    <div style="width:60px;height:60px;background:rgba(0,240,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto;border:1px solid var(--brand);box-shadow:0 0 15px rgba(0,240,255,0.3)">
                        <i class="fas fa-shield-alt text-brand fa-2x"></i>
                    </div>
                </div>
                <h5 class="fw-bold text-white mb-1">SECURE ACCESS</h5>
                <p class="text-sub small mb-4">Authenticate via Email OTP</p>
                <div id="login-step-1">
                    <input type="email" id="otp-email" class="form-control mb-3 text-center" placeholder="name@example.com" style="border-radius: 20px;">
                    <button class="btn-action rounded-pill" onclick="sendOtpCode()">SEND CODE <i class="fas fa-paper-plane ms-2"></i></button>
                </div>
                <div id="login-step-2" style="display:none">
                    <input type="text" id="otp-token" class="form-control mb-3 text-center fw-bold text-brand fs-4 letter-spacing-1" placeholder="• • • • • •" maxlength="6" style="border-radius: 20px; background: #000; border-color: var(--brand);">
                    <button class="btn-action rounded-pill mb-3" onclick="verifyOtpCode()">VERIFY LOGIN</button>
                    <a href="#" onclick="resetLoginModal()" class="text-sub small text-decoration-none">Change Email</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="privacyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-sub"><i class="fas fa-user-shield me-2"></i> PRIVACY POLICY</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-sub small" style="max-height:400px; overflow-y:auto; line-height:1.6">
                <p><strong>Last Updated: October 2025</strong></p>
                <p>1. <strong>Data Collection:</strong> We only collect your email address for authentication purposes via Supabase Auth. We do not sell your data.</p>
                <p>2. <strong>Usage:</strong> Your data is used solely to track your portfolio progress, leaderboard ranking, and tournament participation within Wave Alpha.</p>
                <p>3. <strong>Cookies:</strong> We use local storage to save your view preferences. No third-party tracking cookies are used.</p>
                <p>4. <strong>Rights:</strong> You can request data deletion at any time by contacting support.</p>
                <div class="text-center mt-4"><button class="btn btn-sm btn-outline-light px-4 rounded-pill" data-bs-dismiss="modal">Close</button></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shareCardModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-brand"><i class="fas fa-share-alt me-2"></i> SHARE PREDICTION</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center d-flex flex-column align-items-center">
                <div id="share-card-container">
                    <div class="sc-header">
                        <div class="sc-logo-text">WAVE<span>ALPHA</span></div>
                        <div class="sc-date" id="sc-date-display">--/--/----</div>
                    </div>
                    <div class="sc-main">
                        <div class="sc-user-box">
                            <img id="sc-user-avatar" src="" class="sc-user-avatar" crossOrigin="anonymous">
                            <div class="sc-user-info">
                                <div class="sc-user-label">TRADER</div>
                                <div id="sc-user-name" class="sc-user-name">SHARK</div>
                            </div>
                        </div>

                        <div class="sc-token-row">
                            <img id="sc-token-img" src="" class="sc-token-img" crossOrigin="anonymous">
                            <div id="sc-token-name" class="sc-token-name">BTC</div>
                        </div>

                        <div class="sc-stat-box">
                            <div><div class="sc-stat-label">MIN VOL</div><div class="sc-stat-val brand" id="sc-min-vol">0</div></div>
                            <div class="sc-divider"></div>
                            <div><div class="sc-stat-label">MY PREDICTION</div><div class="sc-stat-val gold" id="sc-my-guess">0</div></div>
                        </div>
                    </div>
                    <div class="sc-footer">
                        <div class="text-start">
                            <div class="sc-ref-text">Challenge me on<br>Prediction Market</div>
                            <div class="sc-web-link">wave-alpha.pages.dev</div>
                        </div>
                        <div class="sc-qr-box" id="sc-qr-target"></div>
                    </div>
                </div>
                <div class="mt-4 w-100">
                    <button class="btn btn-light rounded-pill fw-bold w-100 py-2 mb-3" onclick="downloadShareCard()"><i class="fas fa-download me-2"></i> DOWNLOAD IMAGE</button>

                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-dark border-secondary flex-fill rounded-pill py-2" onclick="shareToX()" style="background:#000"><i class="fab fa-twitter text-white me-2"></i> Share on X</button>
                        <button class="btn btn-primary border-0 flex-fill rounded-pill py-2" onclick="shareToTele()" style="background:#0088cc"><i class="fab fa-telegram-plane text-white me-2"></i> Telegram</button>
                    </div>

                    <div class="text-sub small mt-3 opacity-50">Share link & challenge friends!</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-brand"><i class="fas fa-user-cog me-2"></i> PROFILE SETTINGS</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="avatar-upload-box" onclick="document.getElementById('file-input').click()">
                    <img id="pf-preview" src="">
                    <div class="upload-placeholder" id="pf-placeholder"><i class="fas fa-camera fa-2x mb-1"></i><br>Upload</div>
                    <div id="upload-loading" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);border-radius:50%;display:none;align-items:center;justify-content:center"><div class="spinner-border text-brand spinner-border-sm"></div></div>
                </div>
                <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(this)">
                <input type="hidden" id="pf-avatar-url">

                <label class="small text-sub fw-bold mb-1">NICKNAME (UNIQUE)</label>
                <input type="text" id="pf-nickname" class="form-control mb-4" placeholder="Enter unique nickname">

                <button id="btn-save-profile" class="btn-action" onclick="saveProfile()">SAVE CHANGES</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-warning">GLOBAL SETTINGS</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-4 border-bottom border-secondary border-opacity-25 pb-3">
                    <label class="small text-sub fw-bold mb-2 text-brand">BRAND LOGO (ADMIN)</label>
                    <div class="d-flex align-items-center gap-3">
                        <img id="cfg-logo-preview" src="" style="width:60px; height:60px; object-fit:contain; background:#000; border:1px solid #333; border-radius:4px; display:none">
                        <div style="flex:1">
                            <input type="file" class="form-control form-control-sm mb-1" accept="image/*" onchange="uploadImage(this, 'cfg-logo-preview', 'cfg-logo-url')">
                            <input type="hidden" id="cfg-logo-url">
                            <div class="text-sub" style="font-size:0.7rem">Upload ảnh logo của bạn (PNG/JPG)</div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="small text-sub fw-bold mb-1">X (Twitter) URL</label>
                    <input type="text" id="cfg-x" class="form-control mb-2">
                    <label class="small text-sub fw-bold mb-1">Telegram URL</label>
                    <input type="text" id="cfg-tele" class="form-control mb-2">
                    <label class="small text-sub fw-bold mb-1">Youtube URL</label>
                    <input type="text" id="cfg-yt" class="form-control mb-2">
                </div>

                <h6 class="text-gold mb-3 pt-3 border-top border-secondary border-opacity-25">QUẢN LÝ LINK REF (ARSENAL)</h6>

                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-outline-success" onclick="addArsenalItem()">
                        <i class="fas fa-plus me-1"></i> Thêm Sàn Mới
                    </button>
                </div>

                <div id="cfg-arsenal-list" style="max-height: 400px; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 10px;"></div>


                <button class="btn-action" onclick="saveGlobalConfig()">SAVE CONFIG</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-brand">MY TRADING TRACKER</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="u-db-id">
                <input type="hidden" id="u-original-date">
                <div class="row">
                    <div class="col-lg-4 border-end border-secondary border-opacity-25 pe-lg-4">
                        <h4 class="font-num fw-bold text-main mb-3" id="u-symbol-display">TOKEN</h4>
                        <div class="mb-3">
                            <label class="small text-sub fw-bold mb-1">DATE</label>
                            <input type="date" id="u-date" class="form-control text-brand fw-bold">
                        </div>
                        <div class="p-3 mb-4 rounded" style="background: rgba(240, 185, 11, 0.05); border: 1px dashed rgba(240, 185, 11, 0.3);">
                            <label class="small text-gold fw-bold mb-1"><i class="fas fa-lock me-1"></i> MIN VOLUME (TARGET)</label>
                            <input type="text" id="u-min-vol" class="form-control font-num text-gold fw-bold fs-4" placeholder="---" disabled style="background:transparent; border:none; padding:0" onkeyup="formatCurrency(this)">
                        </div>
                        <label class="small text-brand fw-bold mb-2"><i class="fas fa-wallet me-1"></i> MY VOLUMES & GAP</label>
                        <div class="d-flex justify-content-between text-sub small fw-bold px-1 mb-1">
                            <span style="width:80px">ACC</span>
                            <span class="text-center">VOL</span>
                            <span class="text-end">GAP / COST</span>
                        </div>
                        <div id="u-acc-inputs" class="mb-4"></div>
                        <button id="btn-save-progress" class="btn-action" onclick="saveUpdate()">SAVE MY PROGRESS</button>
                    </div>
                    <div class="col-lg-8 ps-lg-4">
                        <div style="height: 250px; margin-bottom: 20px;">
                            <canvas id="trackerChart"></canvas>
                        </div>
                        <label class="small text-sub fw-bold mb-2">MY HISTORY</label>
                        <div style="max-height:300px;overflow-y:auto">
                            <table class="table table-dark table-sm table-hover align-middle" style="font-size:0.8rem" id="historyTable">
                                <thead>
                                    <tr id="historyHeader"></tr>
                                </thead>
                                <tbody id="historyList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inputModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-white">ENTER PREDICTION</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <p class="text-sub small mb-4">Dự đoán Min Volume chốt sổ.</p>
                <label class="text-brand fw-bold small mb-1">YOUR NAME</label>
                <input type="text" id="modal-p-name" class="form-control mb-3" placeholder="Ví dụ: Shark 1">
                <label class="text-gold fw-bold small mb-1">YOUR GUESS (VOL)</label>
                <input type="number" id="modal-p-guess" class="form-control font-num fs-4 text-gold mb-4" placeholder="Fee: 100 USDT">
                <button class="btn-action w-100 py-3 text-white" style="background: var(--purple)" onclick="submitPredictionFromModal()">CONFIRM & PAY FEE</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="compModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-brand">SETUP TOURNAMENT (ADMIN)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="c-db-id">

                <div class="row g-3 mb-3">
                    <div class="col-md-5">
                        <label class="small text-sub fw-bold mb-1">REWARD TOKEN CONTRACT (Để lấy giá tính Pool)</label>
                        <div class="input-group">
                            <input type="text" id="c-contract" class="form-control" onchange="fetchTokenInfo(this.value)">
                            <button class="btn btn-outline-secondary border-secondary" onclick="fetchTokenInfo(document.getElementById('c-contract').value)"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-sub fw-bold mb-1">CHAIN</label>
                        <input type="text" id="c-chain" class="form-control text-uppercase fw-bold" placeholder="bsc">
                    </div>
                    <div class="col-md-2">
                        <label class="small text-sub fw-bold mb-1">SYMBOL (TÊN)</label>
                        <input type="text" id="c-symbol" class="form-control text-uppercase text-brand font-num fw-bold">
                    </div>
                    <div class="col-md-3">
                        <label class="small text-sub fw-bold mb-1">PRICE ($)</label>
                        <input type="number" id="c-price" class="form-control font-num text-gold">
                    </div>
                </div>

                <div class="p-3 rounded mb-3" style="background: rgba(153, 69, 255, 0.1); border: 1px dashed var(--purple);">
                    <label class="small text-white fw-bold mb-1"><i class="fas fa-layer-group me-1"></i> CAMPAIGN MODE (OPTIONAL)</label>
                    <input type="text" id="c-inputTokens" class="form-control" placeholder="Nhập các token cần trade, cách nhau dấu phẩy (VD: VSN, LAVA)">
                    <div class="text-sub mt-1" style="font-size:0.7rem">* Nếu điền ô này, thẻ sẽ chuyển sang chế độ 'Aggregated Campaign'. Bỏ trống để tạo giải thưởng.</div>
                </div>

                <div class="mb-3">
                    <label class="small text-sub fw-bold mb-1">PROJECT LOGO</label>
                    <div class="input-group mb-2">
                        <input type="file" class="form-control" accept="image/*" onchange="uploadImage(this, 'c-logo-preview', 'c-logo')">
                    </div>
                    <div class="d-flex align-items-center gap-3 p-2 rounded" style="background:rgba(255,255,255,0.05)">
                        <img id="c-logo-preview" src="" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #555; display:none">
                        <input type="text" id="c-logo" class="form-control form-control-sm border-0 bg-transparent text-white" placeholder="Image URL will appear here..." readonly>
                    </div>
                </div>

                <div class="p-3 rounded border border-secondary border-opacity-25 mb-4" style="background: rgba(255,255,255,0.02)">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="small text-sub fw-bold mb-1">ALPHA POINTS</label>
                            <select id="c-alphaType" class="form-select form-select-sm" onchange="toggleListingTime()">
                                <option value="none">None (1x)</option>
                                <option value="x2">Other (x2)</option>
                                <option value="x4">BSC (x4)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-sub fw-bold mb-1 text-gold">LISTING TIME</label>
                            <input type="datetime-local" id="c-listing" class="form-control form-control-sm" disabled>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-sub fw-bold mb-1">RULE TYPE</label>
                            <select id="c-rule" class="form-select form-select-sm">
                                <option value="buy_only">ONLY BUY</option>
                                <option value="trade_x4">BUY + SELL (x4)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="small text-sub fw-bold mb-1">REWARD QTY</label>
                        <input type="number" id="c-rewardQty" class="form-control font-num">
                    </div>
                    <div class="col-md-6">
                        <label class="small text-sub fw-bold mb-1">WINNERS</label>
                        <input type="number" id="c-winners" class="form-control font-num" placeholder="2000">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="small text-sub fw-bold mb-1">START DATE</label>
                        <input type="date" id="c-start" class="form-control">
                    </div>
                    <div class="col-6">
                        <label class="small text-sub fw-bold mb-1">END DATE</label>
                        <div class="input-group">
                            <input type="date" id="c-end" class="form-control">
                            <input type="time" id="c-end-time" class="form-control" style="max-width:100px">
                        </div>
                    </div>
                </div>

                <button class="btn-action" onclick="saveComp()">PUBLISH TO CLOUD</button>
                <div class="text-center mt-3">
                    <button class="btn btn-sm text-danger border-0 bg-transparent opacity-50" onclick="deleteComp()" id="btnDeleteComp" style="display:none">Delete Tournament</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-brand" data-i18n="legend_title">ICON LEGEND</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="d-flex align-items-center gap-3 mb-3">
                <div class="btn-icon" style="cursor:default">
                    <i class="fas fa-comment-dots text-brand"></i>
                </div>
                <div>
                    <div class="fw-bold" data-i18n="leg_feedback_t">Feedback / Support</div>
                    <div class="text-sub small" data-i18n="leg_feedback_d">Send ideas or report bugs directly to Admin.</div>
                </div>
            </div>

                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="btn-icon" style="cursor:default"><i class="fas fa-database"></i></div>
                    <div>
                        <div class="fw-bold" data-i18n="leg_reload_t">Reload Data</div>
                        <div class="text-sub small" data-i18n="leg_reload_d">Force reload data from Cloud Database.</div>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="btn-icon" style="cursor:default"><i class="fas fa-wallet"></i></div>
                    <div>
                        <div class="fw-bold" data-i18n="leg_wallet_t">Manage Wallets</div>
                        <div class="text-sub small" data-i18n="leg_wallet_d">Add or remove tracking accounts.</div>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-3">
                    <div class="btn-icon" style="cursor:default"><i class="fas fa-key"></i></div>
                    <div>
                        <div class="fw-bold" data-i18n="leg_login_t">Login</div>
                        <div class="text-sub small" data-i18n="leg_login_d">Access Admin features via OTP Email.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ruleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-brand"><i class="fas fa-scroll me-2"></i> WAVE ORACLE RULES</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <h6 class="text-white fw-bold mb-3 text-uppercase letter-spacing-1">Objective</h6>
                <p class="text-sub small mb-4">Predict the exact <strong>Min Volume</strong> (the volume of the last ranked winner, e.g., Rank #2000) at the tournament snapshot time.</p>

                <h6 class="text-white fw-bold mb-3 text-uppercase letter-spacing-1">Gameplay Mechanics</h6>
                <ul class="rule-list">
                    <li><strong>Entry Fee:</strong> Each prediction costs <span class="text-gold fw-bold">100 USDT</span> (Virtual). Added to the Prize Pool.</li>
                    <li><strong>Lock Time:</strong> Predictions CLOSE <span class="text-danger fw-bold">AT TOURNAMENT END</span>. Results are announced the following day after Binance publishes the Min Volume.</li>
                    <li><strong>Winner:</strong> The player with the <span class="text-brand">Closest Guess ≥ Actual Result</span> wins. (Lower guesses are disqualified).</li>
                    <li><strong>Tie-Breaker:</strong> If guesses are equal, the earlier prediction wins.</li>
                </ul>

                <h6 class="text-white fw-bold mb-3 text-uppercase letter-spacing-1">Prize Distribution</h6>
                <div class="d-flex gap-2 mb-2">
                    <div class="flex-fill p-2 bg-dark rounded border border-secondary text-center"><div class="text-gold fw-bold">🥇 1st</div><div class="small">50% Pool</div></div>
                    <div class="flex-fill p-2 bg-dark rounded border border-secondary text-center"><div class="text-light fw-bold">🥈 2nd</div><div class="small">30% Pool</div></div>
                    <div class="flex-fill p-2 bg-dark rounded border border-secondary text-center"><div class="text-brand fw-bold">🥉 3rd</div><div class="small">20% Pool</div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="guideModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-brand"><i class="fas fa-graduation-cap me-2"></i> QUICK START GUIDE</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-md-4 text-center">
                        <div class="p-3 rounded h-100" style="border: 1px solid #333; background: rgba(255,255,255,0.03);">
                            <div class="mb-2"><i class="fas fa-list-ol fa-2x text-brand"></i></div>
                            <h6 class="text-white fw-bold">STEP 1: SETUP LIST</h6>
                            <p class="text-sub small">Define your tracking list (e.g. Account A, Account B) to separate volume sources. <br><strong>No connection needed.</strong></p>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="p-3 rounded h-100" style="border: 1px solid #333; background: rgba(255,255,255,0.03);">
                            <div class="mb-2"><i class="fas fa-pen-to-square fa-2x text-gold"></i></div>
                            <h6 class="text-white fw-bold">STEP 2: INPUT VOLUME</h6>
                            <p class="text-sub small">Click <strong>UPDATE</strong> on any tournament. Manually input your daily volume for each account.</p>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="p-3 rounded h-100" style="border: 1px solid #333; background: rgba(255,255,255,0.03);">
                            <div class="mb-2"><i class="fas fa-chart-line fa-2x text-green"></i></div>
                            <h6 class="text-white fw-bold">STEP 3: TRACK GAP</h6>
                            <p class="text-sub small">System automatically calculates the <strong>GAP</strong> (Distance) to the target Min Volume.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button class="btn-action w-50 mx-auto" data-bs-dismiss="modal" onclick="openSettingsModal()">SETUP MY LIST <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="volHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background: #161a1e; border: 1px solid #333;">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <div>
                    <h5 class="modal-title fw-bold text-brand font-num" id="vh-title">VOLUME HISTORY</h5>
                    <div class="text-sub small" id="vh-subtitle">Daily USDT Volume</div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div style="height: 300px; width: 100%;">
                    <canvas id="volHistoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /* ================= SETUP ================= */
    const SUPABASE_URL = 'https://akbcpryqjigndzpuoany.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrYmNwcnlxamlnbmR6cHVvYW55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODg0NTEsImV4cCI6MjA4MDY2NDQ1MX0.p1lBHZ12fzyIrKiSL7DXv7VH74cq3QcU7TtBCJQBH9M';
    const ADMIN_EMAILS = [ "annachou60@gmail.com" ];
const PREDICT_FEE = 100;

// --- CẤU HÌNH TELEGRAM (BẢO MẬT - SECURE MODE) ---
const TELE_BOT_CONFIG = {
    // Tự động tìm Token trong bộ nhớ trình duyệt (không lộ trên code)
    get token() {
        return localStorage.getItem('WAVE_TELE_TOKEN'); 
    },
    // ID Group của bạn (Công khai được)
    chatId: '-1003355713341' // <--- THAY ID GROUP CỦA BẠN VÀO ĐÂY
};

// 1. Hàm hỗ trợ nhập Token (Chạy 1 lần là nhớ mãi trên máy này)
function requireBotToken() {
    let currentToken = TELE_BOT_CONFIG.token;
    if (!currentToken) {
        // Hiện bảng hỏi Token
        let input = prompt("⚠️ CHƯA CÓ TOKEN BOT!\n\nVui lòng dán Token BotFather vào đây (Chỉ cần làm 1 lần trên máy này):");
        if (input && input.trim() !== "") {
            localStorage.setItem('WAVE_TELE_TOKEN', input.trim());
            alert("✅ Đã lưu Token vào máy! Từ giờ bạn có thể cập nhật thoải mái.");
            return true;
        } else {
            alert("❌ Bạn chưa nhập Token nên không thể gửi tin nhắn Telegram.");
            return false;
        }
    }
    return true;
}

// --- HÀM GỬI TIN NHẮN (BẢN FINAL FIX: HIỆN SO SÁNH & CẮT SỐ LẺ) ---
async function sendTeleAlert(comp, newTarget) {
    
    // 1. Kiểm tra Token
    if (!requireBotToken()) return; 
    const token = TELE_BOT_CONFIG.token;
    const chatId = TELE_BOT_CONFIG.chatId;
    if (!token || !chatId) return;

    // 2. Lấy Ngày hiện tại
    let dateStr = new Date().toLocaleDateString('en-GB'); // VD: 20/12/2025
    
    // --- A. TÍNH TOÁN REWARD & PRICE ---
    let qty = parseFloat(comp.rewardQty) || 0;
    let price = comp.cachedPrice || comp.market_analysis?.price || 0;
    let estVal = qty * price;
    let rewardStr = estVal > 0 ? `~$${new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(estVal)}` : '---';
    
    // Price giữ 4 số lẻ nếu nhỏ
    let priceStr = price > 0 
        ? '$' + price.toLocaleString('en-US', { maximumFractionDigits: price < 1 ? 4 : 2 }) 
        : '---';

    // --- B. THỜI GIAN ---
    let timeStatus = "Running 🟢";
    let isEnded = false;
    
    if (comp.end) {
        let endString = comp.end + 'T' + (comp.endTime || '23:59:59') + 'Z';
        let endTime = new Date(endString).getTime();
        let now = Date.now();
        if (now > endTime) {
            timeStatus = "🔴 ENDED";
            isEnded = true;
        } else {
            let diff = endTime - now;
            let d = Math.floor(diff / (1000 * 60 * 60 * 24));
            let h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            timeStatus = `${d}d ${h}h`;
        }
    }

    let promoStr = "";
    if (!isEnded && comp.alphaType !== 'none' && comp.listingTime) {
        let typeLabel = comp.alphaType === 'x4' ? 'X4 BSC' : 'X2 Other';
        let listingDate = new Date(comp.listingTime.includes('T') ? comp.listingTime + 'Z' : comp.listingTime);
        let promoEndTime = listingDate.getTime() + (30 * 24 * 60 * 60 * 1000);
        let now = Date.now();
        if (now < promoEndTime) {
            let diff = promoEndTime - now;
            let d = Math.floor(diff / (1000 * 60 * 60 * 24));
            promoStr = ` | ⚡ ${typeLabel}: ${d}d left`;
        }
    }

    // --- C. MIN VOL: LOGIC SO SÁNH (FIX LỖI MẤT DÒNG) ---
    let changeStr = ""; 
    let currentTargetVal = parseFloat(newTarget.replace(/,/g, ''));

    if (comp.history && Array.isArray(comp.history) && comp.history.length >= 1) {
        // 1. Hàm parse ngày an toàn (xử lý cả 20/12/2025 và 2025-12-20)
        const parseDateSafe = (dStr) => {
            if(!dStr) return 0;
            // Nếu là dạng YYYY-MM-DD
            if (dStr.includes('-')) return new Date(dStr).getTime();
            // Nếu là dạng DD/MM/YYYY
            if (dStr.includes('/')) {
                let [day, month, year] = dStr.split('/');
                return new Date(`${year}-${month}-${day}`).getTime();
            }
            return new Date(dStr).getTime();
        };

        // 2. Sắp xếp lịch sử theo thời gian tăng dần
        let sortedHist = [...comp.history].sort((a, b) => parseDateSafe(a.date) - parseDateSafe(b.date));
        
        let prevTarget = 0;
        // Lấy phần tử áp chót (vì phần tử cuối cùng là cái vừa nhập)
        if (sortedHist.length >= 2) {
            prevTarget = parseFloat(sortedHist[sortedHist.length - 2].target);
        }

        // Tính toán chênh lệch
        let diff = currentTargetVal - prevTarget;
        
        // Format số tiền (Tuyệt đối không có số lẻ)
        let diffFormatted = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(Math.abs(diff));
        let sign = diff >= 0 ? '+' : '-';

        // Tạo chuỗi (Nếu có sự thay đổi hoặc là bản ghi mới)
        if (prevTarget > 0 && diff !== 0) {
            changeStr = ` <i>(${sign}$${diffFormatted} vs prev)</i>`;
        } else if (prevTarget === 0 && currentTargetVal > 0) {
            changeStr = ` <i>(🚀 New Record)</i>`;
        }
    }

    // --- D. LIMIT VOL: FIX LỖI SỐ LẺ DÀI LOẰNG NGOẰNG ---
    let volHistory = comp.real_vol_history || [];
    const getIsoDate = (d) => d.toISOString().split('T')[0];
    let d1 = new Date(); d1.setDate(d1.getDate() - 1); 
    let d2 = new Date(); d2.setDate(d2.getDate() - 2); 
    let yStr = getIsoDate(d1); 
    let pStr = getIsoDate(d2);
    let dateLabel = `${yStr.split('-')[2]}/${yStr.split('-')[1]}`;

    let volYest = volHistory.find(h => h.date === yStr)?.vol || 0;
    let volPrev = volHistory.find(h => h.date === pStr)?.vol || 0;
    
    let limitVolDisplay = "Waiting Update...";
    let volChangeStr = "";

    if (volYest > 0) {
        // Cắt sạch số thập phân
        limitVolDisplay = '$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(volYest);
        
        if (volPrev > 0) {
            let diffVol = volYest - volPrev;
            // Cắt sạch số thập phân ở phần chênh lệch luôn
            let diffVolFmt = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(Math.abs(diffVol));
            let signVol = diffVol >= 0 ? '+' : '-';
            let iconVol = diffVol >= 0 ? "🔼" : "🔽";
            volChangeStr = ` (${iconVol} ${signVol}$${diffVolFmt})`;
        }
    } else {
        let realNow = comp.real_alpha_volume || 0;
        if(realNow > 0) limitVolDisplay = '$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(realNow) + ' (Today)';
    }

    // --- E. SOẠN TIN NHẮN (GỘP DÒNG MIN VOL) ---
    let msg = `
<b>🔔 UPDATE: ${comp.name} MIN TARGET</b>
📅 <i>${dateStr}</i>

🎯 <b>Min Vol:</b> ${newTarget}${changeStr}
💰 <b>Reward:</b> <b>${rewardStr}</b>

💵 <b>Price:</b> ${priceStr}
📊 <b>Limit Vol (${dateLabel}):</b>
👉 <b>${limitVolDisplay}</b>${volChangeStr}

⏳ <b>Time:</b> ${timeStatus}${promoStr}

👉 <a href="https://wave-alpha.pages.dev">Open Wave Alpha</a>
    `;

    try {
        await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                chat_id: chatId,
                text: msg,
                parse_mode: 'HTML',
                disable_web_page_preview: true
            })
        });
        console.log("✅ Telegram sent!");
    } catch (e) {
        console.error("Tele Error:", e);
        if(e.message && e.message.includes('401')) {
            alert("❌ Token sai! Vui lòng nhập lại.");
            localStorage.removeItem('WAVE_TELE_TOKEN');
        }
    }
}


// --- [MỚI] BIẾN LƯU TRỮ LỊCH SỬ KHỚP LỆNH CHO TỪNG TOKEN ---
// Dùng để tính trung bình 10s cho nhiều token cùng lúc
let tokenVolHistory = {}; 
const SAFETY_WINDOW = 10; // Tính trung bình 10 mẫu gần nhất
/* --- BỘ TỪ ĐIỂN FULL (ĐÃ CẬP NHẬT TÊN & SLOGAN MỚI) --- */
let currentLang = localStorage.getItem('wave_lang') || 'en';

/* --- BỘ TỪ ĐIỂN ĐA NGÔN NGỮ (FULL LOCALIZATION - ĐÃ SỬA ĐỊNH NGHĨA LIMIT VOL) --- */
const translations = {
    en: {
        // --- CHUNG ---
        nav_guide: "GUIDE", nav_login: "Login", nav_logout: "Logout",
        sys_time: "SYSTEM TIME", verified_link: "Verified Links",

        // --- HERO ---
        hero_title: "TOURNAMENT VOLUME TRACKER",
        hero_sub: "Manage your accounts & Join the prediction.",

        // --- SECTION HEADERS ---
        sect_arsenal: "TRADING PLATFORMS",
        sect_market: "MARKET OVERVIEW",
        stat_top_reward: "HIGHEST REWARD",
        sect_board: "TRACKING BOARD",

        // --- STATS ---
        stat_active: "ACTIVE POOLS", stat_pool: "TOTAL ACTIVE REWARDS", stat_create: "CREATE NEW",

        // --- SORT ---
        sort_newest: "Newest (Start Date)", sort_ending: "Ending Soon", sort_reward: "Highest Reward ($)",

        // --- CARD ---
        lbl_top: "TOP", lbl_reward: "REWARD", lbl_price: "PRICE",
        lbl_ends: "ENDS:", lbl_min_target: "MIN TARGET",
        btn_update: "UPDATE VOL", btn_predict: "PREDICT",
        status_running: "RUNNING", status_ended: "ENDED",
        tag_x4: "X4 BSC CHAIN", tag_x2: "X2 OTHER CHAINS",
        res_win: "WIN", res_lose: "LOSE",

        // --- MODALS ---
        modal_u_title: "MY TRADING TRACKER", lbl_date: "DATE", lbl_my_vol: "MY VOLUMES & GAP", lbl_history: "MY HISTORY",
        btn_save_prog: "SAVE MY PROGRESS", btn_saving: "SAVING...", btn_saved: "SAVED!", ph_vol: "Volume", ph_cost: "Cost ($)",
        modal_p_title: "ENTER PREDICTION", modal_p_desc: "Predict the final Min Volume.", lbl_p_name: "YOUR NAME", lbl_p_guess: "YOUR GUESS (VOL)",
        ph_p_name: "Ex: Shark 1", ph_p_fee: "Fee: 100 USDT", btn_confirm: "CONFIRM & PAY FEE", btn_processing: "PROCESSING...",
        modal_l_title: "SECURE ACCESS", modal_l_desc: "Authenticate via Email OTP", btn_send_code: "SEND CODE", btn_verify: "VERIFY LOGIN",

        // --- TOAST ---
        toast_login_req: "Please Login first!", toast_success: "Action Successful!", toast_error: "Error occurred!",
        toast_insufficient: "Insufficient Balance!", toast_saved: "Tracking Data Saved!",

        // --- LEGEND & DISCLAIMER ---
        legend_title: "ICON LEGEND",
        // Thay dòng leg_sync cũ bằng dòng này:
leg_feedback_t: "Feedback / Support", 
leg_feedback_d: "Send ideas or report bugs directly to Admin.",
        leg_reload_t: "Reload Data", leg_reload_d: "Force reload data from Cloud Database.",
        leg_wallet_t: "Manage Wallets", leg_wallet_d: "Add or remove tracking accounts.",
        leg_login_t: "Login / Access", leg_login_d: "Secure access via Email OTP to save data.",

        g_title: "METRIC LEGEND",
        // Đã sửa theo yêu cầu: Chỉ Limit Trading
        g_vol: "Volume generated solely from Limit Trading (Off-chain) since 00:00 UTC.",
        g_txs: "Total executed orders today.",
        g_speed: "Execution speed (Orders/sec).",
        g_match: "Avg market absorption per second ($).",
        g_ord: "Average value per order (24h).",
        g_flow: "Net cash flow in the last 1m.",
        g_spread: "Bid/Ask price spread.",
        g_disc: "Automated Data. Disclaimer: For reference only. We accept no liability, please Do Your Own Research (DYOR)."
    },
    vi: {
        // --- CHUNG ---
        nav_guide: "HƯỚNG DẪN", nav_login: "Đăng nhập", nav_logout: "Đăng xuất",
        sys_time: "GIỜ HỆ THỐNG", verified_link: "Link Chính Chủ",

        // --- HERO ---
        hero_title: "CÔNG CỤ THEO DÕI VOLUME",
        hero_sub: "Quản lý các tài khoản & Tham gia dự đoán.",

        // --- SECTION HEADERS ---
        sect_arsenal: "SÀN GIAO DỊCH",
        sect_market: "TỔNG QUAN THỊ TRƯỜNG",
        stat_top_reward: "GIẢI THƯỞNG CAO NHẤT",
        sect_board: "BẢNG THEO DÕI",

        // --- STATS ---
        stat_active: "GIẢI ĐANG CHẠY", stat_pool: "TỔNG GIÁ TRỊ GIẢI", stat_create: "TẠO GIẢI MỚI",

        // --- SORT ---
        sort_newest: "Mới nhất (Ngày bắt đầu)", sort_ending: "Sắp kết thúc", sort_reward: "Thưởng cao nhất ($)",

        // --- CARD ---
        lbl_top: "TOP", lbl_reward: "THƯỞNG", lbl_price: "GIÁ",
        lbl_ends: "KẾT THÚC:", lbl_min_target: "MỤC TIÊU MIN",
        btn_update: "CẬP NHẬT VOL", btn_predict: "DỰ ĐOÁN",
        status_running: "ĐANG CHẠY", status_ended: "ĐÃ KẾT THÚC",
        tag_x4: "X4 MẠNG BSC", tag_x2: "X2 MẠNG KHÁC",
        res_win: "THẮNG", res_lose: "THUA",

        // --- MODALS ---
        modal_u_title: "CẬP NHẬT TIẾN ĐỘ", lbl_date: "NGÀY", lbl_my_vol: "VOL CỦA TÔI & KHOẢNG CÁCH", lbl_history: "LỊCH SỬ NHẬP",
        btn_save_prog: "LƯU TIẾN ĐỘ", btn_saving: "ĐANG LƯU...", btn_saved: "ĐÃ LƯU!", ph_vol: "Nhập Vol", ph_cost: "Vốn ($)",
        modal_p_title: "NHẬP DỰ ĐOÁN", modal_p_desc: "Dự đoán Min Volume khi chốt sổ.", lbl_p_name: "TÊN BẠN", lbl_p_guess: "DỰ ĐOÁN (VOL)",
        ph_p_name: "Ví dụ: Shark 1", ph_p_fee: "Phí: 100 USDT", btn_confirm: "XÁC NHẬN & TRẢ PHÍ", btn_processing: "ĐANG XỬ LÝ...",
        modal_l_title: "ĐĂNG NHẬP", modal_l_desc: "Xác thực qua Email OTP", btn_send_code: "GỬI MÃ CODE", btn_verify: "XÁC NHẬN",

        // --- TOAST ---
        toast_login_req: "Vui lòng đăng nhập trước!", toast_success: "Thao tác thành công!", toast_error: "Có lỗi xảy ra!",
        toast_insufficient: "Số dư không đủ!", toast_saved: "Dữ liệu đã được lưu!",

        // --- LEGEND & DISCLAIMER ---
        legend_title: "CHÚ THÍCH BIỂU TƯỢNG",
        // Thay dòng leg_sync cũ bằng dòng này:
leg_feedback_t: "Góp ý / Hỗ trợ", 
leg_feedback_d: "Gửi ý tưởng hoặc báo lỗi trực tiếp cho Admin.",
        leg_reload_t: "Tải lại Dữ liệu", leg_reload_d: "Buộc tải lại toàn bộ dữ liệu từ Cloud.",
        leg_wallet_t: "Quản lý Ví", leg_wallet_d: "Thêm/Xóa danh mục theo dõi.",
        leg_login_t: "Đăng nhập", leg_login_d: "Truy cập bảo mật để lưu dữ liệu.",

        g_title: "CHÚ THÍCH THÔNG SỐ",
        // Đã sửa: Định nghĩa Limit Only
        g_vol: "Chỉ tính Volume sinh ra từ giao dịch Limit (Off-chain) tính từ 00:00 UTC.",
        g_txs: "Tổng số lệnh đã khớp trong ngày.",
        g_speed: "Tốc độ khớp lệnh (Số lệnh trên giây).",
        g_match: "Sức mua trung bình thị trường mỗi giây ($).",
        g_ord: "Giá trị trung bình của 1 lệnh (Cả ngày).",
        g_flow: "Dòng tiền ròng trong 1 phút qua.",
        g_spread: "Biên độ chênh lệch giá Mua/Bán.",
        g_disc: "Dữ liệu tự động. Miễn trừ trách nhiệm: Chỉ mang tính tham khảo. Vui lòng tự nghiên cứu (DYOR) kỹ trước khi ra quyết định."
    },
    zh: {
        // --- CHUNG ---
        nav_guide: "使用指南", nav_login: "登录", nav_logout: "登出",
        sys_time: "系统时间", verified_link: "官方验证链接",

        // --- HERO ---
        hero_title: "锦标赛成交量追踪器",
        hero_sub: "管理您的账户 & 参与预测。",

        // --- SECTION HEADERS ---
        sect_arsenal: "交易平台",
        sect_market: "市场概览",
        stat_top_reward: "最高奖池",
        sect_board: "追踪板",

        // --- STATS ---
        stat_active: "进行中的奖池", stat_pool: "当前总奖池", stat_create: "创建新池",

        // --- SORT ---
        sort_newest: "最新 (开始日期)", sort_ending: "即将结束", sort_reward: "最高奖励 ($)",

        // --- CARD ---
        lbl_top: "排名", lbl_reward: "奖励", lbl_price: "价格",
        lbl_ends: "结束:", lbl_min_target: "最低目标",
        btn_update: "更新成交量", btn_predict: "预测",
        status_running: "进行中", status_ended: "已结束",
        tag_x4: "X4 BSC链", tag_x2: "X2 其他链",
        res_win: "获胜", res_lose: "未中",

        // --- MODALS ---
        modal_u_title: "我的交易追踪", lbl_date: "日期", lbl_my_vol: "我的成交量 & 差距", lbl_history: "历史记录",
        btn_save_prog: "保存进度", btn_saving: "保存中...", btn_saved: "已保存!", ph_vol: "输入成交量", ph_cost: "成本 ($)",
        modal_p_title: "输入预测", modal_p_desc: "预测最终最低成交量。", lbl_p_name: "您的昵称", lbl_p_guess: "预测值 (VOL)",
        ph_p_name: "例如: Shark 1", ph_p_fee: "费用: 100 USDT", btn_confirm: "确认并支付", btn_processing: "处理中...",
        modal_l_title: "安全登录", modal_l_desc: "通过邮箱 OTP 验证", btn_send_code: "发送验证码", btn_verify: "验证登录",

        // --- TOAST ---
        toast_login_req: "请先登录!", toast_success: "操作成功!", toast_error: "发生错误!",
        toast_insufficient: "余额不足!", toast_saved: "数据已保存!",

        // --- LEGEND & DISCLAIMER ---
        legend_title: "图标说明",
        // Thay dòng leg_sync cũ bằng dòng này:
leg_feedback_t: "反馈 / 支持", 
leg_feedback_d: "直接向管理员发送想法或报告错误。",
        leg_reload_t: "重新加载", leg_reload_d: "强制从云数据库重新加载数据。",
        leg_wallet_t: "管理钱包", leg_wallet_d: "添加/删除追踪组合。",
        leg_login_t: "登录", leg_login_d: "安全登录以保存数据。",

        g_title: "指标说明",
        // Đã sửa: Limit Only Definition
        g_vol: "自 UTC 00:00 起仅计算限价交易 (Limit Trading) 的成交量。",
        g_txs: "今日已成交订单总数。",
        g_speed: "成交速度 (每秒订单数)。",
        g_match: "市场每秒平均撮合额 ($)。",
        g_ord: "平均每单价值 (24小时)。",
        g_flow: "过去1分钟的净资金流。",
        g_spread: "买卖价差幅度。",
        g_disc: "自动数据。免责声明：仅供参考，概不负责。请务必自行研究 (DYOR)。"
    }
};

function changeLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('wave_lang', lang);
    let langBtn = document.getElementById('cur-lang-text');
    if(langBtn) langBtn.innerText = lang.toUpperCase();
    applyLanguage();
    renderGrid();
}

function applyLanguage() {
    const t = translations[currentLang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = t[key];
            } else {
                el.innerText = t[key];
            }
        }
    });
    let sortSel = document.getElementById('sortFilter');
    if(sortSel) {
        sortSel.options[0].text = t.sort_newest;
        sortSel.options[1].text = t.sort_ending;
        sortSel.options[2].text = t.sort_reward;
    }
}


    // V45 UX: CUSTOM TOAST SYSTEM
    function showToast(msg, type='info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast-item ${type === 'success' ? 'toast-success' : (type === 'error' ? 'toast-error' : '')}`;

        let icon = type === 'success' ? 'fa-check-circle text-green' : (type === 'error' ? 'fa-exclamation-triangle text-red' : 'fa-info-circle text-brand');

        toast.innerHTML = `<i class="fas ${icon} fa-lg"></i><div style="flex:1; font-size:0.9rem; font-weight:600; font-family:var(--font-main)">${msg}</div>`;

        container.appendChild(toast);
        // Play gentle sound
        if(type === 'error') playSfx('hover');
        else playSfx('click');

        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s forwards';
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    // Override native alert for better UX (Optional, but safe)
    window.alert = function(msg) { showToast(msg, 'info'); };

    // SFX ENGINE (V45)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSfx(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if(type === 'click') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else if(type === 'hover') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            osc.start(); osc.stop(audioCtx.currentTime + 0.05);
        }
    }
    // Attach SFX to common elements
    document.querySelectorAll('button, .tour-card, .arsenal-card, .nav-link').forEach(el => {
        el.addEventListener('mouseenter', () => playSfx('hover'));
        el.addEventListener('click', () => playSfx('click'));
    });
    /* ========================================= */

    let marketChart = null, trackerChart = null, currentPolyId = null, compList = [];
    let siteConfig = { x:'', tele:'', yt:'', affiliate: {} };
    let accSettings = JSON.parse(localStorage.getItem('wave_settings')) || [{id:'acc1', name:'Main', color:'#00F0FF'}, {id:'acc2', name:'Clone', color:'#FFD700'}];
    let currentUser = null;
    let userProfile = null;

    const fmtNum = n => new Intl.NumberFormat('en-US', { maximumFractionDigits: 6 }).format(n);
    const fmt = n => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n).replace('US$', '$').trim();
    const formatCurrency = (input) => {
        let val = input.value.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = val;
        if(input.id === 'u-min-vol') accSettings.forEach(acc => calcRowGap(acc.id));
    };

    if (typeof window.supabase !== 'undefined') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                document.getElementById('loginBtn').classList.add('d-none');
                document.getElementById('userProfile').classList.remove('d-none');
                document.getElementById('userProfile').classList.add('d-flex');

                fetchUserProfile();
                checkUserAdmin();
                bootstrap.Modal.getInstance(document.getElementById('loginModal'))?.hide();
            } else {
                currentUser = null;
                userProfile = null;
                document.getElementById('loginBtn').classList.remove('d-none');
                document.getElementById('userProfile').classList.add('d-none');
                document.getElementById('userProfile').classList.remove('d-flex');
                document.body.classList.remove('is-admin');
            }
        });
        supabase.channel('public:tournaments').on('postgres_changes', { event: '*', schema: 'public', table: 'tournaments' }, payload => { loadFromCloud(false); }).subscribe();
    }

// --- [SỬA LỖI] BIẾN CỜ CHỐNG ĐƠ & AUTO-WAKEUP ---
    let isSyncing = false; 
    let lastWakeupTime = 0;

    // --- [HÀM MỚI] QUÉT DỮ LIỆU THÔNG MINH (ANTI-FREEZE + AUTO-WAKEUP) ---
    async function quickSyncData() {
        // 1. CHỐNG ĐƠ: Nếu lượt trước chưa xong, HỦY lượt này ngay
        if (isSyncing || !supabase) return; 
        isSyncing = true;

        try {
            // Lấy dữ liệu từ DB (Cực nhẹ & Miễn phí)
            const { data, error } = await supabase.from('tournaments').select('*').neq('id', -1);
            
            if (data && data.length > 0) {
                let maxTimestamp = 0;

                // Cập nhật dữ liệu vào biến bộ nhớ (compList)
                data.forEach(newRow => {
                    let localItem = compList.find(c => c.db_id === newRow.id);
                    if (localItem) {
                        let newData = newRow.data || newRow.Data;
                        if (newData) {
                            // Chỉ update các trường số liệu quan trọng
                            if (newData.real_alpha_volume !== undefined) localItem.real_alpha_volume = newData.real_alpha_volume;
                            if (newData.daily_tx_count !== undefined) localItem.daily_tx_count = newData.daily_tx_count;
                            if (newData.real_vol_history) localItem.real_vol_history = newData.real_vol_history;
                            if (newData.market_analysis) localItem.market_analysis = newData.market_analysis;
                            
                            // Kiểm tra thời gian dữ liệu
                            if (newData.last_updated_ts) {
                                localItem.last_updated_ts = newData.last_updated_ts;
                                if (newData.last_updated_ts > maxTimestamp) maxTimestamp = newData.last_updated_ts;
                            }
                        }
                    }
                });

                // Vẽ lại số liệu (Chỉ update số, không vẽ lại khung -> Mượt)
                updateGridValuesOnly();
                if (document.getElementById('healthTableBody')) renderMarketHealthTable();
                renderStats();
                
                // --- 2. CƠ CHẾ TỰ ĐỘNG ĐÁNH THỨC SERVER (AUTO-WAKEUP) ---
                // Nếu dữ liệu cũ quá 5 giây -> Server đang ngủ -> Gọi dậy!
                const now = Date.now();
                if (maxTimestamp > 0 && (now - maxTimestamp > 8000)) {
                    if (now - lastWakeupTime > 15000) { // Chỉ gọi lại sau mỗi 15s để tránh spam
                        console.log("💤 Data cũ, đang gọi Server dậy...");
                        lastWakeupTime = now;
                        handleSmartRefresh(true); // Gọi ngầm
                    }
                }
            }
        } catch (e) { 
            console.error("Sync Error:", e); 
        } finally {
            // Mở khóa
            isSyncing = false; 
            
            // --- 3. QUAN TRỌNG: DÙNG SETTIMEOUT ĐỆ QUY (KHÔNG BAO GIỜ ĐƠ) ---
            // Làm xong việc mới nghỉ 5 giây rồi làm tiếp
            setTimeout(quickSyncData, 5000); 
        }
    }

    function init() {
        checkLegal();
        
        // --- 1. ƯU TIÊN HIỆN CACHE (ĐỂ USER VÀO LÀ THẤY NGAY) ---
        const cachedData = localStorage.getItem('wave_comp_list');
        let hasCache = false;

        if (cachedData) {
            try {
                compList = JSON.parse(cachedData);
                // Có cache -> Vẽ ngay lập tức
                renderGrid();
                renderStats();
                hasCache = true;
                
                // CÓ DỮ LIỆU RỒI MỚI ĐƯỢC TẮT LOADING
                document.getElementById('loading-overlay').style.display = 'none';
                console.log("Loaded from Cache");
            } catch (e) { console.error(e); }
        }

        // --- 2. GỌI DỮ LIỆU MỚI TỪ SERVER ---
        // Nếu ĐÃ có cache (hasCache = true) -> Load ngầm (false), user vẫn xem được web
        // Nếu CHƯA có cache (hasCache = false) -> Hiện loading (true) để user đợi tải xong
        loadFromCloud(!hasCache).then(() => {
            // Tải xong mới bắt đầu kích hoạt vòng lặp cập nhật
            quickSyncData();
            
            // Nếu nãy giờ đang hiện loading thì giờ tắt đi
            if (!hasCache) {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        });

        // 3. Đồng hồ hệ thống (Giữ nguyên)
        setInterval(updateClock, 1000);

        applyLanguage();
        if(document.getElementById('cur-lang-text')) {
            document.getElementById('cur-lang-text').innerText = currentLang.toUpperCase();
        }

        // 4. REALTIME LISTENER (Hỗ trợ nhận tín hiệu tức thì)
        console.log("📡 Kết nối Realtime...");
        if (supabase) {
            const channel = supabase
                .channel('public:tournaments')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'tournaments' }, (payload) => {
                    const newRow = payload.new;
                    if (newRow) {
                        let localItem = compList.find(c => c.db_id === newRow.id);
                        if (localItem) {
                            let newData = newRow.data || newRow.Data;
                            if (newData) Object.assign(localItem, newData);
                        }
                        updateGridValuesOnly();
                        if (document.getElementById('healthTableBody')) renderMarketHealthTable();
                        renderStats();
                    }
                })
                .subscribe();
        }
            
        // Modal hướng dẫn
        if (!localStorage.getItem('wave_guide_seen')) {
            setTimeout(() => {
                const guideEl = document.getElementById('guideModal');
                if(guideEl) new bootstrap.Modal(guideEl).show();
                localStorage.setItem('wave_guide_seen', 'true');
            }, 1500);
        }
    }

        // --- BẮT ĐẦU: REALTIME (VẪN GIỮ ĐỂ NHẬN TÍN HIỆU TỨC THÌ NẾU CÓ) ---
        console.log("📡 Đang khởi động kết nối Realtime...");
        const channel = supabase
            .channel('public:tournaments')
            .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'tournaments' }, (payload) => {
                // Khi có tín hiệu Realtime (từ Edge Function bắn về), cập nhật ngay lập tức
                // (Cái này hỗ trợ cho cái Quick Sync ở trên, giúp dữ liệu luôn tươi mới)
                const newRow = payload.new;
                if (newRow) {
                    let localItem = compList.find(c => c.db_id === newRow.id);
                    if (localItem) {
                        let newData = newRow.data || newRow.Data;
                        if (newData) {
                            if (newData.real_alpha_volume !== undefined) localItem.real_alpha_volume = newData.real_alpha_volume;
                            if (newData.daily_tx_count !== undefined) localItem.daily_tx_count = newData.daily_tx_count;
                            if (newData.real_vol_history) localItem.real_vol_history = newData.real_vol_history;
                            if (newData.market_analysis) localItem.market_analysis = newData.market_analysis;
                            if (newData.last_updated_ts) localItem.last_updated_ts = newData.last_updated_ts;
                        }
                    }
                    updateGridValuesOnly();
                    if (document.getElementById('healthTableBody')) renderMarketHealthTable();
                    renderStats();
                }
            })
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') console.log("✅ Đã kết nối Realtime thành công!");
            });

    // --- HÀM checkAndAutoRefresh (KHÔNG CẦN DÙNG NỮA - ĐỂ TRỐNG) ---
    function checkAndAutoRefresh() {
        // Đã thay thế bằng QuickSync và Realtime
    }

    // --- GIỮ NGUYÊN 2 HÀM NÀY ---
    function checkLegal() {
        if (!localStorage.getItem('wave_legal_accepted')) document.getElementById('legalModal').style.display = 'flex';
    }
    function acceptLegal() {
        localStorage.setItem('wave_legal_accepted', 'true');
        document.getElementById('legalModal').style.display = 'none';
    }

    // --- [FIX V62] FETCH PROFILE & SYNC WALLET SETTINGS ---
async function fetchUserProfile() {
    if(!currentUser) return;
    
    // 1. Lấy dữ liệu từ Cloud
    const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
    
    if(data) {
        userProfile = data;
        
        // Hiển thị tên & số dư
        document.getElementById('userNameDisplay').innerText = data.nickname || currentUser.email.split('@')[0];
        let bal = data.balance_usdt !== null ? data.balance_usdt : 0;
        document.getElementById('user-balance').innerText = fmtNum(bal);
        userProfile.balance_usdt = bal;

        checkDailyBonus();

        // 2. LẤY DỮ LIỆU TRACKER
        userProfile.tracker_data = data.tracker_data || {};

        // --- [FIX QUAN TRỌNG] ĐỒNG BỘ CẤU HÌNH VÍ TỪ CLOUD ---
        // Chúng ta quy ước key 'meta_wallets' trong tracker_data sẽ chứa cấu hình ví
        if (userProfile.tracker_data && userProfile.tracker_data.meta_wallets) {
            // Nếu trên Cloud có cấu hình ví -> Tải về máy dùng ngay
            accSettings = userProfile.tracker_data.meta_wallets;
            // Lưu đè vào LocalStorage để đồng bộ
            localStorage.setItem('wave_settings', JSON.stringify(accSettings));
        } else {
            // Nếu trên Cloud chưa có (User mới) -> Lấy từ LocalStorage hiện tại đẩy lên Cloud lần đầu
            // Để giữ lại các ví user đang dùng
            updateCloudWallets(); 
        }

        // 3. Avatar
        if(data.avatar_url) {
            document.getElementById('nav-avatar').src = data.avatar_url;
            document.getElementById('nav-avatar').style.display = 'block';
        } else {
            document.getElementById('nav-avatar').style.display = 'none';
        }

        // 4. Vẽ lại giao diện với cấu hình ví chuẩn của User đó
        renderGrid();
    }
}

    // V45 RETENTION: DAILY BONUS LOGIC
    async function checkDailyBonus() {
        if(!currentUser || !userProfile) return;
        const today = new Date().toISOString().split('T')[0];
        const lastClaimKey = 'wave_daily_claim_' + currentUser.id;
        const lastClaim = localStorage.getItem(lastClaimKey);

        if(lastClaim !== today) {
            const bonus = 100;
            const newBal = (userProfile.balance_usdt || 0) + bonus;

            // Optimistic UI Update
            userProfile.balance_usdt = newBal;
            document.getElementById('user-balance').innerText = fmtNum(newBal);

            showToast(`🎉 Daily Login Bonus: +${bonus} USDT!`, 'success');
            localStorage.setItem(lastClaimKey, today);

            // Sync to DB silently
            await supabase.from('profiles').update({ balance_usdt: newBal }).eq('id', currentUser.id);
        }
    }

    function openProfileModal() {
        if(!currentUser) return;
        document.getElementById('pf-nickname').value = userProfile?.nickname || '';
        document.getElementById('pf-avatar-url').value = userProfile?.avatar_url || '';

        let preview = document.getElementById('pf-preview');
        let placeholder = document.getElementById('pf-placeholder');
        if(userProfile?.avatar_url) {
            preview.src = userProfile.avatar_url;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            preview.style.display = 'none';
            placeholder.style.display = 'block';
        }
        new bootstrap.Modal(document.getElementById('profileModal')).show();
    }

    // V45 UPGRADE: Real Storage Upload
    async function handleFileUpload(input) {
        if(!input.files || input.files.length === 0) return;
        if(!currentUser) return showToast("Please Login", "error");

        const file = input.files[0];
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;

        let placeholder = document.getElementById('pf-placeholder');
        let loader = document.getElementById('upload-loading');
        loader.style.display = 'flex';

        try {
            const { error: uploadError } = await supabase.storage.from('avatars').upload(fileName, file);
            if(uploadError) throw uploadError;

            const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(fileName);

            await supabase.from('profiles').update({ avatar_url: publicUrl }).eq('id', currentUser.id);

            document.getElementById('pf-avatar-url').value = publicUrl;
            document.getElementById('pf-preview').src = publicUrl;
            document.getElementById('pf-preview').style.display = 'block';
            placeholder.style.display = 'none';
            loader.style.display = 'none';
            showToast("Avatar updated successfully!", "success");
        } catch (error) {
            showToast("Upload failed: " + error.message, "error");
            loader.style.display = 'none';
        }
    }

    async function saveProfile() {
        const nickname = document.getElementById('pf-nickname').value.trim();
        const avatar_url = document.getElementById('pf-avatar-url').value.trim();
        const btn = document.getElementById('btn-save-profile');
        if(!nickname) return showToast("Nickname required", "error");
        btn.innerText = "SAVING..."; btn.disabled = true;
        const updates = { id: currentUser.id, nickname, avatar_url };
        const { error } = await supabase.from('profiles').upsert(updates);
        btn.innerText = "SAVE CHANGES"; btn.disabled = false;
        if(error) {
            if(error.code === '23505') showToast("Nickname already taken!", "error");
            else showToast(error.message, "error");
        } else {
            fetchUserProfile();
            bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            showToast("Profile Saved!", "success");
        }
    }

    // --- HÀM UPLOAD ẢNH CHUNG (Dùng cho cả Brand & Project) ---
    async function uploadImage(input, previewId, valueId) {
        if (!input.files || input.files.length === 0) return;
        let previewEl = document.getElementById(previewId);
        previewEl.style.opacity = '0.5';

        try {
            const file = input.files[0];
            const fileExt = file.name.split('.').pop();
            const fileName = `img_${Date.now()}_${Math.floor(Math.random()*1000)}.${fileExt}`;
            const { error } = await supabase.storage.from('avatars').upload(fileName, file);
            if (error) throw error;
            const { data } = supabase.storage.from('avatars').getPublicUrl(fileName);
            const publicUrl = data.publicUrl;
            document.getElementById(valueId).value = publicUrl;
            previewEl.src = publicUrl;
            previewEl.style.display = 'block';
            previewEl.style.opacity = '1';
        } catch (e) {
            showToast("Upload Error: " + e.message, "error");
            previewEl.style.opacity = '1';
        }
    }

    function openLoginModal() { resetLoginModal(); new bootstrap.Modal(document.getElementById('loginModal')).show(); }
    function resetLoginModal() { document.getElementById('login-step-1').style.display = 'block'; document.getElementById('login-step-2').style.display = 'none'; document.getElementById('otp-token').value = ''; }

    async function sendOtpCode() {
        const email = document.getElementById('otp-email').value.trim();
        if(!email) return showToast("Please enter email", "error");
        let btn = document.querySelector('#login-step-1 button');
        let oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SENDING...'; btn.disabled = true;
        try {
            const { error } = await supabase.auth.signInWithOtp({ email: email, options: { shouldCreateUser: true } });
            if (error) throw error;
            document.getElementById('login-step-1').style.display = 'none';
            document.getElementById('login-step-2').style.display = 'block';
            setTimeout(() => document.getElementById('otp-token').focus(), 500);
            showToast("OTP Code sent to " + email, "success");
        } catch (e) { showToast("Error sending code: " + e.message, "error"); }
        finally { btn.innerHTML = oldText; btn.disabled = false; }
    }

    async function verifyOtpCode() {
        const email = document.getElementById('otp-email').value.trim();
        const token = document.getElementById('otp-token').value.trim();
        if(!token) return showToast("Enter code", "error");
        let btn = document.querySelector('#login-step-2 button');
        let oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFYING...'; btn.disabled = true;
        try {
            const { data, error } = await supabase.auth.verifyOtp({ email, token, type: 'email' });
            if (error) {
                console.log("Retrying with signup type...");
                const { data: data2, error: error2 } = await supabase.auth.verifyOtp({ email, token, type: 'signup' });
                if (error2) throw error;
            }
            window.location.reload();
        } catch (e) { showToast("Invalid Code or Expired.", "error"); btn.innerHTML = oldText; btn.disabled = false; }
    }

    async function handleLogout() { 
    await supabase.auth.signOut(); 
    
    // --- [FIX] XÓA SẠCH DỮ LIỆU CỤC BỘ KHI LOGOUT ---
    localStorage.removeItem('wave_settings'); // Xóa cấu hình ví
    // Có thể xóa thêm các key khác nếu muốn sạch hơn
    
    window.location.reload(); 
}
    function checkUserAdmin() {
        if(currentUser && ADMIN_EMAILS.includes(currentUser.email)) document.body.classList.add('is-admin');
        else document.body.classList.remove('is-admin');
        renderGrid();
    }

    // --- PHIÊN BẢN SỬA LỖI: LUÔN HIỂN THỊ GIAO DIỆN ---
    async function loadFromCloud(showLoading = true) {
        if(showLoading) document.getElementById('loading-overlay').style.display = 'flex';
        
        try {
            // 1. Gọi dữ liệu
            const { data, error } = await supabase
                .from('tournaments')
                .select('*')
                .order('id', { ascending: true });

            // 2. Nếu có lỗi mạng/server -> Ném lỗi xuống dưới để xử lý, KHÔNG IM LẶNG
            if (error) throw error;

            // 3. Xử lý dữ liệu
            compList = [];
            if (data && data.length > 0) {
                data.forEach(row => {
                    if(row.id === -1) {
                        // Config hệ thống
                        siteConfig = row.data || { x:'', tele:'', yt:'', affiliate:{} };
                        if(!siteConfig.affiliate) siteConfig.affiliate = {};
                        renderFooter();
                        renderArsenal(); 
                    }
                    else {
                        // Dữ liệu giải đấu
                        let item = row.data || row.Data;
                        if (item) {
                            item.db_id = row.id; item.id = item.db_id;
                            // Fix lỗi thiếu trường dữ liệu quan trọng
                            if(!item.name && row.name) item.name = row.name;
                            if(!item.contract && row.contract) item.contract = row.contract;
                            compList.push(item);
                        }
                    }
                });
                
                // Lưu cache để lần sau vào nhanh hơn
                localStorage.setItem('wave_comp_list', JSON.stringify(compList));
            }

        } catch (err) {
            console.error("Lỗi tải dữ liệu:", err);
            // Nếu lỗi, thử dùng dữ liệu cũ trong LocalStorage để cứu vãn
            const cached = localStorage.getItem('wave_comp_list');
            if(cached) {
                console.log("Đang dùng dữ liệu Cache cũ do lỗi mạng...");
                compList = JSON.parse(cached);
            }
            // Hiện thông báo nhỏ góc màn hình (Toast) thay vì Alert
            showToast("Server connection unstable: " + (err.message || "Unknown error"), "error");
        } finally {
            // --- QUAN TRỌNG NHẤT: LUÔN LUÔN VẼ LẠI GIAO DIỆN ---
            // Dù thành công hay thất bại, dòng này vẫn chạy để hiện thẻ bài hoặc hiện chữ "Empty List"
            renderGrid();
            renderStats();
            initCalendar();
            // Tắt màn hình loading
            if(showLoading) document.getElementById('loading-overlay').style.display = 'none';
            
            // Cập nhật giá coin ngầm (chạy sau cùng)
            updateAllPrices();
        }
    }

        // --- CẬP NHẬT: PHÂN CHIA 2 HÀNG (CEX & DEX/WEB3) ---
        // --- BƯỚC 4: HÀM HIỂN THỊ DANH SÁCH ĐỘNG (ĐỌC TỪ CONFIG) ---
    function renderArsenal() {
        const container = document.getElementById('arsenal-grid');
        if(!container) return;

        // 1. Reset container
        container.className = '';
        container.innerHTML = '';

        // 2. LẤY DỮ LIỆU TỪ CẤU HÌNH ĐÃ LƯU (Quan trọng!)
        // Nếu chưa có dữ liệu thì dùng mảng rỗng
        let exchanges = siteConfig.arsenal_items || [];

        // 3. Nếu danh sách trống và là Admin -> Hiện nút nhắc nhở thêm sàn
        if(exchanges.length === 0) {
            if(document.body.classList.contains('is-admin')) {
                container.innerHTML = `<div class="col-12 text-center text-sub border border-dashed border-secondary p-3 rounded" onclick="openConfigModal()" style="cursor:pointer; font-size:0.8rem">Admin: Click to Add Trading Platforms</div>`;
            }
            return;
        }

        // 4. Phân loại CEX và DEX
        const listCEX = exchanges.filter(e => e.type === 'EXCHANGE');
        const listDEX = exchanges.filter(e => e.type !== 'EXCHANGE');

        // Hàm hỗ trợ vẽ thẻ
        const generateCards = (list) => {
            let html = '';
            list.forEach(ex => {
                // Chỉ hiện nếu có Link Ref
                if(ex.link) {
                    // Dùng logo mặc định nếu user chưa up logo
                    // (Tạo ảnh placeholder bằng chữ cái đầu của tên sàn)
                    let logoUrl = ex.logo || 'https://placehold.co/50x50/333/999?text=' + ex.name.charAt(0).toUpperCase();

                    html += `
                    <div class="arsenal-card" onclick="trackAffiliateClick('${ex.name}'); window.open('${ex.link}', '_blank'); playSfx('click')">
                        <img src="${logoUrl}" class="ex-logo">
                        <div class="ex-info">
                            <div class="ex-name">${ex.name}</div>
                            <div class="ex-bonus" style="opacity: 0.7; font-weight: normal;">${ex.type}</div>
                        </div>
                    </div>`;
                }
            });
            return html;
        };

        // 5. Render ra HTML
        let cexHtml = generateCards(listCEX);
        let dexHtml = generateCards(listDEX);

        // Hiển thị nhóm CEX
        if (cexHtml) {
            container.innerHTML += `<div class="text-sub small fw-bold mb-2 ps-1 text-uppercase" style="letter-spacing:1px; font-size:0.7rem"><i class="fas fa-building me-2"></i> CENTRALIZED EXCHANGES (CEX)</div>`;
            container.innerHTML += `<div class="arsenal-grid mb-4">${cexHtml}</div>`;
        }

        // Hiển thị nhóm DEX/WEB3
        if (dexHtml) {
            container.innerHTML += `<div class="text-sub small fw-bold mb-2 ps-1 text-uppercase" style="letter-spacing:1px; font-size:0.7rem"><i class="fas fa-wallet me-2"></i> DECENTRALIZED & WEB3</div>`;
            container.innerHTML += `<div class="arsenal-grid mb-2">${dexHtml}</div>`;
        }
    }


    // New Tracking Function
    function trackAffiliateClick(exchangeId) {
        console.log("Tracking Click:", exchangeId);
        // Gửi sự kiện lên GA4 (nếu đã config)
        if(typeof gtag === 'function') {
            gtag('event', 'click_affiliate', {
                'event_category': 'monetization',
                'event_label': exchangeId
            });
        }
    }

        // --- CẬP NHẬT: TỰ ĐỘNG SỬA LINK NẾU THIẾU HTTPS ---
    function renderFooter() {
        const c = document.getElementById('footer-socials-container');
        c.innerHTML = '';

        // Hàm nhỏ giúp kiểm tra và thêm https:// nếu thiếu
        const fixUrl = (url) => {
            if (!url) return '';
            // Nếu chưa có http hoặc https thì tự thêm vào
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                return 'https://' + url;
            }
            return url;
        };

        if(siteConfig.x) c.innerHTML += `<a href="${fixUrl(siteConfig.x)}" target="_blank" class="social-btn"><i class="fab fa-twitter"></i></a>`;
        if(siteConfig.tele) c.innerHTML += `<a href="${fixUrl(siteConfig.tele)}" target="_blank" class="social-btn"><i class="fab fa-telegram-plane"></i></a>`;
        if(siteConfig.yt) c.innerHTML += `<a href="${fixUrl(siteConfig.yt)}" target="_blank" class="social-btn"><i class="fab fa-youtube"></i></a>`;

        // Render Brand Logo (Giữ nguyên phần logo)
        const brandImg = document.getElementById('nav-brand-img');
        const brandText = document.getElementById('nav-brand-text');
        if(brandText) brandText.style.display = 'block';
        if(siteConfig.brandLogo) {
            brandImg.src = siteConfig.brandLogo;
            brandImg.style.display = 'block';
        } else {
            brandImg.style.display = 'none';
        }
    }


                function openConfigModal() {
        // ... (Phần Socials & Logo cũ giữ nguyên) ...
        document.getElementById('cfg-x').value = siteConfig.x || '';
        document.getElementById('cfg-tele').value = siteConfig.tele || '';
        document.getElementById('cfg-yt').value = siteConfig.yt || '';
        document.getElementById('cfg-logo-url').value = siteConfig.brandLogo || '';
        let img = document.getElementById('cfg-logo-preview');
        if(siteConfig.brandLogo) { img.src = siteConfig.brandLogo; img.style.display = 'block'; }
        else { img.style.display = 'none'; }

        // --- LOAD DANH SÁCH SÀN ĐỘNG ---
        // Lấy danh sách từ config, nếu chưa có thì dùng mảng rỗng
        let arsenalList = siteConfig.arsenal_items || [];
        renderArsenalInputs(arsenalList);

        new bootstrap.Modal(document.getElementById('configModal')).show();
    }


                async function saveGlobalConfig() {
        // 1. Quét dữ liệu từ danh sách động
        let arsenalItems = [];
        document.querySelectorAll('.arsenal-item-row').forEach(row => {
            arsenalItems.push({
                name: row.querySelector('.inp-name').value,
                link: row.querySelector('.inp-link').value,
                type: row.querySelector('.inp-type').value,
                logo: row.querySelector('.inp-logo').value
            });
        });

        // 2. Tạo object Config mới
        const newData = {
            x: document.getElementById('cfg-x').value,
            tele: document.getElementById('cfg-tele').value,
            yt: document.getElementById('cfg-yt').value,
            brandLogo: document.getElementById('cfg-logo-url').value,

            // Lưu mảng danh sách sàn vào đây
            arsenal_items: arsenalItems
        };

       await supabase.from('tournaments').upsert({ id: -1, name: 'CONFIG', contract: 'CONFIG', data: newData });

bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
loadFromCloud(false);
showToast("Configuration saved!", "success"); // Đã sửa dòng này
}



    // --- BIẾN TOÀN CỤC ĐỂ LƯU Ô THẾ THÂN ---
    let activeCardClonePlaceholder = null; 

    function toggleCardHighlight(el) {
        // Nếu thẻ đang mở -> Click lại thì đóng
        if (el.classList.contains('active-card')) {
            closeActiveCard();
            return;
        }
        // Nếu có thẻ khác đang mở -> Đóng thẻ đó trước
        if (document.querySelector('.tour-card.active-card')) {
            closeActiveCard();
        }

        // 1. TẠO Ô THẾ THÂN (Placeholder)
        // Lấy chiều cao thực tế của thẻ hiện tại để tạo ô trống y hệt
        activeCardClonePlaceholder = document.createElement('div');
        activeCardClonePlaceholder.className = 'tour-card-placeholder';
        activeCardClonePlaceholder.style.height = el.offsetHeight + 'px'; 
        
        // 2. CHÈN Ô THẾ THÂN VÀO VỊ TRÍ CŨ
        el.parentNode.insertBefore(activeCardClonePlaceholder, el);

        // 3. BIẾN THẺ THẬT THÀNH FIXED (Nổi lên giữa màn hình)
        el.classList.add('active-card');
        
        // 4. HIỆN MÀN HÌNH ĐEN
        const backdrop = document.getElementById('card-backdrop');
        if(backdrop) {
            backdrop.style.display = 'block';
            setTimeout(() => backdrop.classList.add('show'), 10);
        }
        document.body.classList.add('has-active-card');
    }

    function closeActiveCard() {
        const activeEl = document.querySelector('.tour-card.active-card');
        if (!activeEl) return;

        // 1. Bỏ class active (để nó hết fixed)
        activeEl.classList.remove('active-card');

        // 2. Xóa ô thế thân đi
        if (activeCardClonePlaceholder) {
            activeCardClonePlaceholder.remove();
            activeCardClonePlaceholder = null;
        }

        // 3. Ẩn màn hình đen
        const backdrop = document.getElementById('card-backdrop');
        if(backdrop) {
            backdrop.classList.remove('show');
            setTimeout(() => backdrop.style.display = 'none', 300);
        }
        document.body.classList.remove('has-active-card');
    }

        /* --- [V46] SMART REFRESH SYSTEM (Anti-Spam) --- */
    let lastRefreshTime = 0;
    const REFRESH_COOLDOWN = 10000; // 10 giây

    // --- [FIXED FINAL] SMART REFRESH: KHÔNG BAO GIỜ GỌI RELOAD KHI ĐANG CHẠY NGẦM ---
async function handleSmartRefresh(isSilent = false) {
    const now = Date.now();
    if (!isSilent) {
        if (now - lastRefreshTime < REFRESH_COOLDOWN) {
            showToast(`Please wait ${Math.ceil((REFRESH_COOLDOWN - (now - lastRefreshTime)) / 1000)}s!`, "error");
            return;
        }
    }
    lastRefreshTime = now;

    const icon = document.querySelector('.fa-sync-alt');
    if (!isSilent) {
        if(icon) icon.classList.add('fa-spin');
        showToast("Syncing market data...", "info");
    }

    try {
        const { data, error } = await supabase.functions.invoke('refresh-volume');
        if (error) throw error;

        if (data && data.success) {
            if (data.updatedItems && Array.isArray(data.updatedItems)) {
                // Cập nhật dữ liệu vào biến bộ nhớ
                data.updatedItems.forEach(newItem => {
                    let localItem = compList.find(c => c.db_id === newItem.id);
                    if (localItem) {
                        if(newItem.data.real_alpha_volume) localItem.real_alpha_volume = newItem.data.real_alpha_volume;
                        if(newItem.data.daily_tx_count) localItem.daily_tx_count = newItem.data.daily_tx_count; // Cập nhật Tx
                        if(newItem.data.real_vol_history) localItem.real_vol_history = newItem.data.real_vol_history;
                        if(newItem.data.last_updated_ts) localItem.last_updated_ts = newItem.data.last_updated_ts;
                        if(newItem.data.market_analysis) localItem.market_analysis = newItem.data.market_analysis;
                    }
                });

                // CHỈ CẬP NHẬT SỐ - KHÔNG VẼ LẠI GIAO DIỆN CHÍNH
                updateGridValuesOnly();      
                renderMarketHealthTable();   
                renderStats();               
                
                if (!isSilent) showToast(`Market Data Updated!`, "success");
            } else {
                // Nếu server trả về success nhưng không có data thay đổi
                // Nếu là Silent Mode -> TUYỆT ĐỐI KHÔNG RELOAD -> GIỮ ĐỒNG HỒ ĐỨNG IM
                if (!isSilent) await loadFromCloud(false); 
            }
        }
    } catch (e) {
        console.error(e);
        // Nếu lỗi khi chạy ngầm -> IM LẶNG LUÔN (Không reload, không thông báo)
        if (!isSilent) showToast("Sync Error: " + e.message, "error");
    } finally {
        if(icon) icon.classList.remove('fa-spin');
    }
}

    async function updateAllPrices() {
        // --- GIẢI PHÁP 1: GỌI API SONG SONG (SIÊU TỐC) ---
        // Thay vì chờ từng cái (tuần tự), ta bắn request lấy giá cho TẤT CẢ cùng lúc
        const promises = compList.map(async (c) => {
            if(c.contract) {
                try {
                    // Gọi API DexScreener
                    let r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${c.contract}`);
                    let d = await r.json();
                    if(d.pairs && d.pairs.length > 0) {
                        c.cachedPrice = d.pairs[0].priceUsd;
                    }
                } catch(e) {
                    console.warn(`Failed to fetch price for ${c.name}`);
                }
            }
        });

        // Chờ tất cả các request chạy xong cùng một lúc (chỉ mất ~0.5s thay vì 5-10s)
        await Promise.all(promises);

        // Sau khi có giá mới thì vẽ lại lưới và thanh thống kê một lần nữa
        renderGrid();
        renderStats();
        
        // Cập nhật lại Cache lần nữa để lưu giá mới nhất vào máy người dùng
        // Lần sau F5 là có giá này hiện ra ngay lập tức
        localStorage.setItem('wave_comp_list', JSON.stringify(compList));
    }


            /* --- HÀM VẼ BIỂU ĐỒ V49 (REVERT: TOTAL VOL + MIN TARGET) --- */
    let volHistChart = null;

    function openVolHistory(dbId) {
        let c = compList.find(x => x.db_id == dbId);
        if(!c) return;

        document.getElementById('vh-title').innerText = c.name + " ANALYTICS";
        document.getElementById('vh-subtitle').innerText = "Correlation: Total Vol vs Min Target";

        // 1. LẤY DỮ LIỆU
        let realHistory = c.real_vol_history || [];
        let minHistory = c.history || [];

        let allDates = new Set([
            ...realHistory.map(x => x.date),
            ...minHistory.map(x => x.date)
        ]);

        let isRunning = true;
        if(c.end) {
            let todayStr = new Date().toISOString().split('T')[0];
            if (todayStr > c.end) isRunning = false;
        }

        if (allDates.size === 0 && isRunning) {
            allDates.add(new Date().toISOString().split('T')[0]);
        }

        let sortedDates = Array.from(allDates).sort((a,b) => new Date(a) - new Date(b));

        // --- LỌC BỎ NGÀY SAU KHI KẾT THÚC ---
        if (c.end) {
            sortedDates = sortedDates.filter(d => d <= c.end);
        }


        // Lấy 10 ngày gần nhất
        let recentDates = sortedDates.slice(-10);

        let labels = [];
        let dataReal = [];
        let dataMin = [];
        
        // Lấy ngày hiện tại (YYYY-MM-DD) để so sánh
        let todayStr = new Date().toISOString().split('T')[0];

        recentDates.forEach(date => {
            let parts = date.split('-');
            labels.push(`${parts[2]}/${parts[1]}`);

            // 1. XỬ LÝ TOTAL VOL (CỘT) - VẼ BÌNH THƯỜNG
            let rItem = realHistory.find(x => x.date === date);
            let rVal = rItem ? rItem.vol : 0;
            
            // Nếu là hôm nay mà chưa có trong history thì lấy số Real-time
            if (!rItem && date === todayStr && isRunning) {
                rVal = c.real_alpha_volume || 0;
            }
            dataReal.push(rVal);

            // 2. XỬ LÝ MIN TARGET (ĐƯỜNG) - CẮT NẾU LÀ HÔM NAY
            let mItem = minHistory.find(x => x.date === date);
            let mVal = mItem ? parseFloat(mItem.target) : 0;

            // LOGIC MỚI: 
            // Nếu là ngày hôm nay (date === todayStr) VÀ Giá trị = 0 (Binance chưa cập nhật)
            // Thì đẩy vào 'null'. ChartJS sẽ tự động ngắt nét vẽ tại điểm này.
            if (date === todayStr && mVal === 0) {
                dataMin.push(null); 
            } else {
                dataMin.push(mVal);
            }
        });

        // 3. VẼ CHART
        new bootstrap.Modal(document.getElementById('volHistoryModal')).show();

        const ctx = document.getElementById('volHistoryChart').getContext('2d');
        if (volHistChart) volHistChart.destroy();

        // Màu Gradient Cyberpunk
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(0, 240, 255, 0.6)');
        gradient.addColorStop(1, 'rgba(0, 240, 255, 0.05)');

        volHistChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total Vol',
                        data: dataReal,
                        type: 'bar',
                        backgroundColor: gradient,
                        borderColor: '#00F0FF',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.5,
                        order: 2,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Min Target',
                        data: dataMin,
                        type: 'line',
                        borderColor: '#F0B90B', // Vàng
                        backgroundColor: '#F0B90B',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#000',
                        pointBorderColor: '#F0B90B',
                        tension: 0.3,
                        order: 1,
                        yAxisID: 'y1',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#848e9c', font: { family: 'Rajdhani', size: 11, weight: 'bold' } } },
                    y: {
                        type: 'linear', display: true, position: 'left',
                        grid: { color: '#2b3139', borderDash: [4, 4] },
                        ticks: { color: '#00F0FF', font: { family: 'Rajdhani', size: 10 }, callback: function(v) { return v>=1000000?(v/1000000).toFixed(1)+'M':(v>=1000?(v/1000).toFixed(0)+'k':v); } }
                    },
                    y1: {
                        type: 'linear', display: true, position: 'right', grid: { display: false },
                        ticks: { color: '#F0B90B', font: { family: 'Rajdhani', size: 10, weight: 'bold' }, callback: function(v) { return v>=1000000?(v/1000000).toFixed(1)+'M':(v>=1000?(v/1000).toFixed(0)+'k':v); } }
                    }
                },
                plugins: {
                    legend: { display: true, labels: { color: '#fff', font: { size: 10 }, boxWidth: 10 } },
                    tooltip: {
                        backgroundColor: 'rgba(22, 26, 30, 0.95)', titleColor: '#fff', bodyColor: '#fff', borderColor: '#333', borderWidth: 1, padding: 10,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                let val = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(context.raw);
                                return ` ${label}: $${val}`;
                            }
                        }
                    }
                }
            }
        });
    }



    // --- [V59 FINAL] RENDER GRID: UTC TIME STANDARD ---
function renderGrid(customData = null) {
    const grid = document.getElementById('appGrid');
    if(!grid) return;
    
    let listToRender = customData ? customData : compList;

    listToRender.sort((a,b) => {
        let posA = (a.orderIndex !== undefined && a.orderIndex !== null) ? a.orderIndex : 9999;
        let posB = (b.orderIndex !== undefined && b.orderIndex !== null) ? b.orderIndex : 9999;
        return posA - posB;
    });

    if(listToRender.length === 0) {
        grid.innerHTML = `<div class="col-12 text-center py-5 opacity-50"><i class="fas fa-calendar-times fa-3x mb-3 text-sub"></i><h5 class="text-sub font-num">NO DATA FOUND</h5><button class="btn btn-sm btn-outline-secondary mt-2 rounded-pill px-4" onclick="filterByDate(null)">Show All</button></div>`;
        return;
    }

    const isAdmin = document.body.classList.contains('is-admin');
    document.querySelectorAll('.btn-save-pos').forEach(btn => btn.style.display = isAdmin ? 'block' : 'none');

    let fullHtml = '';
    let now = new Date();

    listToRender.forEach(c => {
        try {
            // --- [FIX QUAN TRỌNG] THÊM 'Z' ĐỂ HIỂU LÀ GIỜ UTC ---
            // Nếu c.endTime thiếu, mặc định là cuối ngày UTC
            let timeString = (c.endTime || '23:59:59');
            // Ghép chuỗi chuẩn ISO 8601 (YYYY-MM-DDTHH:mm:ssZ)
            let endDateTime = new Date(c.end + 'T' + timeString + 'Z');

            let status = endDateTime > now ? 'running' : 'ended';
            let cardClass = status === 'ended' ? 'tour-card ended-card' : 'tour-card';
            
            // --- 1. ĐỒNG HỒ KẾT THÚC GIẢI (BÊN TRÁI) ---
            let tourTimerHtml = '';
            if(c.end) {
                let diff = endDateTime - now;
                let tText = "Ended";
                
                if (diff > 0) {
                    let d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    let h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    let m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    
                    if (d > 0) tText = `${d}d ${h}h`; 
                    else tText = `${h}h ${m}m`;
                }
                
                let tColor = (diff < 86400000 && diff > 0) ? '#F6465D' : '#999'; 
                tourTimerHtml = `<div class="tour-end-timer" style="color:${tColor}"><i class="far fa-clock" style="font-size:0.6rem"></i> ${tText}</div>`;
            }

            // --- 2. ĐỒNG HỒ KHUYẾN MÃI X4/X2 (BÊN PHẢI) ---
            let promoTimerHtml = '';
            let isListingExpired = false;

            if (c.listingTime && c.alphaType !== 'none') {
                // Listing Time trong DB thường lưu dạng "YYYY-MM-DDTHH:mm" (Local input)
                // Ta cũng nên thêm 'Z' nếu muốn chuẩn UTC, hoặc để tự nhiên nếu muốn tính theo giờ máy admin.
                // Tốt nhất là chuẩn hóa UTC luôn:
                let listingDate = new Date(c.listingTime + 'Z'); 
                // Nếu input datetime-local không có giây, + 'Z' vẫn chạy tốt.
                
                // Fallback nếu ngày bị lỗi (do input cũ không đúng chuẩn)
                if(isNaN(listingDate.getTime())) listingDate = new Date(c.listingTime);

                let expiryDate = new Date(listingDate.getTime() + (30 * 24 * 60 * 60 * 1000)); 
                let diff = expiryDate - now;

                if (diff > 0) {
                    let d = Math.floor(diff / (1000 * 60 * 60 * 24));
                    let h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    promoTimerHtml = `<div class="promo-timer" title="Promo expires in"><i class="fas fa-bolt" style="font-size:0.6rem"></i> ${d}d ${h}h</div>`;
                } else {
                    isListingExpired = true; 
                }
            }
            
            if (status === 'ended') isListingExpired = true;

            // TAGS & RULES
            let tagHtml = '';
            if (!isListingExpired) {
                if (c.alphaType === 'x4') tagHtml = `<div class="tag-x4">X4 BSC</div>`;
                else if (c.alphaType === 'x2') { cardClass += ' highlight-x2'; tagHtml = `<div class="tag-x2">X2 OTHER</div>`; }
            } else { 
                tagHtml = `<div class="${c.alphaType==='x4'?'tag-x4':'tag-x2'} tag-expired">${c.alphaType==='x4'?'X4 BSC':'X2 OTHER'}</div>`; 
                promoTimerHtml = ''; 
            }
            
            if ((c.inputTokens||[]).length > 0) tagHtml = `<div class="tag-x2" style="background:#9945FF; color:#fff; border:none; box-shadow:0 0 5px #9945FF">ECOSYSTEM</div>`;
            if (c.alphaType === 'x4' && !isListingExpired && !(c.inputTokens||[]).length && status === 'running') cardClass += ' highlight-x4';

            let ruleHtml = c.ruleType === 'trade_x4' ? `<div class="rule-pill rp-x4"><i class="fas fa-bolt text-gold" style="font-size:0.55rem"></i> ALL VOL <span class="x4-box">x4</span></div>` : `<div class="rule-pill rp-buy"><i class="fas fa-arrow-up" style="font-size:0.55rem"></i> ONLY BUY</div>`;
            if(status === 'ended') ruleHtml = ruleHtml.replace('rule-pill', 'rule-pill opacity-50 grayscale');

            let adminEditBtn = isAdmin ? `<i class="fas fa-pencil-alt ms-2 text-sub cursor-pointer hover-white" style="font-size:0.7rem" onclick="openEditModal('${c.db_id}')"></i>` : '';
            let dragAttr = (isAdmin) ? `draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"` : '';
            let dragHandleHtml = (isAdmin) ? `<i class="fas fa-grip-vertical admin-drag-handle" title="Kéo để sắp xếp"></i>` : '';
            let isPerfect = (c.market_analysis?.label && c.market_analysis.label.includes("PERFECT"));
            let rocketBadgeHtml = isPerfect ? `<div class="rocket-badge"><i class="fas fa-rocket"></i> GEM</div>` : "";
            if(isPerfect) cardClass += " card-perfect";

            // Các chỉ số
            let realVol = c.real_alpha_volume || 0;
            let realVolDisplay = realVol > 0 ? '$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(realVol) : '---';
            let realVolColor = realVol > 0 ? '#d0aaff' : '#666';
            let target = (c.history && c.history.length > 0) ? parseFloat(c.history[c.history.length-1].target) : 0;
            let priceStr = (c.cachedPrice > 0) ? '$' + parseFloat(c.cachedPrice).toLocaleString('en-US', { maximumFractionDigits: 6 }) : '---';
            let estVal = (parseFloat(c.rewardQty)||0) * (c.cachedPrice||0);
            let estHtml = estVal > 0 ? `<span class="text-green small fw-bold ms-1 anim-breathe live-est-val" data-qty="${c.rewardQty}">~$${new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(estVal)}</span>` : '<span class="live-est-val" data-qty="'+(c.rewardQty||0)+'"></span>';

            // HTML
            fullHtml += `
            <div class="col-md-6 col-lg-4 col-xl-3 card-wrapper" ${dragAttr} data-id="${c.db_id}">
                <div class="${cardClass}" onclick="playSfx('click'); toggleCardHighlight(this)">
                    <div class="card-head">
                        ${rocketBadgeHtml}
                        <div class="token-info-wrapper">
                            ${dragHandleHtml}
                            <img src="${c.logo || 'https://placehold.co/40x40/222'}" class="token-logo" onclick="event.stopPropagation(); window.open('https://www.binance.com/en/alpha/${c.chain}/${c.contract}', '_blank')">
                            <div class="token-text">
                                <div class="token-title">${c.name}</div>
                                ${status==='running' ? `<div class="token-status anim-breathe text-green">RUNNING</div>` : `<div class="token-status text-red">ENDED</div>`}
                                ${tourTimerHtml}
                            </div>
                        </div>
                        <div class="card-head-right">
                            ${ruleHtml}
                            ${tagHtml}
                            ${promoTimerHtml}
                        </div>
                    </div>
                    <div class="card-stats-grid">
                        <div class="stat-cell"><div class="stat-lbl">TOP</div><div class="stat-val text-main">${c.topWinners||'--'}</div></div>
                        <div class="stat-cell border-start border-end border-secondary border-opacity-25"><div class="stat-lbl">REWARD</div><div class="stat-val text-brand">${fmtNum(c.rewardQty)}${estHtml}</div></div>
                        <div class="stat-cell"><div class="stat-lbl">PRICE</div><div class="stat-val text-brand fw-bold font-num live-price-val" data-id="${c.db_id}" style="font-size: 1rem; letter-spacing: 0.5px;">${priceStr}</div></div>
                    </div>
                    <div class="card-list" style="padding: 10px 15px 0 15px;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-sub fw-bold" style="font-size:0.6rem; letter-spacing:1px; text-transform:uppercase;">MY PROGRESS</span>
                            <button class="btn btn-sm fw-bold d-flex align-items-center gap-1" onclick="event.stopPropagation(); openUpdateModal('${c.db_id}')" style="font-size:0.65rem; transition:0.2s; background: rgba(14, 203, 129, 0.15); color: #0ECB81; border: 1px solid #0ECB81; padding: 2px 8px; border-radius: 4px;">
                                <i class="fas fa-pen-to-square"></i> UPDATE VOL
                            </button>
                        </div>
                        <div class="mini-chart-wrapper" onclick="event.stopPropagation()">
                            <canvas id="miniChart-${c.db_id}"></canvas>
                        </div>
                        <div class="acc-stats-grid" id="accGrid-${c.db_id}"></div>
                    </div>
                    <div class="market-bar">
                        <div class="mb-item text-start">
                            <div class="mb-label">Limit Vol (Mkt) <i class="fas fa-info-circle opacity-50" title="Tổng Vol Limit toàn thị trường"></i></div>
                            <div class="mb-val" style="color:${realVolColor}">${realVolDisplay}</div>
                        </div>
                        <div class="mb-item text-end">
                            <div class="mb-label" style="justify-content: flex-end; color:#F0B90B">Min Target (Goal)</div>
                            <div class="mb-val text-gold anim-breathe">
                                ${fmtNum(target)}
                                ${adminEditBtn}
                            </div>
                        </div>
                    </div>
                    <div class="card-actions" style="padding: 0; border:none;">
                        <button class="btn-card-action predict" onclick="event.stopPropagation(); openPredictionView('${c.db_id}')">
                            <i class="fas fa-bolt me-2"></i> ${translations[currentLang].btn_predict}
                        </button>
                    </div>
                </div>
            </div>`;
        } catch(e) { console.error("Render error", e); }
    });

    grid.innerHTML = fullHtml;
    listToRender.forEach(c => { renderCardMiniChart(c); });
    try { [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).map(el => new bootstrap.Tooltip(el)); } catch(e) {}
}




// --- [FIX V65] UPDATE GRID VALUES (REALTIME LIMIT VOL & PRICE) ---
function updateGridValuesOnly() {
    try {
        // 1. Cập nhật bảng Market Health (Nếu đang mở)
        if (typeof renderMarketHealthTable === 'function' && document.getElementById('healthTableBody')) {
            renderMarketHealthTable();
        }

        let maxRewardVal = 0;
        let topToken = null;
        let totalEstPool = 0;

        // 2. Duyệt qua từng Token để cập nhật thẻ bài
        compList.forEach(c => {
            // Logic tính toán Pool tổng
            let isRunning = !c.end || new Date() < new Date(c.end + 'T' + (c.endTime || '23:59') + 'Z');
            
            // Lấy giá mới nhất (Ưu tiên từ Market Analysis nếu có)
            let currentPrice = (c.market_analysis && c.market_analysis.price) ? c.market_analysis.price : (c.cachedPrice || 0);
            if (currentPrice > 0) c.cachedPrice = currentPrice;

            let qty = parseFloat(c.rewardQty) || 0;
            let currentTotalVal = qty * currentPrice;

            if (isRunning) {
                totalEstPool += currentTotalVal;
                if (currentTotalVal > maxRewardVal) {
                    maxRewardVal = currentTotalVal;
                    topToken = c;
                }
            }

            // --- TÌM THẺ BÀI CỦA TOKEN NÀY ---
            const cardWrapper = document.querySelector(`.card-wrapper[data-id="${c.db_id}"]`);
            
            if (cardWrapper) {
                // A. [FIX] CẬP NHẬT LIMIT VOL (REALTIME)
                // Tìm đúng vị trí Limit Vol trong giao diện mới (Market Bar -> Item đầu tiên)
                const volEl = cardWrapper.querySelector('.market-bar .mb-item:first-child .mb-val');
                
                if (volEl) {
                    let rv = c.real_alpha_volume || 0;
                    let rvStr = rv > 0 ? '$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(rv) : '---';
                    
                    // Chỉ cập nhật DOM nếu số liệu thay đổi (để tối ưu hiệu năng)
                    if(volEl.innerText !== rvStr) {
                        volEl.innerText = rvStr;
                        // Hiệu ứng nháy sáng nhẹ để báo hiệu có update
                        volEl.style.color = '#fff';
                        volEl.style.textShadow = '0 0 5px #fff';
                        setTimeout(() => { 
                            volEl.style.color = ''; // Trả về màu tím nhạt cũ (hoặc màu gốc trong CSS)
                            volEl.style.textShadow = ''; 
                        }, 300);
                    }
                }

                // B. CẬP NHẬT GIÁ (PRICE)
                const priceEl = cardWrapper.querySelector('.live-price-val');
                if (priceEl && currentPrice > 0) {
                    let pStr = currentPrice < 1 
                        ? '$' + currentPrice.toLocaleString('en-US', { maximumFractionDigits: 6 }) 
                        : '$' + currentPrice.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    
                    if(priceEl.innerText !== pStr) {
                        priceEl.innerText = pStr;
                        priceEl.classList.add('text-brand'); // Màu xanh neon
                        setTimeout(() => priceEl.classList.remove('text-brand'), 500);
                    }
                }

                // C. CẬP NHẬT GIÁ TRỊ ƯỚC TÍNH (REWARD VALUE)
                const estEl = cardWrapper.querySelector('.live-est-val');
                if (estEl) {
                    let estQty = parseFloat(estEl.getAttribute('data-qty')) || qty;
                    let estTotal = estQty * currentPrice;
                    if (estTotal > 0) {
                        estEl.innerText = '~$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(estTotal);
                    }
                }
            }
        });

        // 3. Cập nhật thanh thống kê (Header Stats)
        const poolEl = document.getElementById('stat-pool');
        if (poolEl) poolEl.innerText = fmt(totalEstPool);

        if (topToken) {
            const topSymbolEl = document.getElementById('stat-top-symbol');
            const topValEl = document.getElementById('stat-top-val');
            const topImgEl = document.getElementById('stat-top-img');
            
            if(topSymbolEl) topSymbolEl.innerText = topToken.name;
            if(topValEl) topValEl.innerText = fmt(maxRewardVal);
            if(topImgEl && topToken.logo) { topImgEl.src = topToken.logo; topImgEl.style.display = 'block'; }
        }

        // 4. Cập nhật số liệu trên Lịch
        if (typeof initCalendar === 'function') initCalendar();

    } catch (e) {
        console.error("Lỗi cập nhật số liệu Realtime:", e);
    }
}
        
// --- [V13 FINAL] RENDER TABLE: CLEAN & WHITE STYLE ---
function renderMarketHealthTable() {
    const tbody = document.getElementById('healthTableBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    // 1. Lọc giải đang chạy & Không phải Ecosystem
    let activeProjects = compList.filter(c => {
        let isRunning = !c.end || new Date() < new Date(c.end + 'T' + (c.endTime || '23:59'));
        let isEcosystem = (c.inputTokens && c.inputTokens.length > 0);
        return isRunning && !isEcosystem;
    });
    
    // 2. Sắp xếp theo Dòng tiền/giây (Mạnh nhất lên đầu)
    activeProjects.sort((a, b) => {
        let maA = a.market_analysis || {};
        let maB = b.market_analysis || {};
        return (maB.realTimeVol || 0) - (maA.realTimeVol || 0);
    });

    if (activeProjects.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center text-sub py-4 opacity-50">No active market data</td></tr>`;
        return;
    }

    activeProjects.forEach(c => {
        let ma = c.market_analysis || {};
        
        // --- A. AVG 1s MATCH ---
        let avg1sVal = ma.realTimeVol || 0;
        let avgColor = 'text-sub opacity-50'; 
        let avgDisplay = '<span class="text-sub small fw-normal">Scanning...</span>';

        if (avg1sVal > 0) {
            avgDisplay = '$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(avg1sVal);
            // Giữ màu cho cột này vì nó quan trọng nhất (Highlight)
            if (avg1sVal > 5000) avgColor = 'text-gold fw-bold';       
            else if (avg1sVal > 1000) avgColor = 'text-brand fw-bold'; 
            else if (avg1sVal > 200) avgColor = 'text-green';          
        }

        // --- B. PRICE (GIÁ TOKEN) - [ĐÃ SỬA: MÀU TRẮNG] ---
        let priceVal = ma.price || 0;
        let priceDisplay = '--';
        // Dùng class text-white để đồng bộ
        let priceColor = 'text-white font-num'; 

        if (priceVal > 0) {
            let digits = priceVal < 1 ? 6 : 2;
            priceDisplay = '$' + priceVal.toLocaleString('en-US', { 
                minimumFractionDigits: digits, 
                maximumFractionDigits: digits 
            });
        }

        // --- C. SPEED (Tx/s) ---
        let txPerMin = parseFloat(ma.velocity) || 0;
        let txPerSec = txPerMin / 60; 
        let speedDisplay = '--';
        let speedColor = 'text-sub'; // Mặc định xám
        
        if (txPerSec > 0) {
            speedDisplay = txPerSec.toFixed(2); 
            // Vẫn giữ tô màu nhẹ cho Speed để phân biệt nhanh/chậm
            if (txPerSec > 5.0) speedColor = 'text-gold fw-bold';       
            else if (txPerSec > 1.0) speedColor = 'text-green fw-bold'; 
            else speedColor = 'text-white';         
        }

        // --- D. AVG ORDER (24H) ---
        let volDay = c.real_alpha_volume || 0;
        let txDayCount = c.daily_tx_count || 0;
        let avgOrderDayVal = txDayCount > 0 ? (volDay / txDayCount) : 0;
        let avgOrderDisplay = avgOrderDayVal > 0 ? '$' + Math.round(avgOrderDayVal) : '--';

        // --- E. CÁC BIẾN CÒN LẠI ---
        let volToday = volDay ? '$' + new Intl.NumberFormat('en-US', { notation: "compact" }).format(volDay) : '--';
        
        // [ĐÃ SỬA: TXs DAY MÀU TRẮNG]
        let txDayDisplay = txDayCount ? new Intl.NumberFormat('en-US', { notation: "compact" }).format(txDayCount) : '--';
        
        let flowVal = ma.flowValue || 0;
        let flowDisplay = (flowVal > 0 ? '+' : '') + '$' + new Intl.NumberFormat('en-US', { notation: "compact" }).format(flowVal);
        let flowColor = flowVal > 0 ? 'text-green' : (flowVal < 0 ? 'text-red' : 'text-sub');
        
        let spread = ma.spread || 0;
        let spreadVal = spread ? spread.toFixed(2) + '%' : '--';
        let spreadColor = spread < 0.2 ? 'text-green' : (spread > 1.0 ? 'text-red' : 'text-warning');

        // --- F. VẼ HTML ---
        tbody.innerHTML += `
        <tr style="cursor:pointer; transition: background 0.2s;" onclick="document.querySelector('.card-wrapper[data-id=\\'${c.db_id}\\']').scrollIntoView({behavior: 'smooth', block: 'center'}); toggleCardHighlight(document.querySelector('.card-wrapper[data-id=\\'${c.db_id}\\'] .tour-card'))">
            
            <td class="ps-4">
                <div class="d-flex align-items-center gap-2">
                    <img src="${c.logo || 'https://placehold.co/30x30/333'}" style="width:24px; height:24px; border-radius:50%;">
                    <span class="fw-bold text-white font-num">${c.name}</span>
                </div>
            </td>
            
            <!-- CỘT PRICE (MÀU TRẮNG) -->
            <td class="text-end font-num text-white opacity-75">${priceDisplay}</td>

            <td class="text-end font-num text-sub">${volToday}</td>
            
            <!-- CỘT TXs DAY (MÀU TRẮNG) -->
            <td class="text-end font-num text-white opacity-75">${txDayDisplay}</td>

            <td class="text-end font-num ${speedColor}">${speedDisplay}</td>

            <td class="text-end font-num ${avgColor} col-highlight fw-bold" style="font-size:1.1rem">
                ${avgDisplay}
            </td>

            <td class="text-end font-num text-white">${avgOrderDisplay}</td>

          <td class="text-end font-num ${flowColor}">${flowDisplay}</td>

    <td class="text-end font-num ${spreadColor} fw-bold">${spreadVal}</td>

  </tr>
`;
    });
    
    try {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    } catch(e) {}
}
             

    /* --- CÁC HÀM XỬ LÝ DRAG & DROP --- */
    let draggedItem = null;
    function allowDrop(ev) { ev.preventDefault(); }

    function drag(ev) {
        draggedItem = ev.currentTarget;
        ev.dataTransfer.effectAllowed = 'move';
        ev.currentTarget.querySelector('.tour-card').classList.add('dragging');
    }

    function drop(ev) {
        ev.preventDefault();
        if(!draggedItem) return;
        draggedItem.querySelector('.tour-card').classList.remove('dragging');
        let targetItem = ev.target.closest('.card-wrapper');
        if (draggedItem !== targetItem && targetItem) {
            let container = document.getElementById('appGrid');
            let dragIdx = [...container.children].indexOf(draggedItem);
            let dropIdx = [...container.children].indexOf(targetItem);
            if (dragIdx < dropIdx) targetItem.after(draggedItem); else targetItem.before(draggedItem);
    showToast("Position changed! Click SAVE POSITION to save.", "info"); // Đã sửa dòng này
}
    }

    async function saveCustomOrder() {
    // Sửa confirm
    if(!confirm("Save current position?")) return;

    let btns = document.querySelectorAll('.btn-save-pos');
    btns.forEach(btn => {
        btn.dataset.oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';
        btn.disabled = true;
    });

    try {
        const container = document.getElementById('appGrid');
        const items = container.querySelectorAll('.card-wrapper');
        let updates = [];

        items.forEach((item, index) => {
            let dbId = parseInt(item.getAttribute('data-id'));
            let comp = compList.find(c => c.db_id === dbId);
            if(comp) {
                comp.orderIndex = index;
                updates.push(comp);
            }
        });

        for (let item of updates) {
            let dataToSave = { ...item };
            delete dataToSave.db_id;
            delete dataToSave.id;
            delete dataToSave.cachedPrice;
            dataToSave.history = item.history || [];
            dataToSave.predictions = item.predictions || [];

            await supabase.from('tournaments').update({
                data: dataToSave
            }).eq('id', item.db_id);
        }

        showToast("Position saved successfully!", "success"); // Đã sửa
        await loadFromCloud(false);

    } catch (e) {
        console.error(e);
        showToast("Error saving: " + e.message, "error"); // Đã sửa
    } finally {
        btns.forEach(btn => {
            btn.innerHTML = btn.dataset.oldText || '<i class="fas fa-save me-1"></i> SAVE POSITION';
            btn.disabled = false;
        });
    }
}

    function switchView(view) {
        document.getElementById('view-dashboard').style.display = view==='dashboard'?'block':'none';
        document.getElementById('view-predict').style.display = view==='predict'?'block':'none';
        if(view==='dashboard') { currentPolyId=null; renderGrid(); }
    }

    function switchTab(t) { document.querySelectorAll('.p-tab').forEach(el=>el.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active'); ['chart','activity','chat'].forEach(x => document.getElementById(`content-${x}`).style.display = x===t ? (x==='chat'?'flex':'block') : 'none'); }

        // --- CODE MỚI: LẤY DỮ LIỆU TỪ BẢNG PREDICTIONS (ĐÃ MERGE) ---
    async function openPredictionView(id) {
        // [FIX MỚI] Đóng thẻ bài đang phóng to trước khi làm bất cứ gì
        if (typeof closeActiveCard === 'function') {
            closeActiveCard();
        }

        currentPolyId = id;

        // 1. Hiện loading
        document.getElementById('loading-overlay').style.display = 'flex';

        // 2. Gọi Server lấy danh sách dự đoán
        const { data: predsData, error } = await supabase
            .from('predictions')
            .select('*')
            .eq('tournament_id', id);

        document.getElementById('loading-overlay').style.display = 'none';

        if (error) {
            alert("Lỗi tải dữ liệu: " + error.message);
            return;
        }

        // 3. Gắn dữ liệu vào
        let c = compList.find(x => x.db_id == id);
        if(c) {
            c.predictions = predsData.map(p => ({
                user_id: p.user_id,
                name: p.user_name,
                avatar: p.user_avatar,
                guess: parseFloat(p.guess),
                time: new Date(p.created_at).getTime()
            }));
        }

        // 4. Chuyển màn hình
        // (Đảm bảo ẩn dashboard đi để tránh bị đè)
        document.getElementById('view-dashboard').style.display = 'none';
        switchView('predict');

        // [AN TOÀN] Kiểm tra xem thẻ chứa nội dung có tồn tại không
        // Nếu file HTML chưa có thẻ 'predict-content-placeholder', ta tự tạo nó
        let container = document.getElementById('predict-content-placeholder');
        if (!container) {
            let viewPredict = document.getElementById('view-predict');
            viewPredict.innerHTML = '<div id="predict-content-placeholder"></div>';
            container = document.getElementById('predict-content-placeholder');
        }

        // 5. Vẽ giao diện (Code HTML của bạn giữ nguyên 100%)
        container.innerHTML = `
        <div class="terminal-layout">
            <div class="terminal-main">
                <div class="hero-header">
                    <div class="hh-left"><img id="pt-logo" src="" title="View on Binance Alpha"><div><h1 class="fw-bold text-white mb-0" id="pt-symbol">---</h1><div class="text-sub fw-bold" style="font-size:0.75rem;letter-spacing:2px;">PREDICTION MARKET</div></div></div>

                    <div class="hh-center">
                        <div class="text-brand fw-bold small letter-spacing-1" style="font-size:0.85rem; opacity:0.8">CURRENT MIN VOLUME</div>
                        <div class="big-vol" id="pt-min-vol" style="margin-bottom: 5px;">0</div>
                        <div id="pt-vol-change" class="mb-4 d-flex align-items-center gap-2" style="font-family: var(--font-num); font-size: 1.1rem;"></div>

                        <div class="d-flex gap-2">
                             <button id="btn-predict-action" class="btn-predict-hero" onclick="openInputModal()"><i class="fas fa-crosshairs me-2"></i>MAKE PREDICTION</button>
                             <button class="btn btn-outline-light rounded-pill px-3" onclick="new bootstrap.Modal(document.getElementById('ruleModal')).show()"><i class="fas fa-info-circle"></i> RULES</button>
                             <button class="btn btn-dark border-secondary rounded-pill px-3 text-white" onclick="generateShareCard()" title="Share Card"><i class="fas fa-share-alt"></i></button>
                        </div>

                        <div class="admin-only admin-settle-box mt-3" style="width:100%">
                            <label class="text-danger fw-bold small mb-1">TOURNAMENT SETTLEMENT</label>
                            <button class="btn btn-danger w-100 fw-bold" onclick="settleTournament()"><i class="fas fa-gavel me-2"></i> AUTO SETTLE & DISTRIBUTE</button>
                            <div class="text-sub small mt-1 text-center fst-italic">*System will fetch last Min Volume from History.</div>
                        </div>
                    </div>

                    <div class="hh-right">
                        <div class="text-end"><div class="header-stat-lbl">TIME REMAINING</div><div class="text-gold font-num fw-bold fs-3" id="pt-time">---</div></div>
                        <div class="text-end"><div class="header-stat-lbl">TOTAL POOL</div><div class="text-green font-num fw-bold fs-3" id="pt-pool">0 $</div></div>
                    </div>
                </div>
                <div class="terminal-card" style="flex:1;">
                    <div class="p-tabs">
                        <div class="p-tab active" onclick="switchTab('chart')" id="tab-chart">CHART</div>
                        <div class="p-tab" onclick="switchTab('activity')" id="tab-activity">ACTIVITY</div>
                        <div class="p-tab" onclick="switchTab('chat')" id="tab-chat">CHAT</div>
                    </div>
                    <div style="flex:1; position:relative; padding:25px; display:flex; flex-direction:column; overflow:hidden;">
                        <div id="content-chart" style="height:100%; width:100%;"><canvas id="marketChart"></canvas></div>
                        <div id="content-activity" class="feed-box" style="display:none; height:100%;"></div>
                        <div id="content-chat" style="display:none; height:100%; flex-direction:column;">
                            <div id="chat-feed" class="feed-box" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
                            <div class="d-flex gap-2 align-items-center">
                                <input id="chat-msg" class="form-control rounded-pill" placeholder="Type a message..." style="padding: 10px 20px; background: #222; border: 1px solid #444; color: #fff;" onkeydown="if(event.key==='Enter') sendChat()">
                                <button class="btn btn-icon text-brand border-0 bg-transparent" onclick="sendChat()" style="width: 45px; height: 45px;"><i class="fas fa-paper-plane fa-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="terminal-side">
                <div class="terminal-card" style="flex:1;">
                    <div class="p-4 border-bottom border-secondary border-opacity-25 bg-panel"><h6 class="fw-bold m-0 text-gold letter-spacing-1">TOP TRADERS</h6></div>
                    <div style="flex:1;overflow-y:auto;">
                        <table class="leaderboard-table w-100">
                            <thead>
                                <tr>
                                    <th class="ps-4">RANK</th>
                                    <th>TRADER</th>
                                    <th class="text-center">GUESS</th>
                                    <th class="text-end pe-2">PRIZE</th> 
                                </tr>
                            </thead>
                            <tbody id="pt-leaderboard"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>`;

        updateTerminalData(id);
    }

       // --- [FIXED] UPDATE DATA FOR NEW COCKPIT UI ---
// --- [FIXED] UPDATE DATA & BUTTON STATE (ĐỒNG BỘ GIỜ UTC) ---
function updateTerminalData(id) {
    let c = compList.find(x => x.db_id == id); if(!c) return;
    
    // 1. Header Info
    document.getElementById('pt-symbol').innerText = c.name;
    let logoEl = document.getElementById('pt-logo');
    logoEl.src = c.logo;
    
    // 2. Control Panel Data
    let curMin = (c.history && c.history.length > 0) ? c.history[c.history.length-1].target : 0;
    document.getElementById('pt-min-vol').innerText = fmtNum(curMin);
    
    let totalPool = (c.predictions?.length || 0) * PREDICT_FEE;
    document.getElementById('pt-pool').innerText = fmt(totalPool);

    // 3. LOGIC TIME REMAINING & BUTTON STATE (QUAN TRỌNG)
    let isEnded = false;
    if(c.end) {
        // [FIX] Thêm 'Z' để tính theo giờ UTC chuẩn (Khớp với openInputModal)
        let endString = c.end + 'T' + (c.endTime || '23:59:59') + 'Z';
        let endTime = new Date(endString).getTime();
        
        // Chỉ khi nào thời gian hiện tại VƯỢT QUÁ giờ kết thúc thì mới khóa
        if(Date.now() > endTime) isEnded = true;
    }

    // 4. Update Nút PREDICT
    let btn = document.getElementById('btn-predict-action');
    if(isEnded) {
        btn.innerHTML = '<span>MARKET CLOSED</span> <i class="fas fa-lock"></i>';
        btn.classList.add('btn-ended'); // Thêm class xám màu nếu cần
        btn.disabled = true; // Khóa nút
    } else {
        btn.innerHTML = '<span>ENTER PREDICTION</span> <i class="fas fa-bolt"></i>';
        btn.classList.remove('btn-ended');
        btn.disabled = false; // Mở khóa nút
        btn.onclick = openInputModal; // Gán lại sự kiện click
    }

    // 5. Change Indicator (Giữ nguyên)
    let changeHtml = '';
    if (c.history && c.history.length >= 2) {
        let todayVal = parseFloat(c.history[c.history.length - 1].target);
        let yestVal = parseFloat(c.history[c.history.length - 2].target);
        let diff = todayVal - yestVal;
        let pct = yestVal > 0 ? ((diff / yestVal) * 100).toFixed(2) : 0;
        let color = diff >= 0 ? '#0ECB81' : '#F6465D';
        let icon = diff >= 0 ? 'fa-caret-up' : 'fa-caret-down';
        changeHtml = `<span style="color:${color}; font-size:0.8rem; font-weight:bold"><i class="fas ${icon} me-1"></i>${diff>=0?'+':''}${pct}% (24h)</span>`;
    }
    document.getElementById('pt-vol-change').innerHTML = changeHtml;

    // 6. Vẽ Chart (Giữ nguyên)
    if(!marketChart) {
        let ctx = document.getElementById('marketChart').getContext('2d');
        let labels=[], data=[];
        if(c.history) c.history.forEach(h=>{ labels.push(h.date.substring(5)); data.push(h.target); });
        
        marketChart = new Chart(ctx, { 
             type: 'line', 
             data: { labels, datasets: [{ 
                 label: 'Min Vol', data, borderColor: '#00F0FF', 
                 backgroundColor: (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(0, 240, 255, 0.2)');
                    gradient.addColorStop(1, 'rgba(0, 240, 255, 0)');
                    return gradient;
                },
                fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6 
             }]}, 
             options: { 
                 responsive: true, maintainAspectRatio: false, 
                 interaction: { intersect: false, mode: 'index' },
                 scales: { 
                     x:{ display:true, grid:{display:false}, ticks:{color:'#555', font:{size:9}} }, 
                     y:{ grid:{color:'#222', borderDash:[5,5]}, ticks:{color:'#666', font:{family:'Rajdhani'}} } 
                 }, 
                 plugins:{ legend:{display:false} } 
             } 
         });
    } else {
        let labels=[], data=[];
        if(c.history) c.history.forEach(h=>{ labels.push(h.date.substring(5)); data.push(h.target); });
        marketChart.data.labels = labels;
        marketChart.data.datasets[0].data = data;
        marketChart.update();
    }

    // 7. Leaderboard & Chat (Giữ nguyên logic cũ nhưng trỏ ID mới)
    let lb = document.getElementById('pt-leaderboard');
    if(lb) {
        lb.innerHTML = '';
        let preds = (c.predictions || []).sort((a, b) => Math.abs(a.guess - curMin) - Math.abs(b.guess - curMin));
        
        if(preds.length === 0) lb.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-sub opacity-50">No Data</td></tr>';
        
        preds.forEach((p, i) => {
            let rank = i+1;
            let color = rank===1?'#FFD700':(rank===2?'#C0C0C0':(rank===3?'#CD7F32':'#666'));
            lb.innerHTML += `<tr><td class="ps-3 align-middle"><span style="color:${color}; font-weight:800">#${rank}</span></td><td class="align-middle"><div class="d-flex align-items-center gap-2"><img src="${p.avatar||'https://placehold.co/20'}" style="width:20px;height:20px;border-radius:50%"><span class="text-white small fw-bold">${p.name}</span></div></td><td class="text-end pe-3 align-middle font-num text-brand fw-bold">${fmtNum(p.guess)}</td></tr>`;
        });
    }

    let chatDiv = document.getElementById('chat-feed');
    if(chatDiv) {
        chatDiv.innerHTML = '';
        (c.comments || []).sort((a,b)=>a.time-b.time).forEach(m => {
            let isMe = m.user === (userProfile?.nickname || currentUser?.email.split('@')[0]);
            chatDiv.innerHTML += `<div class="mb-2 d-flex ${isMe?'justify-content-end':''}"><div style="background:${isMe?'var(--brand)':'#222'}; color:${isMe?'#000':'#ddd'}; padding:5px 10px; border-radius:10px; font-size:0.8rem; max-width:85%"><div class="fw-bold" style="font-size:0.65rem; opacity:0.7; margin-bottom:2px">${m.user}</div>${DOMPurify.sanitize(m.text)}</div></div>`;
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }
}

    function openInputModal() {
    // [SAFETY 1] Kiểm tra xem đã chọn giải đấu chưa
    if (!currentPolyId) return showToast("System Error: No Tournament Selected", "error");

    let c = compList.find(x => x.db_id == currentPolyId);
    
    // [SAFETY 2] Quan trọng: Nếu không tìm thấy dữ liệu giải -> Báo lỗi chứ không để Crash
    if (!c) {
        console.error("Data missing for ID: " + currentPolyId);
        return showToast("Data not ready. Please reload page!", "error");
    }

    // --- LOGIC KHÓA CỔNG (Theo giờ chuẩn UTC) ---
    if(c.end) {
        // Thêm 'Z' để máy hiểu là giờ UTC
        let endString = c.end + 'T' + (c.endTime || '23:59:59') + 'Z';
        let endTime = new Date(endString).getTime();
        
        // Chỉ chặn nếu giờ hiện tại ĐÃ VƯỢT QUÁ giờ kết thúc
        if(Date.now() > endTime) {
            return showToast("⛔ Tournament has ENDED! Prediction closed.", "error");
        }
    }
    // ---------------------------------------------

    if(!currentUser) { showToast("Please login to predict!", "error"); return; }
    
    // CHECK BALANCE
    if((userProfile.balance_usdt || 0) < PREDICT_FEE) {
        return showToast(`Insufficient Balance! You need ${PREDICT_FEE} USDT.`, "error");
    }

    let displayName = userProfile?.nickname || currentUser.email.split('@')[0];
    let nameInput = document.getElementById('modal-p-name');
    if(nameInput) {
        nameInput.value = displayName;
        nameInput.disabled = true;
    }
    
    let guessInput = document.getElementById('modal-p-guess');
    if(guessInput) guessInput.placeholder = `Fee: ${PREDICT_FEE} USDT`;

    new bootstrap.Modal(document.getElementById('inputModal')).show();
}

async function submitPredictionFromModal() {
    let nameInput = document.getElementById('modal-p-name');
    let guessInput = document.getElementById('modal-p-guess');
    
    // Validate dữ liệu đầu vào
    let name = nameInput.value.trim();
    let guess = parseFloat(guessInput.value);

    if(!currentUser) return showToast("Please Login to predict!", "error");
    if(!name) return showToast("Nickname required", "error");
    if(isNaN(guess) || guess < 0) return showToast("Invalid Prediction Volume", "error");

    // Hiệu ứng nút bấm
    let btn = document.querySelector('#inputModal .btn-action');
    let oldText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> PROCESSING...';
    btn.disabled = true;

    try {
        // Gọi RPC Supabase
        const { data, error } = await supabase.rpc('submit_prediction_action', {
            p_tourn_id: parseInt(currentPolyId),
            p_guess: guess,
            p_name: name,
            p_avatar: userProfile?.avatar_url || ''
        });

        if (error) throw error;
        if (data && data.status === 'error') throw new Error(data.message);

        // Update số dư ngay lập tức
        if(data && data.new_balance !== undefined) {
            userProfile.balance_usdt = data.new_balance;
            document.getElementById('user-balance').innerText = fmtNum(data.new_balance);
        }

        showToast(`🚀 ENTRY CONFIRMED! (-${PREDICT_FEE} USDT)`, "success");
        playSfx('click');
        
        // Đóng Modal
        bootstrap.Modal.getInstance(document.getElementById('inputModal')).hide();

        // --- CẬP NHẬT GIAO DIỆN (MƯỢT MÀ) ---
        // 1. Cập nhật lại thanh thống kê Pool bên ngoài
        renderStats();

        // 2. Gọi hàm Reload An Toàn (Đã sửa ở trên)
        if(currentPolyId) await silentReload(currentPolyId);

        // 3. Hiện bảng khoe thành tích (Share Card)
        setTimeout(() => { 
             generateShareCard(guess);
        }, 800);

    } catch (e) {
        console.error(e);
        showToast("Error: " + e.message, "error");
        playSfx('hover');
    } finally {
        // Trả lại trạng thái nút bấm
        if(btn) {
            btn.innerHTML = oldText;
            btn.disabled = false;
        }
    }
}


    // V45 VIRAL LOOP: GENERATE SHARE CARD
    function generateShareCard(userGuess = null) {
        let c = compList.find(x => x.db_id == currentPolyId);
        if(!c) return;

        // 1. Fill Token Data
        document.getElementById('sc-token-name').innerText = c.name;

        // 2. Fill User Data (V45 Update)
        let uName = userProfile?.nickname || "Trader";
        // Sử dụng UI Avatars nếu user chưa có ảnh (fallback đẹp)
        let uAvatar = userProfile?.avatar_url || `https://ui-avatars.com/api/?name=${uName}&background=random&color=fff&size=128`;

        document.getElementById('sc-user-name').innerText = uName;

        // Handle Avatar Image (CORS Safe)
        let uaEl = document.getElementById('sc-user-avatar');
        uaEl.crossOrigin = "anonymous";
        uaEl.src = uAvatar + (uAvatar.includes('?')?'&':'?') + 't=' + new Date().getTime();
        uaEl.onerror = function(){ this.src = 'https://placehold.co/50/333/fff?text=' + uName.charAt(0); }; // Fail-safe

        // Date Format
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }).toUpperCase();
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('sc-date-display').innerText = `${dateStr} | ${timeStr}`;

        // FIX CORS: Thêm timestamp để tránh cache và set crossOrigin
        let imgEl = document.getElementById('sc-token-img');
        imgEl.crossOrigin = "anonymous";
        imgEl.src = c.logo + (c.logo.includes('?') ? '&' : '?') + 't=' + new Date().getTime();

        // Fallback nếu ảnh lỗi thì hiện avatar chữ cái (tránh bị đen sì)
        imgEl.onerror = function() {
            this.style.display = 'none'; // Ẩn ảnh lỗi
            // Có thể thêm logic hiện avatar chữ ở đây nếu muốn kỹ hơn
        };
        imgEl.onload = function() {
            this.style.display = 'block';
        };

        let curMin = (c.history && c.history.length>0) ? c.history[c.history.length-1].target : 0;
        document.getElementById('sc-min-vol').innerText = fmtNum(curMin);

        // If userGuess passed, use it. Else try to find from user predictions
        if(!userGuess && currentUser && c.predictions) {
            let myP = c.predictions.find(p => p.user_id === currentUser.id);
            if(myP) userGuess = myP.guess;
        }
        document.getElementById('sc-my-guess').innerText = userGuess ? fmtNum(userGuess) : '---';

        // 2. Generate QR Code
        let qrBox = document.getElementById('sc-qr-target');
        qrBox.innerHTML = '';
        let link = siteConfig.affiliate?.binance || window.location.href;
        new QRCode(qrBox, { text: link, width: 50, height: 50 });

        // 3. Show Modal
        new bootstrap.Modal(document.getElementById('shareCardModal')).show();
    }

    // --- V45 NEW: SMART SOCIAL SHARE WITH IMAGE ---
    async function shareImageSmart(platform) {
        const element = document.getElementById('share-card-container');
        let c = compList.find(x => x.db_id == currentPolyId);
        let guess = document.getElementById('sc-my-guess').innerText;
        let webUrl = "https://wave-alpha.pages.dev";

        let text = "";
        if (platform === 'x') {
            text = `🚀 I predicted $${c.name} Min Volume: ${guess} on Wave Alpha!\n\nCan you beat me? 👇\n${webUrl}\n\n#WaveAlpha #Crypto #Trading`;
        } else {
            text = `🔥 I predict $${c.name} Min Volume: ${guess}!\nJoin Wave Alpha Terminal here: ${webUrl}`;
        }

        try {
            showToast("Generating image...", "info");

            // 1. Capture Image
            const canvas = await html2canvas(element, {
                backgroundColor: '#161a1e', scale: 2, useCORS: true, allowTaint: true, logging: false
            });
            const blob = await new Promise(resolve => canvas.toBlob(resolve));
            const file = new File([blob], "WaveAlpha-Prediction.png", { type: "image/png" });

            // 2. Try Native Share (Mobile - Best Experience)
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    title: 'Wave Alpha Prediction',
                    text: text,
                    files: [file]
                });
                showToast("Shared successfully!", "success");
            } else {
                // 3. Fallback: Download + Open Link (Desktop)
                // Browser cannot auto-attach image to X/Tele web, so we download it for user
                const link = document.createElement('a');
                link.download = 'WaveAlpha-Prediction.png';
                link.href = canvas.toDataURL('image/png');
                link.click();

                showToast("Image Saved! Please attach it to your post.", "success");

                setTimeout(() => {
                    let shareUrl = "";
                    if (platform === 'x') {
                        let hashtags = `WaveAlpha,Crypto,${c.name}`;
                        shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                    } else {
                        shareUrl = `https://t.me/share/url?url=${encodeURIComponent(webUrl)}&text=${encodeURIComponent(text)}`;
                    }
                    window.open(shareUrl, '_blank');
                }, 1000);
            }

        } catch (e) {
            console.error(e);
            showToast("Share failed: " + e.message, "error");
        }
    }

    // Map old functions to new Smart Logic
    function shareToX() { shareImageSmart('x'); }
    function shareToTele() { shareImageSmart('tele'); }

    function downloadShareCard() {
        let element = document.getElementById('share-card-container');

        // FIX: Cấu hình html2canvas chuẩn để bắt được ảnh và style
        html2canvas(element, {
            backgroundColor: '#161a1e', // Đặt màu nền cứng để tránh trong suốt/mất chữ
            scale: 2, // Tăng độ nét
            useCORS: true, // Quan trọng: Cho phép tải ảnh từ domain khác
            allowTaint: true, // Cho phép "vấy bẩn" canvas (giúp render ảnh khó tính)
            logging: false
        }).then(canvas => {
            let link = document.createElement('a');
            link.download = 'WaveAlpha-Prediction.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }

    function sendChat() {
        if(!currentUser) return showToast("Please login to chat!", "error");
        let txt = document.getElementById('chat-msg').value;
        if(!txt) return;
        let c = compList.find(x => x.db_id == currentPolyId);
        if(!c.comments) c.comments = [];

        let displayName = userProfile?.nickname || currentUser.email.split('@')[0];
        c.comments.push({
            user: displayName,
            text: txt,
            time: Date.now(),
            avatar: userProfile?.avatar_url || ''
        });

        let obj = {...c}; delete obj.db_id;
        const payload = {
            name: obj.name || c.name,
            contract: obj.contract || c.contract,
            data: obj
        };

        supabase.from('tournaments').update(payload).eq('id', currentPolyId).then(() => {
            loadFromCloud(false);
        });
        document.getElementById('chat-msg').value = '';
    }

    // --- HÀM LƯU DỮ LIỆU LÊN MÂY (CÓ BẮT LỖI CHẶT CHẼ) ---
async function saveToCloud(compObj) {
    // 1. Tạo bản sao dữ liệu sạch
    let cloudObj = { ...compObj };
    
    // Xóa các biến tạm không cần lưu
    delete cloudObj.myProgress; 
    delete cloudObj.db_id; 
    delete cloudObj.id; 
    delete cloudObj.cachedPrice;
    
    // (Tùy chọn) Xóa predictions/comments nếu bạn không muốn ghi đè user data
    // delete cloudObj.predictions; 
    // delete cloudObj.comments;

    const payload = { 
        name: cloudObj.name, 
        contract: cloudObj.contract, 
        data: cloudObj 
    };

    console.log("Saving payload:", payload); // Debug: Xem dữ liệu gửi đi

    let result;
    
    // 2. Thực hiện lệnh Save
    if (compObj.db_id) {
        // Update
        result = await supabase
            .from('tournaments')
            .update(payload)
            .eq('id', parseInt(compObj.db_id))
            .select(); // <--- BẮT BUỘC CÓ .select() để kiểm tra kết quả
    } else {
        // Insert
        result = await supabase
            .from('tournaments')
            .insert([payload])
            .select();
    }

    // 3. KIỂM TRA LỖI RLS (QUAN TRỌNG)
        if (result.error) throw result.error;
    
    if (!result.data || result.data.length === 0) {
        console.error("Save failed (RLS Blocked). Result:", result);
        // Sửa thông báo lỗi này sang tiếng Anh
        throw new Error("ADMIN PERMISSION ERROR! Database refused to save. Check RLS Policies.");
    }

    console.log("Save Success:", result.data);

    // 4. Tải lại dữ liệu để đồng bộ
    await loadFromCloud(false);
}

    // --- MODAL UPDATES (TRACKING & HISTORY) ---
    function openUpdateModal(dbId) {
        let c=compList.find(x=>x.db_id==dbId); if(!c)return;
        document.getElementById('u-db-id').value=dbId; document.getElementById('u-symbol-display').innerText=c.name;
        let today=new Date().toISOString().split('T')[0];
        document.getElementById('u-original-date').value = "";
        document.getElementById('u-date').value=today;

        let min=document.getElementById('u-min-vol');
        if(document.body.classList.contains('is-admin')){ min.disabled=false; min.placeholder="Admin Edit"; } else { min.disabled=true; min.placeholder="---"; }
        let html='';
        accSettings.forEach(acc=>{
            html+=`<div class="acc-input-row" id="row-${acc.id}"><span style="color:${acc.color}; font-weight:700;">${acc.name}</span><input type="number" class="form-control font-num text-center text-brand" id="u-vol-${acc.id}" placeholder="Volume" oninput="calcRowGap('${acc.id}')"><div class="d-flex align-items-center gap-2"><span class="font-num fw-bold text-sub small" id="gap-display-${acc.id}" style="width:70px; text-align:right;">---</span><input type="number" class="form-control font-num text-end text-danger" id="u-cost-${acc.id}" placeholder="Cost ($)" style="max-width:80px"></div></div>`;
        });
        document.getElementById('u-acc-inputs').innerHTML=html; loadDateData(today); document.getElementById('u-date').onchange=function(){loadDateData(this.value)}; new bootstrap.Modal(document.getElementById('updateModal')).show();
    }

    function calcRowGap(accId) {
        let minInput = document.getElementById('u-min-vol').value.replace(/,/g, '');
        let min = parseFloat(minInput) || 0;
        let vol = parseFloat(document.getElementById(`u-vol-${accId}`).value) || 0;
        let gap = vol - min;
        let el = document.getElementById(`gap-display-${accId}`);
        if(min > 0) { el.innerText = (gap>=0 ? '+' : '') + fmtNum(gap); el.className = `font-num fw-bold small ${gap>=0?'text-green':'text-red'}`; } else { el.innerText = '---'; }
    }

    // V43 UPGRADE: USE TRACKER_DATA FROM CLOUD
    function loadDateData(d) {
        let id=document.getElementById('u-db-id').value; let c=compList.find(x=>x.id==id);
        let min=0;
        if(c.history){let e=c.history.find(h=>h.date===d); if(e)min=e.target; else if(c.history.length>0)min=c.history[c.history.length-1].target;}
        let minInput = document.getElementById('u-min-vol');
        minInput.value=fmtNum(min).replace(/\./g, '');
        formatCurrency(minInput);

        accSettings.forEach(acc=>{ document.getElementById(`u-vol-${acc.id}`).value=''; document.getElementById(`u-cost-${acc.id}`).value=''; calcRowGap(acc.id); });

        // GET DATA FROM USER PROFILE INSTEAD OF LOCAL C.MYPROGRESS
        let myProgress = (userProfile?.tracker_data && userProfile.tracker_data[id]) ? userProfile.tracker_data[id] : [];

        if(myProgress){
            let p = myProgress.find(x => x.date === d);
            if(p && p.accsDetail){
                accSettings.forEach(acc=>{
                    if(p.accsDetail[acc.id]){
                        document.getElementById(`u-vol-${acc.id}`).value=p.accsDetail[acc.id].vol;
                        document.getElementById(`u-cost-${acc.id}`).value=p.accsDetail[acc.id].cost;
                        calcRowGap(acc.id);
                    }
                })
            }
        }
        renderTrackerChart(c); renderHistoryList(c);
    }

    function loadHistoryToEdit(date) {
        document.getElementById('u-date').value = date;
        document.getElementById('u-original-date').value = date;
        loadDateData(date);
        document.getElementById('u-date').focus();
    }

    function renderTrackerChart(c) {
        const ctx = document.getElementById('trackerChart').getContext('2d');
        if(trackerChart) trackerChart.destroy();

        let labels=[], minData=[], dates=new Set();
        if(c.history) c.history.forEach(x => dates.add(x.date));

        // GET DATA FROM USER PROFILE
        let myProgress = (userProfile?.tracker_data && userProfile.tracker_data[c.id]) ? userProfile.tracker_data[c.id] : [];
        if(myProgress) myProgress.forEach(x => dates.add(x.date));

        let sortedDates = Array.from(dates).sort();

        minData = sortedDates.map(d => {
            let h = c.history ? c.history.find(x => x.date === d) : null;
            return h ? h.target : 0;
        });

        let datasets = [{
            label: 'Target (Min)',
            data: minData,
            borderColor: '#F0B90B',
            borderDash: [6, 4],
            borderWidth: 2,
            pointRadius: 0,
            tension: 0,
            fill: false,
            order: 0
        }];

        accSettings.forEach(acc => {
            let accData = [];
            sortedDates.forEach(d => {
                let p = myProgress ? myProgress.find(x => x.date === d) : null;
                let vol = (p && p.accsDetail && p.accsDetail[acc.id]) ? parseFloat(p.accsDetail[acc.id].vol) : 0;
                accData.push(vol);
            });

            datasets.push({
                label: acc.name,
                data: accData,
                borderColor: acc.color,
                backgroundColor: acc.color,
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: (ctx) => {
                    let idx = ctx.dataIndex;
                    let val = ctx.raw;
                    let target = minData[idx] || 0;
                    return val >= target ? '#0ECB81' : '#F6465D';
                },
                pointBorderColor: '#fff',
            });
        });

        trackerChart = new Chart(ctx, {
            type: 'line',
            data: { labels: sortedDates.map(d => d.substring(5)), datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: '#aaa', boxWidth: 10, font: {size: 10} } },
                    tooltip: {
                        enabled: true, backgroundColor: 'rgba(22, 26, 30, 0.95)', titleColor: '#00F0FF',
                        titleFont: { family: 'Rajdhani', size: 14, weight: 'bold' },
                        bodyColor: '#fff', bodyFont: { family: 'Rajdhani', size: 13 },
                        borderColor: '#333', borderWidth: 1, padding: 10, displayColors: true, boxPadding: 4,
                        callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += new Intl.NumberFormat('en-US').format(context.parsed.y); } return label; } }
                    }
                },
                scales: { x: { display: true, ticks: { color: '#555', font:{size:9} }, grid: {display:false} }, y: { display: false } }
            }
        });
    }

    // --- [NEW] HÀM VẼ LỊCH SỬ (AUTO-FILL LOGIC) ---
// --- [FINAL V2] HÀM VẼ LỊCH SỬ (FIX LỖI MẤT NGÀY CUỐI) ---
function renderHistoryList(c) {
    // 1. Vẽ tiêu đề bảng
    let headerHtml = `<th class="text-sub small">Date</th><th class="text-gold small">Target</th>`;
    accSettings.forEach(acc => { headerHtml += `<th class="small text-center" style="color:${acc.color}">${acc.name}</th>`; });
    headerHtml += `<th class="text-end small">Action</th>`;
    document.getElementById('historyHeader').innerHTML = headerHtml;

    const l = document.getElementById('historyList');
    l.innerHTML = '';

    // 2. Lấy dữ liệu
    let adminHistory = c.history || [];
    let myProgress = (userProfile?.tracker_data && userProfile.tracker_data[c.id]) ? userProfile.tracker_data[c.id] : [];

    // 3. Xác định Start Date & End Date (Dạng Chuỗi YYYY-MM-DD)
    let startDateStr = c.start;
    // Nếu không có ngày bắt đầu thì tìm ngày cũ nhất
    if (!startDateStr) {
        let allDates = [...adminHistory.map(h=>h.date), ...myProgress.map(p=>p.date)];
        if(allDates.length > 0) startDateStr = allDates.sort()[0];
        else startDateStr = new Date().toISOString().split('T')[0];
    }

    // Lấy ngày hôm nay (Local Time) chuẩn dạng YYYY-MM-DD
    let now = new Date();
    let todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');

    // --- [LOGIC QUAN TRỌNG: CHỐT NGÀY DỪNG (CUT-OFF)] ---
    // Mặc định chạy đến hôm nay
    let limitStr = todayStr;

    // Nếu giải có ngày kết thúc (End Date)
    if (c.end) {
        // So sánh chuỗi: Nếu "2025-12-12" < "2025-12-18" (Đã qua ngày kết thúc)
        // Thì chốt sổ tại ngày kết thúc "2025-12-12"
        if (c.end < todayStr) {
            limitStr = c.end;
        }
    }

    // 4. CHẠY VÒNG LẶP (DÙNG DATE OBJECT ĐỂ TĂNG NGÀY)
    let timelineData = [];
    let lastKnownTarget = 0;
    let lastKnownVols = {}; 
    accSettings.forEach(acc => lastKnownVols[acc.id] = 0);

    // Bắt đầu từ ngày start
    let loopDate = new Date(startDateStr);
    // Xử lý múi giờ: Set giờ về 12:00 trưa để tránh việc +/- giờ làm nhảy ngày
    loopDate.setHours(12,0,0,0); 

    // VÒNG LẶP: Chừng nào ngày đang xét (loopStr) <= ngày giới hạn (limitStr) thì còn chạy
    while (true) {
        let dStr = loopDate.toISOString().split('T')[0];
        
        // Nếu ngày đang chạy lớn hơn ngày giới hạn -> DỪNG NGAY
        if (dStr > limitStr) break;

        // A. Admin Target (Kế thừa từ ngày trước nếu thiếu)
        let realAdminData = adminHistory.find(h => h.date === dStr);
        if (realAdminData) lastKnownTarget = parseFloat(realAdminData.target);

        // B. User Volume (Kế thừa từ ngày trước nếu thiếu)
        let realUserData = myProgress.find(p => p.date === dStr);
        let currentDayVols = {};
        
        accSettings.forEach(acc => {
            if (realUserData && realUserData.accsDetail && realUserData.accsDetail[acc.id]) {
                let v = parseFloat(realUserData.accsDetail[acc.id].vol);
                lastKnownVols[acc.id] = v; // Cập nhật số mới
            }
            currentDayVols[acc.id] = lastKnownVols[acc.id]; // Dùng số (mới hoặc cũ)
        });

        let isAutoFill = !realUserData; 

        timelineData.push({
            date: dStr,
            target: lastKnownTarget,
            vols: currentDayVols,
            isAuto: isAutoFill
        });

        // Tăng 1 ngày
        loopDate.setDate(loopDate.getDate() + 1);
    }

    // 5. VẼ RA BẢNG (Đảo ngược để ngày mới nhất lên đầu)
    timelineData.reverse().forEach(item => {
        let dateDisplay = item.date.substring(5); // MM-DD
        let targetDisplay = fmtNum(item.target);
        
        let accCells = '';
        accSettings.forEach(acc => {
            let vol = item.vols[acc.id];
            let cls = vol >= item.target && item.target > 0 ? 'text-green fw-bold' : (vol > 0 ? 'text-white' : 'text-sub opacity-50');
            accCells += `<td class="text-center font-num ${cls}">${vol > 0 ? fmtNum(vol) : '-'}</td>`;
        });

        // Chỉ hiện nút Xóa cho ngày có dữ liệu thực
        let deleteBtn = item.isAuto 
            ? `<i class="fas fa-trash text-secondary opacity-25" style="cursor:not-allowed" title="Auto-filled"></i>` 
            : `<i class="fas fa-trash text-danger cursor-pointer" onclick="deleteHistory('${item.date}')" title="Delete"></i>`;

        l.innerHTML += `<tr>
            <td class="font-num text-sub">${dateDisplay}</td>
            <td class="text-gold font-num fw-bold">${targetDisplay}</td>
            ${accCells}
            <td class="text-end">
                <i class="fas fa-pencil-alt text-secondary me-3 cursor-pointer" onclick="loadHistoryToEdit('${item.date}')" title="Edit"></i>
                ${deleteBtn}
            </td>
        </tr>`;
    });
}

    async function deleteHistory(date) {
        if(!confirm("Delete history for " + date + "?")) return;
        let id = document.getElementById('u-db-id').value;
        let c = compList.find(x => x.id == id);

        // V43: DELETE FROM CLOUD TRACKER DATA
        if(userProfile.tracker_data && userProfile.tracker_data[id]) {
            userProfile.tracker_data[id] = userProfile.tracker_data[id].filter(p => p.date !== date);
            // Save to Cloud immediately
            await supabase.from('profiles').update({ tracker_data: userProfile.tracker_data }).eq('id', currentUser.id);
        }

        if(document.body.classList.contains('is-admin')) {
             if(c.history) {
                 c.history = c.history.filter(h => h.date !== date);
                 await saveToCloud(c);
             }
        } else {
            renderTrackerChart(c);
            renderHistoryList(c);
        }
        if(document.getElementById('u-date').value === date) {
             document.getElementById('u-date').value = new Date().toISOString().split('T')[0];
             loadDateData(document.getElementById('u-date').value);
        } else {
             loadDateData(document.getElementById('u-date').value);
        }
    }

  async function saveUpdate() {
    if (!currentUser) return showToast("Please login first!", "error"); // Đã sửa

    let btn = document.getElementById('btn-save-progress');
    let orgText = btn.innerText;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SENDING...'; 
    btn.disabled = true;

    try {
        let rawId = document.getElementById('u-db-id').value;
        let dbId = parseInt(rawId); 
        let c = compList.find(x => x.db_id === dbId);
        
        // Đã sửa thông báo lỗi
        if (!c) throw new Error(`Tournament ID not found: ${dbId}`);

        let date = document.getElementById('u-date').value;
        let telegramTriggered = false; 
        let newMinVol = "0";

        // --- LOGIC ADMIN ---
        if (document.body.classList.contains('is-admin')) {
            let minInput = document.getElementById('u-min-vol');
            
            if (!minInput.disabled && minInput.value.trim() !== "") {
                let minValStr = minInput.value.replace(/,/g, ''); 
                let t = parseFloat(minValStr);

                if (!isNaN(t)) {
                    if (!Array.isArray(c.history)) c.history = [];
                    c.history = c.history.filter(h => h.date !== date);
                    c.history.push({ date: date, target: t });
                    c.history.sort((a, b) => new Date(a.date) - new Date(b.date));

                    await saveToCloud(c);
                    telegramTriggered = true;
                    newMinVol = new Intl.NumberFormat('en-US').format(t);
                }
            }
        }

        // --- LOGIC USER ---
        let my = {};
        accSettings.forEach(acc => {
            let v = parseFloat(document.getElementById(`u-vol-${acc.id}`)?.value || 0);
            let cost = parseFloat(document.getElementById(`u-cost-${acc.id}`)?.value || 0);
            my[acc.id] = { vol: v, cost: cost };
        });

        if (!userProfile.tracker_data) userProfile.tracker_data = {};
        if (!userProfile.tracker_data[dbId]) userProfile.tracker_data[dbId] = [];
        userProfile.tracker_data[dbId] = userProfile.tracker_data[dbId].filter(p => p.date !== date);
        if (Object.values(my).some(x => x.vol > 0 || x.cost > 0)) {
            userProfile.tracker_data[dbId].push({ date: date, accsDetail: my });
        }
        await supabase.from('profiles').update({ tracker_data: userProfile.tracker_data }).eq('id', currentUser.id);

        // --- SỬA THÔNG BÁO THÀNH CÔNG ---
        if (telegramTriggered) {
             await sendTeleAlert(c, newMinVol);
             showToast("Updated & Telegram Alert sent successfully!", "success"); // Đã sửa
        } else {
             showToast("Data saved successfully!", "success"); // Đã sửa
        }

        // --- HOÀN TẤT ---
        btn.innerHTML = '<i class="fas fa-check"></i> SAVED!';
        btn.style.background = "#0ECB81"; 
        btn.style.color = "#000";

        setTimeout(() => {
            btn.innerText = orgText;
            btn.style.background = "";
            btn.style.color = "";
            btn.disabled = false;
            renderTrackerChart(c);
            renderHistoryList(c);
            renderGrid();
        }, 1000);

    } catch (e) {
        console.error("Save Error:", e);
        showToast("Error: " + e.message, "error"); // Đã sửa
        btn.innerText = "ERROR";
        setTimeout(() => { btn.innerText = orgText; btn.disabled = false; }, 3000);
    }
}

    // ADMIN: AUTOMATED SETTLE REWARDS (V45 SECURITY UPGRADE)
    async function settleTournament() {
        if(!confirm("CONFIRM: End tournament and distribute rewards automatically (Server-side)?")) return;

        let c = compList.find(x => x.db_id == currentPolyId);

        document.getElementById('loading-overlay').style.display = 'flex';

        // CALL RPC FUNCTION INSTEAD OF JS LOGIC
        const { data, error } = await supabase.rpc('settle_tournament', { tourn_id: parseInt(currentPolyId) });

        document.getElementById('loading-overlay').style.display = 'none';

        if(error) {
            console.error(error);
            showToast("Settlement Failed: " + error.message, "error");
        } else if (data.status === 'error') {
            showToast("Logic Error: " + data.message, "error");
        } else {
            showToast("SETTLEMENT COMPLETE! Check History.", "success");
            alert(`Result (Min Vol): ${fmtNum(data.actualVol)}\nPool: ${data.pool} $\nWinners:\n${data.winners.join('\n')}`);
            loadFromCloud();
        }
    }

    // --- HÀM ĐỒNG BỘ DỮ LIỆU CŨ LÊN MÂY (MIGRATION TOOL) ---
    async function syncLocalToCloud() {
    if(!currentUser) return showToast("Please login first!", "error"); // Đã sửa

    // Đã sửa confirm
    if(!confirm("This action will OVERWRITE Cloud data with local data. Are you sure?")) return;

    let migrationData = {};
    let count = 0;

    for(let i=0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        if(key.startsWith('wave_progress_')) {
            let dbId = key.replace('wave_progress_', '');
            try {
                let data = JSON.parse(localStorage.getItem(key));
                migrationData[dbId] = data;
                count++;
            } catch(e) {}
        }
    }

    if(count === 0) return showToast("No local data found on this device!", "error"); // Đã sửa

    let btn = document.querySelector('button[onclick="syncLocalToCloud()"]');
    let oldText = btn.innerHTML;
    btn.innerHTML = "UPLOADING..."; btn.disabled = true;

    const { error } = await supabase.from('profiles').update({ tracker_data: migrationData }).eq('id', currentUser.id);

    btn.innerHTML = oldText; btn.disabled = false;

    if(error) {
        showToast("Error: " + error.message, "error"); // Đã sửa
    } else {
        showToast(`Success! Migrated ${count} tournaments to Cloud.`, "success"); // Đã sửa
        if(userProfile) userProfile.tracker_data = migrationData;
        renderGrid();
        bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
    }
}

    // Standard Utils
        function openSettingsModal() {
        let list = document.getElementById('settingsList');
        list.innerHTML = '';
        accSettings.forEach((acc, i) => {
            list.innerHTML += `
            <div class="d-flex align-items-center gap-2">
                <input type="color" class="form-control form-control-color" value="${acc.color}" onchange="updateAccColor(${i}, this.value)" style="height:35px;width:50px">
                <input value="${acc.name}" class="form-control form-control-sm" onchange="updateAccName(${i}, this.value)" placeholder="Account Name">
                <button class="btn btn-sm btn-outline-danger border-0" onclick="delAcc(${i})"><i class="fas fa-trash"></i></button>
            </div>`;
        });
        new bootstrap.Modal(document.getElementById('settingsModal')).show();
    }

    // --- CẬP NHẬT CÁC HÀM QUẢN LÝ VÍ (CÓ GỌI SYNC CLOUD) ---

function updateAccName(i, val) { 
    accSettings[i].name = val; 
    localStorage.setItem('wave_settings', JSON.stringify(accSettings)); 
    updateCloudWallets(); // <--- Thêm dòng này
    renderGrid(); 
}

function updateAccColor(i, val) { 
    accSettings[i].color = val; 
    localStorage.setItem('wave_settings', JSON.stringify(accSettings)); 
    updateCloudWallets(); // <--- Thêm dòng này
    renderGrid(); 
}

function addNewAccount() { 
    accSettings.push({
        id: 'acc_' + Date.now(), 
        name: document.getElementById('newAccName').value || 'New', 
        color: document.getElementById('newAccColor').value
    }); 
    localStorage.setItem('wave_settings', JSON.stringify(accSettings)); 
    updateCloudWallets(); // <--- Thêm dòng này
    openSettingsModal(); 
    renderGrid(); 
}

function delAcc(i) { 
    if(confirm("Delete?")) { 
        accSettings.splice(i, 1); 
        localStorage.setItem('wave_settings', JSON.stringify(accSettings)); 
        updateCloudWallets(); // <--- Thêm dòng này
        openSettingsModal(); 
        renderGrid(); 
    } 
}
        /* --- CÁC HÀM QUẢN LÝ ADMIN (ĐÃ FIX LOGIC CAMPAIGN & PRICE) --- */

    // 1. Mở Modal tạo mới
    function openCreateModal() {
        document.getElementById('c-db-id').value = '';

        // Reset các ô nhập liệu
        document.getElementById('c-contract').value = '';
        document.getElementById('c-symbol').value = '';
        document.getElementById('c-chain').value = ''; // VD: arbitrum
        document.getElementById('c-price').value = '';
        document.getElementById('c-logo').value = '';
        document.getElementById('c-logo-preview').style.display = 'none';

        document.getElementById('c-rewardQty').value = '';
        document.getElementById('c-winners').value = '';

        // Reset ô nhập Token Campaign
        let tokenInput = document.getElementById('c-inputTokens');
        if(tokenInput) tokenInput.value = '';

        // Ẩn nút xóa
        document.getElementById('btnDeleteComp').style.display = 'none';

        new bootstrap.Modal(document.getElementById('compModal')).show();
    }

    // --- 1. ADMIN EDIT: LẤY DỮ LIỆU THÔ TỪ DB HIỆN LÊN (KHÔNG CONVERT) ---
function openEditModal(id) {
    let c = compList.find(x => x.db_id == id);
    if(!c) return;

    document.getElementById('c-db-id').value = id;
    document.getElementById('c-contract').value = c.contract;
    document.getElementById('c-symbol').value = c.name;
    document.getElementById('c-chain').value = c.chain;
    document.getElementById('c-price').value = c.cachedPrice;
    document.getElementById('c-logo').value = c.logo;
    let imgPreview = document.getElementById('c-logo-preview');
    if(c.logo) { imgPreview.src = c.logo; imgPreview.style.display = 'block'; }
    else { imgPreview.style.display = 'none'; }

    document.getElementById('c-rewardQty').value = c.rewardQty;
    document.getElementById('c-winners').value = c.topWinners;
    document.getElementById('c-alphaType').value = c.alphaType;
    document.getElementById('c-rule').value = c.ruleType;

    // --- NGÀY GIỜ: HIỂN THỊ Y NGUYÊN (ADMIN TỰ HIỂU LÀ UTC) ---
    document.getElementById('c-start').value = c.start;
    document.getElementById('c-end').value = c.end;
    document.getElementById('c-end-time').value = c.endTime;
    
    // Listing Time (DB lưu "YYYY-MM-DDTHH:mm", Input cũng dùng định dạng đó -> Khớp)
    document.getElementById('c-listing').value = c.listingTime || '';

    let tokenInput = document.getElementById('c-inputTokens');
    if(tokenInput) {
        if (c.inputTokens && Array.isArray(c.inputTokens)) tokenInput.value = c.inputTokens.join(', ');
        else tokenInput.value = '';
    }

    toggleListingTime();
    document.getElementById('btnDeleteComp').style.display = 'inline-block';
    new bootstrap.Modal(document.getElementById('compModal')).show();
}

            // 3. Logic bật tắt ô nhập giờ Listing
    function toggleListingTime() {
        document.getElementById('c-listing').disabled = document.getElementById('c-alphaType').value === 'none';
    }

    // --- 2. ADMIN SAVE: LƯU Y NGUYÊN (KHÔNG CONVERT) ---
function saveComp() {
    let id = document.getElementById('c-db-id').value;
    let c = id ? compList.find(x => x.db_id == id) : {};

    let tokensArr = [];
    let tokenInput = document.getElementById('c-inputTokens');
    if (tokenInput && tokenInput.value.trim() !== "") {
        tokensArr = tokenInput.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s !== '');
    }

    let obj = {
        db_id: id ? parseInt(id) : null,
        name: document.getElementById('c-symbol').value.toUpperCase(),
        contract: document.getElementById('c-contract').value,
        chain: document.getElementById('c-chain').value,
        logo: document.getElementById('c-logo').value,
        cachedPrice: document.getElementById('c-price').value,
        rewardQty: document.getElementById('c-rewardQty').value,
        topWinners: document.getElementById('c-winners').value,
        
        // LƯU THẲNG GIÁ TRỊ NHẬP VÀO
        start: document.getElementById('c-start').value,
        end: document.getElementById('c-end').value,
        endTime: document.getElementById('c-end-time').value,
        listingTime: document.getElementById('c-listing').value,

        alphaType: document.getElementById('c-alphaType').value,
        ruleType: document.getElementById('c-rule').value,
        inputTokens: tokensArr,
        history: c.history || [],
        predictions: c.predictions || [],
        comments: c.comments || []
    };

    saveToCloud(obj);
    bootstrap.Modal.getInstance(document.getElementById('compModal')).hide();
}

    // 5. Xóa giải đấu
    function deleteComp() {
        if(confirm('Delete this tournament?')) {
            deleteFromCloud(document.getElementById('c-db-id').value);
            bootstrap.Modal.getInstance(document.getElementById('compModal')).hide();
        }
    }

    // 6. Hàm gọi Server xóa
    async function deleteFromCloud(id) {
        await supabase.from('tournaments').delete().eq('id', id);
        loadFromCloud();
    }


    async function fetchTokenInfo(q) {
        if(!q) return;
        try {
            let r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${q}`);
            let d = await r.json();
            if(d.pairs && d.pairs.length) {
                let p = d.pairs[0];
                document.getElementById('c-symbol').value = p.baseToken.symbol;
                document.getElementById('c-price').value = p.priceUsd;
                document.getElementById('c-chain').value = p.chainId;

                let logoUrl = p.info?.imageUrl || `https://dd.dexscreener.com/ds-data/tokens/${p.chainId}/${p.baseToken.address}.png`;
                document.getElementById('c-logo').value = logoUrl;
                let img = document.getElementById('c-logo-preview');
                img.src = logoUrl; img.style.display = 'block';
            }
        } catch(e){}
    }

        // --- FIX: RENDER STATS TỪ SERVER ---
            // --- CẬP NHẬT: CHỈ TÍNH TỔNG TIỀN CÁC GIẢI ĐANG CHẠY (ACTIVE ONLY) ---
    function renderStats() {
        const now = new Date();
        let activeCount = 0;
        let totalEstValue = 0;

        // Biến để tìm Token có giải to nhất
        let maxRewardVal = 0;
        let topToken = null;

        compList.forEach(c => {
            // 1. Kiểm tra trạng thái Running (Còn hạn)
            let isRunning = true;
            if (c.end) {
                let endDateTime = new Date(c.end + 'T' + (c.endTime || '23:59:59'));
                if (now > endDateTime) isRunning = false;
            }

            // 2. Tính toán
            if (isRunning) {
                activeCount++;
                let qty = parseFloat(c.rewardQty) || 0;
                let price = parseFloat(c.cachedPrice) || 0;
                let currentVal = qty * price;

                totalEstValue += currentVal;

                // So sánh tìm Top 1 (Giải thưởng lớn nhất)
                if (currentVal > maxRewardVal) {
                    maxRewardVal = currentVal;
                    topToken = c;
                }
            }
        });

        // 3. Hiển thị 2 ô cơ bản
        document.getElementById('stat-active').innerText = activeCount;
        document.getElementById('stat-pool').innerText = fmt(totalEstValue);

        // 4. Hiển thị ô Top 1 (Highest Reward)
        if (topToken) {
            document.getElementById('stat-top-symbol').innerText = topToken.name;
            document.getElementById('stat-top-val').innerText = fmt(maxRewardVal);
            
            // Hiển thị logo token làm nền (nếu có)
            if(topToken.logo) {
                let imgEl = document.getElementById('stat-top-img');
                imgEl.src = topToken.logo;
                imgEl.style.display = 'block';
            } else {
                document.getElementById('stat-top-img').style.display = 'none';
            }
        } else {
            // Nếu không có giải nào chạy
            document.getElementById('stat-top-symbol').innerText = "---";
            document.getElementById('stat-top-val').innerText = "$0";
            document.getElementById('stat-top-img').style.display = 'none';
        }
    }


        // --- [V61 FINAL] SYSTEM CLOCK: STANDARD UTC+0 ---
function updateClock() {
    const now = new Date();

    // 1. HIỂN THỊ GIỜ HỆ THỐNG (LUÔN LÀ UTC)
    if(document.getElementById('sysClock')) {
        // Lấy ngày giờ theo chuẩn UTC
        let dateStr = now.toLocaleDateString('en-GB', { 
            day: '2-digit', month: '2-digit', year: 'numeric', timeZone: 'UTC' 
        });
        let timeStr = now.toLocaleTimeString('en-GB', {
            hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit", timeZone: 'UTC'
        });

        document.getElementById('sysClock').innerText = `${dateStr} ${timeStr}`;
        document.getElementById('sysClock').style.fontSize = "1rem"; 

        // Luôn ghi chú là UTC để user không nhầm lẫn
        let labelEl = document.querySelector('[data-i18n="sys_time"]');
        if(labelEl) {
            let baseText = translations[currentLang].sys_time;
            labelEl.innerText = `${baseText} (UTC)`; 
            labelEl.style.color = "var(--brand)";
            labelEl.style.fontWeight = "bold";
        }
    }

    // 2. Cập nhật các bộ đếm ngược (X4 Timer - Dùng chuẩn UTC)
    document.querySelectorAll('.x4-timer-val').forEach(el => {
        const listDateStr = el.dataset.list; // Chuỗi ngày giờ từ DB (UTC)
        if(listDateStr) {
            // Thêm 'Z' để báo là UTC
            let endTimeStr = listDateStr.includes('T') ? listDateStr : listDateStr + 'T00:00:00';
            const endTime = new Date(endTimeStr + 'Z').getTime() + (30*24*60*60*1000);
            const dist = endTime - now.getTime();
            if(dist < 0) { el.innerText="EXPIRED"; el.style.color='#555'; }
            else {
                const d = Math.floor(dist/(1000*60*60*24));
                const h = Math.floor((dist%(1000*60*60*24))/(1000*60*60));
                el.innerText = `${d}d ${h}h`;
            }
        }
    });

    // 3. Smart Timer (Nếu có dùng ở đâu đó)
    document.querySelectorAll('.smart-timer').forEach(el => {
        let endDateStr = el.dataset.end;
        let endTimeStr = el.dataset.time;
        if(!endDateStr) return;
        // Thêm 'Z' vào cuối để tính theo UTC
        let endDateTime = new Date(endDateStr + 'T' + endTimeStr + 'Z'); 
        let diff = endDateTime - now;
        
        if (diff < 0) { 
            el.innerText = "ENDED"; 
            el.style.color = 'var(--text-sub)';
            el.classList.remove('anim-breathe');
            return; 
        }

        // Logic hiển thị
        let todayUTC = new Date().toISOString().split('T')[0];
        if (endDateStr === todayUTC) {
            let h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            let m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            let s = Math.floor((diff % (1000 * 60)) / 1000);
            el.innerText = `${h}h ${m}m ${s}s`;
            el.style.color = 'var(--brand)';
            el.classList.add('anim-breathe');
        } else {
            el.innerText = endDateStr;
            el.style.color = '';
            el.classList.remove('anim-breathe');
        }
    });

    // 4. Đồng hồ trang chi tiết (View Predict) - Dùng chuẩn UTC
    if (currentPolyId && document.getElementById('view-predict').style.display === 'block') {
        let c = compList.find(x => x.db_id == currentPolyId);
        let timerEl = document.getElementById('pt-time');
        if (c && c.end && timerEl) {
            // Thêm 'Z' chuẩn UTC
            let endTime = new Date(c.end + 'T' + (c.endTime || '23:59:59') + 'Z').getTime(); 
            let dist = endTime - now.getTime();
            if (dist < 0) {
                timerEl.innerText = "MARKET CLOSED";
                timerEl.className = "text-danger font-num fw-bold fs-3";
            } else {
                let d = Math.floor(dist / (1000 * 60 * 60 * 24));
                let h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                let m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
                timerEl.innerText = `${d}d : ${h}h : ${m}m`;
                timerEl.className = "text-gold font-num fw-bold fs-3 anim-breathe";
            }
        }
    }
}


/* ============================================================
   V47: SILENT RELOAD (CẬP NHẬT MƯỢT MÀ KHÔNG NHÁY MÀN HÌNH)
   ============================================================ */
// --- [FIXED] HÀM CẬP NHẬT NGẦM AN TOÀN (SAFE RELOAD) ---
async function silentReload(id) {
    // 1. Âm thầm lấy dữ liệu mới
    const { data: predsData, error } = await supabase.from('predictions').select('*').eq('tournament_id', id);
    if (error) return console.error(error);

    // 2. Cập nhật dữ liệu vào bộ nhớ
    let c = compList.find(x => x.db_id == id);
    if (c && predsData) {
        c.predictions = predsData.map(p => ({
            user_id: p.user_id, name: p.user_name, avatar: p.user_avatar,
            guess: parseFloat(p.guess), time: new Date(p.created_at).getTime()
        }));

        // 3. Cập nhật Pool & Min Vol (Chỉ update nếu tìm thấy ID trên màn hình)
        let pool = (c.predictions.length || 0) * PREDICT_FEE;
        let poolEl = document.getElementById('pt-pool');
        if(poolEl) poolEl.innerText = fmt(pool);

        let curMin = (c.history && c.history.length > 0) ? c.history[c.history.length - 1].target : 0;

        // 4. Cập nhật Bảng Xếp Hạng (Leaderboard) - QUAN TRỌNG: CÓ KIỂM TRA TỒN TẠI
        let lb = document.getElementById('pt-leaderboard');
        if (lb) { 
            lb.innerHTML = ''; 
            let preds = (c.predictions || []).sort((a, b) => Math.abs(a.guess - curMin) - Math.abs(b.guess - curMin));
            
            if(preds.length === 0) lb.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-sub opacity-50">No Data</td></tr>';

            preds.forEach((p, i) => {
                let badgeHtml = i < 3 ? `<span class="rank-badge rank-${i + 1}">${i + 1}</span>` : `<span class="rank-badge">${i + 1}</span>`;
                let avatarHtml = p.avatar ? `<img src="${p.avatar}" class="list-avatar">` : `<div class="list-avatar-placeholder">${p.name.substring(0, 1).toUpperCase()}</div>`;
                
                // Highlight dòng của chính mình
                let myName = document.getElementById('modal-p-name')?.value || '';
                let highlightClass = (p.name === myName) ? 'anim-breathe' : '';

                lb.innerHTML += `<tr class="${highlightClass}"><td class="ps-4">${badgeHtml}</td><td>${avatarHtml}<span class="fw-bold text-white">${p.name}</span></td><td class="text-end pe-4 text-brand font-num fw-bold">${fmtNum(p.guess)}</td></tr>`;
            });
        }
        
        // 5. [FIX] Bỏ qua cập nhật 'content-activity' vì giao diện mới không dùng nữa
        // (Hoặc nếu bạn muốn dùng lại sau này, hãy thêm if(actDiv) như dưới đây)
        let actDiv = document.getElementById('content-activity');
        if (actDiv) {
            actDiv.innerHTML = '';
            // Logic cũ nếu cần...
        }
    }
}

    init();
    // --- BACKUP & RESTORE LOGIC (ENGLISH) ---
function backupData() {
    let data = {};
    // Get all Wave Alpha related data
    for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        if (key.startsWith('wave_')) {
            data[key] = localStorage.getItem(key);
        }
    }
    // Create download file
    let blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    let date = new Date().toISOString().slice(0,10);
    a.download = 'WaveAlpha_Backup_' + date + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // Notification in English
    alert("Backup file downloaded successfully!");
}

function restoreData(input) {
    let file = input.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(e) {
        try {
            let data = JSON.parse(e.target.result);
            for (let key in data) {
                localStorage.setItem(key, data[key]);
            }
            alert("Data restored successfully! Page reloading...");
            window.location.reload();
        } catch (err) {
            alert("Error: Invalid backup file!");
        }
    };
    reader.readAsText(file);
    input.value = ''; // Reset input
}
// ----------------------------------------

    /* ================= ARSENAL DYNAMIC CONFIG LOGIC ================= */

    // 1. Hàm vẽ lại danh sách Input trong Modal từ dữ liệu đã lưu
    function renderArsenalInputs(items = []) {
        const container = document.getElementById('cfg-arsenal-list');
        container.innerHTML = '';

        items.forEach((item, index) => {
            addArsenalItem(item, index);
        });
    }

    // 2. Hàm thêm một dòng nhập liệu mới (hoặc vẽ dòng cũ)
    function addArsenalItem(data = null, index = null) {
        const container = document.getElementById('cfg-arsenal-list');
        const uniqueId = Date.now() + Math.random().toString(36).substr(2, 9); // Tạo ID ngẫu nhiên

        const name = data ? data.name : '';
        const link = data ? data.link : '';
        const logo = data ? data.logo : '';
        const type = data ? data.type : 'EXCHANGE'; // Mặc định là CEX

        const html = `
        <div class="p-3 rounded border border-secondary border-opacity-25 bg-dark arsenal-item-row" data-id="${uniqueId}">
            <div class="d-flex gap-2 mb-2">
                <input type="text" class="form-control form-control-sm inp-name" placeholder="Tên sàn (VD: Binance)" value="${name}" style="flex:1">
                <select class="form-select form-select-sm inp-type" style="width:130px">
                    <option value="EXCHANGE" ${type==='EXCHANGE'?'selected':''}>Sàn CEX</option>
                    <option value="WEB3 WALLET" ${type==='WEB3 WALLET'?'selected':''}>Ví Web3</option>
                    <option value="DEX SWAP" ${type==='DEX SWAP'?'selected':''}>Sàn DEX</option>
                </select>
            </div>

            <div class="d-flex gap-2 mb-2 align-items-center">
                <input type="text" class="form-control form-control-sm inp-link" placeholder="Link Ref (https://...)" value="${link}">

                <div class="position-relative btn btn-sm btn-outline-secondary" style="width:35px; overflow:hidden;" title="Logo">
                    <i class="fas fa-camera"></i>
                    <input type="file" onchange="uploadImage(this, 'prev-${uniqueId}', 'val-${uniqueId}')" style="position:absolute;left:0;top:0;opacity:0;cursor:pointer;width:100%;height:100%">
                </div>
                <input type="hidden" class="inp-logo" id="val-${uniqueId}" value="${logo}">
                <img id="prev-${uniqueId}" src="${logo}" style="width:30px;height:30px;object-fit:contain; ${logo?'':'display:none'}; border:1px solid #444; border-radius:4px">
            </div>

            <div class="d-flex justify-content-between">
                <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-dark border-secondary" onclick="moveItem(this, -1)" title="Lên"><i class="fas fa-arrow-up"></i></button>
                    <button class="btn btn-sm btn-dark border-secondary" onclick="moveItem(this, 1)" title="Xuống"><i class="fas fa-arrow-down"></i></button>
                </div>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="this.closest('.arsenal-item-row').remove()"><i class="fas fa-trash me-1"></i> Xóa</button>
            </div>
        </div>`;

        container.insertAdjacentHTML('beforeend', html);
    }

    // 3. Hàm di chuyển vị trí (Lên/Xuống)
    function moveItem(btn, direction) {
        const row = btn.closest('.arsenal-item-row');
        const container = document.getElementById('cfg-arsenal-list');
        if (direction === -1 && row.previousElementSibling) {
            container.insertBefore(row, row.previousElementSibling);
        } else if (direction === 1 && row.nextElementSibling) {
            container.insertBefore(row.nextElementSibling, row);
        }
    }

// --- [MỚI - ĐÃ FIX] HÀM TÍNH TOÁN TRUNG BÌNH 10S (Rolling Average) ---
function calculateSafeAvg(id, currentTotalVol) {
    // 1. Nếu chưa có dữ liệu lịch sử (Lần chạy đầu tiên)
    if (!tokenVolHistory[id]) {
        tokenVolHistory[id] = {
            history: [],
            lastVol: currentTotalVol, // Ghi nhớ mốc 48 Triệu $
            lastTime: Date.now()
        };
        return 0; // TRẢ VỀ 0 NGAY LẬP TỨC để tránh hiện số 48 Triệu ra màn hình
    }

    let tracker = tokenVolHistory[id];

    // 2. Tính chênh lệch (Delta) so với lần trước
    // Ví dụ: 48,005,000 - 48,000,000 = 5,000
    let delta = currentTotalVol - tracker.lastVol;

    // Cập nhật mốc mới
    tracker.lastVol = currentTotalVol;

    // --- BỘ LỌC NHIỄU QUAN TRỌNG ---
    // Nếu delta < 0 (Sàn reset ngày mới) hoặc delta quá lớn vô lý (> 10% tổng vol 1 lúc)
    // Thì coi như bằng 0 để không làm hỏng biểu đồ
    if (delta < 0 || delta > (currentTotalVol * 0.1)) {
        delta = 0;
    }

    // 3. Đẩy vào mảng lịch sử (Rolling Window)
    tracker.history.push(delta);
    
    // Chỉ giữ lại đúng 10 mẫu gần nhất (10 giây)
    if (tracker.history.length > SAFETY_WINDOW) {
        tracker.history.shift(); // Xóa mẫu cũ nhất
    }

    // 4. TÍNH TRUNG BÌNH CỘNG (AVERAGE)
    // Tổng 10 lần / 10 = Trung bình mỗi giây
    // Ví dụ: Tổng 10s là 50k -> Trung bình là 5k/s
    if (tracker.history.length === 0) return 0;
    let totalInWindow = tracker.history.reduce((a, b) => a + b, 0);
    let avg = totalInWindow / tracker.history.length;

    return avg;
}

// --- LOGIC LỊCH: DEADLINE RADAR (CÓ TỔNG TIỀN) ---
let currentFilterDate = null;

function initCalendar() {
    const container = document.getElementById('calendar-wrapper');
    if (!container) return;
    container.innerHTML = ''; 

    // 1. Thống kê: Số lượng giải & Tổng giá trị theo ngày
    let dateStats = {}; 

    compList.forEach(c => {
        if(c.end) {
            if(!dateStats[c.end]) dateStats[c.end] = { count: 0, totalVal: 0 };
            
            // Tăng biến đếm số lượng
            dateStats[c.end].count++;

            // Tính tiền: Qty * Giá (Ưu tiên giá mới nhất, nếu không có thì lấy giá cache)
            let qty = parseFloat(c.rewardQty) || 0;
            let price = (c.market_analysis && c.market_analysis.price) ? c.market_analysis.price : (c.cachedPrice || 0);
            
            // Cộng dồn vào tổng ngày đó (Tính cả giải đang chạy và đã kết thúc trong ngày)
            dateStats[c.end].totalVal += (qty * price);
        }
    });

    // 2. Vẽ 15 ngày
    const today = new Date();
    let html = '';

    for (let i = 0; i < 15; i++) {
        let d = new Date();
        d.setDate(today.getDate() + i);

        // Format YYYY-MM-DD để so sánh
        let year = d.getFullYear();
        let month = String(d.getMonth() + 1).padStart(2, '0');
        let day = String(d.getDate()).padStart(2, '0');
        let dateStr = `${year}-${month}-${day}`;

        // Hiển thị: THỨ (T2...) & NGÀY (16...)
        let dayName = d.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
        let dayNum = d.getDate();

        // Lấy dữ liệu thống kê của ngày này
        let stat = dateStats[dateStr] || { count: 0, totalVal: 0 };
        
        // HTML Badge số lượng (Nếu có giải thì hiện chấm vàng)
        let badgeHtml = stat.count > 0 ? `<div class="date-dot">${stat.count}</div>` : '';
        
        // HTML Số tiền (Format: 1.5k, 2M...)
        let moneyHtml = '';
        if (stat.totalVal > 0) {
            let val = stat.totalVal;
            let txt = '';
            if (val >= 1000000) txt = '$' + (val / 1000000).toFixed(1) + 'M';
            else if (val >= 1000) txt = '$' + (val / 1000).toFixed(0) + 'k';
            else txt = '$' + Math.round(val);
            
            moneyHtml = `<div class="d-val">${txt}</div>`;
        } else {
            // Để trống 1 dòng ẩn (visibility:hidden) để các ô cao bằng nhau
            moneyHtml = `<div class="d-val" style="visibility:hidden">-</div>`;
        }

        let activeClass = (currentFilterDate === dateStr) ? 'active' : '';

        html += `
            <div class="date-box ${activeClass}" id="dbox-${dateStr}" onclick="filterByDate('${dateStr}')">
                ${badgeHtml}
                <div class="d-name">${dayName}</div>
                <div class="d-num">${dayNum}</div>
                ${moneyHtml}
            </div>
        `;
    }
    container.innerHTML = html;
}

// Hàm lọc (Giữ nguyên logic chuẩn)
function filterByDate(dateStr) {
    document.querySelectorAll('.date-card').forEach(el => el.classList.remove('active'));
    if (dateStr === null || currentFilterDate === dateStr) {
        currentFilterDate = null;
        renderGrid(null);
        return;
    }
    currentFilterDate = dateStr;
    let box = document.getElementById(`date-${dateStr}`);
    if(box) box.classList.add('active');

    let filteredList = compList.filter(c => c.end === dateStr);
    renderGrid(filteredList);
}

// 3. Kích hoạt ngay lập tức
initCalendar();
// --- HÀM CHUYỂN TAB CHO GIAO DIỆN COCKPIT MỚI ---
// --- HÀM CHUYỂN TAB MỚI (ĐÃ FIX LỖI HIỂN THỊ) ---
function switchCpTab(tabName) {
    // 1. Cập nhật trạng thái nút bấm (Màu sắc)
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(`tab-btn-${tabName}`).classList.add('active');

    // 2. Lấy 2 khung nội dung
    const lbBox = document.getElementById('cp-content-leaderboard');
    const chatBox = document.getElementById('cp-content-chat');

    // 3. Xử lý ẩn hiện (Dùng class mới định nghĩa ở CSS)
    if (tabName === 'leaderboard') {
        // Hiện Leaderboard, Ẩn Chat
        lbBox.classList.remove('hide-force');
        chatBox.classList.remove('chat-visible');
        chatBox.classList.add('d-none'); // Đảm bảo ẩn hẳn
    } else {
        // Ẩn Leaderboard, Hiện Chat
        lbBox.classList.add('hide-force');
        chatBox.classList.remove('d-none'); // Gỡ bỏ class ẩn của Bootstrap
        chatBox.classList.add('chat-visible'); // Kích hoạt Flex để hiện khung chat
        
        // Auto scroll xuống cuối khung chat
        let feed = document.getElementById('chat-feed');
        if(feed) feed.scrollTop = feed.scrollHeight;
    }
}

// --- CẬP NHẬT LẠI HÀM openPredictionView (Để tương thích với giao diện mới) ---
// Bạn Tìm hàm openPredictionView cũ và thay thế bằng hàm này:

async function openPredictionView(id) {
    currentPolyId = id;
    document.getElementById('loading-overlay').style.display = 'flex';

    // 1. Fetch Data
    const { data: predsData, error } = await supabase.from('predictions').select('*').eq('tournament_id', id);
    document.getElementById('loading-overlay').style.display = 'none';

    if (error) { showToast("Error loading data", "error"); return; }

    // 2. Map Data
    let c = compList.find(x => x.db_id == id);
    if(c) {
        c.predictions = predsData.map(p => ({
            user_id: p.user_id, name: p.user_name, avatar: p.user_avatar,
            guess: parseFloat(p.guess), time: new Date(p.created_at).getTime()
        }));
    }

    // 3. Switch View
    // Lưu ý: Giao diện mới dùng z-index đè lên, nên ta chỉ cần show div view-predict
    document.getElementById('view-predict').style.display = 'block';
    
    // 4. Update Data to UI
    updateTerminalData(id);
}

// --- CẬP NHẬT LOGIC NÚT BACK (QUAN TRỌNG) ---
function switchView(view) {
    // 1. Ẩn tất cả trước
    document.getElementById('view-dashboard').style.display = 'none';
    document.getElementById('view-predict').style.display = 'none';

    // 2. Hiện cái cần thiết
    if (view === 'dashboard') {
        document.getElementById('view-dashboard').style.display = 'block';
        // Reset ID để tránh lỗi vẽ lại
        currentPolyId = null;
        renderGrid();
    } 
    else if (view === 'predict') {
        // Giao diện Cockpit mới dùng display: block thay vì flex
        document.getElementById('view-predict').style.display = 'block';
    }
}

// --- [V75 FINAL LOGIC] CHART: SMART TOOLTIP (CHỈ HIỆN EST. FINAL Ở CỘT CUỐI) ---
function renderCardMiniChart(c) {
    const ctx = document.getElementById(`miniChart-${c.db_id}`);
    if (!ctx) return;

    let now = new Date();

    // 1. TÍNH TOÁN DATA & THỜI GIAN
    let tournamentEndTime = null;
    let isEnded = false;
    if (c.end) {
        tournamentEndTime = new Date(c.end + 'T' + (c.endTime || '23:59:59') + 'Z');
        if (now > tournamentEndTime) isEnded = true;
    }

    let todayMidnight = new Date();
    todayMidnight.setUTCHours(23, 59, 59, 999);
    let projectionTargetTime = todayMidnight;
    
    if (tournamentEndTime && tournamentEndTime < todayMidnight) {
        projectionTargetTime = tournamentEndTime;
    }

    let secondsRemaining = (projectionTargetTime - now) / 1000;
    if (secondsRemaining < 0) secondsRemaining = 0;
    if (isEnded) secondsRemaining = 0;

    let anchorDate = new Date();
    if (isEnded && c.end) {
        let parts = c.end.split('-'); 
        anchorDate = new Date(Date.UTC(parts[0], parts[1]-1, parts[2], 12, 0, 0));
    } else {
        anchorDate.setUTCHours(12, 0, 0, 0);
    }

    let todayStr = now.toISOString().split('T')[0];
    let adminHistory = c.history || [];
    let realHistory = c.real_vol_history || [];
    let myProgress = (userProfile?.tracker_data && userProfile.tracker_data[c.id]) ? userProfile.tracker_data[c.id] : [];
    
    let labels = [];
    let limitVolData = [], projectedData = [], targetData = [];
    let accDatasets = {}; 
    accSettings.forEach(acc => accDatasets[acc.id] = []);

    for (let i = 6; i >= 0; i--) {
        let d = new Date(anchorDate);
        d.setDate(anchorDate.getDate() - i);
        let dStr = d.toISOString().split('T')[0];
        
        if(c.start && dStr < c.start) continue;
        labels.push(d.getUTCDate() + '/' + (d.getUTCMonth()+1));

        // Limit Vol
        let rVal = 0;
        let rItem = realHistory.find(x => x.date === dStr);
        if (rItem) rVal = parseFloat(rItem.vol);
        else if (dStr === todayStr) rVal = parseFloat(c.real_alpha_volume || 0);
        limitVolData.push(rVal);

        // Forecast Vol (Chỉ tính cho hôm nay)
        let projVal = 0;
        if (dStr === todayStr && !isEnded && secondsRemaining > 0) {
            let stableSpeed = 0;
            if (c.market_analysis && c.market_analysis.realTimeVol) {
                stableSpeed = parseFloat(c.market_analysis.realTimeVol);
            }
            if (stableSpeed > 0) projVal = stableSpeed * secondsRemaining;
        }
        projectedData.push(projVal);

        // Target
        let tVal = 0;
        let hItem = adminHistory.find(h => h.date === dStr);
        if(hItem) tVal = parseFloat(hItem.target);
        else {
            let prev = adminHistory.filter(h => h.date < dStr).sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
            if(prev) tVal = parseFloat(prev.target);
        }
        
        if (dStr === todayStr && !isEnded) {
            targetData.push(null); 
            accSettings.forEach(acc => accDatasets[acc.id].push(null));
        } else {
            targetData.push(tVal);
            let pItem = myProgress.find(p => p.date === dStr);
            accSettings.forEach(acc => {
                let vVal = 0;
                if (pItem && pItem.accsDetail && pItem.accsDetail[acc.id]) vVal = parseFloat(pItem.accsDetail[acc.id].vol);
                else {
                    let prevP = myProgress.filter(p => p.date < dStr).sort((a,b)=>new Date(b.date)-new Date(a.date))[0];
                    if(prevP && prevP.accsDetail && prevP.accsDetail[acc.id]) vVal = parseFloat(prevP.accsDetail[acc.id].vol);
                    else vVal = null;
                }
                accDatasets[acc.id].push(vVal);
            });
        }
    }

    // 2. CHECK & UPDATE
    let existingChart = Chart.getChart(`miniChart-${c.db_id}`);
    if (existingChart) {
        existingChart.data.labels = labels;
        existingChart.data.datasets[0].data = limitVolData;
        existingChart.data.datasets[1].data = projectedData;
        existingChart.data.datasets[2].data = targetData;
        accSettings.forEach((acc, index) => {
            if(existingChart.data.datasets[3 + index]) {
                existingChart.data.datasets[3 + index].data = accDatasets[acc.id];
            }
        });
        if(typeof updateGridInfo === 'function') updateGridInfo(c, targetData, accDatasets);
        existingChart.update('none'); 
        return; 
    }

    // 3. DRAW NEW CHART
    let chartDatasets = [
        {
            type: 'bar', label: 'Current', 
            data: limitVolData,
            backgroundColor: (context) => {
                const ctx = context.chart.ctx;
                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(0, 240, 255, 0.9)');
                gradient.addColorStop(1, 'rgba(0, 240, 255, 0.1)');
                return gradient;
            },
            borderRadius: 4, order: 3, stack: 'volStack', yAxisID: 'y_limit'
        },
        {
            type: 'bar', label: 'Forecast (+)', 
            data: projectedData,
            backgroundColor: 'rgba(255, 255, 255, 0.05)', 
            borderColor: 'rgba(255, 255, 255, 0.5)',
            borderWidth: {top: 2, right: 2, left: 2, bottom: 0}, 
            borderDash: [4, 4],
            borderRadius: 4, order: 3, stack: 'volStack', yAxisID: 'y_limit'
        },
        {
            type: 'line', label: 'Target', data: targetData,
            borderColor: '#F0B90B', borderWidth: 2, borderDash: [3, 3],
            pointRadius: 2, pointHoverRadius: 5, pointBackgroundColor: '#000', pointBorderColor: '#F0B90B',
            pointBorderWidth: 2, pointHitRadius: 10, 
            fill: false, tension: 0.3, order: 2, yAxisID: 'y_user'
        }
    ];

    accSettings.forEach(acc => {
        chartDatasets.push({
            type: 'line', label: acc.name, data: accDatasets[acc.id],
            borderColor: acc.color, backgroundColor: hexToRgba(acc.color, 0.1), borderWidth: 2,
            pointRadius: 3, pointHoverRadius: 6, pointBackgroundColor: '#161a1e', pointBorderColor: acc.color,
            pointBorderWidth: 2, pointHitRadius: 15,
            fill: false, tension: 0.3, order: 1, yAxisID: 'y_user'
        });
    });

    new Chart(ctx, {
        data: { labels: labels, datasets: chartDatasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            animation: false,
            interaction: { mode: 'index', intersect: false, axis: 'x' },
            plugins: { 
                legend: { display: false }, 
                tooltip: { 
                    backgroundColor: 'rgba(22, 26, 30, 0.95)', 
                    titleColor: '#888',
                    padding: 10,
                    cornerRadius: 6,
                    displayColors: true, 
                    callbacks: {
                        label: function(ctx) {
                            let val = ctx.raw; if (!val) return null;
                            let valStr = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(val);
                            
                            // Chỉ hiện Text, bỏ Icon
                            if (ctx.dataset.label === 'Current') return ` Current: $${valStr}`;
                            if (ctx.dataset.label === 'Forecast (+)') return ` Forecast: +$${valStr}`;
                            
                            return ` ${ctx.dataset.label}: ${valStr}`;
                        },
                        footer: function(tooltipItems) {
                            let total = 0; 
                            let forecastVal = 0; // Biến kiểm tra xem có dự báo không
                            
                            tooltipItems.forEach(t => { 
                                if(t.dataset.stack === 'volStack') { 
                                    total += t.raw; 
                                    // Kiểm tra xem cột Forecast của ngày này có giá trị không
                                    if(t.dataset.label.includes('Forecast')) {
                                        forecastVal = t.raw;
                                    }
                                } 
                            });

                            // --- [LOGIC MỚI] ---
                            // Chỉ hiện Est. Final nếu cột Forecast > 0
                            // (Nghĩa là chỉ hiện ở cột ngày hôm nay khi đang chạy)
                            // Các ngày quá khứ (forecast = 0) sẽ KHÔNG hiện dòng này nữa.
                            if (forecastVal > 0) {
                                return '----------------\n🏁 Est. Final: $' + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(total);
                            }
                            return '';
                        }
                    } 
                }
            },
            scales: {
                x: { display: false },
                y_user: { display: false, position: 'left', min: 0 },
                y_limit: { display: false, position: 'right', min: 0, stacked: true, suggestedMax: Math.max(...limitVolData) * 1.5 }
            },
            layout: { padding: { top: 10, bottom: 5 } }
        }
    });

    if(typeof updateGridInfo === 'function') updateGridInfo(c, targetData, accDatasets);
}

    
    // --- HÀM PHỤ: CẬP NHẬT THÔNG SỐ GRID BÊN DƯỚI BIỂU ĐỒ ---
function updateGridInfo(c, targetData, accDatasets) {
    let accGridEl = document.getElementById(`accGrid-${c.db_id}`);
    
    // Tìm giá trị Target mới nhất (bỏ qua null)
    let lastTargetData = targetData.filter(v => v !== null);
    let lastTarget = lastTargetData.length > 0 ? lastTargetData[lastTargetData.length - 1] : 0;

    if(accGridEl) {
        let gridHtml = '';
        accSettings.forEach(acc => {
            // Tìm giá trị User mới nhất (bỏ qua null)
            let validUser = accDatasets[acc.id].filter(v => v !== null);
            let lastUserVal = validUser.length > 0 ? validUser[validUser.length - 1] : 0;
            
            // Tính khoảng cách Gap
            let gap = lastUserVal - lastTarget;
            let gapColor = gap >= 0 ? 'text-green' : 'text-red';
            let gapIcon = gap >= 0 ? 'fa-caret-up' : 'fa-caret-down';
            
            gridHtml += `
            <div class="as-item">
                <div class="as-head"><div class="dot" style="background:${acc.color}"></div> ${acc.name}</div>
                <div class="as-vol">${fmtNum(lastUserVal)}</div>
                <div class="as-gap ${gapColor}">
                    ${lastTarget > 0 ? `<i class="fas ${gapIcon}"></i> ${fmtNum(Math.abs(gap))}` : '<span class="text-sub opacity-50">--</span>'}
                </div>
            </div>`;
        });
        accGridEl.innerHTML = gridHtml;
    }
}

// Helper: Chuyển HEX sang RGBA
function hexToRgba(hex, alpha) {
    let r = parseInt(hex.slice(1, 3), 16),
        g = parseInt(hex.slice(3, 5), 16),
        b = parseInt(hex.slice(5, 7), 16);
    return `rgba(${r},${g},${b},${alpha})`;
}
// --- [NEW] HÀM ĐỒNG BỘ VÍ LÊN CLOUD ---
async function updateCloudWallets() {
    if (!currentUser || !userProfile) return;

    // Đảm bảo tracker_data tồn tại
    if (!userProfile.tracker_data) userProfile.tracker_data = {};

    // Gán cấu hình hiện tại vào key 'meta_wallets'
    userProfile.tracker_data.meta_wallets = accSettings;

    // Lưu lên Supabase (Âm thầm)
    await supabase.from('profiles').update({ 
        tracker_data: userProfile.tracker_data 
    }).eq('id', currentUser.id);
    
    console.log("✅ Wallets config synced to Cloud");
}

// --- [NEW] REALTIME CHART LOOP (TỰ ĐỘNG CẬP NHẬT CHART MỖI 5 GIÂY) ---
setInterval(() => {
    // Chỉ cập nhật khi User đang xem tab Dashboard (để tiết kiệm pin)
    if (document.hidden) return; 

    // Lặp qua tất cả các giải đấu đang có
    compList.forEach(c => {
        // Chỉ vẽ lại nếu thẻ đang hiển thị trên màn hình (có canvas)
        let canvas = document.getElementById(`miniChart-${c.db_id}`);
        if (canvas) {
            // Gọi lại hàm vẽ (Nó sẽ tự tính lại thời gian secondsRemaining)
            renderCardMiniChart(c);
        }
    });
}, 5000); // 5000ms = 5 giây

/* === BẮT ĐẦU ĐOẠN CODE FIX LỖI === */
document.addEventListener('click', function(e) {
    // Kiểm tra xem người dùng có bấm vào nút Predict (hoặc icon bên trong nó) không
    if (e.target.closest('.btn-predict')) {
        
        // 1. Tìm thẻ cha (.card-item) đang chứa cái nút này
        const currentCard = e.target.closest('.card-item');
        
        // 2. Tắt chế độ phóng to của thẻ bài
        if (currentCard) {
            // Xóa các class thường dùng để phóng to (active, expanded, open...)
            // Code này sẽ thử xóa hết các tên thông dụng, trúng cái nào thì ăn cái đó
            currentCard.classList.remove('active');
            currentCard.classList.remove('expanded');
            currentCard.classList.remove('show');
            currentCard.classList.remove('open');

            // Reset style nếu bạn dùng style inline (đề phòng)
            currentCard.style.zIndex = ''; 
            currentCard.style.position = '';
        }
    }
});
/* === KẾT THÚC ĐOẠN CODE FIX LỖI === */

// --- FEEDBACK LOGIC (ENGLISH) ---
function openFeedbackModal() {
    // Auto-fill name if logged in
    if(typeof userProfile !== 'undefined' && userProfile && userProfile.nickname) {
        document.getElementById('fb-name').value = userProfile.nickname;
    }
    new bootstrap.Modal(document.getElementById('feedbackModal')).show();
}

function selectFbType(btn, type) {
    document.querySelectorAll('.feedback-type-btn').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('fb-type').value = type;
}

async function sendFeedbackToDb() {
    const name = document.getElementById('fb-name').value.trim() || 'Anonymous';
    const type = document.getElementById('fb-type').value;
    const msg = document.getElementById('fb-msg').value.trim();

    if (!msg) return showToast("Please enter your message!", "error");

    let btn = document.querySelector('#feedbackModal .btn-action');
    let oldHtml = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SENDING...'; btn.disabled = true;

    try {
        const { error } = await supabase.from('feedback').insert({
            sender_name: name,
            type: type,
            message: msg
        });
        if (error) throw error;

        showToast("Sent successfully! Thank you.", "success");
        document.getElementById('fb-msg').value = ''; 
        bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
    } catch (e) {
        console.error(e);
        showToast("Error: " + e.message, "error");
    } finally {
        btn.innerHTML = oldHtml; btn.disabled = false;
    }
}

// --- TELEGRAM SYSTEM CONFIG (English) ---

const TELE_CONFIG = {
    get token() { return localStorage.getItem('WAVE_TELE_TOKEN'); },
    chatId: '-1003355713341' // <-- ĐIỀN CHANNEL ID CỦA BẠN VÀO ĐÂY
};

// 1. Logic Admin Panel Toggle
window.addEventListener('load', () => {
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('mode') === 'admin') {
        document.getElementById('admin-control-panel').classList.remove('hidden');
        checkTokenStatus();
    }
});

function closeAdmin() {
    document.getElementById('admin-control-panel').classList.add('hidden');
    window.history.replaceState({}, document.title, "/");
}

// 2. Logic Save Token
window.saveTokenFromUI = function() {
    const inputToken = document.getElementById('bot-token-input').value.trim();
    if (!inputToken) return alert("❌ Token is empty!");
    
    localStorage.setItem('WAVE_TELE_TOKEN', inputToken);
    alert("✅ Token saved to this device!");
    checkTokenStatus();
}

function checkTokenStatus() {
    const statusText = document.getElementById('token-status');
    if (localStorage.getItem('WAVE_TELE_TOKEN')) {
        statusText.innerText = "✅ Status: Token Ready. System Operational.";
        statusText.style.color = "#00ff88";
    } else {
        statusText.innerText = "⚠️ Status: Missing Token.";
        statusText.style.color = "orange";
    }
}

// 3. Logic Send Message (English Content)
window.sendReportFromUI = async function() {
    if (!TELE_CONFIG.token) return alert("⚠️ Token missing! Please save token first.");

    let name = document.getElementById('report-name').value;
    let vol = document.getElementById('report-vol').value;
    let time = document.getElementById('report-time').value;
    let date = new Date().toLocaleDateString('en-GB'); // Định dạng ngày quốc tế DD/MM/YYYY

    // Nội dung tin nhắn Tiếng Anh
    let msg = `
<b>🔔 VOLUME UPDATE (${date})</b>

🏆 <b>Tournament:</b> ${name}
📊 <b>Min Volume:</b> <code>${vol}</code>
⏳ <b>Time Left:</b> ${time}

⚠️ <i>Alert: High volatility detected. Check your position!</i>

👉 <a href="https://wave-alpha.pages.dev">Open Wave Alpha Terminal</a>
    `;

    const url = `https://api.telegram.org/bot${TELE_CONFIG.token}/sendMessage`;
    try {
        const res = await fetch(url, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                chat_id: TELE_CONFIG.chatId,
                text: msg,
                parse_mode: 'HTML',
                disable_web_page_preview: true
            })
        });
        const data = await res.json();
        if(data.ok) alert("✅ Alert sent to Channel successfully!");
        else alert("❌ Telegram Error: " + data.description);
    } catch (err) {
        alert("❌ Network Error!");
    }
}

</script>
<a href="https://t.me/+VHBHlDAk9LwxNDE1" target="_blank" class="fab-telegram" title="Join Community">
    <i class="fab fa-telegram-plane"></i>
    <div class="fab-dot"></div>
</a>

<div class="modal fade" id="feedbackModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-brand"><i class="fas fa-comments me-2"></i> FEEDBACK & SUPPORT</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-sub small mb-3">Your feedback helps Wave Alpha improve every day.</p>
                
                <div class="d-flex gap-2 mb-3">
                    <button type="button" class="feedback-type-btn active" onclick="selectFbType(this, 'IDEA')">
                        <i class="fas fa-lightbulb text-gold me-1"></i> Idea / Feature
                    </button>
                    <button type="button" class="feedback-type-btn" onclick="selectFbType(this, 'BUG')">
                        <i class="fas fa-tools text-danger me-1"></i> Report Bug
                    </button>
                </div>
                <input type="hidden" id="fb-type" value="IDEA">

                <div class="mb-3">
                    <input type="text" id="fb-name" class="form-control" placeholder="Your Name (Optional)">
                </div>
                <div class="mb-4">
                    <textarea id="fb-msg" class="form-control" rows="4" placeholder="Describe your idea or the bug you found..."></textarea>
                </div>

                <button class="btn-action w-100" onclick="sendFeedbackToDb()">
                    <i class="fas fa-paper-plane me-2"></i> SEND MESSAGE
                </button>
            </div>
        </div>
    </div>
</div>

<a href="https://t.me/wavealphachannel" target="_blank" class="tele-floating-btn">
    <div class="tele-icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
            <path fill="currentColor" d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.68.02zm6.57 6.61-2.57 10.7c-.2.86-1.14 1.2-1.92.73l-5.3-3.9-2.56-1.23c-.57-.27-.58-1.12.02-1.37l12.33-4.93z"/>
        </svg>
    </div>
    <div class="tele-text">
        <span>Get Vol Alerts ⚡</span>
    </div>
</a>

<div id="admin-control-panel" class="admin-panel hidden">
    <div class="admin-header">
        <h3>🚀 TELEGRAM BROADCAST</h3>
        <button onclick="closeAdmin()" class="close-btn">×</button>
    </div>
    
    <div class="admin-body">
        <div class="admin-section">
            <label>Bot Token (First time only):</label>
            <input type="password" id="bot-token-input" placeholder="712345:AAF..." />
            <button onclick="saveTokenFromUI()" class="btn-save">Save Token to Browser</button>
            <p id="token-status" style="font-size: 12px; color: gray; margin-top: 5px;">Status: Checking...</p>
        </div>

        <hr>

        <div class="admin-section">
            <label>Tournament Name:</label>
            <input type="text" id="report-name" value="Grand Tournament" />
            
            <label>Current Min Volume:</label>
            <input type="text" id="report-vol" placeholder="$5,000,000" />
            
            <label>Time Remaining:</label>
            <input type="text" id="report-time" placeholder="24h" />
            
            <button onclick="sendReportFromUI()" class="btn-send">🔥 SEND ALERT NOW</button>
        </div>
    </div>
</div>

<style>
    /* CSS cho nút Telegram */
    .tele-floating-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #0088cc; /* Màu xanh Tele */
        color: white;
        padding: 12px 24px; /* Tăng padding chút cho nút to đẹp */
        border-radius: 50px;
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(0, 136, 204, 0.4);
        z-index: 9999;
        transition: all 0.3s ease;
        animation: bounce 2s infinite;
    }
    
    .tele-floating-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 136, 204, 0.6);
    }
    
    .tele-text span {
        font-weight: bold;
        font-size: 15px; /* Chữ to hơn một chút */
        letter-spacing: 0.5px;
    }
    
    @keyframes bounce {
        0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
        40% {transform: translateY(-6px);}
        60% {transform: translateY(-3px);}
    }

/* Admin CSS */
.admin-panel {
    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    width: 90%; max-width: 400px;
    background: #1a1a1a; border: 1px solid #333; border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.8); z-index: 10000;
    color: white; font-family: sans-serif; padding: 20px;
}
.admin-panel.hidden { display: none; }
.admin-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.admin-header h3 { margin: 0; font-size: 16px; color: #00ff88; }
.close-btn { background: none; border: none; color: white; font-size: 24px; cursor: pointer; }
.admin-section { display: flex; flex-direction: column; gap: 10px; }
.admin-section label { font-size: 12px; color: #ccc; }
.admin-section input { background: #333; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; }
.btn-save { background: #444; color: white; padding: 8px; border: none; border-radius: 6px; cursor: pointer; }
.btn-send { background: #0088cc; color: white; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; }
.btn-send:hover { background: #0099ff; }
</style>


<script>
    // --- TELEGRAM MINI APP INTEGRATION ---
    document.addEventListener('DOMContentLoaded', function() {
        const tg = window.Telegram.WebApp;
        
        // 1. Báo cho Telegram biết App đã sẵn sàng (để mở rộng full màn hình)
        tg.ready();
        tg.expand(); 

        // 2. Tự động lấy User ID từ Telegram điền vào form Login (Optional)
        // Nếu user mở từ Telegram, ta có thể biết họ là ai ngay
        const user = tg.initDataUnsafe?.user;
        if (user) {
            console.log("User from Tele:", user);
            // Bạn có thể dùng logic này để auto-login hoặc điền tên vào ô dự đoán
            // Ví dụ:
            if(document.getElementById('modal-p-name')) {
                document.getElementById('modal-p-name').value = user.username || user.first_name;
            }
        }

        // 3. Chỉnh màu Header của App trùng màu Header của Telegram
        tg.setHeaderColor('#161a1e'); // Màu nền app của bạn
    });
</script>

</body>
</html>
