<!DOCTYPE html>
<html lang="vi" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>WAVE ALPHA | V45 SECURITY & ARSENAL</title>
    <meta name="description" content="Predict Market Volume, Win USDT. The most advanced crypto simulation terminal.">
    <meta property="og:title" content="WAVE ALPHA TERMINAL">
    <meta property="og:description" content="Tham gia dự đoán Volume Bitcoin & nhận thưởng ngay hôm nay!">
    <meta property="og:image" content="https://placehold.co/1200x630/0b0e11/00F0FF.png?text=WAVE+ALPHA+TERMINAL&font=montserrat">
    <meta property="og:url" content="https://wave-alpha.app">
    <meta name="twitter:card" content="summary_large_image">

    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&family=Rajdhani:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-KTKQYTJ2ZC"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-KTKQYTJ2ZC');
    </script>

    <style>
        /* --- CORE THEME (Original V44) --- */
        :root {
            --bg-body: #0b0e11; --bg-card: #161a1e; --bg-header: #181a20;
            --bg-input: #2b3139; --border: #353a42; --text-main: #eaecef; --text-sub: #848e9c;
            --brand: #00F0FF; --brand-glow: rgba(0, 240, 255, 0.3);
            --accent-yellow: #F0B90B; --accent-green: #0ECB81; --accent-red: #F6465D;
            --purple: #9945FF;
            --font-main: 'Be Vietnam Pro', sans-serif; --font-num: 'Rajdhani', sans-serif;
        }
        body { background-color: var(--bg-body); color: var(--text-main); font-family: var(--font-main); font-size: 13px; display: flex; flex-direction: column; min-height: 100vh; }
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--bg-body); } ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        .font-num { font-family: var(--font-num); font-weight: 700; letter-spacing: 0.5px; }
        .text-brand { color: var(--brand) !important; text-shadow: 0 0 10px var(--brand-glow); }
        .text-gold { color: var(--accent-yellow) !important; } .text-green { color: var(--accent-green) !important; } .text-red { color: var(--accent-red) !important; }

        .navbar { background: var(--bg-header); border-bottom: 1px solid var(--border); padding: 12px 0; position: sticky; top: 0; z-index: 1000; }
        .brand-logo { font-family: var(--font-num); font-weight: 800; font-size: 1.6rem; color: var(--text-main); text-decoration: none; cursor:pointer; display: flex; align-items: center; gap: 4px; }
        .brand-logo span { color: var(--brand); }

        .btn-icon { width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--text-sub); background: var(--bg-input); transition: all 0.2s ease-in-out; cursor: pointer; position: relative; }
        .btn-icon:hover { color: #fff; border-color: #fff; background: #333; box-shadow: 0 0 15px 2px rgba(255,255,255,0.6); transform: scale(1.1); z-index: 10; }

        .stat-box { background: linear-gradient(145deg, var(--bg-card), #080808); border: 1px solid var(--border); border-radius: 8px; padding: 20px; display: flex; align-items: center; justify-content: space-between; height: 100%; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .stat-val { font-size: 2rem; font-weight: 700; font-family: var(--font-num); line-height: 1; }

        /* V45 REDESIGN: COMPACT TRADING ARSENAL (Đã sửa lại nhỏ gọn) */
        .arsenal-section { margin-bottom: 25px; }
        .arsenal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 10px;
        }
        .arsenal-card {
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
            height: 50px;
        }
        .arsenal-card:hover {
            transform: translateY(-2px);
            border-color: var(--brand);
            background: rgba(0, 240, 255, 0.05);
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.15);
        }
        /* --- ĐÃ SỬA: LOGO CÓ MÀU RỰC RỠ --- */
        .ex-logo {
            width: 24px; height: 24px;
            object-fit: contain;
            transition: 0.3s;
            flex-shrink: 0;
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.2));
        }
        /* Khi di chuột vào thì sáng lên và phóng to một chút */
        .arsenal-card:hover .ex-logo {
            transform: scale(1.15);
            filter: brightness(1.2) drop-shadow(0 0 5px var(--brand));
        }


        .ex-info { display: flex; flex-direction: column; justify-content: center; line-height: 1.1; overflow: hidden; }
        .ex-name {
            font-family: var(--font-num);
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--text-main);
            white-space: nowrap;
        }
        .ex-bonus {
            font-size: 0.55rem;
            color: var(--accent-yellow);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        /* GAME STYLES */
        .balance-badge { background: rgba(14, 203, 129, 0.15); border: 1px solid var(--accent-green); color: var(--accent-green); font-family: var(--font-num); font-weight: 700; padding: 5px 12px; border-radius: 20px; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; margin-right: 10px; }
        .rule-list { list-style: none; padding: 0; }
        .rule-list li { margin-bottom: 10px; padding-left: 20px; position: relative; color: #ddd; font-size: 0.9rem; }
        .rule-list li::before { content: '►'; position: absolute; left: 0; color: var(--brand); font-size: 0.7rem; top: 4px; }
        .admin-settle-box { background: rgba(246, 70, 93, 0.1); border: 1px dashed var(--accent-red); padding: 15px; border-radius: 8px; margin-top: 20px; width: 100%; }

        /* HERO & SORT BAR */
        .hero-banner { background: linear-gradient(180deg, rgba(0, 240, 255, 0.05) 0%, rgba(11, 14, 17, 0) 100%); border-bottom: 1px solid var(--border); padding: 40px 0 20px 0; margin-bottom: 30px; text-align: center; }
        .hero-title { font-family: var(--font-main); font-weight: 900; font-size: 2.2rem; letter-spacing: 1px; color: #fff; text-shadow: 0 0 20px rgba(0,240,255,0.3); margin-bottom: 10px; text-transform: uppercase; }
        .hero-sub { color: var(--text-sub); font-size: 1rem; max-width: 600px; margin: 0 auto; }
        .sort-select { background: var(--bg-input); border: 1px solid var(--border); color: #fff; padding: 5px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; outline: none; transition: 0.3s; }
        .sort-select:hover, .sort-select:focus { border-color: var(--brand); box-shadow: 0 0 10px rgba(0,240,255,0.3); }

        /* CARD STYLES */
        .tour-card {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; position: relative;
            display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: center center;
            z-index: 1;
            height: 100%;
        }


        .tour-card:hover { transform: translateY(-3px); border-color: #666; box-shadow: 0 8px 25px rgba(0,0,0,0.5); }

        /* Trạng thái được chọn */
        .tour-card.active-card {
            transform: scale(1.1);
            z-index: 100;
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.9), 0 0 30px rgba(0, 240, 255, 0.15);
            border-color: var(--brand);
            background: linear-gradient(160deg, #1c2127, #0f1115);
        }

        /* Khi có 1 thẻ đang active, các thẻ khác sẽ bị mờ đi */
        body.has-active-card .tour-card:not(.active-card) {
            opacity: 0.4;
            filter: grayscale(0.8) blur(2px);
            transform: scale(0.95);
            pointer-events: none;
        }

        .tour-card.ended-card { opacity: 0.6; filter: grayscale(0.8); border-color: #333; }
        .tour-card.highlight-x4 { border: 1px solid rgba(240, 185, 11, 0.8); box-shadow: 0 0 15px rgba(240, 185, 11, 0.15); }
        .tour-card.highlight-x2 { border: 1px solid rgba(14, 203, 129, 0.8); box-shadow: 0 0 15px rgba(14, 203, 129, 0.15); }

        .card-head { padding: 10px 15px; background: linear-gradient(to bottom, #20252b, #161a1e); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: relative; }
        .token-info-wrapper { display: flex; align-items: center; gap: 10px; }
        .token-logo { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 2px solid #333; background: #000; transition: transform 0.2s, border-color 0.2s; cursor: pointer; }
        .token-logo:hover { transform: scale(1.15); border-color: var(--brand); box-shadow: 0 0 10px var(--brand); }
        .token-title { font-family: var(--font-num); font-weight: 800; font-size: 1.4rem; color: var(--text-main); line-height: 1; }
        .token-status { font-size: 0.6rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px; }

        .tag-x4, .tag-x2 { font-family: var(--font-num); font-size: 0.65rem; font-weight: 700; text-transform: uppercase; padding: 3px 8px; border-radius: 4px; letter-spacing: 0.5px; margin-left: 5px; transition: all 0.3s; }
        .tag-x4 { background: rgba(255, 215, 0, 0.1); color: var(--accent-yellow); border: 1px solid var(--accent-yellow); }
        .tag-x2 { background: rgba(14, 203, 129, 0.1); color: var(--accent-green); border: 1px solid var(--accent-green); }
        .tag-expired { opacity: 0.3; filter: grayscale(1); border-color: #444 !important; color: #666 !important; background: transparent !important; }

        .x4-timer-box { font-family: var(--font-num); font-size: 0.75rem; color: var(--text-sub); font-weight: 600; display: flex; align-items: center; gap: 4px; margin-top: 2px; justify-content: flex-end;}
        .x4-timer-val { color: var(--accent-yellow); font-weight: 700; }

        .card-stats-grid { display: grid; grid-template-columns: 0.8fr 1.4fr 1fr; border-bottom: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .stat-cell { padding: 12px 5px; text-align: center; position: relative; display: flex; flex-direction: column; justify-content: center; }
        .stat-cell:not(:last-child)::after { content: ''; position: absolute; right: 0; top: 20%; height: 60%; width: 1px; background: #333; }
              
        /* 1. Style nhỏ cho trong thẻ bài (Card) */
        .card-stats-grid .stat-lbl { font-size: 0.6rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; margin-bottom: 3px; }
        .card-stats-grid .stat-val { font-family: var(--font-num); font-weight: 700; font-size: 1rem; color: var(--text-main); line-height: 1; }

        /* 2. Style to cho Hộp thống kê (Market Overview) */
        .stat-box .stat-lbl { font-size: 0.9rem; color: var(--text-sub); font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .stat-box .stat-val { font-family: var(--font-num); font-weight: 700; font-size: 2.8rem; color: var(--text-main); line-height: 1; text-shadow: 0 0 20px rgba(0,0,0,0.5); }

        .card-list { padding: 10px 15px; flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .acc-item { display: flex; align-items: center; justify-content: space-between; font-size: 0.8rem; position: relative; padding: 2px 0; }
        .acc-info { display: flex; align-items: center; width: 25%; gap: 6px; color: var(--text-main); font-weight: 500; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; z-index: 2; }
        .acc-bar-bg { position: absolute; left: 0; bottom: 0; height: 2px; width: 100%; background: #222; border-radius: 2px; }
        .acc-bar-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }
        .acc-stats { text-align: right; font-family: var(--font-num); font-weight: 700; z-index: 2; display: flex; gap: 8px; align-items: center; justify-content: flex-end; flex: 1; }
        .acc-vol { color: #fff; font-size: 0.9rem; }
        .acc-gap { font-size: 0.75rem; padding: 1px 4px; border-radius: 3px; background: rgba(0,0,0,0.3); }
        .gap-pos { color: var(--accent-green); }
        .gap-neg { color: var(--accent-red); }

        .card-actions { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--border); }
        .btn-card-action { background: var(--bg-input); border: none; color: var(--text-sub); font-size: 0.7rem; font-weight: 700; text-transform: uppercase; padding: 10px; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-card-action:hover { background: #fff; color: #000; box-shadow: 0 0 15px rgba(255,255,255,0.7); z-index: 10; transform: translateY(-2px); }
        .btn-card-action.action-update { color: var(--accent-green); }
        .btn-card-action.action-update:hover { background: var(--accent-green); color: #000; box-shadow: 0 0 15px var(--accent-green); }
        .btn-card-action.predict { color: #fff; background: rgba(153, 69, 255, 0.15); border-left: 1px solid var(--border); }
        .btn-card-action.predict:hover { background: var(--purple); color: #fff; box-shadow: 0 0 20px var(--purple); text-shadow: 0 0 5px #fff; }

        .card-foot { padding: 8px 15px; background: var(--bg-input); border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .tour-timer { display: flex; align-items: center; gap: 5px; }
        .tour-timer-label { font-size: 0.6rem; font-weight: 700; color: var(--text-sub); text-transform: uppercase; }
        .tour-timer-val { font-family: var(--font-num); font-weight: 700; font-size: 0.9rem; color: var(--text-main); }
        .btn-edit-foot { background: transparent; border: none; color: #444; font-size: 0.85rem; padding: 2px 10px; transition: 0.2s; cursor: pointer; }
        .btn-edit-foot:hover { color: var(--brand); transform: scale(1.1); }

        /* TERMINAL */
        .terminal-layout { display: grid; grid-template-columns: 2.5fr 1fr; gap: 20px; height: calc(100vh - 80px); padding: 0 20px 20px 20px; max-width:1600px; margin:0 auto; }
        .terminal-main { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .terminal-side { display: flex; flex-direction: column; gap: 15px; overflow: hidden; }
        .terminal-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; }

        .hero-header { display: grid; grid-template-columns: 0.8fr 1.5fr 0.8fr; align-items: center; padding: 25px 30px; background: linear-gradient(90deg, #111 0%, #161616 100%); border: 1px solid var(--border); border-radius: 12px; gap: 20px; }
        .hh-left { display: flex; align-items: center; gap: 15px; }
        #pt-logo { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #444; object-fit: cover; transition:0.2s; cursor: pointer; }
        #pt-logo:hover { border-color: var(--brand); box-shadow: 0 0 15px var(--brand); transform: scale(1.05); }
        #pt-symbol { font-size: 2.2rem; line-height: 1; }
        .hh-center { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .big-vol { font-size: 5.5rem; font-weight: 800; font-family: var(--font-num); line-height: 1; color: #fff; text-shadow: 0 0 40px rgba(255,255,255,0.1); margin: 5px 0 15px 0; }

        .btn-predict-hero { background: linear-gradient(135deg, var(--purple), #7b2cbf); border: none; color: #fff; font-weight: 800; padding: 12px 50px; border-radius: 50px; font-size: 1.1rem; box-shadow: 0 0 20px rgba(153, 69, 255, 0.4); transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; }
        .btn-predict-hero:hover { transform: scale(1.05); box-shadow: 0 0 40px rgba(153, 69, 255, 0.6); }
        .btn-ended { background: #333 !important; color: #888 !important; border: 1px solid #444 !important; box-shadow: none !important; cursor: not-allowed; opacity: 0.8; }
        .btn-ended:hover { transform: none !important; }

        .hh-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 15px; }
        .header-stat-lbl { font-size: 0.7rem; color: var(--text-sub); font-weight: 700; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 5px; }
        .p-tabs { display: flex; border-bottom: 1px solid var(--border); background: #111; }
        .p-tab { padding: 12px 20px; color: var(--text-sub); font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; transition: 0.2s; font-size: 0.85rem; }
        .p-tab:hover { color: #fff; }
        .p-tab.active { color: var(--brand); border-bottom-color: var(--brand); background: rgba(0,240,255,0.05); }
        .feed-box { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-bubble { max-width: 85%; padding: 8px 12px; border-radius: 8px; font-size: 0.9rem; line-height: 1.4; color: #ddd; display: flex; flex-direction: column; }
        .chat-me { align-self: flex-end; background: rgba(157, 78, 221, 0.2); border: 1px solid var(--purple); }
        .chat-other { align-self: flex-start; background: #222; border: 1px solid #333; }
        .chat-row { display: flex; align-items: flex-end; gap: 8px; margin-bottom: 5px; }
        .chat-row.me { flex-direction: row-reverse; }

        .leaderboard-table th { padding: 10px; text-align: left; color: var(--text-sub); font-size: 0.7rem; }
        .leaderboard-table td { padding: 8px 10px; border-bottom: 1px solid #222; vertical-align: middle; }
        .rank-badge { width: 22px; height: 22px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; font-size: 0.7rem; font-weight: bold; background: #333; color: #aaa; margin-right: 5px; }
        .rank-1 { background: #FFD700; color: #000; box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); }
        .rank-2 { background: #C0C0C0; color: #000; }
        .rank-3 { background: #CD7F32; color: #000; }

        /* FOOTER */
        .app-footer { background: var(--bg-header); border-top: 1px solid var(--border); padding: 30px 0; margin-top: auto; }
        .footer-socials { display: flex; gap: 15px; justify-content: center; margin-bottom: 15px; }
        .social-btn { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-input); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; color: var(--text-sub); transition: 0.2s; text-decoration: none; }
        .social-btn:hover { color: #fff; border-color: var(--brand); transform: translateY(-3px); box-shadow: 0 0 10px var(--brand); }
        .footer-copy { color: var(--text-sub); font-size: 0.8rem; text-align: center; }

        /* MODALS & UTILS */
        .modal-content { background: #1e2329; border: 1px solid var(--border); box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        .form-control, .form-select { background: var(--bg-input); border: 1px solid var(--border); color: #fff; }
        .form-control:focus { border-color: var(--brand); background: #2b3139; color:#fff; box-shadow:none; }
        .form-control:disabled { background: #111; color: #555; }
        input:-webkit-autofill, input:-webkit-autofill:hover, input:-webkit-autofill:focus, input:-webkit-autofill:active { -webkit-box-shadow: 0 0 0 30px var(--bg-input) inset !important; -webkit-text-fill-color: white !important; }
        .btn-action { background: var(--brand); color: #000; font-weight: 800; border: none; padding: 10px; width: 100%; border-radius: 4px; text-transform: uppercase; transition: 0.2s; }
        .btn-action:hover { background: #fff; box-shadow: 0 0 15px var(--brand); }
        .acc-input-row { display: grid; grid-template-columns: 80px 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 10px; padding: 8px; background: rgba(255,255,255,0.02); border-radius: 4px; border: 1px solid transparent; }
        .acc-input-row:hover { border-color: #333; }

        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #0b0e11; z-index: 9999; display: none; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top: 4px solid var(--brand); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .admin-only { display: none !important; }
        body.is-admin .admin-only { display: flex !important; }
        .back-btn { color: #fff; border: 1px solid #444; padding: 8px 20px; border-radius: 30px; font-weight: 600; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; background:rgba(255,255,255,0.05); }
        .back-btn:hover { background: #fff; color: #000; border-color: #fff; box-shadow: 0 0 10px #fff; }
        @media (max-width: 1200px) {
            .terminal-layout { grid-template-columns: 1fr; height: auto; display: block; }
            .hero-header { grid-template-columns: 1fr; text-align: center; gap: 20px; padding: 20px; }
            .hh-left, .hh-right { justify-content: center; align-items: center; width: 100%; }
            .btn-predict-hero { width: 100%; }
        }
        .anim-breathe { animation: breathe 3s infinite ease-in-out; }
        @keyframes breathe { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        #legalModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 99999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .legal-box { width: 90%; max-width: 500px; background: #161a1e; border: 1px solid var(--brand); border-radius: 10px; padding: 30px; text-align: center; box-shadow: 0 0 50px rgba(0,240,255,0.2); }
        .legal-title { color: var(--brand); font-family: var(--font-num); font-weight: 800; font-size: 1.8rem; margin-bottom: 20px; letter-spacing: 1px; }
        .legal-text { color: #ddd; font-size: 0.9rem; line-height: 1.6; text-align: left; margin-bottom: 25px; max-height: 200px; overflow-y: auto; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; border: 1px solid #333; }
        .btn-legal { background: var(--brand); color: #000; font-weight: 800; padding: 12px 30px; border: none; border-radius: 30px; text-transform: uppercase; transition: 0.3s; width: 100%; }
        .btn-legal:hover { transform: scale(1.05); background: #fff; box-shadow: 0 0 20px var(--brand); }

        .cursor-pointer { cursor: pointer; }

        /* AVATAR STYLES */
        .user-avatar-sm { width:24px; height:24px; border-radius:50%; object-fit:cover; border:1px solid var(--brand); margin-right:5px; }
        .profile-btn-area { display: flex; align-items: center; cursor: pointer; padding: 5px 10px; border-radius: 20px; transition:0.2s; border: 1px solid transparent;}
        .profile-btn-area:hover { background: rgba(255,255,255,0.1); border-color:#444; }
        .avatar-upload-box { position: relative; width: 100px; height: 100px; margin: 0 auto 20px; border-radius: 50%; overflow: hidden; border: 2px dashed #444; cursor: pointer; background: #111; transition: 0.2s; }
        .avatar-upload-box:hover { border-color: var(--brand); }
        .avatar-upload-box img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .upload-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #666; font-size: 0.8rem; pointer-events: none; }
        #file-input { display: none; }

        /* New Avatar Classes */
        .list-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; margin-right: 8px; border: 1px solid #444; vertical-align: middle; }
        .chat-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid #444; margin-bottom: 5px; flex-shrink: 0; }
        .act-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; border: 1px solid var(--brand); margin-right: 10px; flex-shrink: 0; }
        .list-avatar-placeholder { width: 28px; height: 28px; border-radius: 50%; background: #333; color: #aaa; display: inline-flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold; margin-right: 8px; vertical-align: middle; }
        .chat-avatar-placeholder { width: 32px; height: 32px; border-radius: 50%; background: #333; color: #aaa; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; flex-shrink: 0; }

        /* --- V45 SHARE CARD STYLES (REDESIGNED) --- */
        #share-card-container {
            width: 100%; max-width: 400px; margin: 0 auto;
            background: #0b0e11;
            background-image:
                linear-gradient(rgba(0, 240, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 240, 255, 0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            border: 1px solid var(--border); border-radius: 16px;
            padding: 25px; text-align: center; position: relative; overflow: hidden;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.5);
        }
        /* Top Border Accent */
        #share-card-container::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: linear-gradient(90deg, var(--brand), var(--purple));
        }

        .sc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
        .sc-logo-text { font-family: var(--font-num); font-weight: 800; font-size: 1.4rem; color: #fff; letter-spacing: 1px; }
        .sc-logo-text span { color: var(--brand); }
        .sc-date { font-family: var(--font-num); font-size: 0.85rem; color: var(--text-sub); font-weight: 600; text-transform: uppercase; }

        .sc-main { position: relative; z-index: 2; margin-bottom: 25px; }
        .sc-token-row { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .sc-token-img { width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--brand); box-shadow: 0 0 15px rgba(0,240,255,0.3); }
        .sc-token-name { font-size: 2.2rem; font-weight: 800; font-family: var(--font-num); color: #fff; line-height: 1; text-shadow: 0 0 20px rgba(255,255,255,0.2); }

        .sc-stat-box {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px;
            display: grid; grid-template-columns: 1fr 1px 1fr; align-items: center;
        }
        .sc-divider { height: 40px; background: rgba(255,255,255,0.1); }

        .sc-stat-label { font-size: 0.65rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 5px; font-weight: 700; }
        .sc-stat-val { font-size: 1.5rem; font-weight: 700; font-family: var(--font-num); color: #fff; }
        .sc-stat-val.gold { color: var(--accent-yellow); text-shadow: 0 0 10px rgba(240, 185, 11, 0.4); }
        .sc-stat-val.brand { color: var(--brand); }

        .sc-footer {
            display: flex; align-items: center; justify-content: space-between;
            background: linear-gradient(90deg, rgba(0,240,255,0.1), transparent);
            padding: 12px 15px; border-radius: 8px; border: 1px solid rgba(0,240,255,0.2);
        }
        .sc-qr-box { background: #fff; padding: 4px; border-radius: 4px; height: 58px; width: 58px; display: flex; align-items: center; justify-content: center; }
        .sc-ref-text { text-align: left; font-size: 0.75rem; color: #ddd; line-height: 1.3; font-weight: 500; }
        .sc-web-link {
            font-family: var(--font-num); font-weight: 800; color: var(--brand);
            font-size: 0.9rem; margin-top: 3px; letter-spacing: 0.5px;
        }

        /* V45 FIX: Style cho User Profile trên thẻ Share */
        .sc-user-box {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            margin-bottom: 15px; padding-bottom: 15px;
            border-bottom: 1px dashed rgba(255,255,255,0.1);
        }
        .sc-user-avatar {
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--text-sub);
        }
        .sc-user-info { text-align: left; }
        .sc-user-label { font-size: 0.6rem; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }
        .sc-user-name {
            font-family: var(--font-num); font-weight: 800; font-size: 1.2rem; color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.1);
        }

        /* V45 UX POLISH: TOAST NOTIFICATIONS (Thay thế Alert xấu xí) */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast-item {
            background: rgba(16, 20, 24, 0.95); border: 1px solid var(--border); border-left: 4px solid var(--brand);
            color: #fff; padding: 15px 20px; border-radius: 4px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideIn 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
            min-width: 300px; backdrop-filter: blur(10px);
        }
        .toast-success { border-left-color: var(--accent-green); }
        .toast-error { border-left-color: var(--accent-red); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        /* --- [STYLE MỚI] GIAO DIỆN TAG NHỎ GỌN (SLIM PILL) --- */
        .rule-pill {
            font-family: var(--font-num);
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 4px;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 2px;
            cursor: help;
            transition: all 0.2s;
            border: 1px solid transparent;
            line-height: 1.1;
            width: fit-content;
        }
        .rule-pill:hover { filter: brightness(1.2); transform: translateY(-1px); }

        /* ONLY BUY: Màu xanh nhẹ */
        .rp-buy {
            border-color: rgba(14, 203, 129, 0.4);
            color: #0ECB81;
            background: rgba(14, 203, 129, 0.05);
        }

        /* ALL VOL x4: Màu tím huyền bí */
        .rp-x4 {
            border-color: rgba(153, 69, 255, 0.5);
            color: #d0aaff;
            background: rgba(153, 69, 255, 0.05);
        }

        /* Ô vuông nhỏ bao quanh chữ x4 */
        .x4-box {
            background: #9945FF;
            color: #fff;
            padding: 1px 3px;
            border-radius: 2px;
            font-size: 0.55rem;
            font-weight: 800;
        }

        /* Sắp xếp cột bên phải */
        .card-head-right {
            display: flex; flex-direction: column; align-items: flex-end; justify-content: center; gap: 3px;
        }
        /* --- STYLE CHO THẺ KẾT QUẢ (WIN/LOSE) --- */
        .res-badge {
            font-family: var(--font-num);
            font-size: 0.65rem;
            font-weight: 800;
            padding: 1px 6px;
            border-radius: 3px;
            margin-left: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            min-width: 45px;
            justify-content: center;
        }
        /* Thẻ Thắng: Vàng rực + Bóng sáng */
        .res-win {
            background: #F0B90B;
            color: #000;
            box-shadow: 0 0 8px rgba(240, 185, 11, 0.4);
        }
        /* Thẻ Thua: Xám tối + Viền mờ */
        .res-lose {
            background: #2b3139;
            color: #666;
            border: 1px solid #444;
        }
        /* Thêm vào cuối phần <style> */
        .text-silver { color: #C0C0C0 !important; text-shadow: 0 0 10px rgba(192, 192, 192, 0.4); }
        .text-bronze { color: #CD7F32 !important; text-shadow: 0 0 10px rgba(205, 127, 50, 0.4); }

        /* --- ADMIN DRAG & DROP (FIXED ORDER) --- */

        /* Hiệu ứng khi đang kéo */
        .tour-card.dragging {
            opacity: 0.5;
            border: 2px dashed var(--brand);
            transform: scale(0.95);
            z-index: 1000;
        }

        /* Icon tay cầm (Grip) - Mặc định ẩn */
        .admin-drag-handle {
            display: none;
            color: var(--text-sub);
            margin-right: 8px;
            font-size: 1.1rem;
            cursor: grab;
            transition: 0.2s;
        }

        /* Admin thì LUÔN LUÔN nhìn thấy tay cầm và kéo được */
        body.is-admin .admin-drag-handle { display: inline-block; }
        body.is-admin .admin-drag-handle:hover { color: var(--brand); }
        body.is-admin .tour-card { cursor: grab; }
        body.is-admin .tour-card:active { cursor: grabbing; }
    </style>
</head>
<body>

<div id="toast-container"></div>

<audio id="sfx-click" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>
<audio id="sfx-hover" src="data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU"></audio>

<div id="loading-overlay">
    <div class="spinner mb-3"></div>
    <div class="text-brand font-num fw-bold letter-spacing-1">SYSTEM LOADING...</div>
</div>

<div id="legalModal">
    <div class="legal-box">
        <div class="legal-title"><i class="fas fa-shield-alt me-2"></i> DISCLAIMER</div>
        <div class="legal-text"><strong>Welcome to Wave Alpha Terminal.</strong><br><br>1. <strong>Not Financial Advice:</strong> All content, data, and predictions provided herein are for informational and entertainment purposes only.<br>2. <strong>No Real Money:</strong> This is a simulation tracking tool. We do not accept deposits or facilitate real-money gambling.<br>3. <strong>Risk Warning:</strong> Cryptocurrency trading involves significant risk. You are solely responsible for your investment decisions.<br><br>By clicking "I AGREE", you acknowledge that you have read and understood these terms.</div>
        <button class="btn-legal" onclick="acceptLegal(); playSfx('click')">I AGREE & ENTER</button>
    </div>
</div>

<nav class="navbar">
    <div class="container">
        <div class="d-flex align-items-center gap-4">
            <a onclick="playSfx('click'); switchView('dashboard')" class="brand-logo d-flex align-items-center gap-2" style="text-decoration:none">
                <img id="nav-brand-img" src="" style="height:50px; display:none; border-radius:4px;">
                <div id="nav-brand-text">WAVE<span>ALPHA</span></div>
            </a>
            <div class="d-none d-md-block ps-4 border-start border-secondary border-opacity-25">
                <span class="text-sub" style="font-size:0.65rem; font-weight:700; letter-spacing:1px" data-i18n="sys_time">SYSTEM TIME</span>
                <div id="sysClock" class="font-num fw-bold text-brand" style="line-height:1; font-size: 1.2rem;">--:--:--</div>
            </div>
        </div>

        <div class="d-flex align-items-center gap-2">
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-light border-secondary text-sub fw-bold dropdown-toggle d-flex align-items-center gap-1" type="button" data-bs-toggle="dropdown" style="min-width: 70px;">
                    <i class="fas fa-globe"></i> <span id="cur-lang-text">EN</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark shadow" style="border: 1px solid var(--border);">
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('en')"><i class="fas fa-flag-usa me-2"></i>ENGLISH</a></li>
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('vi')"><i class="fas fa-star text-danger me-2"></i>TIẾNG VIỆT</a></li>
                    <li><a class="dropdown-item" href="#" onclick="changeLanguage('zh')"><i class="fas fa-circle text-danger me-2"></i>中文</a></li>
                </ul>
            </div>

            <button class="btn btn-sm btn-outline-light border-secondary text-brand fw-bold d-flex align-items-center gap-2 me-2" onclick="new bootstrap.Modal(document.getElementById('guideModal')).show()">
                <i class="fas fa-book-open"></i> <span class="d-none d-md-inline">GUIDE</span>
            </button>

            <button class="btn-icon text-gold" onclick="handleSmartRefresh()" title="Smart Sync">
                <i class="fas fa-sync-alt"></i>
            </button>
            <button class="btn-icon" onclick="loadFromCloud()" title="Reload Data"><i class="fas fa-database"></i></button>
            <button class="btn-icon" onclick="openSettingsModal()" title="Wallets"><i class="fas fa-wallet"></i></button>
            <button class="btn-icon" onclick="new bootstrap.Modal(document.getElementById('helpModal')).show()" title="Help"><i class="fas fa-question"></i></button>

            <button class="btn btn-sm btn-outline-light d-flex align-items-center gap-2 ms-2" onclick="openLoginModal()" id="loginBtn"><i class="fas fa-key"></i> <span class="d-none d-md-inline">Login</span></button>

            <div id="userProfile" class="d-none align-items-center ms-2">
                 <div class="balance-badge" title="Virtual USDT (BSC)">
                    <i class="fas fa-coins"></i> <span id="user-balance">0</span> USDT
                </div>
                <div class="profile-btn-area" onclick="openProfileModal()">
                    <img id="nav-avatar" src="" class="user-avatar-sm" style="display:none">
                    <span class="text-brand fw-bold small" id="userNameDisplay">User</span>
                </div>
                <button class="btn-icon ms-2" style="width:28px;height:28px" onclick="handleLogout()" title="Logout"><i class="fas fa-sign-out-alt"></i></button>
            </div>
        </div>
    </div>
</nav>


<div id="view-dashboard">
    <div class="hero-banner">
        <div class="container">
            <h1 class="hero-title" data-i18n="hero_title">TOURNAMENT VOLUME TRACKER</h1>
            <p class="hero-sub" data-i18n="hero_sub">Manage your accounts & Join the prediction.</p>
        </div>
    </div>

    <div class="container">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
             <h4 class="fw-bold mb-0 text-brand text-uppercase letter-spacing-1 font-num" style="text-shadow: 0 0 10px rgba(0, 240, 255, 0.4);">
                <i class="fas fa-link me-2"></i>
                <span data-i18n="sect_arsenal">TRADING PLATFORMS</span>
            </h4>
            <span class="text-sub small"><i class="fas fa-check-circle text-green me-1"></i> <span data-i18n="verified_link">Verified Links</span></span>
        </div>
        
        <div class="arsenal-section">
            <div class="arsenal-grid" id="arsenal-grid">
                </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3 mt-5">
             <h4 class="fw-bold mb-0 text-brand text-uppercase letter-spacing-1 font-num" style="text-shadow: 0 0 10px rgba(0, 240, 255, 0.4);">
                <i class="fas fa-chart-pie me-2"></i>
                <span data-i18n="sect_market">MARKET OVERVIEW</span>
            </h4>
        </div>

        <div class="row g-4 mb-5">
            <div class="col-md-4">
                <div class="stat-box">
                    <div>
                        <div class="stat-lbl" data-i18n="stat_active">ACTIVE POOLS</div>
                        <div class="stat-val text-brand" id="stat-active">0</div>
                    </div>
                    <i class="fas fa-bolt text-sub opacity-25 fa-2x"></i>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stat-box">
                    <div>
                        <div class="stat-lbl" data-i18n="stat_pool">TOTAL ACTIVE REWARDS</div>
                        <div class="stat-val text-green" id="stat-pool">0 $</div>
                    </div>
                    <i class="fas fa-sack-dollar text-sub opacity-25 fa-2x"></i>
                </div>
            </div>

            <div class="col-md-4">
                <div class="stat-box" style="position: relative; overflow: hidden; border-color: var(--accent-yellow);">
                    <div style="z-index: 2; position: relative;">
                        <div class="stat-lbl text-gold" data-i18n="stat_top_reward">HIGHEST REWARD</div>
                        <div class="d-flex align-items-baseline gap-3"> <div class="stat-val text-white anim-breathe" id="stat-top-symbol">---</div>
    <div class="fw-bold text-gold font-num" id="stat-top-val" style="font-size: 1.8rem; text-shadow: 0 0 10px rgba(240, 185, 11, 0.5);">$0</div>
</div>
                    </div>
                    <img id="stat-top-img" src="" style="position: absolute; right: -10px; bottom: -10px; width: 80px; height: 80px; opacity: 0.15; border-radius: 50%; filter: grayscale(100%); transform: rotate(-15deg); display:none">
                    <i class="fas fa-trophy text-gold opacity-25 fa-2x" style="position: absolute; right: 20px; top: 20px;"></i>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="d-flex align-items-center gap-3">
                <h6 class="fw-bold mb-0 text-sub text-uppercase letter-spacing-1 font-num" style="font-size: 1rem;">
                    <i class="fas fa-list me-2"></i>
                    <span data-i18n="sect_board">TRACKING BOARD</span>
                </h6>

                <button class="btn btn-sm btn-outline-success fw-bold admin-only" onclick="openCreateModal()" style="border-radius: 20px; padding: 5px 20px;">
                    <i class="fas fa-plus me-1"></i> <span data-i18n="stat_create">CREATE</span>
                </button>

                <button class="btn btn-sm btn-brand fw-bold admin-only btn-save-pos" style="display:none; background:var(--brand); color:#000; border:none; padding: 5px 20px; border-radius: 20px; box-shadow: 0 0 10px rgba(0,240,255,0.3); white-space: nowrap;" onclick="saveCustomOrder()">
                    <i class="fas fa-save me-1"></i> SAVE POSITION
                </button>
            </div>

            <div>
                <button class="btn btn-sm btn-outline-warning border-0 text-sub me-2 admin-only" onclick="openConfigModal()"><i class="fas fa-cog me-1"></i> Site Config</button>
            </div>
        </div>

        <div class="row g-4" id="appGrid"></div>
    </div>
</div>

<div id="view-predict" style="display:none; padding: 0 20px 20px 20px; max-width: 1600px; margin: 0 auto;">
    <button class="back-btn mb-4" onclick="playSfx('click'); switchView('dashboard')"><i class="fas fa-arrow-left"></i> BACK TO DASHBOARD</button>
    <div id="predict-content-placeholder"></div>
</div>


<footer class="app-footer">
    <div class="container">
        <div class="footer-socials" id="footer-socials-container"></div>
        <div class="footer-copy text-center text-sub small">
            &copy; 2025 WAVE ALPHA. All rights reserved.<br>
            <span class="opacity-50">Data provided by DexScreener & Binance. Not financial advice.</span><br>
            <a href="#" class="text-sub text-decoration-none mt-2 d-inline-block border-bottom border-secondary" onclick="new bootstrap.Modal(document.getElementById('privacyModal')).show()">Privacy Policy</a> &bull; <a href="#" class="text-sub text-decoration-none border-bottom border-secondary" onclick="new bootstrap.Modal(document.getElementById('legalModal')).show()">Terms of Service</a>
        </div>
    </div>
</footer>

<div class="modal fade" id="settingsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-white">MANAGE WALLETS</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="text-sub small mb-3">Define accounts to track volume separately (e.g. Main, Sub, Friend).</p>

                <div id="settingsList" class="d-flex flex-column gap-2 mb-3"></div>

                <label class="small fw-bold text-brand mb-1">ADD NEW WALLET</label>
                <div class="input-group">
                    <input type="color" class="form-control form-control-color" id="newAccColor" value="#00F0FF" title="Choose Color">
                    <input type="text" class="form-control" id="newAccName" placeholder="Name (e.g. Account 3)">
                    <button class="btn btn-light fw-bold" onclick="addNewAccount()">ADD</button>
                </div>

                <div class="text-center mt-4">
                    <button class="btn btn-sm btn-outline-secondary border-0" onclick="syncLocalToCloud()">
                        <i class="fas fa-cloud-upload-alt me-1"></i> Sync Old Data to Cloud
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0" style="background: linear-gradient(145deg, #1a1e23, #111); border: 1px solid var(--border);">
            <div class="modal-body p-4 text-center">
                <div class="mb-4">
                    <div style="width:60px;height:60px;background:rgba(0,240,255,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto;border:1px solid var(--brand);box-shadow:0 0 15px rgba(0,240,255,0.3)">
                        <i class="fas fa-shield-alt text-brand fa-2x"></i>
                    </div>
                </div>
                <h5 class="fw-bold text-white mb-1">SECURE ACCESS</h5>
                <p class="text-sub small mb-4">Authenticate via Email OTP</p>
                <div id="login-step-1">
                    <input type="email" id="otp-email" class="form-control mb-3 text-center" placeholder="name@example.com" style="border-radius: 20px;">
                    <button class="btn-action rounded-pill" onclick="sendOtpCode()">SEND CODE <i class="fas fa-paper-plane ms-2"></i></button>
                </div>
                <div id="login-step-2" style="display:none">
                    <input type="text" id="otp-token" class="form-control mb-3 text-center fw-bold text-brand fs-4 letter-spacing-1" placeholder="• • • • • •" maxlength="6" style="border-radius: 20px; background: #000; border-color: var(--brand);">
                    <button class="btn-action rounded-pill mb-3" onclick="verifyOtpCode()">VERIFY LOGIN</button>
                    <a href="#" onclick="resetLoginModal()" class="text-sub small text-decoration-none">Change Email</a>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="privacyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-sub"><i class="fas fa-user-shield me-2"></i> PRIVACY POLICY</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-sub small" style="max-height:400px; overflow-y:auto; line-height:1.6">
                <p><strong>Last Updated: October 2025</strong></p>
                <p>1. <strong>Data Collection:</strong> We only collect your email address for authentication purposes via Supabase Auth. We do not sell your data.</p>
                <p>2. <strong>Usage:</strong> Your data is used solely to track your portfolio progress, leaderboard ranking, and tournament participation within Wave Alpha.</p>
                <p>3. <strong>Cookies:</strong> We use local storage to save your view preferences. No third-party tracking cookies are used.</p>
                <p>4. <strong>Rights:</strong> You can request data deletion at any time by contacting support.</p>
                <div class="text-center mt-4"><button class="btn btn-sm btn-outline-light px-4 rounded-pill" data-bs-dismiss="modal">Close</button></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="shareCardModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-brand"><i class="fas fa-share-alt me-2"></i> SHARE PREDICTION</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center d-flex flex-column align-items-center">
                <div id="share-card-container">
                    <div class="sc-header">
                        <div class="sc-logo-text">WAVE<span>ALPHA</span></div>
                        <div class="sc-date" id="sc-date-display">--/--/----</div>
                    </div>
                    <div class="sc-main">
                        <div class="sc-user-box">
                            <img id="sc-user-avatar" src="" class="sc-user-avatar" crossOrigin="anonymous">
                            <div class="sc-user-info">
                                <div class="sc-user-label">TRADER</div>
                                <div id="sc-user-name" class="sc-user-name">SHARK</div>
                            </div>
                        </div>

                        <div class="sc-token-row">
                            <img id="sc-token-img" src="" class="sc-token-img" crossOrigin="anonymous">
                            <div id="sc-token-name" class="sc-token-name">BTC</div>
                        </div>

                        <div class="sc-stat-box">
                            <div><div class="sc-stat-label">MIN VOL</div><div class="sc-stat-val brand" id="sc-min-vol">0</div></div>
                            <div class="sc-divider"></div>
                            <div><div class="sc-stat-label">MY PREDICTION</div><div class="sc-stat-val gold" id="sc-my-guess">0</div></div>
                        </div>
                    </div>
                    <div class="sc-footer">
                        <div class="text-start">
                            <div class="sc-ref-text">Challenge me on<br>Prediction Market</div>
                            <div class="sc-web-link">wave-alpha.netlify.app</div>
                        </div>
                        <div class="sc-qr-box" id="sc-qr-target"></div>
                    </div>
                </div>
                <div class="mt-4 w-100">
                    <button class="btn btn-light rounded-pill fw-bold w-100 py-2 mb-3" onclick="downloadShareCard()"><i class="fas fa-download me-2"></i> DOWNLOAD IMAGE</button>

                    <div class="d-flex gap-2 justify-content-center">
                        <button class="btn btn-dark border-secondary flex-fill rounded-pill py-2" onclick="shareToX()" style="background:#000"><i class="fab fa-twitter text-white me-2"></i> Share on X</button>
                        <button class="btn btn-primary border-0 flex-fill rounded-pill py-2" onclick="shareToTele()" style="background:#0088cc"><i class="fab fa-telegram-plane text-white me-2"></i> Telegram</button>
                    </div>

                    <div class="text-sub small mt-3 opacity-50">Share link & challenge friends!</div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title fw-bold text-brand"><i class="fas fa-user-cog me-2"></i> PROFILE SETTINGS</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="avatar-upload-box" onclick="document.getElementById('file-input').click()">
                    <img id="pf-preview" src="">
                    <div class="upload-placeholder" id="pf-placeholder"><i class="fas fa-camera fa-2x mb-1"></i><br>Upload</div>
                    <div id="upload-loading" style="position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);border-radius:50%;display:none;align-items:center;justify-content:center"><div class="spinner-border text-brand spinner-border-sm"></div></div>
                </div>
                <input type="file" id="file-input" accept="image/*" onchange="handleFileUpload(this)">
                <input type="hidden" id="pf-avatar-url">

                <label class="small text-sub fw-bold mb-1">NICKNAME (UNIQUE)</label>
                <input type="text" id="pf-nickname" class="form-control mb-4" placeholder="Enter unique nickname">

                <button id="btn-save-profile" class="btn-action" onclick="saveProfile()">SAVE CHANGES</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-warning">GLOBAL SETTINGS</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-4 border-bottom border-secondary border-opacity-25 pb-3">
                    <label class="small text-sub fw-bold mb-2 text-brand">BRAND LOGO (ADMIN)</label>
                    <div class="d-flex align-items-center gap-3">
                        <img id="cfg-logo-preview" src="" style="width:60px; height:60px; object-fit:contain; background:#000; border:1px solid #333; border-radius:4px; display:none">
                        <div style="flex:1">
                            <input type="file" class="form-control form-control-sm mb-1" accept="image/*" onchange="uploadImage(this, 'cfg-logo-preview', 'cfg-logo-url')">
                            <input type="hidden" id="cfg-logo-url">
                            <div class="text-sub" style="font-size:0.7rem">Upload ảnh logo của bạn (PNG/JPG)</div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="small text-sub fw-bold mb-1">X (Twitter) URL</label>
                    <input type="text" id="cfg-x" class="form-control mb-2">
                    <label class="small text-sub fw-bold mb-1">Telegram URL</label>
                    <input type="text" id="cfg-tele" class="form-control mb-2">
                    <label class="small text-sub fw-bold mb-1">Youtube URL</label>
                    <input type="text" id="cfg-yt" class="form-control mb-2">
                </div>

                <h6 class="text-gold mb-3 pt-3 border-top border-secondary border-opacity-25">QUẢN LÝ LINK REF (ARSENAL)</h6>

                <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-sm btn-outline-success" onclick="addArsenalItem()">
                        <i class="fas fa-plus me-1"></i> Thêm Sàn Mới
                    </button>
                </div>

                <div id="cfg-arsenal-list" style="max-height: 400px; overflow-y: auto; padding-right: 5px; display: flex; flex-direction: column; gap: 10px;"></div>


                <button class="btn-action" onclick="saveGlobalConfig()">SAVE CONFIG</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="updateModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-brand">MY TRADING TRACKER</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="u-db-id">
                <input type="hidden" id="u-original-date">
                <div class="row">
                    <div class="col-lg-4 border-end border-secondary border-opacity-25 pe-lg-4">
                        <h4 class="font-num fw-bold text-main mb-3" id="u-symbol-display">TOKEN</h4>
                        <div class="mb-3">
                            <label class="small text-sub fw-bold mb-1">DATE</label>
                            <input type="date" id="u-date" class="form-control text-brand fw-bold">
                        </div>
                        <div class="p-3 mb-4 rounded" style="background: rgba(240, 185, 11, 0.05); border: 1px dashed rgba(240, 185, 11, 0.3);">
                            <label class="small text-gold fw-bold mb-1"><i class="fas fa-lock me-1"></i> MIN VOLUME (TARGET)</label>
                            <input type="text" id="u-min-vol" class="form-control font-num text-gold fw-bold fs-4" placeholder="---" disabled style="background:transparent; border:none; padding:0" onkeyup="formatCurrency(this)">
                        </div>
                        <label class="small text-brand fw-bold mb-2"><i class="fas fa-wallet me-1"></i> MY VOLUMES & GAP</label>
                        <div class="d-flex justify-content-between text-sub small fw-bold px-1 mb-1">
                            <span style="width:80px">ACC</span>
                            <span class="text-center">VOL</span>
                            <span class="text-end">GAP / COST</span>
                        </div>
                        <div id="u-acc-inputs" class="mb-4"></div>
                        <button id="btn-save-progress" class="btn-action" onclick="saveUpdate()">SAVE MY PROGRESS</button>
                    </div>
                    <div class="col-lg-8 ps-lg-4">
                        <div style="height: 250px; margin-bottom: 20px;">
                            <canvas id="trackerChart"></canvas>
                        </div>
                        <label class="small text-sub fw-bold mb-2">MY HISTORY</label>
                        <div style="max-height:300px;overflow-y:auto">
                            <table class="table table-dark table-sm table-hover align-middle" style="font-size:0.8rem" id="historyTable">
                                <thead>
                                    <tr id="historyHeader"></tr>
                                </thead>
                                <tbody id="historyList"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="inputModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-white">ENTER PREDICTION</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body pt-2">
                <p class="text-sub small mb-4">Dự đoán Min Volume chốt sổ.</p>
                <label class="text-brand fw-bold small mb-1">YOUR NAME</label>
                <input type="text" id="modal-p-name" class="form-control mb-3" placeholder="Ví dụ: Shark 1">
                <label class="text-gold fw-bold small mb-1">YOUR GUESS (VOL)</label>
                <input type="number" id="modal-p-guess" class="form-control font-num fs-4 text-gold mb-4" placeholder="Fee: 100 USDT">
                <button class="btn-action w-100 py-3 text-white" style="background: var(--purple)" onclick="submitPredictionFromModal()">CONFIRM & PAY FEE</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="compModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold text-brand">SETUP TOURNAMENT (ADMIN)</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <input type="hidden" id="c-db-id">

                <div class="row g-3 mb-3">
                    <div class="col-md-5">
                        <label class="small text-sub fw-bold mb-1">REWARD TOKEN CONTRACT (Để lấy giá tính Pool)</label>
                        <div class="input-group">
                            <input type="text" id="c-contract" class="form-control" onchange="fetchTokenInfo(this.value)">
                            <button class="btn btn-outline-secondary border-secondary" onclick="fetchTokenInfo(document.getElementById('c-contract').value)"><i class="fas fa-search"></i></button>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="small text-sub fw-bold mb-1">CHAIN</label>
                        <input type="text" id="c-chain" class="form-control text-uppercase fw-bold" placeholder="bsc">
                    </div>
                    <div class="col-md-2">
                        <label class="small text-sub fw-bold mb-1">SYMBOL (TÊN)</label>
                        <input type="text" id="c-symbol" class="form-control text-uppercase text-brand font-num fw-bold">
                    </div>
                    <div class="col-md-3">
                        <label class="small text-sub fw-bold mb-1">PRICE ($)</label>
                        <input type="number" id="c-price" class="form-control font-num text-gold">
                    </div>
                </div>

                <div class="p-3 rounded mb-3" style="background: rgba(153, 69, 255, 0.1); border: 1px dashed var(--purple);">
                    <label class="small text-white fw-bold mb-1"><i class="fas fa-layer-group me-1"></i> CAMPAIGN MODE (OPTIONAL)</label>
                    <input type="text" id="c-inputTokens" class="form-control" placeholder="Nhập các token cần trade, cách nhau dấu phẩy (VD: VSN, LAVA)">
                    <div class="text-sub mt-1" style="font-size:0.7rem">* Nếu điền ô này, thẻ sẽ chuyển sang chế độ 'Aggregated Campaign'. Bỏ trống để tạo giải thưởng.</div>
                </div>

                <div class="mb-3">
                    <label class="small text-sub fw-bold mb-1">PROJECT LOGO</label>
                    <div class="input-group mb-2">
                        <input type="file" class="form-control" accept="image/*" onchange="uploadImage(this, 'c-logo-preview', 'c-logo')">
                    </div>
                    <div class="d-flex align-items-center gap-3 p-2 rounded" style="background:rgba(255,255,255,0.05)">
                        <img id="c-logo-preview" src="" style="width:40px; height:40px; border-radius:50%; object-fit:cover; border:1px solid #555; display:none">
                        <input type="text" id="c-logo" class="form-control form-control-sm border-0 bg-transparent text-white" placeholder="Image URL will appear here..." readonly>
                    </div>
                </div>

                <div class="p-3 rounded border border-secondary border-opacity-25 mb-4" style="background: rgba(255,255,255,0.02)">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="small text-sub fw-bold mb-1">ALPHA POINTS</label>
                            <select id="c-alphaType" class="form-select form-select-sm" onchange="toggleListingTime()">
                                <option value="none">None (1x)</option>
                                <option value="x2">Other (x2)</option>
                                <option value="x4">BSC (x4)</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-sub fw-bold mb-1 text-gold">LISTING TIME</label>
                            <input type="datetime-local" id="c-listing" class="form-control form-control-sm" disabled>
                        </div>
                        <div class="col-md-4">
                            <label class="small text-sub fw-bold mb-1">RULE TYPE</label>
                            <select id="c-rule" class="form-select form-select-sm">
                                <option value="buy_only">ONLY BUY</option>
                                <option value="trade_x4">BUY + SELL (x4)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="small text-sub fw-bold mb-1">REWARD QTY</label>
                        <input type="number" id="c-rewardQty" class="form-control font-num">
                    </div>
                    <div class="col-md-6">
                        <label class="small text-sub fw-bold mb-1">WINNERS</label>
                        <input type="number" id="c-winners" class="form-control font-num" placeholder="2000">
                    </div>
                </div>

                <div class="row g-3 mb-3">
                    <div class="col-6">
                        <label class="small text-sub fw-bold mb-1">START DATE</label>
                        <input type="date" id="c-start" class="form-control">
                    </div>
                    <div class="col-6">
                        <label class="small text-sub fw-bold mb-1">END DATE</label>
                        <div class="input-group">
                            <input type="date" id="c-end" class="form-control">
                            <input type="time" id="c-end-time" class="form-control" style="max-width:100px">
                        </div>
                    </div>
                </div>

                <button class="btn-action" onclick="saveComp()">PUBLISH TO CLOUD</button>
                <div class="text-center mt-3">
                    <button class="btn btn-sm text-danger border-0 bg-transparent opacity-50" onclick="deleteComp()" id="btnDeleteComp" style="display:none">Delete Tournament</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="helpModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-brand" data-i18n="legend_title">ICON LEGEND</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="btn-icon" style="cursor:default"><i class="fas fa-sync-alt text-gold"></i></div>
                    <div>
                        <div class="fw-bold" data-i18n="leg_sync_t">Smart Sync</div>
                        <div class="text-sub small" data-i18n="leg_sync_d">Update latest prices & volume from Server.</div>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="btn-icon" style="cursor:default"><i class="fas fa-database"></i></div>
                    <div>
                        <div class="fw-bold" data-i18n="leg_reload_t">Reload Data</div>
                        <div class="text-sub small" data-i18n="leg_reload_d">Force reload data from Cloud Database.</div>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-3 mb-3">
                    <div class="btn-icon" style="cursor:default"><i class="fas fa-wallet"></i></div>
                    <div>
                        <div class="fw-bold" data-i18n="leg_wallet_t">Manage Wallets</div>
                        <div class="text-sub small" data-i18n="leg_wallet_d">Add or remove tracking accounts.</div>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-3">
                    <div class="btn-icon" style="cursor:default"><i class="fas fa-key"></i></div>
                    <div>
                        <div class="fw-bold" data-i18n="leg_login_t">Login</div>
                        <div class="text-sub small" data-i18n="leg_login_d">Access Admin features via OTP Email.</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="ruleModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-brand"><i class="fas fa-scroll me-2"></i> WAVE ORACLE RULES</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <h6 class="text-white fw-bold mb-3 text-uppercase letter-spacing-1">Objective</h6>
                <p class="text-sub small mb-4">Predict the exact <strong>Min Volume</strong> (the volume of the last ranked winner, e.g., Rank #2000) at the tournament snapshot time.</p>

                <h6 class="text-white fw-bold mb-3 text-uppercase letter-spacing-1">Gameplay Mechanics</h6>
                <ul class="rule-list">
                    <li><strong>Entry Fee:</strong> Each prediction costs <span class="text-gold fw-bold">100 USDT</span> (Virtual). Added to the Prize Pool.</li>
                    <li><strong>Lock Time:</strong> Predictions CLOSE <span class="text-danger fw-bold">AT TOURNAMENT END</span>. Results are announced the following day after Binance publishes the Min Volume.</li>
                    <li><strong>Winner:</strong> The player with the <span class="text-brand">Closest Guess ≥ Actual Result</span> wins. (Lower guesses are disqualified).</li>
                    <li><strong>Tie-Breaker:</strong> If guesses are equal, the earlier prediction wins.</li>
                </ul>

                <h6 class="text-white fw-bold mb-3 text-uppercase letter-spacing-1">Prize Distribution</h6>
                <div class="d-flex gap-2 mb-2">
                    <div class="flex-fill p-2 bg-dark rounded border border-secondary text-center"><div class="text-gold fw-bold">🥇 1st</div><div class="small">50% Pool</div></div>
                    <div class="flex-fill p-2 bg-dark rounded border border-secondary text-center"><div class="text-light fw-bold">🥈 2nd</div><div class="small">30% Pool</div></div>
                    <div class="flex-fill p-2 bg-dark rounded border border-secondary text-center"><div class="text-brand fw-bold">🥉 3rd</div><div class="small">20% Pool</div></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="guideModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-brand"><i class="fas fa-graduation-cap me-2"></i> QUICK START GUIDE</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="row g-4">
                    <div class="col-md-4 text-center">
                        <div class="p-3 rounded h-100" style="border: 1px solid #333; background: rgba(255,255,255,0.03);">
                            <div class="mb-2"><i class="fas fa-list-ol fa-2x text-brand"></i></div>
                            <h6 class="text-white fw-bold">STEP 1: SETUP LIST</h6>
                            <p class="text-sub small">Define your tracking list (e.g. Account A, Account B) to separate volume sources. <br><strong>No connection needed.</strong></p>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="p-3 rounded h-100" style="border: 1px solid #333; background: rgba(255,255,255,0.03);">
                            <div class="mb-2"><i class="fas fa-pen-to-square fa-2x text-gold"></i></div>
                            <h6 class="text-white fw-bold">STEP 2: INPUT VOLUME</h6>
                            <p class="text-sub small">Click <strong>UPDATE</strong> on any tournament. Manually input your daily volume for each account.</p>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="p-3 rounded h-100" style="border: 1px solid #333; background: rgba(255,255,255,0.03);">
                            <div class="mb-2"><i class="fas fa-chart-line fa-2x text-green"></i></div>
                            <h6 class="text-white fw-bold">STEP 3: TRACK GAP</h6>
                            <p class="text-sub small">System automatically calculates the <strong>GAP</strong> (Distance) to the target Min Volume.</p>
                        </div>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button class="btn-action w-50 mx-auto" data-bs-dismiss="modal" onclick="openSettingsModal()">SETUP MY LIST <i class="fas fa-arrow-right ms-2"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="volHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background: #161a1e; border: 1px solid #333;">
            <div class="modal-header border-bottom border-secondary border-opacity-25">
                <div>
                    <h5 class="modal-title fw-bold text-brand font-num" id="vh-title">VOLUME HISTORY</h5>
                    <div class="text-sub small" id="vh-subtitle">Daily USDT Volume</div>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div style="height: 300px; width: 100%;">
                    <canvas id="volHistoryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    /* ================= SETUP ================= */
    const SUPABASE_URL = 'https://akbcpryqjigndzpuoany.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFrYmNwcnlxamlnbmR6cHVvYW55Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwODg0NTEsImV4cCI6MjA4MDY2NDQ1MX0.p1lBHZ12fzyIrKiSL7DXv7VH74cq3QcU7TtBCJQBH9M';
    const ADMIN_EMAILS = [ "annachou60@gmail.com" ];
    const PREDICT_FEE = 100; // Game Fee

/* --- BỘ TỪ ĐIỂN FULL (ĐÃ CẬP NHẬT TÊN & SLOGAN MỚI) --- */
let currentLang = localStorage.getItem('wave_lang') || 'en';

const translations = {
    en: {
        // --- CHUNG ---
        nav_guide: "GUIDE", nav_login: "Login", nav_logout: "Logout",
        sys_time: "SYSTEM TIME", verified_link: "Verified Links",

        // --- HERO ---
        hero_title: "TOURNAMENT VOLUME TRACKER",
        hero_sub: "Manage your accounts & Join the prediction.",

        // --- SECTION HEADERS ---
        sect_arsenal: "TRADING PLATFORMS",
        sect_market: "MARKET OVERVIEW",
        stat_top_reward: "HIGHEST REWARD",
        sect_board: "TRACKING BOARD",

        // --- STATS ---
        stat_active: "ACTIVE POOLS", stat_pool: "TOTAL ACTIVE REWARDS", stat_create: "CREATE NEW",

        // --- SORT ---
        sort_newest: "Newest (Start Date)", sort_ending: "Ending Soon", sort_reward: "Highest Reward ($)",

        // --- CARD ---
        lbl_top: "TOP", lbl_reward: "REWARD", lbl_price: "PRICE",
        lbl_ends: "ENDS:", lbl_min_target: "MIN TARGET",
        btn_update: "UPDATE", btn_predict: "PREDICT",
        status_running: "RUNNING", status_ended: "ENDED",
        tag_x4: "X4 BSC", tag_x2: "X2 OTHER",
        res_win: "WIN", res_lose: "LOSE",

        // --- MODALS ---
        modal_u_title: "MY TRADING TRACKER", lbl_date: "DATE", lbl_my_vol: "MY VOLUMES & GAP", lbl_history: "MY HISTORY",
        btn_save_prog: "SAVE MY PROGRESS", btn_saving: "SAVING...", btn_saved: "SAVED!", ph_vol: "Volume", ph_cost: "Cost ($)",
        modal_p_title: "ENTER PREDICTION", modal_p_desc: "Predict the final Min Volume.", lbl_p_name: "YOUR NAME", lbl_p_guess: "YOUR GUESS (VOL)",
        ph_p_name: "Ex: Shark 1", ph_p_fee: "Fee: 100 USDT", btn_confirm: "CONFIRM & PAY FEE", btn_processing: "PROCESSING...",
        modal_l_title: "SECURE ACCESS", modal_l_desc: "Authenticate via Email OTP", btn_send_code: "SEND CODE", btn_verify: "VERIFY LOGIN",

        // --- TOAST ---
        toast_login_req: "Please Login first!", toast_success: "Action Successful!", toast_error: "Error occurred!",
        toast_insufficient: "Insufficient Balance!", toast_saved: "Tracking Data Saved!",

        // --- [MỚI] ICON LEGEND (TIẾNG ANH) ---
        legend_title: "ICON LEGEND",
        leg_sync_t: "Smart Sync", leg_sync_d: "Update latest prices & volume from Server.",
        leg_reload_t: "Reload Data", leg_reload_d: "Force reload data from Cloud Database.",
        leg_wallet_t: "Manage Wallets", leg_wallet_d: "Add/Remove tracking portfolios.",
        leg_login_t: "Login / Access", leg_login_d: "Secure access via Email OTP to save data."
    },
    vi: {
        // --- CHUNG ---
        nav_guide: "HƯỚNG DẪN", nav_login: "Đăng nhập", nav_logout: "Đăng xuất",
        sys_time: "GIỜ HỆ THỐNG", verified_link: "Link Chính Chủ",

        // --- HERO ---
        hero_title: "TRÌNH THEO DÕI VOLUME GIẢI ĐẤU",
        hero_sub: "Quản lý các tài khoản & Tham gia dự đoán.",

        // --- SECTION HEADERS ---
        sect_arsenal: "SÀN GIAO DỊCH",
        sect_market: "TỔNG QUAN THỊ TRƯỜNG",
        stat_top_reward: "GIẢI THƯỞNG CAO NHẤT",
        sect_board: "BẢNG THEO DÕI",

        // --- STATS ---
        stat_active: "GIẢI ĐANG CHẠY", stat_pool: "TỔNG GIÁ TRỊ GIẢI (ACTIVE)", stat_create: "TẠO GIẢI MỚI",

        // --- SORT ---
        sort_newest: "Mới nhất (Ngày bắt đầu)", sort_ending: "Sắp kết thúc", sort_reward: "Thưởng cao nhất ($)",

        // --- CARD ---
        lbl_top: "TOP", lbl_reward: "THƯỞNG", lbl_price: "GIÁ",
        lbl_ends: "KẾT THÚC:", lbl_min_target: "MỤC TIÊU MIN",
        btn_update: "CẬP NHẬT", btn_predict: "DỰ ĐOÁN",
        status_running: "ĐANG CHẠY", status_ended: "ĐÃ KẾT THÚC",
        tag_x4: "X4 MẠNG BSC", tag_x2: "X2 MẠNG KHÁC",
        res_win: "THẮNG", res_lose: "THUA",

        // --- MODALS ---
        modal_u_title: "CẬP NHẬT VOLUME", lbl_date: "NGÀY", lbl_my_vol: "VOL CỦA TÔI & KHOẢNG CÁCH", lbl_history: "LỊCH SỬ NHẬP",
        btn_save_prog: "LƯU TIẾN ĐỘ", btn_saving: "ĐANG LƯU...", btn_saved: "ĐÃ LƯU!", ph_vol: "Nhập Vol", ph_cost: "Vốn ($)",
        modal_p_title: "NHẬP DỰ ĐOÁN", modal_p_desc: "Dự đoán Min Volume khi chốt sổ.", lbl_p_name: "TÊN BẠN", lbl_p_guess: "DỰ ĐOÁN (VOL)",
        ph_p_name: "Ví dụ: Shark 1", ph_p_fee: "Phí: 100 USDT", btn_confirm: "XÁC NHẬN & TRẢ PHÍ", btn_processing: "ĐANG XỬ LÝ...",
        modal_l_title: "ĐĂNG NHẬP", modal_l_desc: "Xác thực qua Email OTP", btn_send_code: "GỬI MÃ CODE", btn_verify: "XÁC NHẬN",

        // --- TOAST ---
        toast_login_req: "Vui lòng đăng nhập trước!", toast_success: "Thao tác thành công!", toast_error: "Có lỗi xảy ra!",
        toast_insufficient: "Số dư không đủ!", toast_saved: "Dữ liệu đã được lưu!",

        // --- [MỚI] ICON LEGEND (TIẾNG VIỆT) ---
        legend_title: "CHÚ THÍCH BIỂU TƯỢNG",
        leg_sync_t: "Đồng bộ Thông minh", leg_sync_d: "Cập nhật giá & volume mới nhất từ Server.",
        leg_reload_t: "Tải lại Dữ liệu", leg_reload_d: "Buộc tải lại toàn bộ dữ liệu từ Cloud.",
        leg_wallet_t: "Quản lý Ví", leg_wallet_d: "Thêm/Xóa danh mục theo dõi.",
        leg_login_t: "Đăng nhập", leg_login_d: "Truy cập bảo mật để lưu dữ liệu."
    },
    zh: {
        // --- CHUNG ---
        nav_guide: "指南", nav_login: "登录", nav_logout: "登出",
        sys_time: "系统时间", verified_link: "官方链接",

        // --- HERO ---
        hero_title: "锦标赛成交量追踪器",
        hero_sub: "管理您的账户 & 参与预测。",

        // --- SECTION HEADERS ---
        sect_arsenal: "交易平台",
        sect_market: "市场概览",
        stat_top_reward: "最高奖池",
        sect_board: "追踪板",

        // --- STATS ---
        stat_active: "活跃池", stat_pool: "当前活跃奖池总值", stat_create: "创建新池",

        // --- SORT ---
        sort_newest: "最新 (开始日期)", sort_ending: "即将结束", sort_reward: "最高奖励 ($)",

        // --- CARD ---
        lbl_top: "排名", lbl_reward: "奖励", lbl_price: "价格",
        lbl_ends: "结束:", lbl_min_target: "最低目标",
        btn_update: "更新", btn_predict: "预测",
        status_running: "进行中", status_ended: "已结束",
        tag_x4: "X4 BSC链", tag_x2: "X2 其他链",
        res_win: "获胜", res_lose: "未中",

        // --- MODALS ---
        modal_u_title: "我的交易追踪", lbl_date: "日期", lbl_my_vol: "我的成交量 & 差距", lbl_history: "历史记录",
        btn_save_prog: "保存进度", btn_saving: "保存中...", btn_saved: "已保存!", ph_vol: "成交量", ph_cost: "成本 ($)",
        modal_p_title: "输入预测", modal_p_desc: "预测最终最低成交量。", lbl_p_name: "昵称", lbl_p_guess: "预测值 (VOL)",
        ph_p_name: "例如: Shark 1", ph_p_fee: "费用: 100 USDT", btn_confirm: "确认并支付", btn_processing: "处理中...",
        modal_l_title: "安全登录", modal_l_desc: "通过邮箱 OTP 验证", btn_send_code: "发送验证码", btn_verify: "验证登录",

        // --- TOAST ---
        toast_login_req: "请先登录!", toast_success: "操作成功!", toast_error: "发生错误!",
        toast_insufficient: "余额不足!", toast_saved: "数据已保存!",

        // --- [MỚI] ICON LEGEND (TIẾNG TRUNG) ---
        legend_title: "图标说明",
        leg_sync_t: "智能同步", leg_sync_d: "从服务器更新最新价格和成交量。",
        leg_reload_t: "重新加载", leg_reload_d: "强制从云数据库重新加载数据。",
        leg_wallet_t: "管理钱包", leg_wallet_d: "添加/删除追踪组合。",
        leg_login_t: "登录", leg_login_d: "安全登录以保存数据。"
    }
};

function changeLanguage(lang) {
    currentLang = lang;
    localStorage.setItem('wave_lang', lang);
    let langBtn = document.getElementById('cur-lang-text');
    if(langBtn) langBtn.innerText = lang.toUpperCase();
    applyLanguage();
    renderGrid();
}

function applyLanguage() {
    const t = translations[currentLang];
    document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.getAttribute('data-i18n');
        if (t[key]) {
            if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                el.placeholder = t[key];
            } else {
                el.innerText = t[key];
            }
        }
    });
    let sortSel = document.getElementById('sortFilter');
    if(sortSel) {
        sortSel.options[0].text = t.sort_newest;
        sortSel.options[1].text = t.sort_ending;
        sortSel.options[2].text = t.sort_reward;
    }
}


    // V45 UX: CUSTOM TOAST SYSTEM
    function showToast(msg, type='info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast-item ${type === 'success' ? 'toast-success' : (type === 'error' ? 'toast-error' : '')}`;

        let icon = type === 'success' ? 'fa-check-circle text-green' : (type === 'error' ? 'fa-exclamation-triangle text-red' : 'fa-info-circle text-brand');

        toast.innerHTML = `<i class="fas ${icon} fa-lg"></i><div style="flex:1; font-size:0.9rem; font-weight:600; font-family:var(--font-main)">${msg}</div>`;

        container.appendChild(toast);
        // Play gentle sound
        if(type === 'error') playSfx('hover');
        else playSfx('click');

        setTimeout(() => {
            toast.style.animation = 'fadeOut 0.5s forwards';
            setTimeout(() => toast.remove(), 500);
        }, 4000);
    }

    // Override native alert for better UX (Optional, but safe)
    window.alert = function(msg) { showToast(msg, 'info'); };

    // SFX ENGINE (V45)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSfx(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain); gain.connect(audioCtx.destination);
        if(type === 'click') {
            osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(300, audioCtx.currentTime + 0.1);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else if(type === 'hover') {
            osc.type = 'triangle'; osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
            osc.start(); osc.stop(audioCtx.currentTime + 0.05);
        }
    }
    // Attach SFX to common elements
    document.querySelectorAll('button, .tour-card, .arsenal-card, .nav-link').forEach(el => {
        el.addEventListener('mouseenter', () => playSfx('hover'));
        el.addEventListener('click', () => playSfx('click'));
    });
    /* ========================================= */

    let supabase = null;
    let marketChart = null, trackerChart = null, currentPolyId = null, compList = [];
    let siteConfig = { x:'', tele:'', yt:'', affiliate: {} };
    let accSettings = JSON.parse(localStorage.getItem('wave_settings')) || [{id:'acc1', name:'Main', color:'#00F0FF'}, {id:'acc2', name:'Clone', color:'#FFD700'}];
    let currentUser = null;
    let userProfile = null;

    const fmtNum = n => new Intl.NumberFormat('en-US', { maximumFractionDigits: 6 }).format(n);
    const fmt = n => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(n).replace('US$', '$').trim();
    const formatCurrency = (input) => {
        let val = input.value.replace(/\D/g, "").replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        input.value = val;
        if(input.id === 'u-min-vol') accSettings.forEach(acc => calcRowGap(acc.id));
    };

    if (typeof window.supabase !== 'undefined') {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        supabase.auth.onAuthStateChange((event, session) => {
            if (session) {
                currentUser = session.user;
                document.getElementById('loginBtn').classList.add('d-none');
                document.getElementById('userProfile').classList.remove('d-none');
                document.getElementById('userProfile').classList.add('d-flex');

                fetchUserProfile();
                checkUserAdmin();
                bootstrap.Modal.getInstance(document.getElementById('loginModal'))?.hide();
            } else {
                currentUser = null;
                userProfile = null;
                document.getElementById('loginBtn').classList.remove('d-none');
                document.getElementById('userProfile').classList.add('d-none');
                document.getElementById('userProfile').classList.remove('d-flex');
                document.body.classList.remove('is-admin');
            }
        });
        supabase.channel('public:tournaments').on('postgres_changes', { event: '*', schema: 'public', table: 'tournaments' }, payload => { loadFromCloud(false); }).subscribe();
    }

    function init() {
        checkLegal();
        
        // 1. Load dữ liệu từ DB ngay lập tức (để user thấy hình ảnh liền, không phải chờ)
        // Tham số 'true' nghĩa là hiện loading overlay lúc đầu
        loadFromCloud(true).then(() => {
            // 2. Load xong thì âm thầm kiểm tra xem dữ liệu có cũ quá không
            checkAndAutoRefresh();
        });

        setInterval(updateClock, 1000);

        applyLanguage();
        if(document.getElementById('cur-lang-text')) {
            document.getElementById('cur-lang-text').innerText = currentLang.toUpperCase();
        }

        // Tự động bật Hướng dẫn (nếu chưa xem)
        if (!localStorage.getItem('wave_guide_seen')) {
            setTimeout(() => {
                const guideEl = document.getElementById('guideModal');
                if(guideEl) {
                    new bootstrap.Modal(guideEl).show();
                    localStorage.setItem('wave_guide_seen', 'true');
                }
            }, 1500);
        }
    }

    // --- LOGIC MỚI: AUTO REFRESH THÔNG MINH (ANTI-LAG) ---
    function checkAndAutoRefresh() {
        let oldestTime = Date.now();
        let hasRunning = false;

        compList.forEach(c => {
            let isRunning = !c.end || (new Date() < new Date(c.end + 'T' + (c.endTime||'23:59')));
            if (isRunning) {
                hasRunning = true;
                let t = c.last_updated_ts || 0;
                if (t < oldestTime) oldestTime = t;
            }
        });

        if (!hasRunning) return; 

        const STALE_THRESHOLD = 2 * 60 * 1000; 
        const timeDiff = Date.now() - oldestTime;

        if (timeDiff > STALE_THRESHOLD) {
            // QUAN TRỌNG: Truyền tham số 'true' để kích hoạt chế độ im lặng
            handleSmartRefresh(true); 
        } else {
            console.log("Data fresh. No auto-refresh needed.");
        }
    }

    // --- GIỮ NGUYÊN 2 HÀM NÀY (QUAN TRỌNG) ---
    function checkLegal() {
        if (!localStorage.getItem('wave_legal_accepted')) document.getElementById('legalModal').style.display = 'flex';
    }
    function acceptLegal() {
        localStorage.setItem('wave_legal_accepted', 'true');
        document.getElementById('legalModal').style.display = 'none';
    }
    // --- AUTH & PROFILE ---
    async function fetchUserProfile() {
        if(!currentUser) return;
        const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
        if(data) {
            userProfile = data;
            document.getElementById('userNameDisplay').innerText = data.nickname || currentUser.email.split('@')[0];

            // V45: Read correct balance column
            let bal = data.balance_usdt !== null ? data.balance_usdt : 0;
            document.getElementById('user-balance').innerText = fmtNum(bal);
            userProfile.balance_usdt = bal;

            // CHECK DAILY BONUS
            checkDailyBonus();

            // LOAD CLOUD TRACKER DATA
            userProfile.tracker_data = data.tracker_data || {};
            // Re-render grid to show updated progress bars immediately
            renderGrid();

            if(data.avatar_url) {
                document.getElementById('nav-avatar').src = data.avatar_url;
                document.getElementById('nav-avatar').style.display = 'block';
            } else {
                document.getElementById('nav-avatar').style.display = 'none';
            }
        }
    }

    // V45 RETENTION: DAILY BONUS LOGIC
    async function checkDailyBonus() {
        if(!currentUser || !userProfile) return;
        const today = new Date().toISOString().split('T')[0];
        const lastClaimKey = 'wave_daily_claim_' + currentUser.id;
        const lastClaim = localStorage.getItem(lastClaimKey);

        if(lastClaim !== today) {
            const bonus = 100;
            const newBal = (userProfile.balance_usdt || 0) + bonus;

            // Optimistic UI Update
            userProfile.balance_usdt = newBal;
            document.getElementById('user-balance').innerText = fmtNum(newBal);

            showToast(`🎉 Daily Login Bonus: +${bonus} USDT!`, 'success');
            localStorage.setItem(lastClaimKey, today);

            // Sync to DB silently
            await supabase.from('profiles').update({ balance_usdt: newBal }).eq('id', currentUser.id);
        }
    }

    function openProfileModal() {
        if(!currentUser) return;
        document.getElementById('pf-nickname').value = userProfile?.nickname || '';
        document.getElementById('pf-avatar-url').value = userProfile?.avatar_url || '';

        let preview = document.getElementById('pf-preview');
        let placeholder = document.getElementById('pf-placeholder');
        if(userProfile?.avatar_url) {
            preview.src = userProfile.avatar_url;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        } else {
            preview.style.display = 'none';
            placeholder.style.display = 'block';
        }
        new bootstrap.Modal(document.getElementById('profileModal')).show();
    }

    // V45 UPGRADE: Real Storage Upload
    async function handleFileUpload(input) {
        if(!input.files || input.files.length === 0) return;
        if(!currentUser) return showToast("Please Login", "error");

        const file = input.files[0];
        const fileExt = file.name.split('.').pop();
        const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;

        let placeholder = document.getElementById('pf-placeholder');
        let loader = document.getElementById('upload-loading');
        loader.style.display = 'flex';

        try {
            const { error: uploadError } = await supabase.storage.from('avatars').upload(fileName, file);
            if(uploadError) throw uploadError;

            const { data: { publicUrl } } = supabase.storage.from('avatars').getPublicUrl(fileName);

            await supabase.from('profiles').update({ avatar_url: publicUrl }).eq('id', currentUser.id);

            document.getElementById('pf-avatar-url').value = publicUrl;
            document.getElementById('pf-preview').src = publicUrl;
            document.getElementById('pf-preview').style.display = 'block';
            placeholder.style.display = 'none';
            loader.style.display = 'none';
            showToast("Avatar updated successfully!", "success");
        } catch (error) {
            showToast("Upload failed: " + error.message, "error");
            loader.style.display = 'none';
        }
    }

    async function saveProfile() {
        const nickname = document.getElementById('pf-nickname').value.trim();
        const avatar_url = document.getElementById('pf-avatar-url').value.trim();
        const btn = document.getElementById('btn-save-profile');
        if(!nickname) return showToast("Nickname required", "error");
        btn.innerText = "SAVING..."; btn.disabled = true;
        const updates = { id: currentUser.id, nickname, avatar_url };
        const { error } = await supabase.from('profiles').upsert(updates);
        btn.innerText = "SAVE CHANGES"; btn.disabled = false;
        if(error) {
            if(error.code === '23505') showToast("Nickname already taken!", "error");
            else showToast(error.message, "error");
        } else {
            fetchUserProfile();
            bootstrap.Modal.getInstance(document.getElementById('profileModal')).hide();
            showToast("Profile Saved!", "success");
        }
    }

    // --- HÀM UPLOAD ẢNH CHUNG (Dùng cho cả Brand & Project) ---
    async function uploadImage(input, previewId, valueId) {
        if (!input.files || input.files.length === 0) return;
        let previewEl = document.getElementById(previewId);
        previewEl.style.opacity = '0.5';

        try {
            const file = input.files[0];
            const fileExt = file.name.split('.').pop();
            const fileName = `img_${Date.now()}_${Math.floor(Math.random()*1000)}.${fileExt}`;
            const { error } = await supabase.storage.from('avatars').upload(fileName, file);
            if (error) throw error;
            const { data } = supabase.storage.from('avatars').getPublicUrl(fileName);
            const publicUrl = data.publicUrl;
            document.getElementById(valueId).value = publicUrl;
            previewEl.src = publicUrl;
            previewEl.style.display = 'block';
            previewEl.style.opacity = '1';
        } catch (e) {
            showToast("Upload Error: " + e.message, "error");
            previewEl.style.opacity = '1';
        }
    }

    function openLoginModal() { resetLoginModal(); new bootstrap.Modal(document.getElementById('loginModal')).show(); }
    function resetLoginModal() { document.getElementById('login-step-1').style.display = 'block'; document.getElementById('login-step-2').style.display = 'none'; document.getElementById('otp-token').value = ''; }

    async function sendOtpCode() {
        const email = document.getElementById('otp-email').value.trim();
        if(!email) return showToast("Please enter email", "error");
        let btn = document.querySelector('#login-step-1 button');
        let oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SENDING...'; btn.disabled = true;
        try {
            const { error } = await supabase.auth.signInWithOtp({ email: email, options: { shouldCreateUser: true } });
            if (error) throw error;
            document.getElementById('login-step-1').style.display = 'none';
            document.getElementById('login-step-2').style.display = 'block';
            setTimeout(() => document.getElementById('otp-token').focus(), 500);
            showToast("OTP Code sent to " + email, "success");
        } catch (e) { showToast("Error sending code: " + e.message, "error"); }
        finally { btn.innerHTML = oldText; btn.disabled = false; }
    }

    async function verifyOtpCode() {
        const email = document.getElementById('otp-email').value.trim();
        const token = document.getElementById('otp-token').value.trim();
        if(!token) return showToast("Enter code", "error");
        let btn = document.querySelector('#login-step-2 button');
        let oldText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFYING...'; btn.disabled = true;
        try {
            const { data, error } = await supabase.auth.verifyOtp({ email, token, type: 'email' });
            if (error) {
                console.log("Retrying with signup type...");
                const { data: data2, error: error2 } = await supabase.auth.verifyOtp({ email, token, type: 'signup' });
                if (error2) throw error;
            }
            window.location.reload();
        } catch (e) { showToast("Invalid Code or Expired.", "error"); btn.innerHTML = oldText; btn.disabled = false; }
    }

    async function handleLogout() { await supabase.auth.signOut(); window.location.reload(); }
    function checkUserAdmin() {
        if(currentUser && ADMIN_EMAILS.includes(currentUser.email)) document.body.classList.add('is-admin');
        else document.body.classList.remove('is-admin');
        renderGrid();
    }

    // --- MAIN ---
    async function loadFromCloud(showLoading = true) {
        if(showLoading) document.getElementById('loading-overlay').style.display = 'flex';
        const { data, error } = await supabase.from('tournaments').select('*');
        if (!error) {
            compList = [];
            data.forEach(row => {
                if(row.id === -1) {
                    siteConfig = row.data || { x:'', tele:'', yt:'', affiliate:{} };
                    if(!siteConfig.affiliate) siteConfig.affiliate = {};
                    renderFooter();
                    renderArsenal(); // V45
                }
                else {
                    let item = row.data || row.Data;
                    if (item) {
                        item.db_id = row.id; item.id = item.db_id;
                        // Backup logic for column mapping
                        if(!item.name && row.name) item.name = row.name;
                        if(!item.contract && row.contract) item.contract = row.contract;
                        compList.push(item);
                    }
                }
            });
            await updateAllPrices();
            if(currentPolyId) updateTerminalData(currentPolyId); else renderGrid();
            renderStats();
        }
        if(showLoading) document.getElementById('loading-overlay').style.display = 'none';
    }

        // --- CẬP NHẬT: PHÂN CHIA 2 HÀNG (CEX & DEX/WEB3) ---
        // --- BƯỚC 4: HÀM HIỂN THỊ DANH SÁCH ĐỘNG (ĐỌC TỪ CONFIG) ---
    function renderArsenal() {
        const container = document.getElementById('arsenal-grid');
        if(!container) return;

        // 1. Reset container
        container.className = '';
        container.innerHTML = '';

        // 2. LẤY DỮ LIỆU TỪ CẤU HÌNH ĐÃ LƯU (Quan trọng!)
        // Nếu chưa có dữ liệu thì dùng mảng rỗng
        let exchanges = siteConfig.arsenal_items || [];

        // 3. Nếu danh sách trống và là Admin -> Hiện nút nhắc nhở thêm sàn
        if(exchanges.length === 0) {
            if(document.body.classList.contains('is-admin')) {
                container.innerHTML = `<div class="col-12 text-center text-sub border border-dashed border-secondary p-3 rounded" onclick="openConfigModal()" style="cursor:pointer; font-size:0.8rem">Admin: Click to Add Trading Platforms</div>`;
            }
            return;
        }

        // 4. Phân loại CEX và DEX
        const listCEX = exchanges.filter(e => e.type === 'EXCHANGE');
        const listDEX = exchanges.filter(e => e.type !== 'EXCHANGE');

        // Hàm hỗ trợ vẽ thẻ
        const generateCards = (list) => {
            let html = '';
            list.forEach(ex => {
                // Chỉ hiện nếu có Link Ref
                if(ex.link) {
                    // Dùng logo mặc định nếu user chưa up logo
                    // (Tạo ảnh placeholder bằng chữ cái đầu của tên sàn)
                    let logoUrl = ex.logo || 'https://placehold.co/50x50/333/999?text=' + ex.name.charAt(0).toUpperCase();

                    html += `
                    <div class="arsenal-card" onclick="trackAffiliateClick('${ex.name}'); window.open('${ex.link}', '_blank'); playSfx('click')">
                        <img src="${logoUrl}" class="ex-logo">
                        <div class="ex-info">
                            <div class="ex-name">${ex.name}</div>
                            <div class="ex-bonus" style="opacity: 0.7; font-weight: normal;">${ex.type}</div>
                        </div>
                    </div>`;
                }
            });
            return html;
        };

        // 5. Render ra HTML
        let cexHtml = generateCards(listCEX);
        let dexHtml = generateCards(listDEX);

        // Hiển thị nhóm CEX
        if (cexHtml) {
            container.innerHTML += `<div class="text-sub small fw-bold mb-2 ps-1 text-uppercase" style="letter-spacing:1px; font-size:0.7rem"><i class="fas fa-building me-2"></i> CENTRALIZED EXCHANGES (CEX)</div>`;
            container.innerHTML += `<div class="arsenal-grid mb-4">${cexHtml}</div>`;
        }

        // Hiển thị nhóm DEX/WEB3
        if (dexHtml) {
            container.innerHTML += `<div class="text-sub small fw-bold mb-2 ps-1 text-uppercase" style="letter-spacing:1px; font-size:0.7rem"><i class="fas fa-wallet me-2"></i> DECENTRALIZED & WEB3</div>`;
            container.innerHTML += `<div class="arsenal-grid mb-2">${dexHtml}</div>`;
        }
    }


    // New Tracking Function
    function trackAffiliateClick(exchangeId) {
        console.log("Tracking Click:", exchangeId);
        // Gửi sự kiện lên GA4 (nếu đã config)
        if(typeof gtag === 'function') {
            gtag('event', 'click_affiliate', {
                'event_category': 'monetization',
                'event_label': exchangeId
            });
        }
    }

        // --- CẬP NHẬT: TỰ ĐỘNG SỬA LINK NẾU THIẾU HTTPS ---
    function renderFooter() {
        const c = document.getElementById('footer-socials-container');
        c.innerHTML = '';

        // Hàm nhỏ giúp kiểm tra và thêm https:// nếu thiếu
        const fixUrl = (url) => {
            if (!url) return '';
            // Nếu chưa có http hoặc https thì tự thêm vào
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                return 'https://' + url;
            }
            return url;
        };

        if(siteConfig.x) c.innerHTML += `<a href="${fixUrl(siteConfig.x)}" target="_blank" class="social-btn"><i class="fab fa-twitter"></i></a>`;
        if(siteConfig.tele) c.innerHTML += `<a href="${fixUrl(siteConfig.tele)}" target="_blank" class="social-btn"><i class="fab fa-telegram-plane"></i></a>`;
        if(siteConfig.yt) c.innerHTML += `<a href="${fixUrl(siteConfig.yt)}" target="_blank" class="social-btn"><i class="fab fa-youtube"></i></a>`;

        // Render Brand Logo (Giữ nguyên phần logo)
        const brandImg = document.getElementById('nav-brand-img');
        const brandText = document.getElementById('nav-brand-text');
        if(brandText) brandText.style.display = 'block';
        if(siteConfig.brandLogo) {
            brandImg.src = siteConfig.brandLogo;
            brandImg.style.display = 'block';
        } else {
            brandImg.style.display = 'none';
        }
    }


                function openConfigModal() {
        // ... (Phần Socials & Logo cũ giữ nguyên) ...
        document.getElementById('cfg-x').value = siteConfig.x || '';
        document.getElementById('cfg-tele').value = siteConfig.tele || '';
        document.getElementById('cfg-yt').value = siteConfig.yt || '';
        document.getElementById('cfg-logo-url').value = siteConfig.brandLogo || '';
        let img = document.getElementById('cfg-logo-preview');
        if(siteConfig.brandLogo) { img.src = siteConfig.brandLogo; img.style.display = 'block'; }
        else { img.style.display = 'none'; }

        // --- LOAD DANH SÁCH SÀN ĐỘNG ---
        // Lấy danh sách từ config, nếu chưa có thì dùng mảng rỗng
        let arsenalList = siteConfig.arsenal_items || [];
        renderArsenalInputs(arsenalList);

        new bootstrap.Modal(document.getElementById('configModal')).show();
    }


                async function saveGlobalConfig() {
        // 1. Quét dữ liệu từ danh sách động
        let arsenalItems = [];
        document.querySelectorAll('.arsenal-item-row').forEach(row => {
            arsenalItems.push({
                name: row.querySelector('.inp-name').value,
                link: row.querySelector('.inp-link').value,
                type: row.querySelector('.inp-type').value,
                logo: row.querySelector('.inp-logo').value
            });
        });

        // 2. Tạo object Config mới
        const newData = {
            x: document.getElementById('cfg-x').value,
            tele: document.getElementById('cfg-tele').value,
            yt: document.getElementById('cfg-yt').value,
            brandLogo: document.getElementById('cfg-logo-url').value,

            // Lưu mảng danh sách sàn vào đây
            arsenal_items: arsenalItems
        };

        // 3. Gửi lên Server
        await supabase.from('tournaments').upsert({ id: -1, name: 'CONFIG', contract: 'CONFIG', data: newData });

        bootstrap.Modal.getInstance(document.getElementById('configModal')).hide();
        loadFromCloud(false);
        showToast("Cấu hình đã lưu!", "success");
    }



    // --- V45 FIX: Card Highlight Logic ---
    function toggleCardHighlight(el) {
        const isAlreadyActive = el.classList.contains('active-card');

        // 1. Reset all cards first
        document.querySelectorAll('.tour-card').forEach(card => {
            card.classList.remove('active-card');
        });
        document.body.classList.remove('has-active-card');

        // 2. Activate clicked card if it wasn't active
        if (!isAlreadyActive) {
            el.classList.add('active-card');
            document.body.classList.add('has-active-card');

            // Scroll to view if needed (smoothly)
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    // Đóng focus khi click ra ngoài khoảng trống
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.tour-card') && document.body.classList.contains('has-active-card')) {
            document.querySelectorAll('.tour-card').forEach(c => c.classList.remove('active-card'));
            document.body.classList.remove('has-active-card');
        }
    });

        /* --- [V46] SMART REFRESH SYSTEM (Anti-Spam) --- */
    let lastRefreshTime = 0;
    const REFRESH_COOLDOWN = 10000; // 10 giây

    // --- [V50] SUPER REFRESH: CÓ CHẾ ĐỘ SILENT ---
    async function handleSmartRefresh(isSilent = false) {
        // 1. Anti-Spam Check
        const now = Date.now();
        // Nếu chạy ngầm (Silent) thì không cần check cooldown gắt gao, cứ cho chạy nếu cần
        // Nhưng nếu User bấm thì phải check để tránh spam nút
        if (!isSilent) {
            const timeLeft = Math.ceil((REFRESH_COOLDOWN - (now - lastRefreshTime)) / 1000);
            if (now - lastRefreshTime < REFRESH_COOLDOWN) {
                showToast(`Please wait ${timeLeft}s!`, "error");
                return;
            }
        }
        lastRefreshTime = now;

        // 2. UI Loading Effect (CHỈ HIỆN KHI USER BẤM)
        const icon = document.querySelector('.fa-sync-alt');
        if (!isSilent) {
            if(icon) icon.classList.add('fa-spin');
            showToast("Syncing data...", "info");
        } else {
            console.log("[System] Auto-refreshing data in background...");
        }

        try {
            // 3. Call Supabase Edge Function
            const { data, error } = await supabase.functions.invoke('refresh-volume');

            if (error) throw error;

            if (data && data.success) {
                // --- INSTANT UPDATE LOGIC ---
                if (data.updatedItems && Array.isArray(data.updatedItems)) {
                    let updateCount = 0;
                    
                    data.updatedItems.forEach(newItem => {
                        let localItem = compList.find(c => c.db_id === newItem.id);
                        if (localItem) {
                            if(newItem.data.real_alpha_volume) localItem.real_alpha_volume = newItem.data.real_alpha_volume;
                            if(newItem.data.real_vol_history) localItem.real_vol_history = newItem.data.real_vol_history;
                            if(newItem.data.last_updated_ts) localItem.last_updated_ts = newItem.data.last_updated_ts;
                            updateCount++;
                        }
                    });

                    // Re-render UI immediately
                    renderGrid();
                    renderStats(); 
                    
                    // CHỈ HIỆN THÔNG BÁO THÀNH CÔNG KHI USER BẤM
                    if (!isSilent) {
                        showToast(`Instantly updated ${updateCount} tokens!`, "success");
                    }
                } else {
                    // Fallback
                    if (!isSilent) showToast(`Success! Reloading...`, "success");
                    await loadFromCloud(false);
                }
            } else {
                throw new Error("Server returned no data.");
            }

        } catch (e) {
            console.error(e);
            // Lỗi thì chỉ hiện nếu User bấm, còn tự động thì thôi (để tránh spam lỗi đỏ lòm)
            if (!isSilent) showToast("System Error: " + e.message, "error");
        } finally {
            if(icon) icon.classList.remove('fa-spin');
        }
    }

    async function updateAllPrices() {
        // Hàm này chỉ chuyên lấy giá (nhẹ)
        for(let c of compList) {
            if(c.contract) {
                
                try {
                    let r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${c.contract}`);
                    let d = await r.json();
                    if(d.pairs && d.pairs.length > 0) c.cachedPrice = d.pairs[0].priceUsd;
                } catch(e) {}
            }
        }
        renderGrid();
    }


            /* --- HÀM VẼ BIỂU ĐỒ V49 (REVERT: TOTAL VOL + MIN TARGET) --- */
    let volHistChart = null;

    function openVolHistory(dbId) {
        let c = compList.find(x => x.db_id == dbId);
        if(!c) return;

        document.getElementById('vh-title').innerText = c.name + " ANALYTICS";
        document.getElementById('vh-subtitle').innerText = "Correlation: Total Vol vs Min Target";

        // 1. LẤY DỮ LIỆU
        let realHistory = c.real_vol_history || [];
        let minHistory = c.history || [];

        let allDates = new Set([
            ...realHistory.map(x => x.date),
            ...minHistory.map(x => x.date)
        ]);

        let isRunning = true;
        if(c.end) {
            let todayStr = new Date().toISOString().split('T')[0];
            if (todayStr > c.end) isRunning = false;
        }

        if (allDates.size === 0 && isRunning) {
            allDates.add(new Date().toISOString().split('T')[0]);
        }

        let sortedDates = Array.from(allDates).sort((a,b) => new Date(a) - new Date(b));

        // --- LỌC BỎ NGÀY SAU KHI KẾT THÚC ---
        if (c.end) {
            sortedDates = sortedDates.filter(d => d <= c.end);
        }


        // Lấy 10 ngày gần nhất
        let recentDates = sortedDates.slice(-10);

        let labels = [];
        let dataReal = [];
        let dataMin = [];
        
        // Lấy ngày hiện tại (YYYY-MM-DD) để so sánh
        let todayStr = new Date().toISOString().split('T')[0];

        recentDates.forEach(date => {
            let parts = date.split('-');
            labels.push(`${parts[2]}/${parts[1]}`);

            // 1. XỬ LÝ TOTAL VOL (CỘT) - VẼ BÌNH THƯỜNG
            let rItem = realHistory.find(x => x.date === date);
            let rVal = rItem ? rItem.vol : 0;
            
            // Nếu là hôm nay mà chưa có trong history thì lấy số Real-time
            if (!rItem && date === todayStr && isRunning) {
                rVal = c.real_alpha_volume || 0;
            }
            dataReal.push(rVal);

            // 2. XỬ LÝ MIN TARGET (ĐƯỜNG) - CẮT NẾU LÀ HÔM NAY
            let mItem = minHistory.find(x => x.date === date);
            let mVal = mItem ? parseFloat(mItem.target) : 0;

            // LOGIC MỚI: 
            // Nếu là ngày hôm nay (date === todayStr) VÀ Giá trị = 0 (Binance chưa cập nhật)
            // Thì đẩy vào 'null'. ChartJS sẽ tự động ngắt nét vẽ tại điểm này.
            if (date === todayStr && mVal === 0) {
                dataMin.push(null); 
            } else {
                dataMin.push(mVal);
            }
        });

        // 3. VẼ CHART
        new bootstrap.Modal(document.getElementById('volHistoryModal')).show();

        const ctx = document.getElementById('volHistoryChart').getContext('2d');
        if (volHistChart) volHistChart.destroy();

        // Màu Gradient Cyberpunk
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(0, 240, 255, 0.6)');
        gradient.addColorStop(1, 'rgba(0, 240, 255, 0.05)');

        volHistChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total Vol',
                        data: dataReal,
                        type: 'bar',
                        backgroundColor: gradient,
                        borderColor: '#00F0FF',
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.5,
                        order: 2,
                        yAxisID: 'y',
                    },
                    {
                        label: 'Min Target',
                        data: dataMin,
                        type: 'line',
                        borderColor: '#F0B90B', // Vàng
                        backgroundColor: '#F0B90B',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#000',
                        pointBorderColor: '#F0B90B',
                        tension: 0.3,
                        order: 1,
                        yAxisID: 'y1',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { grid: { display: false }, ticks: { color: '#848e9c', font: { family: 'Rajdhani', size: 11, weight: 'bold' } } },
                    y: {
                        type: 'linear', display: true, position: 'left',
                        grid: { color: '#2b3139', borderDash: [4, 4] },
                        ticks: { color: '#00F0FF', font: { family: 'Rajdhani', size: 10 }, callback: function(v) { return v>=1000000?(v/1000000).toFixed(1)+'M':(v>=1000?(v/1000).toFixed(0)+'k':v); } }
                    },
                    y1: {
                        type: 'linear', display: true, position: 'right', grid: { display: false },
                        ticks: { color: '#F0B90B', font: { family: 'Rajdhani', size: 10, weight: 'bold' }, callback: function(v) { return v>=1000000?(v/1000000).toFixed(1)+'M':(v>=1000?(v/1000).toFixed(0)+'k':v); } }
                    }
                },
                plugins: {
                    legend: { display: true, labels: { color: '#fff', font: { size: 10 }, boxWidth: 10 } },
                    tooltip: {
                        backgroundColor: 'rgba(22, 26, 30, 0.95)', titleColor: '#fff', bodyColor: '#fff', borderColor: '#333', borderWidth: 1, padding: 10,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                let val = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(context.raw);
                                return ` ${label}: $${val}`;
                            }
                        }
                    }
                }
            }
        });
    }



    /* --- HÀM VẼ GIAO DIỆN LƯỚI THẺ (GRID) - FINAL FIXED V47 --- */
    function renderGrid() {
        const grid = document.getElementById('appGrid');
        if(!grid) return;
        grid.innerHTML = '';

        let displayList = [...compList];
        displayList.sort((a,b) => {
            let posA = (a.orderIndex !== undefined && a.orderIndex !== null) ? a.orderIndex : 9999;
            let posB = (b.orderIndex !== undefined && b.orderIndex !== null) ? b.orderIndex : 9999;
            return posA - posB;
        });

        if(displayList.length === 0) {
            grid.innerHTML = `<div class="col-12 text-center py-5 opacity-25"><i class="fas fa-plus-circle fa-4x mb-3 text-brand"></i><p>Empty List</p></div>`;
            return;
        }

        const isAdmin = document.body.classList.contains('is-admin');
        const btnsSave = document.querySelectorAll('.btn-save-pos');
        btnsSave.forEach(btn => {
            btn.style.display = isAdmin ? 'inline-block' : 'none';
            if(isAdmin && btn.closest('.d-flex')) btn.style.display = 'block';
        });

        displayList.forEach(c => {
            try {
                let status = c.end && new Date() > new Date(c.end + 'T' + (c.endTime||'23:59')) ? 'ended' : 'running';
                let cardClass = status === 'ended' ? 'tour-card ended-card' : 'tour-card';
                let isExpired = false;

                // 1. TIMER (HEADER)
                let timerHtml = '';
                if(c.end) {
                    timerHtml = `<div class="d-flex align-items-center gap-1 mt-1" style="opacity:0.8"><i class="far fa-clock text-sub" style="font-size:0.65rem"></i><span class="text-sub fw-bold smart-timer" style="font-size:0.75rem; letter-spacing:0.5px" data-end="${c.end}" data-time="${c.endTime || '23:59:59'}">${c.end}</span></div>`;
                }

                // 2. REAL VOLUME (FOOTER)
                let realVol = c.real_alpha_volume || 0;
                let realVolDisplay = '---';
                let realVolColor = '#666';

                if(realVol > 0) {
                    realVolDisplay = '$' + new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 }).format(realVol);
                    realVolColor = '#d0aaff';
                }

                // 3. THỜI GIAN CẬP NHẬT
                let lastUpd = c.last_updated_ts || 0;
                let timeAgoStr = 'Pending update...';

                if (lastUpd > 0) {
                    let diffMin = Math.floor((Date.now() - lastUpd) / 60000);
                    if(diffMin < 1) timeAgoStr = 'Just now';
                    else if(diffMin < 60) timeAgoStr = `${diffMin}m ago`;
                    else {
                        let h = Math.floor(diffMin/60);
                        timeAgoStr = `${h}h ago`;
                    }
                }

     // --- SỬA UI: ICON CÓ CHẾ ĐỘ TỰ ĐỘNG TẮT ---
let footerRealVolHtml = `
    <div class="d-flex flex-column" onclick="openVolHistory('${c.db_id}')" style="cursor: pointer;" title="View Chart">
        <div class="stat-lbl text-sub d-flex align-items-center gap-1" style="margin-bottom:2px">
            LIMIT VOL (CEX) 
            
            <i class="fas fa-info-circle text-sub opacity-50 auto-close-tooltip" 
               style="font-size:0.9rem; cursor:pointer; padding: 10px; margin: -5px; outline: none;" 
               data-bs-toggle="tooltip" 
               data-bs-placement="top" 
               data-bs-trigger="hover focus click"
               tabindex="0"
               title="Off-chain Order Book data only. Excludes On-chain Swap (Instant) volume."
               onclick="event.stopPropagation()"></i>
        </div>

        <div class="font-num fw-bold" style="color: ${realVolColor}; font-size: 1.1rem; text-shadow: 0 0 10px rgba(153, 69, 255, 0.25); line-height:1;">
            ${realVolDisplay}
        </div>
        
        <div class="text-sub d-flex align-items-center gap-1" style="font-size: 0.65rem; opacity: 0.7; margin-top: 4px; font-style:italic;">
            <i class="fas fa-history"></i> <span>${timeAgoStr}</span>
        </div>
    </div>
`;

                let isCampaign = (c.inputTokens || []).length > 0;
                let tokenInfoHtml = '', tagHtml = '';
                let priceDisplayHtml = `<div class="stat-lbl">PRICE</div><div class="stat-val text-gold anim-breathe">${fmtNum(c.cachedPrice||0)}</div>`;

             // --- BẮT ĐẦU CODE MỚI ---
                
                // 1. Tính toán trạng thái hết hạn (30 ngày kể từ Listing Time)
                let isListingExpired = false;
                let listingEndTime = 0;

                if (c.listingTime && c.alphaType !== 'none') {
                    // 30 ngày tính bằng milliseconds
                    listingEndTime = new Date(c.listingTime).getTime() + (30 * 24 * 60 * 60 * 1000);
                    // Nếu quá hạn 30 ngày HOẶC giải đấu đã kết thúc -> Coi như Tag hết hạn
                    if (Date.now() > listingEndTime || status === 'ended') {
                        isListingExpired = true;
                    }
                } else {
                    // Nếu không có listing time nhưng giải đã End -> Cũng tính là hết
                    if (status === 'ended') isListingExpired = true;
                }

                // 2. Xử lý hiển thị Tag & Token Info
                if (isCampaign) {
                    let iconsHtml = (c.inputTokens || []).map(t => `<span style="background:#333; color:#fff; border:1px solid #555; padding:1px 4px; border-radius:3px; font-size:0.6rem; margin-right:3px;">${t}</span>`).join('');
                    tokenInfoHtml = `<div style="margin-top:2px;"><span class="text-sub" style="font-size:0.55rem; font-weight:700; text-transform:uppercase;">REQ TRADE:</span><div class="d-inline-flex flex-wrap">${iconsHtml}</div></div>`;
                    tagHtml = `<div class="tag-x2" style="background:#9945FF; color:#fff; border:none; box-shadow:0 0 5px #9945FF">ECOSYSTEM</div>`;
                } else {
                    tokenInfoHtml = `<div class="token-status ${status==='running'?'anim-breathe':''}" style="color:${status==='running'?'var(--accent-green)':'var(--accent-red)'}">${status.toUpperCase()}</div>`;

                    // Logic hiển thị Tag dựa trên biến isListingExpired vừa tính
                    if (!isListingExpired) {
                        // CÒN HẠN: Hiện màu sáng
                        if (c.alphaType === 'x4') tagHtml = `<div class="tag-x4">X4 BSC</div>`;
                        else if (c.alphaType === 'x2') {
                            cardClass += ' highlight-x2'; // Highlight viền xanh
                            tagHtml = `<div class="tag-x2">X2 OTHER</div>`;
                        }
                    } else {
                        // HẾT HẠN (Do quá 30 ngày HOẶC giải ended): Làm mờ
                        if (c.alphaType === 'x4') tagHtml = `<div class="tag-x4 tag-expired">X4 BSC</div>`;
                        else if (c.alphaType === 'x2') tagHtml = `<div class="tag-x2 tag-expired">X2 OTHER</div>`;
                    }
                }

                // 3. Xử lý đồng hồ đếm ngược (x4TimerHtml) - Logic giống hệt Tag
                let x4TimerHtml = `<div class="x4-timer-box" style="visibility:hidden">--</div>`;
                
                if (c.listingTime && c.alphaType !== 'none') {
                    if (isListingExpired) {
                        // Hết hạn -> Hiện chữ ENDED mờ mờ
                        x4TimerHtml = `<div class="x4-timer-box" style="color:#666;border-color:#333;background:transparent;">ENDED</div>`;
                    } else {
                        // Còn hạn -> Hiện đồng hồ đếm ngược
                        x4TimerHtml = `<div class="x4-timer-box"><i class="far fa-clock small"></i> <span class="x4-timer-val" data-list="${c.listingTime}">...</span></div>`;
                    }
                } else if (status === 'ended') {
                    // Trường hợp không có Listing Time nhưng giải đã End
                    x4TimerHtml = `<div class="x4-timer-box" style="color:#666;border-color:#333;background:transparent;">ENDED</div>`;
                }

                // LOGIC MỚI: Highlight thẻ X4 nếu còn hạn và chưa kết thúc
                if (c.alphaType === 'x4' && !isListingExpired && !isCampaign && status === 'running') {
                    cardClass += ' highlight-x4';
                }
                // --- KẾT THÚC CODE MỚI ---
             
                let ruleHtml = c.ruleType === 'trade_x4' ? `<div class="rule-pill rp-x4"><i class="fas fa-bolt text-gold" style="font-size:0.55rem"></i> ALL VOL <span class="x4-box">x4</span></div>` : `<div class="rule-pill rp-buy"><i class="fas fa-arrow-up" style="font-size:0.55rem"></i> ONLY BUY</div>`;
                if(status === 'ended') ruleHtml = ruleHtml.replace('rule-pill', 'rule-pill opacity-50 grayscale');

                let latestCloud = (c.history && c.history.length > 0) ? c.history[c.history.length-1] : null;
                let target = latestCloud ? parseFloat(latestCloud.target) : 0;
                let estVal = (parseFloat(c.rewardQty)||0) * (parseFloat(c.cachedPrice)||0);
                let estHtml = (estVal > 0) ? `<span class="text-green small fw-bold ms-1 anim-breathe">~$${fmt(estVal).replace('$','')}</span>` : '';

                let accListHtml = '';
                let myProgress = (userProfile?.tracker_data && userProfile.tracker_data[c.id]) ? userProfile.tracker_data[c.id] : [];
                accSettings.forEach(acc => {
                    let v = 0;
                    if(myProgress && myProgress.length > 0) {
                        let lastP = myProgress[myProgress.length-1];
                        if(lastP.accsDetail && lastP.accsDetail[acc.id]) v = parseFloat(lastP.accsDetail[acc.id].vol);
                    }
                    let pct = target > 0 ? (v/target)*100 : 0;
                    let color = pct>=100 ? 'var(--accent-green)' : (pct>=50 ? 'var(--accent-yellow)' : acc.color);
                    let rightInfoHtml = (status === 'ended')
                        ? (v >= target && target > 0 ? `<span class="res-badge res-win">WIN</span>` : `<span class="res-badge res-lose">LOSE</span>`)
                        : (target > 0 ? `<span class="acc-gap ${v-target>=0?'gap-pos':'gap-neg'}">(${v-target>=0?'+':''}${fmtNum(v-target)})</span>` : '');

                    accListHtml += `<div class="acc-item"><div class="acc-info"><span style="width:6px;height:6px;border-radius:50%;background:${acc.color};box-shadow:0 0 5px ${acc.color}"></span><span class="text-truncate">${acc.name}</span></div><div style="flex:1; margin:0 10px; position:relative"><div class="acc-bar-bg"><div class="acc-bar-fill" style="width:${Math.min(pct,100)}%; background:${color}; box-shadow:0 0 5px ${color}"></div></div></div><div class="acc-stats"><span class="acc-vol">${fmtNum(v)}</span>${rightInfoHtml}</div></div>`;
                });

                let dragAttr = (isAdmin) ? `draggable="true" ondragstart="drag(event)" ondrop="drop(event)" ondragover="allowDrop(event)"` : '';
                let dragHandleHtml = (isAdmin) ? `<i class="fas fa-grip-vertical admin-drag-handle" title="Kéo để sắp xếp"></i>` : '';

                grid.innerHTML += `
                <div class="col-md-6 col-lg-4 col-xl-3 card-wrapper" ${dragAttr} data-id="${c.db_id}">
                    <div class="${cardClass}" onclick="playSfx('click'); toggleCardHighlight(this)">
                        <div class="card-head">
                            <div class="token-info-wrapper">
                                ${dragHandleHtml}
                                <img src="${c.logo || 'https://placehold.co/40x40/222'}" class="token-logo" onclick="event.stopPropagation(); window.open('https://www.binance.com/en/alpha/${c.chain}/${c.contract}', '_blank')">
                                <div class="token-text">
                                    <div class="token-title">${c.name}</div>
                                    ${tokenInfoHtml}
                                    ${timerHtml}
                                </div>
                            </div>
                            <div class="card-head-right">${ruleHtml}${tagHtml}${x4TimerHtml}</div>
                        </div>
                        <div class="card-stats-grid">
                            <div class="stat-cell"><div class="stat-lbl">TOP</div><div class="stat-val text-main">${c.topWinners||'--'}</div></div>
                            <div class="stat-cell border-start border-end border-secondary border-opacity-25"><div class="stat-lbl">REWARD</div><div class="stat-val text-brand">${fmtNum(c.rewardQty)}${estHtml}</div></div>
                            <div class="stat-cell">${priceDisplayHtml}</div>
                        </div>
                        <div class="card-list">${accListHtml}</div>
                        <div class="card-actions">
                            <button class="btn-card-action action-update" onclick="event.stopPropagation(); openUpdateModal('${c.db_id}')"><i class="fas fa-edit"></i> ${translations[currentLang].btn_update}</button>
                            <button class="btn-card-action predict" onclick="event.stopPropagation(); openPredictionView('${c.db_id}')"><i class="fas fa-bolt"></i> ${translations[currentLang].btn_predict}</button>
                        </div>
                        <div class="card-foot">
                            <div class="real-vol-box">${footerRealVolHtml}</div>
                            <div class="admin-only mx-2"><button class="btn btn-edit-foot" onclick="openEditModal('${c.db_id}')"><i class="fas fa-pencil-alt"></i></button></div>
                            <div class="ms-auto text-end lh-1">
                                <div class="stat-lbl text-brand" style="font-weight:800; letter-spacing:0.5px; opacity:0.9; margin-bottom:2px;">${translations[currentLang].lbl_min_target}</div>
                                <div class="stat-val text-gold anim-breathe" style="font-size: 1.4rem; text-shadow: 0 0 15px rgba(240, 185, 11, 0.4);">${fmtNum(target)}</div>
                            </div>
                        </div>
                </div>`;
            } catch(e) { console.error("Render error", e); }
        });

        // --- ĐOẠN CODE KHỞI TẠO TOOLTIP MỚI (AUTO HIDE) ---
        try {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                // Tạo tooltip
                var tooltip = new bootstrap.Tooltip(tooltipTriggerEl);

                // Nếu là icon Limit Vol (có class auto-close-tooltip) -> Thêm logic tự tắt
                if (tooltipTriggerEl.classList.contains('auto-close-tooltip')) {
                    tooltipTriggerEl.addEventListener('shown.bs.tooltip', function () {
                        // Đặt hẹn giờ 3 giây (3000ms) sau khi hiện thì tự ẩn
                        setTimeout(function () {
                            tooltip.hide();
                        }, 3000);
                    });
                }
                return tooltip;
            });
        } catch (e) { console.error(e); }
    }


    /* --- CÁC HÀM XỬ LÝ DRAG & DROP --- */
    let draggedItem = null;
    function allowDrop(ev) { ev.preventDefault(); }

    function drag(ev) {
        draggedItem = ev.currentTarget;
        ev.dataTransfer.effectAllowed = 'move';
        ev.currentTarget.querySelector('.tour-card').classList.add('dragging');
    }

    function drop(ev) {
        ev.preventDefault();
        if(!draggedItem) return;
        draggedItem.querySelector('.tour-card').classList.remove('dragging');
        let targetItem = ev.target.closest('.card-wrapper');
        if (draggedItem !== targetItem && targetItem) {
            let container = document.getElementById('appGrid');
            let dragIdx = [...container.children].indexOf(draggedItem);
            let dropIdx = [...container.children].indexOf(targetItem);
            if (dragIdx < dropIdx) targetItem.after(draggedItem); else targetItem.before(draggedItem);
            showToast("Vị trí đã đổi! Bấm SAVE POSITION để lưu.", "info");
        }
    }

    // --- HÀM LƯU VỊ TRÍ XUỐNG DB ---
        // --- HÀM LƯU VỊ TRÍ MỚI (ĐÃ SỬA LỖI 2 NÚT) ---
            async function saveCustomOrder() {
        if(!confirm("Lưu vị trí hiện tại?")) return;

        // Hiệu ứng loading cho tất cả nút Save
        let btns = document.querySelectorAll('.btn-save-pos');
        btns.forEach(btn => {
            btn.dataset.oldText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';
            btn.disabled = true;
        });

        try {
            const container = document.getElementById('appGrid');
            const items = container.querySelectorAll('.card-wrapper');
            let updates = [];

            // 1. Cập nhật số thứ tự mới (0, 1, 2...) vào bộ nhớ
            items.forEach((item, index) => {
                let dbId = parseInt(item.getAttribute('data-id'));
                let comp = compList.find(c => c.db_id === dbId);
                if(comp) {
                    comp.orderIndex = index; // Gán vị trí mới
                    updates.push(comp);
                }
            });

            // 2. Lưu từng cái xuống Server
            // Dùng vòng lặp for...of để đợi lưu xong cái này mới lưu cái kia (tránh lỗi đường truyền)
            for (let item of updates) {
                // Tạo bản sao dữ liệu sạch để lưu
                let dataToSave = { ...item };

                // Xóa các biến hệ thống không cần lưu vào cột data
                delete dataToSave.db_id;
                delete dataToSave.id;
                delete dataToSave.cachedPrice;

                // Đảm bảo giữ lại lịch sử và dự đoán
                dataToSave.history = item.history || [];
                dataToSave.predictions = item.predictions || [];

                // Lệnh Update
                await supabase.from('tournaments').update({
                    data: dataToSave
                }).eq('id', item.db_id);
            }

            showToast("Đã lưu vị trí thành công!", "success");

            // 3. Quan trọng: Tải lại dữ liệu từ Server để đồng bộ hiển thị
            await loadFromCloud(false);

        } catch (e) {
            console.error(e);
            showToast("Lỗi khi lưu: " + e.message, "error");
        } finally {
            // Trả lại trạng thái nút ban đầu
            btns.forEach(btn => {
                btn.innerHTML = btn.dataset.oldText || '<i class="fas fa-save me-1"></i> SAVE POSITION';
                btn.disabled = false;
            });
        }
    }

    function switchView(view) {
        document.getElementById('view-dashboard').style.display = view==='dashboard'?'block':'none';
        document.getElementById('view-predict').style.display = view==='predict'?'block':'none';
        if(view==='dashboard') { currentPolyId=null; renderGrid(); }
    }

    function switchTab(t) { document.querySelectorAll('.p-tab').forEach(el=>el.classList.remove('active')); document.getElementById(`tab-${t}`).classList.add('active'); ['chart','activity','chat'].forEach(x => document.getElementById(`content-${x}`).style.display = x===t ? (x==='chat'?'flex':'block') : 'none'); }

        // --- CODE MỚI: LẤY DỮ LIỆU TỪ BẢNG PREDICTIONS ---
    async function openPredictionView(id) {
        currentPolyId = id;

        // 1. Hiện loading
        document.getElementById('loading-overlay').style.display = 'flex';

        // 2. Gọi Server lấy danh sách dự đoán
        const { data: predsData, error } = await supabase
            .from('predictions')
            .select('*')
            .eq('tournament_id', id);

        document.getElementById('loading-overlay').style.display = 'none';

        if (error) {
            alert("Lỗi tải dữ liệu: " + error.message);
            return;
        }

        // 3. Gắn dữ liệu vào
        let c = compList.find(x => x.db_id == id);
        if(c) {
            c.predictions = predsData.map(p => ({
                user_id: p.user_id,
                name: p.user_name,
                avatar: p.user_avatar,
                guess: parseFloat(p.guess),
                time: new Date(p.created_at).getTime()
            }));
        }

        // 4. Chuyển màn hình
        switchView('predict');

        // 5. Vẽ giao diện (Giữ nguyên HTML cũ)
        document.getElementById('predict-content-placeholder').innerHTML = `
        <div class="terminal-layout">
            <div class="terminal-main">
                <div class="hero-header">
                    <div class="hh-left"><img id="pt-logo" src="" title="View on Binance Alpha"><div><h1 class="fw-bold text-white mb-0" id="pt-symbol">---</h1><div class="text-sub fw-bold" style="font-size:0.75rem;letter-spacing:2px;">PREDICTION MARKET</div></div></div>

                    <div class="hh-center">
    <div class="text-brand fw-bold small letter-spacing-1" style="font-size:0.85rem; opacity:0.8">CURRENT MIN VOLUME</div>

    <div class="big-vol" id="pt-min-vol" style="margin-bottom: 5px;">0</div>

    <div id="pt-vol-change" class="mb-4 d-flex align-items-center gap-2" style="font-family: var(--font-num); font-size: 1.1rem;">
        </div>

    <div class="d-flex gap-2">
         <button id="btn-predict-action" class="btn-predict-hero" onclick="openInputModal()"><i class="fas fa-crosshairs me-2"></i>MAKE PREDICTION</button>
         <button class="btn btn-outline-light rounded-pill px-3" onclick="new bootstrap.Modal(document.getElementById('ruleModal')).show()"><i class="fas fa-info-circle"></i> RULES</button>
         <button class="btn btn-dark border-secondary rounded-pill px-3 text-white" onclick="generateShareCard()" title="Share Card"><i class="fas fa-share-alt"></i></button>
    </div>

    <div class="admin-only admin-settle-box mt-3" style="width:100%">
        <label class="text-danger fw-bold small mb-1">TOURNAMENT SETTLEMENT</label>
        <button class="btn btn-danger w-100 fw-bold" onclick="settleTournament()"><i class="fas fa-gavel me-2"></i> AUTO SETTLE & DISTRIBUTE</button>
        <div class="text-sub small mt-1 text-center fst-italic">*System will fetch last Min Volume from History.</div>
    </div>
</div>

                    <div class="hh-right"><div class="text-end"><div class="header-stat-lbl">TIME REMAINING</div><div class="text-gold font-num fw-bold fs-3" id="pt-time">---</div></div><div class="text-end"><div class="header-stat-lbl">TOTAL POOL</div><div class="text-green font-num fw-bold fs-3" id="pt-pool">0 $</div></div></div>
                </div>
                <div class="terminal-card" style="flex:1;">
                    <div class="p-tabs">
                        <div class="p-tab active" onclick="switchTab('chart')" id="tab-chart">CHART</div>
                        <div class="p-tab" onclick="switchTab('activity')" id="tab-activity">ACTIVITY</div>
                        <div class="p-tab" onclick="switchTab('chat')" id="tab-chat">CHAT</div>
                    </div>
                    <div style="flex:1; position:relative; padding:25px; display:flex; flex-direction:column; overflow:hidden;">
                        <div id="content-chart" style="height:100%; width:100%;"><canvas id="marketChart"></canvas></div>

                        <div id="content-activity" class="feed-box" style="display:none; height:100%;"></div>

                        <div id="content-chat" style="display:none; height:100%; flex-direction:column;">
                            <div id="chat-feed" class="feed-box" style="flex:1; overflow-y:auto; margin-bottom:10px;"></div>
                            <div class="d-flex gap-2 align-items-center">
                                <input id="chat-msg" class="form-control rounded-pill" placeholder="Type a message..." style="padding: 10px 20px; background: #222; border: 1px solid #444; color: #fff;" onkeydown="if(event.key==='Enter') sendChat()">
                                <button class="btn btn-icon text-brand border-0 bg-transparent" onclick="sendChat()" style="width: 45px; height: 45px;"><i class="fas fa-paper-plane fa-lg"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="terminal-side"><div class="terminal-card" style="flex:1;"><div class="p-4 border-bottom border-secondary border-opacity-25 bg-panel"><h6 class="fw-bold m-0 text-gold letter-spacing-1">TOP TRADERS</h6></div><div style="flex:1;overflow-y:auto;"><table class="leaderboard-table w-100"><thead>
    <tr>
        <th class="ps-4">RANK</th>
        <th>TRADER</th>
        <th class="text-center">GUESS</th>
        <th class="text-end pe-2">PRIZE</th> </tr>
</thead>
<tbody id="pt-leaderboard"></tbody></table></div></div></div>
        </div>`;

        updateTerminalData(id);
    }

        // --- HÀM CẬP NHẬT DỮ LIỆU CHI TIẾT GIẢI ĐẤU (LOGIC CHUẨN V3) ---
    function updateTerminalData(id) {
        let c = compList.find(x => x.db_id == id); if(!c) return;
        document.getElementById('pt-symbol').innerText = c.name;

        let logoEl = document.getElementById('pt-logo');
        logoEl.src = c.logo;
        logoEl.onclick = function() { window.open(`https://www.binance.com/en/alpha/${c.chain}/${c.contract}`, '_blank'); };
        logoEl.style.cursor = 'pointer';

        let curMin = (c.history && c.history.length>0) ? c.history[c.history.length-1].target : 0;
        document.getElementById('pt-min-vol').innerText = fmtNum(curMin);

        // --- TÍNH TĂNG TRƯỞNG ---
        let changeHtml = '';
        if (c.history && c.history.length >= 2) {
            let todayVal = parseFloat(c.history[c.history.length - 1].target);
            let yestVal = parseFloat(c.history[c.history.length - 2].target);
            let diff = todayVal - yestVal;
            let pct = yestVal > 0 ? ((diff / yestVal) * 100).toFixed(2) : 0;
            let colorClass = diff >= 0 ? 'text-green' : 'text-red';
            let icon = diff >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';
            let sign = diff >= 0 ? '+' : '';
            let bgStyle = diff >= 0 ? 'rgba(14, 203, 129, 0.08)' : 'rgba(246, 70, 93, 0.08)';
            let borderStyle = diff >= 0 ? '#0ECB81' : '#F6465D';
            changeHtml = `<div title="Yesterday Volume: ${fmtNum(yestVal)}" class="${colorClass} fw-bold d-flex align-items-center justify-content-center" style="cursor: help; background: ${bgStyle}; padding: 5px 20px; border-radius: 50px; border: 1px solid ${borderStyle}; font-size: 0.95rem; min-width: 140px; transition: all 0.2s;"><i class="fas ${icon} me-2" style="font-size: 0.8rem;"></i>${sign}${fmtNum(diff)} (${sign}${pct}%)</div>`;
        }
        let changeEl = document.getElementById('pt-vol-change');
        if(changeEl) { changeEl.innerHTML = changeHtml; changeEl.className = "mb-4 d-flex justify-content-center"; }

        // --- XỬ LÝ TRẠNG THÁI GIẢI (ENDED/RUNNING) ---
        let isEnded = false;
        if(c.end) {
            let endTime = new Date(c.end + 'T' + (c.endTime || '23:59:59')).getTime();
            let dist = endTime - Date.now();
            if(dist > 0) {
                let d = Math.floor(dist / (1000 * 60 * 60 * 24));
                let h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                document.getElementById('pt-time').innerText = `${d}d ${h}h`;
            } else {
                document.getElementById('pt-time').innerText = 'Ended';
                isEnded = true;
            }
        }

        let btn = document.getElementById('btn-predict-action');
        if(isEnded) {
            btn.innerHTML = '<i class="fas fa-trophy me-2"></i> EVENT ENDED - VIEW WINNERS';
            btn.className = 'btn-predict-hero btn-ended';
            btn.onclick = null;
        } else {
            btn.innerHTML = '<i class="fas fa-crosshairs me-2"></i>MAKE PREDICTION';
            btn.className = 'btn-predict-hero';
            btn.onclick = openInputModal;
        }

        let totalPool = (c.predictions?.length || 0) * PREDICT_FEE;
        document.getElementById('pt-pool').innerText = fmt(totalPool);

        // --- VẼ BIỂU ĐỒ ---
        if(document.getElementById('content-chart').style.display !== 'none' || !marketChart) {
            let ctx = document.getElementById('marketChart').getContext('2d'); if(marketChart) marketChart.destroy();
            let labels=[], data=[]; if(c.history) c.history.forEach(h=>{ labels.push(h.date.substring(5)); data.push(h.target); });
            marketChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Min Vol', data, borderColor: '#00F0FF', backgroundColor: 'rgba(0,240,255,0.1)', fill: true, tension: 0.3 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { x:{display:false}, y:{grid:{color:'#222'}} }, plugins:{legend:{display:false}} } });
        }

        // --- [CODE MỚI V3] BẢNG XẾP HẠNG: LỌC MIN VOL & FIX UI ---
        let lb = document.getElementById('pt-leaderboard');
        lb.innerHTML = '';

        // Nhóm A: Hợp lệ (>= Min Vol) -> Xếp tăng dần
        let validPreds = (c.predictions || []).filter(p => p.guess >= curMin).sort((a,b) => a.guess - b.guess);
        // Nhóm B: Không hợp lệ (< Min Vol) -> Xếp giảm dần
        let invalidPreds = (c.predictions || []).filter(p => p.guess < curMin).sort((a,b) => b.guess - a.guess);
        // Gộp lại: Nhóm A luôn nằm trên
        let preds = [...validPreds, ...invalidPreds];

        preds.forEach((p, i) => {
            let rank = i + 1;
            let prizeAmount = 0;
            let rankIcon = '';
            let rowClass = '';
            let isValidWinner = p.guess >= curMin;

            if(rank === 1 && isValidWinner) {
                prizeAmount = totalPool * 0.50;
                rankIcon = isEnded ? `<i class="fas fa-trophy text-gold fa-lg"></i>` : `<span class="rank-badge" style="background:#F0B90B; color:#000; box-shadow:0 0 10px rgba(240,185,11,0.5)">#1</span>`;
                if(isEnded) rowClass = 'style="background: rgba(240, 185, 11, 0.1); border: 1px solid rgba(240, 185, 11, 0.3)"';
            } else if (rank === 2 && isValidWinner) {
                prizeAmount = totalPool * 0.30;
                rankIcon = isEnded ? `<i class="fas fa-medal text-silver fa-lg"></i>` : `<span class="rank-badge" style="background:#C0C0C0; color:#000">#2</span>`;
            } else if (rank === 3 && isValidWinner) {
                prizeAmount = totalPool * 0.20;
                rankIcon = isEnded ? `<i class="fas fa-medal text-bronze fa-lg"></i>` : `<span class="rank-badge" style="background:#CD7F32; color:#000">#3</span>`;
            } else {
                rankIcon = `<span class="rank-badge" style="background:#333; color:#777">#${rank}</span>`;
            }

            let prizeDisplay = '<span class="text-sub opacity-25 font-num">--</span>';
            if (prizeAmount > 0) {
                if(isEnded) {
                    prizeDisplay = `<span class="text-green font-num fw-bold" style="font-size:0.9rem; text-shadow: 0 0 10px rgba(14, 203, 129, 0.4); white-space: nowrap;">+${fmt(prizeAmount)}</span>`;
                } else {
                    prizeDisplay = `<div class="d-flex flex-column align-items-end" style="line-height:1.1"><span class="text-green font-num fw-bold opacity-75">${fmt(prizeAmount)}</span><span class="text-sub" style="font-size:0.6rem; font-weight:700">Est.</span></div>`;
                }
            }

            let avatarHtml = p.avatar ? `<img src="${p.avatar}" class="list-avatar">` : `<div class="list-avatar-placeholder">${p.name.substring(0,1).toUpperCase()}</div>`;
            let myName = document.getElementById('modal-p-name').value;
            if(p.name === myName && !rowClass) rowClass = 'style="background: rgba(0, 240, 255, 0.05); border-left: 2px solid var(--brand)"';
            if (!isValidWinner) rowClass = 'style="opacity: 0.5"';

            lb.innerHTML += `
            <tr ${rowClass}>
                <td class="ps-4 align-middle">${rankIcon}</td>
                <td class="align-middle"><div class="d-flex align-items-center">${avatarHtml}<span class="fw-bold text-white">${p.name}</span></div></td>
                <td class="text-center align-middle text-brand font-num fw-bold">${fmtNum(p.guess)}</td>
                <td class="text-end pe-2 align-middle">${prizeDisplay}</td>
            </tr>`;
        });

        // --- XỬ LÝ HOẠT ĐỘNG & CHAT ---
        let actDiv = document.getElementById('content-activity'); actDiv.innerHTML = '';
        (c.predictions || []).sort((a,b)=>b.time-a.time).forEach(p => {
            let avatarHtml = p.avatar ? `<img src="${p.avatar}" class="act-avatar">` : `<i class="fas fa-bolt text-gold me-3 fa-lg"></i>`;
            actDiv.innerHTML += `<div class="act-item d-flex align-items-center mb-2">${avatarHtml}<div><span class="text-white fw-bold">${p.name}</span> predicted <span class="text-brand font-num">${fmtNum(p.guess)}</span> <div class="text-sub small">${new Date(p.time).toLocaleTimeString()}</div></div></div>`;
        });

        let chatDiv = document.getElementById('chat-feed'); chatDiv.innerHTML = '';
        (c.comments || []).sort((a,b)=>a.time-b.time).forEach(m => {
            let isMe = m.user === (userProfile?.nickname || currentUser?.email.split('@')[0]);
            let avatarHtml = m.avatar ? `<img src="${m.avatar}" class="chat-avatar">` : `<div class="chat-avatar-placeholder">${m.user.substring(0,1).toUpperCase()}</div>`;
            let cleanText = DOMPurify.sanitize(m.text);
            chatDiv.innerHTML += `<div class="chat-row ${isMe ? 'me' : ''}">${avatarHtml}<div class="chat-bubble ${isMe ? 'chat-me' : 'chat-other'}"><div class="small fw-bold mb-1 ${isMe ? 'text-end text-brand' : 'text-sub'}">${m.user}</div>${cleanText}</div></div>`;
        });
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }

    function openInputModal() {
        let c = compList.find(x => x.db_id == currentPolyId);

        // CHECK LOCK TIME (6 hours before end)
        if(c.end) {
            let endTime = new Date(c.end + 'T' + (c.endTime || '23:59:59')).getTime();
            let lockTime = endTime - (6 * 3600 * 1000);

            if(Date.now() > endTime) return showToast("Tournament has ENDED!", "error");
            if(Date.now() > lockTime) return showToast("Prediction Gate CLOSED (6 hours before end).", "error");
        }

        if(!currentUser) { showToast("Please login to predict!", "error"); return; }

        // CHECK BALANCE
        if((userProfile.balance_usdt || 0) < PREDICT_FEE) {
            return showToast(`Insufficient Balance! You need ${PREDICT_FEE} USDT.`, "error");
        }

        let displayName = userProfile?.nickname || currentUser.email.split('@')[0];
        document.getElementById('modal-p-name').value = displayName;
        document.getElementById('modal-p-name').disabled = true;
        document.getElementById('modal-p-guess').placeholder = `Fee: ${PREDICT_FEE} USDT`;

        new bootstrap.Modal(document.getElementById('inputModal')).show();
    }

    async function submitPredictionFromModal() {
    let nameInput = document.getElementById('modal-p-name');
    let guessInput = document.getElementById('modal-p-guess');

    let name = nameInput.value.trim();
    let guess = parseFloat(guessInput.value);

    if(!currentUser) return showToast("Please Login to predict!", "error");
    if(!name) return showToast("Nickname required", "error");
    if(isNaN(guess) || guess < 0) return showToast("Invalid Prediction Volume", "error");

    let btn = document.querySelector('#inputModal .btn-action');
    let oldText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> PROCESSING...';
    btn.disabled = true;

    try {
        const { data, error } = await supabase.rpc('submit_prediction_action', {
            p_tourn_id: parseInt(currentPolyId),
            p_guess: guess,
            p_name: name,
            p_avatar: userProfile?.avatar_url || ''
        });

        if (error) throw error;
        if (data && data.status === 'error') throw new Error(data.message);

        // Update Balance UI
        if(data && data.new_balance !== undefined) {
            userProfile.balance_usdt = data.new_balance;
            document.getElementById('user-balance').innerText = fmtNum(data.new_balance);
        }

        showToast(`🚀 ENTRY CONFIRMED! (-${PREDICT_FEE} USDT)`, "success");
        playSfx('click');

        bootstrap.Modal.getInstance(document.getElementById('inputModal')).hide();

        // --- KHÚC QUAN TRỌNG: CẬP NHẬT MƯỢT MÀ ---

        // 1. Cập nhật lại số tiền tổng bên ngoài (không ảnh hưởng giao diện)
        renderStats();

        // 2. Cập nhật bảng xếp hạng MƯỢT (Không load lại cả khung)
        if(currentPolyId) await silentReload(currentPolyId);

        // 3. Hiện bảng khoe thành tích
        setTimeout(() => {
             generateShareCard(guess);
        }, 800);

    } catch (e) {
        console.error(e);
        showToast("Error: " + e.message, "error");
        playSfx('hover');
    } finally {
        btn.innerHTML = oldText;
        btn.disabled = false;
    }
}


    // V45 VIRAL LOOP: GENERATE SHARE CARD
    function generateShareCard(userGuess = null) {
        let c = compList.find(x => x.db_id == currentPolyId);
        if(!c) return;

        // 1. Fill Token Data
        document.getElementById('sc-token-name').innerText = c.name;

        // 2. Fill User Data (V45 Update)
        let uName = userProfile?.nickname || "Trader";
        // Sử dụng UI Avatars nếu user chưa có ảnh (fallback đẹp)
        let uAvatar = userProfile?.avatar_url || `https://ui-avatars.com/api/?name=${uName}&background=random&color=fff&size=128`;

        document.getElementById('sc-user-name').innerText = uName;

        // Handle Avatar Image (CORS Safe)
        let uaEl = document.getElementById('sc-user-avatar');
        uaEl.crossOrigin = "anonymous";
        uaEl.src = uAvatar + (uAvatar.includes('?')?'&':'?') + 't=' + new Date().getTime();
        uaEl.onerror = function(){ this.src = 'https://placehold.co/50/333/fff?text=' + uName.charAt(0); }; // Fail-safe

        // Date Format
        const now = new Date();
        const dateStr = now.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' }).toUpperCase();
        const timeStr = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        document.getElementById('sc-date-display').innerText = `${dateStr} | ${timeStr}`;

        // FIX CORS: Thêm timestamp để tránh cache và set crossOrigin
        let imgEl = document.getElementById('sc-token-img');
        imgEl.crossOrigin = "anonymous";
        imgEl.src = c.logo + (c.logo.includes('?') ? '&' : '?') + 't=' + new Date().getTime();

        // Fallback nếu ảnh lỗi thì hiện avatar chữ cái (tránh bị đen sì)
        imgEl.onerror = function() {
            this.style.display = 'none'; // Ẩn ảnh lỗi
            // Có thể thêm logic hiện avatar chữ ở đây nếu muốn kỹ hơn
        };
        imgEl.onload = function() {
            this.style.display = 'block';
        };

        let curMin = (c.history && c.history.length>0) ? c.history[c.history.length-1].target : 0;
        document.getElementById('sc-min-vol').innerText = fmtNum(curMin);

        // If userGuess passed, use it. Else try to find from user predictions
        if(!userGuess && currentUser && c.predictions) {
            let myP = c.predictions.find(p => p.user_id === currentUser.id);
            if(myP) userGuess = myP.guess;
        }
        document.getElementById('sc-my-guess').innerText = userGuess ? fmtNum(userGuess) : '---';

        // 2. Generate QR Code
        let qrBox = document.getElementById('sc-qr-target');
        qrBox.innerHTML = '';
        let link = siteConfig.affiliate?.binance || window.location.href;
        new QRCode(qrBox, { text: link, width: 50, height: 50 });

        // 3. Show Modal
        new bootstrap.Modal(document.getElementById('shareCardModal')).show();
    }

    // --- V45 NEW: SMART SOCIAL SHARE WITH IMAGE ---
    async function shareImageSmart(platform) {
        const element = document.getElementById('share-card-container');
        let c = compList.find(x => x.db_id == currentPolyId);
        let guess = document.getElementById('sc-my-guess').innerText;
        let webUrl = "https://wave-alpha.netlify.app";

        let text = "";
        if (platform === 'x') {
            text = `🚀 I predicted $${c.name} Min Volume: ${guess} on Wave Alpha!\n\nCan you beat me? 👇\n${webUrl}\n\n#WaveAlpha #Crypto #Trading`;
        } else {
            text = `🔥 I predict $${c.name} Min Volume: ${guess}!\nJoin Wave Alpha Terminal here: ${webUrl}`;
        }

        try {
            showToast("Generating image...", "info");

            // 1. Capture Image
            const canvas = await html2canvas(element, {
                backgroundColor: '#161a1e', scale: 2, useCORS: true, allowTaint: true, logging: false
            });
            const blob = await new Promise(resolve => canvas.toBlob(resolve));
            const file = new File([blob], "WaveAlpha-Prediction.png", { type: "image/png" });

            // 2. Try Native Share (Mobile - Best Experience)
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    title: 'Wave Alpha Prediction',
                    text: text,
                    files: [file]
                });
                showToast("Shared successfully!", "success");
            } else {
                // 3. Fallback: Download + Open Link (Desktop)
                // Browser cannot auto-attach image to X/Tele web, so we download it for user
                const link = document.createElement('a');
                link.download = 'WaveAlpha-Prediction.png';
                link.href = canvas.toDataURL('image/png');
                link.click();

                showToast("Image Saved! Please attach it to your post.", "success");

                setTimeout(() => {
                    let shareUrl = "";
                    if (platform === 'x') {
                        let hashtags = `WaveAlpha,Crypto,${c.name}`;
                        shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
                    } else {
                        shareUrl = `https://t.me/share/url?url=${encodeURIComponent(webUrl)}&text=${encodeURIComponent(text)}`;
                    }
                    window.open(shareUrl, '_blank');
                }, 1000);
            }

        } catch (e) {
            console.error(e);
            showToast("Share failed: " + e.message, "error");
        }
    }

    // Map old functions to new Smart Logic
    function shareToX() { shareImageSmart('x'); }
    function shareToTele() { shareImageSmart('tele'); }

    function downloadShareCard() {
        let element = document.getElementById('share-card-container');

        // FIX: Cấu hình html2canvas chuẩn để bắt được ảnh và style
        html2canvas(element, {
            backgroundColor: '#161a1e', // Đặt màu nền cứng để tránh trong suốt/mất chữ
            scale: 2, // Tăng độ nét
            useCORS: true, // Quan trọng: Cho phép tải ảnh từ domain khác
            allowTaint: true, // Cho phép "vấy bẩn" canvas (giúp render ảnh khó tính)
            logging: false
        }).then(canvas => {
            let link = document.createElement('a');
            link.download = 'WaveAlpha-Prediction.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        });
    }

    function sendChat() {
        if(!currentUser) return showToast("Please login to chat!", "error");
        let txt = document.getElementById('chat-msg').value;
        if(!txt) return;
        let c = compList.find(x => x.db_id == currentPolyId);
        if(!c.comments) c.comments = [];

        let displayName = userProfile?.nickname || currentUser.email.split('@')[0];
        c.comments.push({
            user: displayName,
            text: txt,
            time: Date.now(),
            avatar: userProfile?.avatar_url || ''
        });

        let obj = {...c}; delete obj.db_id;
        const payload = {
            name: obj.name || c.name,
            contract: obj.contract || c.contract,
            data: obj
        };

        supabase.from('tournaments').update(payload).eq('id', currentPolyId).then(() => {
            loadFromCloud(false);
        });
        document.getElementById('chat-msg').value = '';
    }

    async function saveToCloud(compObj) {
        document.getElementById('loading-overlay').style.display = 'flex';
        let cloudObj = {...compObj}; delete cloudObj.myProgress;

        const payload = {
            name: cloudObj.name,
            contract: cloudObj.contract,
            data: cloudObj
        };

        if (cloudObj.db_id) await supabase.from('tournaments').update(payload).eq('id', cloudObj.db_id);
        else { if(payload.data.db_id) delete payload.data.db_id; await supabase.from('tournaments').insert([payload]); }
        document.getElementById('loading-overlay').style.display = 'none'; loadFromCloud(false);
    }

    // --- MODAL UPDATES (TRACKING & HISTORY) ---
    function openUpdateModal(dbId) {
        let c=compList.find(x=>x.db_id==dbId); if(!c)return;
        document.getElementById('u-db-id').value=dbId; document.getElementById('u-symbol-display').innerText=c.name;
        let today=new Date().toISOString().split('T')[0];
        document.getElementById('u-original-date').value = "";
        document.getElementById('u-date').value=today;

        let min=document.getElementById('u-min-vol');
        if(document.body.classList.contains('is-admin')){ min.disabled=false; min.placeholder="Admin Edit"; } else { min.disabled=true; min.placeholder="---"; }
        let html='';
        accSettings.forEach(acc=>{
            html+=`<div class="acc-input-row" id="row-${acc.id}"><span style="color:${acc.color}; font-weight:700;">${acc.name}</span><input type="number" class="form-control font-num text-center text-brand" id="u-vol-${acc.id}" placeholder="Volume" oninput="calcRowGap('${acc.id}')"><div class="d-flex align-items-center gap-2"><span class="font-num fw-bold text-sub small" id="gap-display-${acc.id}" style="width:70px; text-align:right;">---</span><input type="number" class="form-control font-num text-end text-danger" id="u-cost-${acc.id}" placeholder="Cost ($)" style="max-width:80px"></div></div>`;
        });
        document.getElementById('u-acc-inputs').innerHTML=html; loadDateData(today); document.getElementById('u-date').onchange=function(){loadDateData(this.value)}; new bootstrap.Modal(document.getElementById('updateModal')).show();
    }

    function calcRowGap(accId) {
        let minInput = document.getElementById('u-min-vol').value.replace(/,/g, '');
        let min = parseFloat(minInput) || 0;
        let vol = parseFloat(document.getElementById(`u-vol-${accId}`).value) || 0;
        let gap = vol - min;
        let el = document.getElementById(`gap-display-${accId}`);
        if(min > 0) { el.innerText = (gap>=0 ? '+' : '') + fmtNum(gap); el.className = `font-num fw-bold small ${gap>=0?'text-green':'text-red'}`; } else { el.innerText = '---'; }
    }

    // V43 UPGRADE: USE TRACKER_DATA FROM CLOUD
    function loadDateData(d) {
        let id=document.getElementById('u-db-id').value; let c=compList.find(x=>x.id==id);
        let min=0;
        if(c.history){let e=c.history.find(h=>h.date===d); if(e)min=e.target; else if(c.history.length>0)min=c.history[c.history.length-1].target;}
        let minInput = document.getElementById('u-min-vol');
        minInput.value=fmtNum(min).replace(/\./g, '');
        formatCurrency(minInput);

        accSettings.forEach(acc=>{ document.getElementById(`u-vol-${acc.id}`).value=''; document.getElementById(`u-cost-${acc.id}`).value=''; calcRowGap(acc.id); });

        // GET DATA FROM USER PROFILE INSTEAD OF LOCAL C.MYPROGRESS
        let myProgress = (userProfile?.tracker_data && userProfile.tracker_data[id]) ? userProfile.tracker_data[id] : [];

        if(myProgress){
            let p = myProgress.find(x => x.date === d);
            if(p && p.accsDetail){
                accSettings.forEach(acc=>{
                    if(p.accsDetail[acc.id]){
                        document.getElementById(`u-vol-${acc.id}`).value=p.accsDetail[acc.id].vol;
                        document.getElementById(`u-cost-${acc.id}`).value=p.accsDetail[acc.id].cost;
                        calcRowGap(acc.id);
                    }
                })
            }
        }
        renderTrackerChart(c); renderHistoryList(c);
    }

    function loadHistoryToEdit(date) {
        document.getElementById('u-date').value = date;
        document.getElementById('u-original-date').value = date;
        loadDateData(date);
        document.getElementById('u-date').focus();
    }

    function renderTrackerChart(c) {
        const ctx = document.getElementById('trackerChart').getContext('2d');
        if(trackerChart) trackerChart.destroy();

        let labels=[], minData=[], dates=new Set();
        if(c.history) c.history.forEach(x => dates.add(x.date));

        // GET DATA FROM USER PROFILE
        let myProgress = (userProfile?.tracker_data && userProfile.tracker_data[c.id]) ? userProfile.tracker_data[c.id] : [];
        if(myProgress) myProgress.forEach(x => dates.add(x.date));

        let sortedDates = Array.from(dates).sort();

        minData = sortedDates.map(d => {
            let h = c.history ? c.history.find(x => x.date === d) : null;
            return h ? h.target : 0;
        });

        let datasets = [{
            label: 'Target (Min)',
            data: minData,
            borderColor: '#F0B90B',
            borderDash: [6, 4],
            borderWidth: 2,
            pointRadius: 0,
            tension: 0,
            fill: false,
            order: 0
        }];

        accSettings.forEach(acc => {
            let accData = [];
            sortedDates.forEach(d => {
                let p = myProgress ? myProgress.find(x => x.date === d) : null;
                let vol = (p && p.accsDetail && p.accsDetail[acc.id]) ? parseFloat(p.accsDetail[acc.id].vol) : 0;
                accData.push(vol);
            });

            datasets.push({
                label: acc.name,
                data: accData,
                borderColor: acc.color,
                backgroundColor: acc.color,
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: (ctx) => {
                    let idx = ctx.dataIndex;
                    let val = ctx.raw;
                    let target = minData[idx] || 0;
                    return val >= target ? '#0ECB81' : '#F6465D';
                },
                pointBorderColor: '#fff',
            });
        });

        trackerChart = new Chart(ctx, {
            type: 'line',
            data: { labels: sortedDates.map(d => d.substring(5)), datasets: datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { labels: { color: '#aaa', boxWidth: 10, font: {size: 10} } },
                    tooltip: {
                        enabled: true, backgroundColor: 'rgba(22, 26, 30, 0.95)', titleColor: '#00F0FF',
                        titleFont: { family: 'Rajdhani', size: 14, weight: 'bold' },
                        bodyColor: '#fff', bodyFont: { family: 'Rajdhani', size: 13 },
                        borderColor: '#333', borderWidth: 1, padding: 10, displayColors: true, boxPadding: 4,
                        callbacks: { label: function(context) { let label = context.dataset.label || ''; if (label) { label += ': '; } if (context.parsed.y !== null) { label += new Intl.NumberFormat('en-US').format(context.parsed.y); } return label; } }
                    }
                },
                scales: { x: { display: true, ticks: { color: '#555', font:{size:9} }, grid: {display:false} }, y: { display: false } }
            }
        });
    }

    function renderHistoryList(c) {
        let headerHtml = `<th class="text-sub small">Date</th><th class="text-gold small">Target</th>`;
        accSettings.forEach(acc => { headerHtml += `<th class="small text-center" style="color:${acc.color}">${acc.name}</th>`; });
        headerHtml += `<th class="text-end small">Action</th>`;
        document.getElementById('historyHeader').innerHTML = headerHtml;

        const l=document.getElementById('historyList'); l.innerHTML='';
        let dates=new Set();
        if(c.history)c.history.forEach(h=>dates.add(h.date));

        // GET DATA FROM USER PROFILE
        let myProgress = (userProfile?.tracker_data && userProfile.tracker_data[c.id]) ? userProfile.tracker_data[c.id] : [];
        if(myProgress) myProgress.forEach(p => dates.add(p.date));

        Array.from(dates).sort().reverse().forEach(d=>{
            let h=c.history?c.history.find(x=>x.date===d):null;
            let p=myProgress?myProgress.find(x=>x.date===d):null;
            let min=h?h.target:0;

            let accCells = '';
            accSettings.forEach(acc => {
                let vol = (p && p.accsDetail && p.accsDetail[acc.id]) ? parseFloat(p.accsDetail[acc.id].vol) : 0;
                let cls = vol >= min && min > 0 ? 'text-green fw-bold' : (vol > 0 ? 'text-white' : 'text-sub opacity-50');
                accCells += `<td class="text-center font-num ${cls}">${vol > 0 ? fmtNum(vol) : '-'}</td>`;
            });

            l.innerHTML+=`<tr>
                <td class="font-num">${d.substring(5)}</td>
                <td class="text-gold font-num fw-bold">${fmtNum(min)}</td>
                ${accCells}
                <td class="text-end">
                    <i class="fas fa-pencil-alt text-secondary me-3 cursor-pointer" onclick="loadHistoryToEdit('${d}')" title="Edit / Move Date"></i>
                    <i class="fas fa-trash text-danger cursor-pointer" onclick="deleteHistory('${d}')" title="Delete"></i>
                </td>
            </tr>`;
        });
    }

    async function deleteHistory(date) {
        if(!confirm("Delete history for " + date + "?")) return;
        let id = document.getElementById('u-db-id').value;
        let c = compList.find(x => x.id == id);

        // V43: DELETE FROM CLOUD TRACKER DATA
        if(userProfile.tracker_data && userProfile.tracker_data[id]) {
            userProfile.tracker_data[id] = userProfile.tracker_data[id].filter(p => p.date !== date);
            // Save to Cloud immediately
            await supabase.from('profiles').update({ tracker_data: userProfile.tracker_data }).eq('id', currentUser.id);
        }

        if(document.body.classList.contains('is-admin')) {
             if(c.history) {
                 c.history = c.history.filter(h => h.date !== date);
                 await saveToCloud(c);
             }
        } else {
            renderTrackerChart(c);
            renderHistoryList(c);
        }
        if(document.getElementById('u-date').value === date) {
             document.getElementById('u-date').value = new Date().toISOString().split('T')[0];
             loadDateData(document.getElementById('u-date').value);
        } else {
             loadDateData(document.getElementById('u-date').value);
        }
    }

    // V43: SAVE UPDATE TO CLOUD (PROFILES TABLE)
    async function saveUpdate(){
        if(!currentUser) return showToast("Please Login to save progress!", "error");

        let id = document.getElementById('u-db-id').value;
        let c = compList.find(x => x.id == id);
        let date = document.getElementById('u-date').value;
        let originalDate = document.getElementById('u-original-date').value;

        let my = {};
        accSettings.forEach(acc=>{
            my[acc.id] = {
                vol: parseFloat(document.getElementById(`u-vol-${acc.id}`).value) || 0,
                cost: parseFloat(document.getElementById(`u-cost-${acc.id}`).value) || 0
            }
        });

        // Initialize tracker_data if null
        if(!userProfile.tracker_data) userProfile.tracker_data = {};
        if(!userProfile.tracker_data[id]) userProfile.tracker_data[id] = [];

        let currentProg = userProfile.tracker_data[id];

        // Remove old entry if editing existing date
        if(originalDate && originalDate !== date) {
            currentProg = currentProg.filter(p => p.date !== originalDate);
        }
        currentProg = currentProg.filter(p => p.date !== date);

        // Add new entry
        currentProg.push({date: date, accsDetail: my});
        currentProg.sort((a,b) => new Date(a.date) - new Date(b.date));

        // Assign back
        userProfile.tracker_data[id] = currentProg;

        // SAVE TO CLOUD
        let btn = document.getElementById('btn-save-progress');
        let orgText = btn.innerText;
        btn.innerText = "SAVING..."; btn.disabled = true;

        await supabase.from('profiles').update({ tracker_data: userProfile.tracker_data }).eq('id', currentUser.id);

        if(document.body.classList.contains('is-admin')){
            let minValStr = document.getElementById('u-min-vol').value.replace(/,/g, '');
            let t = parseFloat(minValStr) || 0;
            if(!c.history) c.history = [];
            c.history = c.history.filter(h => h.date !== date);
            c.history.push({date: date, target: t});
            c.history.sort((a,b) => new Date(a.date) - new Date(b.date));
            saveToCloud(c);
        }

        btn.innerText = "SAVED!";
        btn.style.background = "#0ECB81";
        btn.disabled = false;
        showToast("Tracking Data Saved!", "success");
        setTimeout(() => {
            btn.innerText = orgText;
            btn.style.background = "";
            renderTrackerChart(c);
            renderHistoryList(c);
        }, 1000);
    }

    // ADMIN: AUTOMATED SETTLE REWARDS (V45 SECURITY UPGRADE)
    async function settleTournament() {
        if(!confirm("CONFIRM: End tournament and distribute rewards automatically (Server-side)?")) return;

        let c = compList.find(x => x.db_id == currentPolyId);

        document.getElementById('loading-overlay').style.display = 'flex';

        // CALL RPC FUNCTION INSTEAD OF JS LOGIC
        const { data, error } = await supabase.rpc('settle_tournament', { tourn_id: parseInt(currentPolyId) });

        document.getElementById('loading-overlay').style.display = 'none';

        if(error) {
            console.error(error);
            showToast("Settlement Failed: " + error.message, "error");
        } else if (data.status === 'error') {
            showToast("Logic Error: " + data.message, "error");
        } else {
            showToast("SETTLEMENT COMPLETE! Check History.", "success");
            alert(`Result (Min Vol): ${fmtNum(data.actualVol)}\nPool: ${data.pool} $\nWinners:\n${data.winners.join('\n')}`);
            loadFromCloud();
        }
    }

    // --- HÀM ĐỒNG BỘ DỮ LIỆU CŨ LÊN MÂY (MIGRATION TOOL) ---
    async function syncLocalToCloud() {
        if(!currentUser) return showToast("Vui lòng đăng nhập trước!", "error");

        if(!confirm("Hành động này sẽ lấy dữ liệu từ máy này GHI ĐÈ lên dữ liệu trên Cloud. Bạn chắc chắn chứ?")) return;

        let migrationData = {};
        let count = 0;

        // 1. Quét toàn bộ dữ liệu trong máy (Local Storage)
        for(let i=0; i < localStorage.length; i++) {
            let key = localStorage.key(i);
            if(key.startsWith('wave_progress_')) {
                let dbId = key.replace('wave_progress_', '');
                try {
                    let data = JSON.parse(localStorage.getItem(key));
                    migrationData[dbId] = data;
                    count++;
                } catch(e) {}
            }
        }

        if(count === 0) return showToast("Không tìm thấy dữ liệu cũ nào trên máy này!", "error");

        // 2. Gửi gói hàng lên Supabase
        let btn = document.querySelector('button[onclick="syncLocalToCloud()"]');
        let oldText = btn.innerHTML;
        btn.innerHTML = "UPLOADING..."; btn.disabled = true;

        const { error } = await supabase.from('profiles').update({ tracker_data: migrationData }).eq('id', currentUser.id);

        btn.innerHTML = oldText; btn.disabled = false;

        if(error) {
            showToast("Lỗi: " + error.message, "error");
        } else {
            showToast(`Thành công! Đã chuyển ${count} giải đấu lên Mây.`, "success");
            // Update local state and UI
            if(userProfile) userProfile.tracker_data = migrationData;
            renderGrid();
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
        }
    }

    // Standard Utils
        function openSettingsModal() {
        let list = document.getElementById('settingsList');
        list.innerHTML = '';
        accSettings.forEach((acc, i) => {
            list.innerHTML += `
            <div class="d-flex align-items-center gap-2">
                <input type="color" class="form-control form-control-color" value="${acc.color}" onchange="updateAccColor(${i}, this.value)" style="height:35px;width:50px">
                <input value="${acc.name}" class="form-control form-control-sm" onchange="updateAccName(${i}, this.value)" placeholder="Account Name">
                <button class="btn btn-sm btn-outline-danger border-0" onclick="delAcc(${i})"><i class="fas fa-trash"></i></button>
            </div>`;
        });
        new bootstrap.Modal(document.getElementById('settingsModal')).show();
    }

    function updateAccName(i, val) { accSettings[i].name = val; localStorage.setItem('wave_settings', JSON.stringify(accSettings)); renderGrid(); }
    function updateAccColor(i, val) { accSettings[i].color = val; localStorage.setItem('wave_settings', JSON.stringify(accSettings)); renderGrid(); }

    function addNewAccount() { accSettings.push({id:'acc_'+Date.now(), name: document.getElementById('newAccName').value||'New', color: document.getElementById('newAccColor').value}); localStorage.setItem('wave_settings', JSON.stringify(accSettings)); openSettingsModal(); renderGrid(); }
    function delAcc(i) { if(confirm("Delete?")){ accSettings.splice(i, 1); localStorage.setItem('wave_settings', JSON.stringify(accSettings)); openSettingsModal(); renderGrid(); } }
        /* --- CÁC HÀM QUẢN LÝ ADMIN (ĐÃ NÂNG CẤP & LÀM SẠCH) --- */

        /* --- CÁC HÀM QUẢN LÝ ADMIN (ĐÃ FIX LOGIC CAMPAIGN & PRICE) --- */

    // 1. Mở Modal tạo mới
    function openCreateModal() {
        document.getElementById('c-db-id').value = '';

        // Reset các ô nhập liệu
        document.getElementById('c-contract').value = '';
        document.getElementById('c-symbol').value = '';
        document.getElementById('c-chain').value = ''; // VD: arbitrum
        document.getElementById('c-price').value = '';
        document.getElementById('c-logo').value = '';
        document.getElementById('c-logo-preview').style.display = 'none';

        document.getElementById('c-rewardQty').value = '';
        document.getElementById('c-winners').value = '';

        // Reset ô nhập Token Campaign
        let tokenInput = document.getElementById('c-inputTokens');
        if(tokenInput) tokenInput.value = '';

        // Ẩn nút xóa
        document.getElementById('btnDeleteComp').style.display = 'none';

        new bootstrap.Modal(document.getElementById('compModal')).show();
    }

    // 2. Mở Modal chỉnh sửa
    function openEditModal(id) {
        let c = compList.find(x => x.db_id == id);
        if(!c) return;

        // Điền dữ liệu cũ vào form
        document.getElementById('c-db-id').value = id;
        document.getElementById('c-contract').value = c.contract;
        document.getElementById('c-symbol').value = c.name;
        document.getElementById('c-chain').value = c.chain;
        document.getElementById('c-price').value = c.cachedPrice;

        // Logo
        document.getElementById('c-logo').value = c.logo;
        let imgPreview = document.getElementById('c-logo-preview');
        if(c.logo) {
            imgPreview.src = c.logo;
            imgPreview.style.display = 'block';
        } else {
            imgPreview.style.display = 'none';
        }

        // Các chỉ số
        document.getElementById('c-rewardQty').value = c.rewardQty;
        document.getElementById('c-winners').value = c.topWinners;
        document.getElementById('c-start').value = c.start;
        document.getElementById('c-end').value = c.end;
        document.getElementById('c-end-time').value = c.endTime;
        document.getElementById('c-alphaType').value = c.alphaType;
        document.getElementById('c-listing').value = c.listingTime;
        document.getElementById('c-rule').value = c.ruleType;

        // Load danh sách Token Campaign (Chuyển từ Mảng về Chuỗi để hiển thị)
        let tokenInput = document.getElementById('c-inputTokens');
        if(tokenInput) {
            if (c.inputTokens && Array.isArray(c.inputTokens)) {
                tokenInput.value = c.inputTokens.join(', '); // VD: "VSN, LAVA"
            } else {
                tokenInput.value = '';
            }
        }

        toggleListingTime();

        // Hiện nút xóa
        document.getElementById('btnDeleteComp').style.display = 'inline-block';
        new bootstrap.Modal(document.getElementById('compModal')).show();
    }

    // 3. Logic bật tắt ô nhập giờ Listing
    function toggleListingTime() {
        document.getElementById('c-listing').disabled = document.getElementById('c-alphaType').value === 'none';
    }

    // 4. Lưu giải đấu (Save to Cloud)
    function saveComp() {
        let id = document.getElementById('c-db-id').value;
        let c = id ? compList.find(x => x.db_id == id) : {};

        // Xử lý ô Input Tokens (Tách chuỗi thành mảng)
        let tokensArr = [];
        let tokenInput = document.getElementById('c-inputTokens');
        if (tokenInput && tokenInput.value.trim() !== "") {
            tokensArr = tokenInput.value.split(',').map(s => s.trim().toUpperCase()).filter(s => s !== '');
        }

        let obj = {
            db_id: id ? parseInt(id) : null,
            name: document.getElementById('c-symbol').value.toUpperCase(),
            contract: document.getElementById('c-contract').value, // Vẫn lưu Contract ARB để tính giá
            chain: document.getElementById('c-chain').value,
            logo: document.getElementById('c-logo').value,
            cachedPrice: document.getElementById('c-price').value,
            rewardQty: document.getElementById('c-rewardQty').value,
            topWinners: document.getElementById('c-winners').value,
            start: document.getElementById('c-start').value,
            end: document.getElementById('c-end').value,
            endTime: document.getElementById('c-end-time').value,
            alphaType: document.getElementById('c-alphaType').value,
            listingTime: document.getElementById('c-listing').value,
            ruleType: document.getElementById('c-rule').value,

            // Lưu mảng token campaign
            inputTokens: tokensArr,

            // Giữ lại dữ liệu mảng con
            history: c.history || [],
            predictions: c.predictions || [],
            comments: c.comments || []
        };

        saveToCloud(obj);
        bootstrap.Modal.getInstance(document.getElementById('compModal')).hide();
    }

    // 5. Xóa giải đấu
    function deleteComp() {
        if(confirm('Delete this tournament?')) {
            deleteFromCloud(document.getElementById('c-db-id').value);
            bootstrap.Modal.getInstance(document.getElementById('compModal')).hide();
        }
    }

    // 6. Hàm gọi Server xóa
    async function deleteFromCloud(id) {
        await supabase.from('tournaments').delete().eq('id', id);
        loadFromCloud();
    }


    async function fetchTokenInfo(q) {
        if(!q) return;
        try {
            let r = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${q}`);
            let d = await r.json();
            if(d.pairs && d.pairs.length) {
                let p = d.pairs[0];
                document.getElementById('c-symbol').value = p.baseToken.symbol;
                document.getElementById('c-price').value = p.priceUsd;
                document.getElementById('c-chain').value = p.chainId;

                let logoUrl = p.info?.imageUrl || `https://dd.dexscreener.com/ds-data/tokens/${p.chainId}/${p.baseToken.address}.png`;
                document.getElementById('c-logo').value = logoUrl;
                let img = document.getElementById('c-logo-preview');
                img.src = logoUrl; img.style.display = 'block';
            }
        } catch(e){}
    }

        // --- FIX: RENDER STATS TỪ SERVER ---
            // --- CẬP NHẬT: CHỈ TÍNH TỔNG TIỀN CÁC GIẢI ĐANG CHẠY (ACTIVE ONLY) ---
    function renderStats() {
        const now = new Date();
        let activeCount = 0;
        let totalEstValue = 0;

        // Biến để tìm Token có giải to nhất
        let maxRewardVal = 0;
        let topToken = null;

        compList.forEach(c => {
            // 1. Kiểm tra trạng thái Running (Còn hạn)
            let isRunning = true;
            if (c.end) {
                let endDateTime = new Date(c.end + 'T' + (c.endTime || '23:59:59'));
                if (now > endDateTime) isRunning = false;
            }

            // 2. Tính toán
            if (isRunning) {
                activeCount++;
                let qty = parseFloat(c.rewardQty) || 0;
                let price = parseFloat(c.cachedPrice) || 0;
                let currentVal = qty * price;

                totalEstValue += currentVal;

                // So sánh tìm Top 1 (Giải thưởng lớn nhất)
                if (currentVal > maxRewardVal) {
                    maxRewardVal = currentVal;
                    topToken = c;
                }
            }
        });

        // 3. Hiển thị 2 ô cơ bản
        document.getElementById('stat-active').innerText = activeCount;
        document.getElementById('stat-pool').innerText = fmt(totalEstValue);

        // 4. Hiển thị ô Top 1 (Highest Reward)
        if (topToken) {
            document.getElementById('stat-top-symbol').innerText = topToken.name;
            document.getElementById('stat-top-val').innerText = fmt(maxRewardVal);
            
            // Hiển thị logo token làm nền (nếu có)
            if(topToken.logo) {
                let imgEl = document.getElementById('stat-top-img');
                imgEl.src = topToken.logo;
                imgEl.style.display = 'block';
            } else {
                document.getElementById('stat-top-img').style.display = 'none';
            }
        } else {
            // Nếu không có giải nào chạy
            document.getElementById('stat-top-symbol').innerText = "---";
            document.getElementById('stat-top-val').innerText = "$0";
            document.getElementById('stat-top-img').style.display = 'none';
        }
    }


        // --- V46 UPDATE: ĐỒNG HỒ THÔNG MINH (KÈM NHÃN UTC) ---
    function updateClock() {
        const now = new Date();

        // 1. XỬ LÝ GIỜ & NHÃN UTC
        if(document.getElementById('sysClock')) {
            // Lấy giờ gốc UTC
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);

            // Xác định Offset
            let offset = 0;
            if (currentLang === 'vi') offset = 7;
            else if (currentLang === 'zh') offset = 8;

            // Tính giờ hiển thị
            const targetTime = new Date(utc + (3600000 * offset));

            // Hiển thị giờ (00:00:00)
            document.getElementById('sysClock').innerText = targetTime.toLocaleTimeString('en-GB', {
                hour12: false, hour: "2-digit", minute: "2-digit", second: "2-digit"
            });

            // --- CẬP NHẬT NHÃN UTC BÊN CẠNH CHỮ "SYSTEM TIME" ---
            let labelEl = document.querySelector('[data-i18n="sys_time"]');
            if(labelEl) {
                // Lấy tên gốc từ từ điển (để đảm bảo đúng ngôn ngữ)
                let baseText = translations[currentLang].sys_time;
                // Thêm đuôi (UTC +X) vào sau
                labelEl.innerText = `${baseText} (UTC +${offset})`;

                // Tô màu chút cho chữ UTC nổi bật (Optional)
                labelEl.style.color = "var(--brand)";
                labelEl.style.fontWeight = "bold";
            }
        }

        // 2. Cập nhật X4 Timers (GIỮ NGUYÊN)
        document.querySelectorAll('.x4-timer-val').forEach(el => {
            const listDate = el.dataset.list;
            if(listDate) {
                const endTime = new Date(listDate).getTime() + (30*24*60*60*1000);
                const dist = endTime - now.getTime();
                if(dist < 0) { el.innerText="EXPIRED"; el.style.color='#555'; }
                else {
                    const d = Math.floor(dist/(1000*60*60*24));
                    const h = Math.floor((dist%(1000*60*60*24))/(1000*60*60));
                    el.innerText = `${d}d ${h}h`;
                }
            }
        });

        // 3. Smart Timer cho Ngày kết thúc (GIỮ NGUYÊN)
        document.querySelectorAll('.smart-timer').forEach(el => {
            let endDateStr = el.dataset.end;
            let endTimeStr = el.dataset.time;
            if(!endDateStr) return;

            let endDateTime = new Date(endDateStr + 'T' + endTimeStr);
            let diff = endDateTime - now;

            if (diff < 0) {
                el.innerText = "ENDED";
                el.style.color = 'var(--text-sub)';
                el.classList.remove('anim-breathe');
                return;
            }

            let todayStr = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2, '0') + '-' + String(now.getDate()).padStart(2, '0');

            if (endDateStr === todayStr) {
                let h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                let m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                let s = Math.floor((diff % (1000 * 60)) / 1000);
                el.innerText = `${h}h ${m}m ${s}s`;
                el.style.color = 'var(--brand)';
                el.classList.add('anim-breathe');
            } else {
                el.innerText = endDateStr;
                el.style.color = '';
                el.classList.remove('anim-breathe');
            }
        });

        // 4. Đồng hồ trang chi tiết (GIỮ NGUYÊN)
        if (currentPolyId && document.getElementById('view-predict').style.display === 'block') {
            let c = compList.find(x => x.db_id == currentPolyId);
            let timerEl = document.getElementById('pt-time');
            if (c && c.end && timerEl) {
                let endTime = new Date(c.end + 'T' + (c.endTime || '23:59:59')).getTime();
                let dist = endTime - now.getTime();
                if (dist < 0) {
                    timerEl.innerText = "MARKET CLOSED";
                    timerEl.className = "text-danger font-num fw-bold fs-3";
                } else {
                    let d = Math.floor(dist / (1000 * 60 * 60 * 24));
                    let h = Math.floor((dist % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    let m = Math.floor((dist % (1000 * 60 * 60)) / (1000 * 60));
                    timerEl.innerText = `${d}d : ${h}h : ${m}m`;
                    timerEl.className = "text-gold font-num fw-bold fs-3 anim-breathe";
                }
            }
        }
    }


/* ============================================================
   V47: SILENT RELOAD (CẬP NHẬT MƯỢT MÀ KHÔNG NHÁY MÀN HÌNH)
   ============================================================ */
async function silentReload(id) {
    // 1. Âm thầm lấy dữ liệu mới từ Server
    const { data: predsData, error } = await supabase
        .from('predictions')
        .select('*')
        .eq('tournament_id', id);

    if (error) return console.error(error);

    // 2. Cập nhật dữ liệu vào bộ nhớ đệm
    let c = compList.find(x => x.db_id == id);
    if (c && predsData) {
        c.predictions = predsData.map(p => ({
            user_id: p.user_id,
            name: p.user_name,
            avatar: p.user_avatar,
            guess: parseFloat(p.guess),
            time: new Date(p.created_at).getTime()
        }));

        // 3. Cập nhật lại Tổng Pool và Min Volume
        let pool = (c.predictions.length || 0) * PREDICT_FEE;
        document.getElementById('pt-pool').innerText = fmt(pool);

        let curMin = (c.history && c.history.length > 0) ? c.history[c.history.length - 1].target : 0;

        // 4. Vẽ lại Bảng xếp hạng (Leaderboard) nhẹ nhàng
        let lb = document.getElementById('pt-leaderboard');
        lb.innerHTML = ''; // Chỉ xóa nội dung bảng, không xóa cả khung

        let preds = (c.predictions || []).sort((a, b) => Math.abs(a.guess - curMin) - Math.abs(b.guess - curMin));

        preds.forEach((p, i) => {
            let avatarHtml = p.avatar ? `<img src="${p.avatar}" class="list-avatar">` : `<div class="list-avatar-placeholder">${p.name.substring(0, 1).toUpperCase()}</div>`;
            let badgeHtml = i < 3 ? `<span class="rank-badge rank-${i + 1}">${i + 1}</span>` : `<span class="rank-badge">${i + 1}</span>`;

            // Hiệu ứng nhấp nháy nhẹ cho dòng của chính mình vừa mới thêm
            let highlightClass = (p.name === document.getElementById('modal-p-name').value) ? 'anim-breathe' : '';

            lb.innerHTML += `<tr class="${highlightClass}"><td class="ps-4">${badgeHtml}</td><td>${avatarHtml}<span class="fw-bold text-white">${p.name}</span></td><td class="text-end pe-4 text-brand font-num fw-bold">${fmtNum(p.guess)}</td></tr>`;
        });

        // 5. Cập nhật Activity Feed
        let actDiv = document.getElementById('content-activity');
        actDiv.innerHTML = '';
        (c.predictions || []).sort((a,b)=>b.time-a.time).forEach(p => {
            let avatarHtml = p.avatar ? `<img src="${p.avatar}" class="act-avatar">` : `<i class="fas fa-bolt text-gold me-3 fa-lg"></i>`;
            actDiv.innerHTML += `<div class="act-item d-flex align-items-center mb-2">${avatarHtml}<div><span class="text-white fw-bold">${p.name}</span> predicted <span class="text-brand font-num">${fmtNum(p.guess)}</span> <div class="text-sub small">${new Date(p.time).toLocaleTimeString()}</div></div></div>`;
        });
    }
}

    init();
    // --- BACKUP & RESTORE LOGIC (ENGLISH) ---
function backupData() {
    let data = {};
    // Get all Wave Alpha related data
    for (let i = 0; i < localStorage.length; i++) {
        let key = localStorage.key(i);
        if (key.startsWith('wave_')) {
            data[key] = localStorage.getItem(key);
        }
    }
    // Create download file
    let blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
    let a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    let date = new Date().toISOString().slice(0,10);
    a.download = 'WaveAlpha_Backup_' + date + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);

    // Notification in English
    alert("Backup file downloaded successfully!");
}

function restoreData(input) {
    let file = input.files[0];
    if (!file) return;
    let reader = new FileReader();
    reader.onload = function(e) {
        try {
            let data = JSON.parse(e.target.result);
            for (let key in data) {
                localStorage.setItem(key, data[key]);
            }
            alert("Data restored successfully! Page reloading...");
            window.location.reload();
        } catch (err) {
            alert("Error: Invalid backup file!");
        }
    };
    reader.readAsText(file);
    input.value = ''; // Reset input
}
// ----------------------------------------

    /* ================= ARSENAL DYNAMIC CONFIG LOGIC ================= */

    // 1. Hàm vẽ lại danh sách Input trong Modal từ dữ liệu đã lưu
    function renderArsenalInputs(items = []) {
        const container = document.getElementById('cfg-arsenal-list');
        container.innerHTML = '';

        items.forEach((item, index) => {
            addArsenalItem(item, index);
        });
    }

    // 2. Hàm thêm một dòng nhập liệu mới (hoặc vẽ dòng cũ)
    function addArsenalItem(data = null, index = null) {
        const container = document.getElementById('cfg-arsenal-list');
        const uniqueId = Date.now() + Math.random().toString(36).substr(2, 9); // Tạo ID ngẫu nhiên

        const name = data ? data.name : '';
        const link = data ? data.link : '';
        const logo = data ? data.logo : '';
        const type = data ? data.type : 'EXCHANGE'; // Mặc định là CEX

        const html = `
        <div class="p-3 rounded border border-secondary border-opacity-25 bg-dark arsenal-item-row" data-id="${uniqueId}">
            <div class="d-flex gap-2 mb-2">
                <input type="text" class="form-control form-control-sm inp-name" placeholder="Tên sàn (VD: Binance)" value="${name}" style="flex:1">
                <select class="form-select form-select-sm inp-type" style="width:130px">
                    <option value="EXCHANGE" ${type==='EXCHANGE'?'selected':''}>Sàn CEX</option>
                    <option value="WEB3 WALLET" ${type==='WEB3 WALLET'?'selected':''}>Ví Web3</option>
                    <option value="DEX SWAP" ${type==='DEX SWAP'?'selected':''}>Sàn DEX</option>
                </select>
            </div>

            <div class="d-flex gap-2 mb-2 align-items-center">
                <input type="text" class="form-control form-control-sm inp-link" placeholder="Link Ref (https://...)" value="${link}">

                <div class="position-relative btn btn-sm btn-outline-secondary" style="width:35px; overflow:hidden;" title="Logo">
                    <i class="fas fa-camera"></i>
                    <input type="file" onchange="uploadImage(this, 'prev-${uniqueId}', 'val-${uniqueId}')" style="position:absolute;left:0;top:0;opacity:0;cursor:pointer;width:100%;height:100%">
                </div>
                <input type="hidden" class="inp-logo" id="val-${uniqueId}" value="${logo}">
                <img id="prev-${uniqueId}" src="${logo}" style="width:30px;height:30px;object-fit:contain; ${logo?'':'display:none'}; border:1px solid #444; border-radius:4px">
            </div>

            <div class="d-flex justify-content-between">
                <div class="d-flex gap-1">
                    <button class="btn btn-sm btn-dark border-secondary" onclick="moveItem(this, -1)" title="Lên"><i class="fas fa-arrow-up"></i></button>
                    <button class="btn btn-sm btn-dark border-secondary" onclick="moveItem(this, 1)" title="Xuống"><i class="fas fa-arrow-down"></i></button>
                </div>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="this.closest('.arsenal-item-row').remove()"><i class="fas fa-trash me-1"></i> Xóa</button>
            </div>
        </div>`;

        container.insertAdjacentHTML('beforeend', html);
    }

    // 3. Hàm di chuyển vị trí (Lên/Xuống)
    function moveItem(btn, direction) {
        const row = btn.closest('.arsenal-item-row');
        const container = document.getElementById('cfg-arsenal-list');
        if (direction === -1 && row.previousElementSibling) {
            container.insertBefore(row, row.previousElementSibling);
        } else if (direction === 1 && row.nextElementSibling) {
            container.insertBefore(row.nextElementSibling, row);
        }
    }


</script>
</body>
</html>

